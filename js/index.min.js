// Main application initialization
(function(){
    // Ensure DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('App initialized');
        
        // Initialize Spectrum color pickers if present
        if (window.jQuery && jQuery.fn.spectrum) {
            jQuery('.color-picker').spectrum({
                showInput: true,
                showInitial: true,
                preferredFormat: "hex",
                showAlpha: true,
                showPalette: true,
                palette: [
                    ["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],
                    ["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],
                    ["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],
                    ["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],
                    ["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],
                    ["#cc0000","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],
                    ["#990000","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],
                    ["#660000","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]
                ]
            });
        }
        
        // Initialize popup handlers
        window.popupManager = {
            open: function(content, options = {}) {
                if (typeof Popup !== 'undefined') {
                    Popup.open(content, options);
                } else {
                    console.warn('Popup library not loaded');
                    // Fallback basic modal
                    const modal = document.createElement('div');
                    modal.className = 'basic-modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <span class="close-btn">&times;</span>
                            ${content}
                        </div>
                    `;
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                        align-items: center; justify-content: center;
                    `;
                    modal.querySelector('.modal-content').style.cssText = `
                        background: white; padding: 20px; border-radius: 5px; 
                        max-width: 500px; width: 90%; position: relative;
                    `;
                    modal.querySelector('.close-btn').onclick = () => modal.remove();
                    document.body.appendChild(modal);
                }
            },
            close: function() {
                if (typeof Popup !== 'undefined') {
                    Popup.close();
                } else {
                    const modals = document.querySelectorAll('.basic-modal');
                    modals.forEach(modal => modal.remove());
                }
            }
        };
        
        // Status display system
        window.showStatus = function(message, type = 'info', duration = 3000) {
            const status = document.createElement('div');
            status.className = `status-message status-${type}`;
            status.textContent = message;
            status.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 12px 20px;
                border-radius: 4px; z-index: 10000; font-family: sans-serif;
                font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                animation: slideIn 0.3s ease;
            `;
            
            // Style based on type
            const styles = {
                'success': 'background: #4CAF50; color: white;',
                'error': 'background: #f44336; color: white;',
                'info': 'background: #2196F3; color: white;',
                'warning': 'background: #ff9800; color: white;'
            };
            status.style.cssText += styles[type] || styles.info;
            
            document.body.appendChild(status);
            
            // Auto remove after duration
            setTimeout(() => {
                status.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => status.remove(), 300);
            }, duration);
            
            // Add CSS animations if not present
            if (!document.querySelector('#status-animations')) {
                const style = document.createElement('style');
                style.id = 'status-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        };
        
        // Form handling
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (form.method === 'post' && !form.hasAttribute('data-ajax-disabled')) {
                e.preventDefault();
                const submitBtn = form.querySelector('[type="submit"]');
                const originalText = submitBtn ? submitBtn.value : '';
                
                // Show loading state
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.value = 'Processing...';
                }
                
                // Simulate form submission
                setTimeout(() => {
                    showStatus('Form submitted successfully!', 'success');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.value = originalText;
                    }
                }, 1000);
            }
        });
        
        // Initialize tooltips
        document.querySelectorAll('[data-tooltip]').forEach(element => {
            element.addEventListener('mouseenter', function(e) {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = this.dataset.tooltip;
                tooltip.style.cssText = `
                    position: absolute; background: #333; color: white;
                    padding: 5px 10px; border-radius: 3px; font-size: 12px;
                    z-index: 1000; white-space: nowrap;
                `;
                document.body.appendChild(tooltip);
                
                const rect = this.getBoundingClientRect();
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
                tooltip.style.left = (rect.left + (rect.width - tooltip.offsetWidth) / 2) + 'px';
                
                this.dataset.tooltipId = tooltip;
                
                // Clean up on mouseleave
                this.addEventListener('mouseleave', function() {
                    if (tooltip.parentNode) {
                        tooltip.remove();
                    }
                }, { once: true });
            });
        });
        
        console.log('All frontend functionality initialized');
    });
})();