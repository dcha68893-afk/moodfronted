<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniConnect Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #06d6a0;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }
        
        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --secondary: #a78bfa;
            --accent: #34d399;
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .glass-card {
            background: var(--surface);
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 12px;
        }
        
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            z-index: 1000;
            max-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--surface);
            border-radius: 1rem;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: var(--text-primary);
        }
        
        .modal.active .modal-content {
            transform: scale(1);
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .tab-button.active {
            background: var(--primary);
            color: white;
        }
        
        .content-area {
            display: none;
        }
        
        .content-area.active {
            display: block;
        }
        
        .auction-timer {
            font-family: monospace;
            font-size: 1.25rem;
            font-weight: bold;
            color: #ef4444;
        }
        
        .hot-deal-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
        }
        
        .discount-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #10b981;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
        }
        
        .image-upload-area {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .image-upload-area.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        
        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .image-preview-item {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        
        .image-preview-item .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .verified-badge {
            display: inline-flex;
            align-items: center;
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .countdown-timer {
            font-family: monospace;
            font-weight: bold;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 0.5rem;
            border-radius: 0.5rem;
            display: inline-block;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
            z-index: 100;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        
        .bottom-nav-item.active {
            color: var(--primary);
        }
        
        .bottom-nav-item i {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .product-card {
            transition: all 0.3s ease;
        }
        
        .product-card:hover .secondary-image {
            opacity: 1;
        }
        
        .secondary-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .quick-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .product-card:hover .quick-actions {
            opacity: 1;
        }
        
        .quick-action-btn {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            background: white;
            transform: scale(1.1);
        }
        
        .quick-action-btn.active {
            color: #ef4444;
        }
        
        .carousel {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
        }
        
        .carousel-inner {
            display: flex;
            transition: transform 0.5s ease;
        }
        
        .carousel-item {
            min-width: 100%;
            position: relative;
        }
        
        .carousel-item img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        
        .carousel-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 1.5rem;
        }
        
        .carousel-control {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }
        
        .carousel-control.prev {
            left: 1rem;
        }
        
        .carousel-control.next {
            right: 1rem;
        }
        
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--border);
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 0 5px;
            transition: background 0.3s ease;
        }
        
        .theme-toggle.active {
            background: var(--primary);
        }
        
        .theme-toggle-handle {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle.active .theme-toggle-handle {
            transform: translateX(30px);
        }
        
        .suggestion-tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }
        
        .list-view .product-card {
            display: flex;
            gap: 1rem;
        }
        
        .list-view .product-image {
            width: 150px;
            height: 150px;
            flex-shrink: 0;
        }
        
        .list-view .product-details {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .list-view .product-card {
                flex-direction: column;
            }
            
            .list-view .product-image {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body class="min-h-screen pb-16">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b dark:bg-slate-800 dark:border-slate-700">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="bg-indigo-600 p-2 rounded-lg">
                        <i class="fas fa-store text-white text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">UniConnect Marketplace</h1>
                </div>
                
                <div class="hidden md:flex space-x-6">
                    <a href="#" class="text-gray-700 hover:text-indigo-600 dark:text-gray-300 dark:hover:text-white font-medium transition">Home</a>
                    <a href="#" class="text-gray-700 hover:text-indigo-600 dark:text-gray-300 dark:hover:text-white font-medium transition">Discover</a>
                    <a href="#" class="text-gray-700 hover:text-indigo-600 dark:text-gray-300 dark:hover:text-white font-medium transition">Categories</a>
                    <a href="#" class="text-gray-700 hover:text-indigo-600 dark:text-gray-300 dark:hover:text-white font-medium transition">Sellers</a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="relative hidden md:block">
                        <input type="text" id="searchInput" placeholder="Search products..." class="pl-10 pr-4 py-2 border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent w-64">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg mt-1 shadow-lg z-10 hidden">
                            <!-- Search suggestions will appear here -->
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <div class="theme-toggle" id="themeToggle">
                            <div class="theme-toggle-handle"></div>
                        </div>
                        
                        <button id="createListingBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>List Item</span>
                        </button>
                        
                        <div class="relative">
                            <button class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                            <span class="absolute -top-1 -right-1 bg-indigo-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                        </div>
                        
                        <div class="relative">
                            <button class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition">
                                <i class="far fa-bell"></i>
                            </button>
                            <span class="absolute -top-1 -right-1 bg-indigo-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">5</span>
                        </div>
                        
                        <div class="flex items-center space-x-2 ml-2">
                            <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff&size=40" alt="User" class="w-10 h-10 rounded-full object-cover">
                            <div class="hidden md:block">
                                <p id="userName" class="text-sm font-medium text-gray-900 dark:text-white">User</p>
                                <p id="userStatus" class="text-xs text-gray-500 dark:text-gray-400">Student</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Hero Section with Carousel -->
        <section class="mb-8">
            <div class="carousel rounded-xl overflow-hidden">
                <div class="carousel-inner">
                    <div class="carousel-item">
                        <img src="https://images.unsplash.com/photo-1563013544-824ae1b704d3?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="Marketplace Banner">
                        <div class="carousel-caption">
                            <h2 class="text-2xl font-bold">Welcome to UniConnect Marketplace</h2>
                            <p class="text-lg">Buy and sell within your community</p>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="Hot Deals">
                        <div class="carousel-caption">
                            <h2 class="text-2xl font-bold">Hot Deals</h2>
                            <p class="text-lg">Check out our trending items with special discounts</p>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="Flash Sale">
                        <div class="carousel-caption">
                            <h2 class="text-2xl font-bold">Flash Sale</h2>
                            <p class="text-lg">Limited time offers with countdown timer</p>
                            <div class="countdown-timer mt-2" id="flashSaleTimer">24:00:00</div>
                        </div>
                    </div>
                </div>
                <button class="carousel-control prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-control next">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass-card p-4 text-center">
                <div class="text-indigo-600 text-xl font-bold mb-1" id="activeListingsCount">0</div>
                <div class="text-gray-600 dark:text-gray-400 text-sm">Active Listings</div>
            </div>
            <div class="glass-card p-4 text-center">
                <div class="text-indigo-600 text-xl font-bold mb-1" id="totalUsersCount">0</div>
                <div class="text-gray-600 dark:text-gray-400 text-sm">Users</div>
            </div>
            <div class="glass-card p-4 text-center">
                <div class="text-indigo-600 text-xl font-bold mb-1" id="successfulSalesCount">0</div>
                <div class="text-gray-600 dark:text-gray-400 text-sm">Successful Sales</div>
            </div>
            <div class="glass-card p-4 text-center">
                <div class="text-indigo-600 text-xl font-bold mb-1" id="averageRatingCount">0.0</div>
                <div class="text-gray-600 dark:text-gray-400 text-sm">Avg. Rating</div>
            </div>
        </section>

        <!-- Trending Items Section -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Trending Items</h2>
                <a href="#" class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 font-medium">View All</a>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="trendingItemsContainer">
                <!-- Trending items will be loaded here -->
            </div>
        </section>

        <!-- Marketplace Tabs -->
        <section class="mb-8">
            <div class="flex flex-wrap justify-between items-center mb-6">
                <div class="flex flex-wrap gap-2 mb-4 md:mb-0">
                    <button class="tab-button active" data-category="all">All Listings</button>
                    <button class="tab-button" data-category="electronics">Electronics</button>
                    <button class="tab-button" data-category="textbooks">Textbooks</button>
                    <button class="tab-button" data-category="furniture">Furniture</button>
                    <button class="tab-button" data-category="clothing">Clothing</button>
                    <button class="tab-button" data-category="services">Services</button>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <button id="gridViewBtn" class="p-2 border border-gray-300 dark:border-slate-600 rounded-lg text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white bg-indigo-50 dark:bg-indigo-900/20">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button id="listViewBtn" class="p-2 border border-gray-300 dark:border-slate-600 rounded-lg text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                    
                    <select id="sortFilter" class="border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="popular">Most Popular</option>
                    </select>
                </div>
            </div>

            <!-- Filters -->
            <div class="glass-card p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Price Range</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="minPrice" placeholder="Min" class="w-20 border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="maxPrice" placeholder="Max" class="w-20 border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Seller Rating</label>
                        <select id="sellerRatingFilter" class="border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="any">Any Rating</option>
                            <option value="4.5">4.5+ Stars</option>
                            <option value="4.0">4.0+ Stars</option>
                            <option value="3.5">3.5+ Stars</option>
                            <option value="3.0">3.0+ Stars</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location</label>
                        <select id="locationFilter" class="border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="any">Any Location</option>
                            <option value="campus">On Campus</option>
                            <option value="downtown">Downtown</option>
                            <option value="suburbs">Suburbs</option>
                        </select>
                    </div>
                    
                    <button id="applyFilters" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition mt-5">Apply Filters</button>
                    <button id="clearFilters" class="bg-gray-300 dark:bg-slate-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 dark:hover:bg-slate-500 transition mt-5">Clear</button>
                </div>
            </div>

            <!-- Product Grid/List -->
            <div id="listingsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Listings will be loaded here -->
            </div>

            <!-- Load More Button -->
            <div class="text-center mt-8">
                <button id="loadMoreBtn" class="bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 dark:hover:bg-slate-700 transition">
                    Load More Listings
                </button>
            </div>
        </section>

        <!-- Recommended For You -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Recommended For You</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="recommendedContainer">
                <!-- Recommended items will be loaded here -->
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="index.html" class="bottom-nav-item active">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="chat.html" class="bottom-nav-item">
            <i class="fas fa-comments"></i>
            <span>Chat</span>
        </a>
        <a href="games.html" class="bottom-nav-item">
            <i class="fas fa-gamepad"></i>
            <span>Games</span>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </div>

    <!-- Create Listing Modal -->
    <div id="createListingModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Create New Listing</h2>
                <button id="closeCreateModal" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="createListingForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product Title</label>
                    <input type="text" id="listingTitle" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="e.g. Calculus Textbook 8th Edition" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                    <textarea rows="4" id="listingDescription" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Describe your item..." required></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Price ($)</label>
                        <input type="number" id="listingPrice" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                        <select id="listingCategory" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="electronics">Electronics</option>
                            <option value="textbooks">Textbooks</option>
                            <option value="furniture">Furniture</option>
                            <option value="clothing">Clothing</option>
                            <option value="services">Services</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Condition</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="condition" value="new" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500" checked>
                            <span class="ml-2 text-gray-700 dark:text-gray-300">New</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="condition" value="like-new" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Like New</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="condition" value="good" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Good</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="condition" value="fair" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Fair</span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tags</label>
                    <input type="text" id="listingTags" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Add tags (comma separated)">
                    <div id="tagSuggestions" class="mt-2">
                        <!-- Tag suggestions will appear here -->
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product Images</label>
                    <div class="image-upload-area" id="imageUploadArea">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600 dark:text-gray-400 mb-2">Drag & drop images here or click to browse</p>
                        <button type="button" id="browseImagesBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Browse Files</button>
                        <input type="file" id="listingImages" multiple accept="image/*" class="hidden">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">JPEG, PNG up to 5MB each. Max 8 images.</p>
                    </div>
                    <div id="imagePreview" class="image-preview mt-4">
                        <!-- Image previews will appear here -->
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelCreateListing" class="bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 dark:hover:bg-slate-700 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Create Listing</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="productModalTitle" class="text-2xl font-bold text-gray-900 dark:text-white">Product Details</h2>
                <button id="closeProductModal" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="productModalContent">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
            authDomain: "uniconnect-ee95c.firebaseapp.com",
            projectId: "uniconnect-ee95c",
            storageBucket: "uniconnect-ee95c.firebasestorage.app",
            messagingSenderId: "1003264444309",
            appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let userData = null;
        let selectedImages = [];
        let currentView = 'grid'; // 'grid' or 'list'
        let currentCategory = 'all';
        let currentSort = 'newest';
        let allListings = [];
        let filteredListings = [];
        let displayedCount = 0;
        const listingsPerPage = 12;

        // DOM Elements
        const listingsContainer = document.getElementById('listingsContainer');
        const trendingItemsContainer = document.getElementById('trendingItemsContainer');
        const recommendedContainer = document.getElementById('recommendedContainer');
        const createListingBtn = document.getElementById('createListingBtn');
        const createListingModal = document.getElementById('createListingModal');
        const closeCreateModal = document.getElementById('closeCreateModal');
        const cancelCreateListing = document.getElementById('cancelCreateListing');
        const createListingForm = document.getElementById('createListingForm');
        const browseImagesBtn = document.getElementById('browseImagesBtn');
        const listingImages = document.getElementById('listingImages');
        const imagePreview = document.getElementById('imagePreview');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const searchInput = document.getElementById('searchInput');
        const searchSuggestions = document.getElementById('searchSuggestions');
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const sortFilter = document.getElementById('sortFilter');
        const minPrice = document.getElementById('minPrice');
        const maxPrice = document.getElementById('maxPrice');
        const sellerRatingFilter = document.getElementById('sellerRatingFilter');
        const locationFilter = document.getElementById('locationFilter');
        const applyFilters = document.getElementById('applyFilters');
        const clearFilters = document.getElementById('clearFilters');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const productModal = document.getElementById('productModal');
        const closeProductModal = document.getElementById('closeProductModal');
        const productModalTitle = document.getElementById('productModalTitle');
        const productModalContent = document.getElementById('productModalContent');
        const themeToggle = document.getElementById('themeToggle');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userStatus = document.getElementById('userStatus');
        const activeListingsCount = document.getElementById('activeListingsCount');
        const totalUsersCount = document.getElementById('totalUsersCount');
        const successfulSalesCount = document.getElementById('successfulSalesCount');
        const averageRatingCount = document.getElementById('averageRatingCount');
        const flashSaleTimer = document.getElementById('flashSaleTimer');
        const tagSuggestions = document.getElementById('tagSuggestions');
        const listingTitle = document.getElementById('listingTitle');
        const listingTags = document.getElementById('listingTags');

        // Clear any cached data
        localStorage.removeItem('marketplaceListings');
        sessionStorage.clear();

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸª Marketplace loaded');
            
            // Check authentication
            auth.onAuthStateChanged(handleAuthStateChange);
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize carousel
            initCarousel();
            
            // Initialize theme
            initTheme();
            
            // Start flash sale timer
            startFlashSaleTimer();
        });

        // Handle authentication state changes
        function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                console.log('âœ… User authenticated:', user.uid);
                loadUserData(user.uid);
                loadMarketplaceData();
                updateUserUI(user);
            } else {
                console.log('âŒ No user signed in');
                // Redirect to login page or show login modal
                window.location.href = 'login.html';
            }
        }

        // Load current user's data
        async function loadUserData(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log('âœ… User data loaded:', userData);
                } else {
                    // Create user document if it doesn't exist
                    await db.collection('users').doc(uid).set({
                        name: currentUser.displayName || 'User',
                        email: currentUser.email,
                        avatar: currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || 'User')}&background=6366f1&color=fff&size=150`,
                        status: 'student',
                        joined: new Date(),
                        rating: 5.0,
                        listings: 0,
                        sales: 0
                    });
                    userData = {
                        name: currentUser.displayName || 'User',
                        email: currentUser.email,
                        avatar: currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || 'User')}&background=6366f1&color=fff&size=150`,
                        status: 'student',
                        joined: new Date(),
                        rating: 5.0,
                        listings: 0,
                        sales: 0
                    };
                }
            } catch (error) {
                console.error('âŒ Error loading user data:', error);
            }
        }

        // Load marketplace data
        async function loadMarketplaceData() {
            try {
                // Load active listings
                const listingsSnapshot = await db.collection('marketplace')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                allListings = [];
                listingsSnapshot.forEach(doc => {
                    const listing = doc.data();
                    listing.id = doc.id;
                    allListings.push(listing);
                });
                
                console.log(`âœ… Loaded ${allListings.length} listings`);
                
                // Load stats
                await loadStats();
                
                // Display listings
                filterAndDisplayListings();
                
                // Load trending items (most viewed listings)
                loadTrendingItems();
                
                // Load recommended items
                loadRecommendedItems();
                
            } catch (error) {
                console.error('âŒ Error loading marketplace data:', error);
                showNotification('Error loading marketplace data', 'error');
            }
        }

        // Load marketplace stats
        async function loadStats() {
            try {
                // Active listings count
                const activeListingsQuery = await db.collection('marketplace')
                    .where('status', '==', 'active')
                    .get();
                activeListingsCount.textContent = activeListingsQuery.size;
                
                // Total users count
                const usersQuery = await db.collection('users').get();
                totalUsersCount.textContent = usersQuery.size;
                
                // Successful sales count (placeholder - would need a sales collection)
                successfulSalesCount.textContent = Math.floor(usersQuery.size * 1.5);
                
                // Average rating (placeholder)
                averageRatingCount.textContent = '4.8';
                
            } catch (error) {
                console.error('âŒ Error loading stats:', error);
            }
        }

        // Load trending items
        function loadTrendingItems() {
            // For now, we'll use the first 4 listings as trending
            const trendingItems = allListings.slice(0, 4);
            
            trendingItemsContainer.innerHTML = '';
            trendingItems.forEach(item => {
                trendingItemsContainer.innerHTML += createProductCard(item, true);
            });
            
            // Add event listeners to trending items
            setTimeout(() => {
                addProductCardListeners();
            }, 100);
        }

        // Load recommended items
        function loadRecommendedItems() {
            // For now, we'll use random listings as recommended
            const shuffled = [...allListings].sort(() => 0.5 - Math.random());
            const recommendedItems = shuffled.slice(0, 4);
            
            recommendedContainer.innerHTML = '';
            recommendedItems.forEach(item => {
                recommendedContainer.innerHTML += createProductCard(item, true);
            });
            
            // Add event listeners to recommended items
            setTimeout(() => {
                addProductCardListeners();
            }, 100);
        }

        // Filter and display listings based on current filters
        function filterAndDisplayListings() {
            // Apply category filter
            if (currentCategory === 'all') {
                filteredListings = [...allListings];
            } else {
                filteredListings = allListings.filter(listing => listing.category === currentCategory);
            }
            
            // Apply price filter
            const minPriceValue = parseFloat(minPrice.value) || 0;
            const maxPriceValue = parseFloat(maxPrice.value) || Infinity;
            
            filteredListings = filteredListings.filter(listing => {
                return listing.price >= minPriceValue && listing.price <= maxPriceValue;
            });
            
            // Apply sort
            switch (currentSort) {
                case 'newest':
                    filteredListings.sort((a, b) => b.createdAt - a.createdAt);
                    break;
                case 'oldest':
                    filteredListings.sort((a, b) => a.createdAt - b.createdAt);
                    break;
                case 'price-low':
                    filteredListings.sort((a, b) => a.price - b.price);
                    break;
                case 'price-high':
                    filteredListings.sort((a, b) => b.price - a.price);
                    break;
                case 'popular':
                    // Sort by views (placeholder - would need views field)
                    filteredListings.sort((a, b) => (b.views || 0) - (a.views || 0));
                    break;
            }
            
            // Reset displayed count
            displayedCount = 0;
            
            // Display listings
            displayListings();
        }

        // Display listings in the container
        function displayListings() {
            const listingsToShow = filteredListings.slice(displayedCount, displayedCount + listingsPerPage);
            
            if (displayedCount === 0) {
                listingsContainer.innerHTML = '';
            }
            
            if (listingsToShow.length === 0 && displayedCount === 0) {
                listingsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700 dark:text-gray-300 mb-2">No listings found</h3>
                        <p class="text-gray-500 dark:text-gray-400">Try adjusting your filters or search terms</p>
                    </div>
                `;
                loadMoreBtn.style.display = 'none';
                return;
            }
            
            listingsToShow.forEach(listing => {
                listingsContainer.innerHTML += createProductCard(listing);
            });
            
            displayedCount += listingsToShow.length;
            
            // Show/hide load more button
            if (displayedCount >= filteredListings.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
            }
            
            // Add event listeners to product cards
            setTimeout(() => {
                addProductCardListeners();
            }, 100);
        }

        // Create product card HTML
        function createProductCard(listing, isSmall = false) {
            const isOwnListing = currentUser && listing.sellerId === currentUser.uid;
            const listingDate = listing.createdAt ? new Date(listing.createdAt.seconds * 1000).toLocaleDateString() : 'Recently';
            const discount = listing.originalPrice && listing.price < listing.originalPrice 
                ? Math.round((1 - listing.price / listing.originalPrice) * 100) 
                : 0;
            
            const imageUrl = listing.images && listing.images.length > 0 
                ? listing.images[0] 
                : 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80';
            
            const secondaryImageUrl = listing.images && listing.images.length > 1 
                ? listing.images[1] 
                : imageUrl;
            
            return `
                <div class="product-card glass-card rounded-xl overflow-hidden hover-lift fade-in ${currentView === 'list' ? 'list-view' : ''}" data-listing-id="${listing.id}">
                    <div class="relative ${isSmall ? 'h-40' : 'h-48'} overflow-hidden">
                        <img src="${imageUrl}" alt="${listing.title}" class="w-full h-full object-cover primary-image">
                        <img src="${secondaryImageUrl}" alt="${listing.title}" class="secondary-image">
                        
                        ${discount > 0 ? `<div class="discount-badge">${discount}% OFF</div>` : ''}
                        ${listing.isHotDeal ? `<div class="hot-deal-badge">HOT DEAL</div>` : ''}
                        
                        <div class="quick-actions">
                            <button class="quick-action-btn favorite-btn ${isInWishlist(listing.id) ? 'active' : ''}" data-listing-id="${listing.id}">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button class="quick-action-btn view-btn" data-listing-id="${listing.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-4 product-details">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-gray-900 dark:text-white line-clamp-2 flex-1">${listing.title}</h3>
                            <span class="text-indigo-600 dark:text-indigo-400 font-bold ml-2">$${listing.price.toFixed(2)}</span>
                        </div>
                        
                        <div class="flex items-center mb-2">
                            <img src="${listing.sellerAvatar || 'https://ui-avatars.com/api/?name=Seller&background=6366f1&color=fff&size=32'}" 
                                 alt="${listing.sellerName}" 
                                 class="w-6 h-6 rounded-full object-cover mr-2">
                            <span class="text-sm text-gray-600 dark:text-gray-400">${listing.sellerName}</span>
                            ${listing.sellerVerified ? '<span class="verified-badge"><i class="fas fa-check mr-1"></i>Verified</span>' : ''}
                        </div>
                        
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-4 line-clamp-2">${listing.description || 'No description available'}</p>
                        
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-1">
                                <i class="fas fa-star text-yellow-400 text-sm"></i>
                                <span class="text-sm text-gray-600 dark:text-gray-400">${listing.rating || '4.5'}</span>
                                <span class="text-sm text-gray-400 dark:text-gray-500">(${listing.reviewCount || '12'})</span>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${listingDate}</span>
                        </div>
                        
                        ${!isSmall ? `
                            <div class="flex justify-between mt-4">
                                <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition flex-1 mr-2 contact-seller-btn" data-listing-id="${listing.id}">
                                    Contact
                                </button>
                                <button class="bg-gray-200 dark:bg-slate-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-slate-500 transition add-to-cart-btn" data-listing-id="${listing.id}">
                                    <i class="fas fa-shopping-cart"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Create listing modal
            if (createListingBtn) {
                createListingBtn.addEventListener('click', openCreateListingModal);
            }
            
            if (closeCreateModal) {
                closeCreateModal.addEventListener('click', closeCreateListingModal);
            }
            
            if (cancelCreateListing) {
                cancelCreateListing.addEventListener('click', closeCreateListingModal);
            }
            
            if (createListingForm) {
                createListingForm.addEventListener('submit', handleCreateListing);
            }
            
            // Image upload
            if (browseImagesBtn) {
                browseImagesBtn.addEventListener('click', () => listingImages.click());
            }
            
            if (listingImages) {
                listingImages.addEventListener('change', handleImageSelection);
            }
            
            if (imageUploadArea) {
                imageUploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                
                imageUploadArea.addEventListener('dragleave', function() {
                    this.classList.remove('dragover');
                });
                
                imageUploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    listingImages.files = e.dataTransfer.files;
                    handleImageSelection({ target: listingImages });
                });
            }
            
            // Search
            if (searchInput) {
                searchInput.addEventListener('input', debounce(handleSearch, 300));
                searchInput.addEventListener('focus', showSearchSuggestions);
            }
            
            // View toggle
            if (gridViewBtn) {
                gridViewBtn.addEventListener('click', () => switchView('grid'));
            }
            
            if (listViewBtn) {
                listViewBtn.addEventListener('click', () => switchView('list'));
            }
            
            // Sorting and filtering
            if (sortFilter) {
                sortFilter.addEventListener('change', function() {
                    currentSort = this.value;
                    filterAndDisplayListings();
                });
            }
            
            if (applyFilters) {
                applyFilters.addEventListener('click', filterAndDisplayListings);
            }
            
            if (clearFilters) {
                clearFilters.addEventListener('click', clearAllFilters);
            }
            
            // Load more
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', displayListings);
            }
            
            // Product modal
            if (closeProductModal) {
                closeProductModal.addEventListener('click', closeProductModalFunc);
            }
            
            // Theme toggle
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // Category tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update current category
                    currentCategory = this.getAttribute('data-category');
                    filterAndDisplayListings();
                });
            });
            
            // Tag suggestions
            if (listingTitle) {
                listingTitle.addEventListener('input', generateTagSuggestions);
            }
        }

        // Add event listeners to product cards
        function addProductCardListeners() {
            // Favorite buttons
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const listingId = this.getAttribute('data-listing-id');
                    toggleWishlist(listingId, this);
                });
            });
            
            // View buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const listingId = this.getAttribute('data-listing-id');
                    viewProductDetails(listingId);
                });
            });
            
            // Contact seller buttons
            document.querySelectorAll('.contact-seller-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const listingId = this.getAttribute('data-listing-id');
                    contactSeller(listingId);
                });
            });
            
            // Add to cart buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const listingId = this.getAttribute('data-listing-id');
                    addToCart(listingId);
                });
            });
        }

        // Switch between grid and list view
        function switchView(view) {
            currentView = view;
            
            if (view === 'grid') {
                gridViewBtn.classList.add('bg-indigo-50', 'dark:bg-indigo-900/20');
                listViewBtn.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/20');
                listingsContainer.classList.remove('grid-cols-1');
                listingsContainer.classList.add('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
            } else {
                listViewBtn.classList.add('bg-indigo-50', 'dark:bg-indigo-900/20');
                gridViewBtn.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/20');
                listingsContainer.classList.remove('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');
                listingsContainer.classList.add('grid-cols-1');
            }
            
            // Re-render listings with new view
            const currentListings = [...listingsContainer.children];
            listingsContainer.innerHTML = '';
            currentListings.forEach(card => {
                listingsContainer.appendChild(card);
            });
        }

        // Open create listing modal
        function openCreateListingModal() {
            if (!currentUser) {
                showNotification('Please log in to create a listing', 'warning');
                return;
            }
            
            if (createListingModal) {
                createListingModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        // Close create listing modal
        function closeCreateListingModal() {
            if (createListingModal) {
                createListingModal.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                // Reset form
                if (createListingForm) {
                    createListingForm.reset();
                }
                
                // Clear image preview
                if (imagePreview) {
                    imagePreview.innerHTML = '';
                }
                
                selectedImages = [];
            }
        }

        // Handle image selection
        function handleImageSelection(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            // Clear previous preview
            imagePreview.innerHTML = '';
            
            // Limit to 8 images
            const fileArray = Array.from(files).slice(0, 8);
            
            fileArray.forEach(file => {
                if (!file.type.startsWith('image/')) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', function() {
                        previewItem.remove();
                        // Remove from selectedImages
                        const index = selectedImages.indexOf(file);
                        if (index > -1) {
                            selectedImages.splice(index, 1);
                        }
                    });
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    imagePreview.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
                
                selectedImages.push(file);
            });
        }

        // Handle create listing form submission
        async function handleCreateListing(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showNotification('Please log in to create a listing', 'warning');
                return;
            }
            
            const title = document.getElementById('listingTitle').value;
            const description = document.getElementById('listingDescription').value;
            const price = parseFloat(document.getElementById('listingPrice').value);
            const category = document.getElementById('listingCategory').value;
            const condition = document.querySelector('input[name="condition"]:checked').value;
            const tags = document.getElementById('listingTags').value
                ? document.getElementById('listingTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
                : [];
            
            if (!title || !description || isNaN(price)) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                // Upload images if any
                let imageUrls = [];
                
                if (selectedImages.length > 0) {
                    for (const image of selectedImages) {
                        const imageRef = storage.ref().child(`marketplace/${currentUser.uid}/${Date.now()}_${image.name}`);
                        const snapshot = await imageRef.put(image);
                        const url = await snapshot.ref.getDownloadURL();
                        imageUrls.push(url);
                    }
                }
                
                // Create listing in Firestore
                const listingData = {
                    title,
                    description,
                    price,
                    category,
                    condition,
                    tags,
                    images: imageUrls,
                    sellerId: currentUser.uid,
                    sellerName: userData.name,
                    sellerAvatar: userData.avatar,
                    sellerVerified: userData.verified || false,
                    status: 'active',
                    views: 0,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                await db.collection('marketplace').add(listingData);
                
                showNotification('Listing created successfully!', 'success');
                closeCreateListingModal();
                
                // Refresh listings
                loadMarketplaceData();
                
            } catch (error) {
                console.error('âŒ Error creating listing:', error);
                showNotification('Error creating listing', 'error');
            }
        }

        // Handle search
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm.length === 0) {
                searchSuggestions.classList.add('hidden');
                return;
            }
            
            // Filter listings by search term
            const searchResults = allListings.filter(listing => 
                listing.title.toLowerCase().includes(searchTerm) ||
                listing.description.toLowerCase().includes(searchTerm) ||
                (listing.tags && listing.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
            );
            
            // Update listings
            filteredListings = searchResults;
            displayedCount = 0;
            displayListings();
        }

        // Show search suggestions
        function showSearchSuggestions() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm.length === 0) {
                searchSuggestions.classList.add('hidden');
                return;
            }
            
            // Get unique categories and tags for suggestions
            const categories = [...new Set(allListings.map(listing => listing.category))];
            const allTags = allListings.flatMap(listing => listing.tags || []);
            const popularTags = [...new Set(allTags)].slice(0, 5);
            
            let suggestionsHTML = '';
            
            // Add category suggestions
            const categorySuggestions = categories.filter(cat => 
                cat.toLowerCase().includes(searchTerm)
            ).slice(0, 3);
            
            if (categorySuggestions.length > 0) {
                suggestionsHTML += `<div class="p-2 border-b border-gray-200 dark:border-slate-600 text-sm font-medium text-gray-500 dark:text-gray-400">Categories</div>`;
                categorySuggestions.forEach(cat => {
                    suggestionsHTML += `<div class="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer" data-suggestion="${cat}">${cat}</div>`;
                });
            }
            
            // Add tag suggestions
            const tagSuggestions = popularTags.filter(tag => 
                tag.toLowerCase().includes(searchTerm)
            ).slice(0, 3);
            
            if (tagSuggestions.length > 0) {
                suggestionsHTML += `<div class="p-2 border-b border-gray-200 dark:border-slate-600 text-sm font-medium text-gray-500 dark:text-gray-400">Popular Tags</div>`;
                tagSuggestions.forEach(tag => {
                    suggestionsHTML += `<div class="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer" data-suggestion="${tag}">#${tag}</div>`;
                });
            }
            
            // Add product suggestions
            const productSuggestions = allListings.filter(listing => 
                listing.title.toLowerCase().includes(searchTerm)
            ).slice(0, 3);
            
            if (productSuggestions.length > 0) {
                suggestionsHTML += `<div class="p-2 border-b border-gray-200 dark:border-slate-600 text-sm font-medium text-gray-500 dark:text-gray-400">Products</div>`;
                productSuggestions.forEach(product => {
                    suggestionsHTML += `
                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer flex items-center" data-suggestion="${product.title}">
                            <img src="${product.images && product.images.length > 0 ? product.images[0] : 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}" 
                                 alt="${product.title}" 
                                 class="w-8 h-8 rounded object-cover mr-2">
                            <div>
                                <div class="font-medium">${product.title}</div>
                                <div class="text-xs text-gray-500">$${product.price.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (suggestionsHTML) {
                searchSuggestions.innerHTML = suggestionsHTML;
                searchSuggestions.classList.remove('hidden');
                
                // Add click listeners to suggestions
                searchSuggestions.querySelectorAll('div[data-suggestion]').forEach(suggestion => {
                    suggestion.addEventListener('click', function() {
                        searchInput.value = this.getAttribute('data-suggestion');
                        searchSuggestions.classList.add('hidden');
                        handleSearch();
                    });
                });
            } else {
                searchSuggestions.classList.add('hidden');
            }
        }

        // Clear all filters
        function clearAllFilters() {
            minPrice.value = '';
            maxPrice.value = '';
            sellerRatingFilter.value = 'any';
            locationFilter.value = 'any';
            filterAndDisplayListings();
        }

        // Toggle wishlist
        async function toggleWishlist(listingId, button) {
            if (!currentUser) {
                showNotification('Please log in to add items to your wishlist', 'warning');
                return;
            }
            
            try {
                const wishlistRef = db.collection('wishlist')
                    .where('userId', '==', currentUser.uid)
                    .where('listingId', '==', listingId);
                
                const snapshot = await wishlistRef.get();
                
                if (snapshot.empty) {
                    // Add to wishlist
                    await db.collection('wishlist').add({
                        userId: currentUser.uid,
                        listingId: listingId,
                        addedAt: new Date()
                    });
                    
                    button.classList.add('active');
                    showNotification('Added to wishlist', 'success');
                } else {
                    // Remove from wishlist
                    const doc = snapshot.docs[0];
                    await db.collection('wishlist').doc(doc.id).delete();
                    
                    button.classList.remove('active');
                    showNotification('Removed from wishlist', 'info');
                }
            } catch (error) {
                console.error('âŒ Error toggling wishlist:', error);
                showNotification('Error updating wishlist', 'error');
            }
        }

        // Check if item is in wishlist
        function isInWishlist(listingId) {
            // This would need to be implemented with actual data
            // For now, we'll return false
            return false;
        }

        // View product details
        async function viewProductDetails(listingId) {
            try {
                const listingDoc = await db.collection('marketplace').doc(listingId).get();
                
                if (!listingDoc.exists) {
                    showNotification('Product not found', 'error');
                    return;
                }
                
                const listing = listingDoc.data();
                listing.id = listingDoc.id;
                
                // Update modal title
                productModalTitle.textContent = listing.title;
                
                // Create product details HTML
                let productHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="rounded-lg overflow-hidden mb-4">
                                <img src="${listing.images && listing.images.length > 0 ? listing.images[0] : 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}" 
                                     alt="${listing.title}" 
                                     class="w-full h-64 object-cover">
                            </div>
                            
                            ${listing.images && listing.images.length > 1 ? `
                                <div class="grid grid-cols-4 gap-2">
                                    ${listing.images.map((img, index) => `
                                        <img src="${img}" 
                                             alt="${listing.title}" 
                                             class="w-full h-16 object-cover rounded cursor-pointer ${index === 0 ? 'border-2 border-indigo-500' : ''}"
                                             data-image-index="${index}">
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">${listing.title}</h3>
                                <span class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">$${listing.price.toFixed(2)}</span>
                            </div>
                            
                            <div class="flex items-center mb-4">
                                <img src="${listing.sellerAvatar || 'https://ui-avatars.com/api/?name=Seller&background=6366f1&color=fff&size=32'}" 
                                     alt="${listing.sellerName}" 
                                     class="w-10 h-10 rounded-full object-cover mr-3">
                                <div>
                                    <div class="font-medium text-gray-900 dark:text-white">${listing.sellerName}</div>
                                    <div class="flex items-center">
                                        <div class="flex items-center mr-2">
                                            <i class="fas fa-star text-yellow-400 mr-1"></i>
                                            <span>${listing.rating || '4.5'}</span>
                                        </div>
                                        <span class="text-gray-500 dark:text-gray-400 text-sm">(${listing.reviewCount || '12'} reviews)</span>
                                        ${listing.sellerVerified ? '<span class="verified-badge ml-2"><i class="fas fa-check mr-1"></i>Verified</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="font-medium text-gray-900 dark:text-white mb-2">Description</h4>
                                <p class="text-gray-600 dark:text-gray-400">${listing.description || 'No description available'}</p>
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="font-medium text-gray-900 dark:text-white mb-2">Details</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <span class="text-gray-500 dark:text-gray-400">Category:</span>
                                        <span class="font-medium ml-1">${listing.category}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 dark:text-gray-400">Condition:</span>
                                        <span class="font-medium ml-1">${listing.condition}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 dark:text-gray-400">Listed:</span>
                                        <span class="font-medium ml-1">${listing.createdAt ? new Date(listing.createdAt.seconds * 1000).toLocaleDateString() : 'Recently'}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 dark:text-gray-400">Views:</span>
                                        <span class="font-medium ml-1">${listing.views || 0}</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${listing.tags && listing.tags.length > 0 ? `
                                <div class="mb-4">
                                    <h4 class="font-medium text-gray-900 dark:text-white mb-2">Tags</h4>
                                    <div class="flex flex-wrap">
                                        ${listing.tags.map(tag => `
                                            <span class="suggestion-tag">${tag}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="flex space-x-4 mt-6">
                                <button class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition flex-1 contact-seller-modal-btn" data-listing-id="${listing.id}">
                                    Contact Seller
                                </button>
                                <button class="bg-gray-200 dark:bg-slate-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-slate-500 transition add-to-cart-modal-btn" data-listing-id="${listing.id}">
                                    <i class="fas fa-shopping-cart mr-2"></i>Add to Cart
                                </button>
                                <button class="bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 px-4 py-3 rounded-lg font-semibold hover:bg-gray-50 dark:hover:bg-slate-600 transition favorite-modal-btn ${isInWishlist(listing.id) ? 'active' : ''}" data-listing-id="${listing.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                productModalContent.innerHTML = productHTML;
                
                // Open modal
                productModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Add event listeners to modal buttons
                setTimeout(() => {
                    document.querySelector('.contact-seller-modal-btn').addEventListener('click', function() {
                        contactSeller(listing.id);
                    });
                    
                    document.querySelector('.add-to-cart-modal-btn').addEventListener('click', function() {
                        addToCart(listing.id);
                    });
                    
                    document.querySelector('.favorite-modal-btn').addEventListener('click', function() {
                        toggleWishlist(listing.id, this);
                    });
                    
                    // Add image switcher
                    if (listing.images && listing.images.length > 1) {
                        document.querySelectorAll('[data-image-index]').forEach(img => {
                            img.addEventListener('click', function() {
                                const index = this.getAttribute('data-image-index');
                                const mainImage = document.querySelector('.product-modal-main-image');
                                if (mainImage) {
                                    mainImage.src = listing.images[index];
                                }
                                
                                // Update active thumbnail
                                document.querySelectorAll('[data-image-index]').forEach(thumb => {
                                    thumb.classList.remove('border-2', 'border-indigo-500');
                                });
                                this.classList.add('border-2', 'border-indigo-500');
                            });
                        });
                    }
                }, 100);
                
            } catch (error) {
                console.error('âŒ Error loading product details:', error);
                showNotification('Error loading product details', 'error');
            }
        }

        // Close product modal
        function closeProductModalFunc() {
            if (productModal) {
                productModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // Contact seller
        function contactSeller(listingId) {
            showNotification('Redirecting to chat...', 'info');
            // In a full implementation, this would redirect to chat.html with the seller
            setTimeout(() => {
                window.location.href = `chat.html?seller=${listingId}`;
            }, 1000);
        }

        // Add to cart
        function addToCart(listingId) {
            showNotification('Added to cart', 'success');
            // In a full implementation, this would add the item to the user's cart
        }

        // Initialize carousel
        function initCarousel() {
            const carouselInner = document.querySelector('.carousel-inner');
            const carouselItems = document.querySelectorAll('.carousel-item');
            const prevButton = document.querySelector('.carousel-control.prev');
            const nextButton = document.querySelector('.carousel-control.next');
            
            let currentIndex = 0;
            const totalItems = carouselItems.length;
            
            function updateCarousel() {
                carouselInner.style.transform = `translateX(-${currentIndex * 100}%)`;
            }
            
            if (prevButton) {
                prevButton.addEventListener('click', function() {
                    currentIndex = (currentIndex - 1 + totalItems) % totalItems;
                    updateCarousel();
                });
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', function() {
                    currentIndex = (currentIndex + 1) % totalItems;
                    updateCarousel();
                });
            }
            
            // Auto-advance carousel
            setInterval(function() {
                currentIndex = (currentIndex + 1) % totalItems;
                updateCarousel();
            }, 5000);
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // Set theme
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            if (theme === 'dark') {
                themeToggle.classList.add('active');
            } else {
                themeToggle.classList.remove('active');
            }
        }

        // Start flash sale timer
        function startFlashSaleTimer() {
            let timeLeft = 24 * 60 * 60; // 24 hours in seconds
            
            function updateTimer() {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                
                flashSaleTimer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft > 0) {
                    timeLeft--;
                } else {
                    // Reset timer when it reaches 0
                    timeLeft = 24 * 60 * 60;
                }
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // Generate tag suggestions based on title
        function generateTagSuggestions() {
            const title = listingTitle.value.toLowerCase();
            if (title.length < 3) {
                tagSuggestions.innerHTML = '';
                return;
            }
            
            // Common tags based on categories
            const tagMap = {
                electronics: ['tech', 'gadget', 'electronic', 'device', 'smartphone', 'laptop', 'tablet'],
                textbooks: ['book', 'textbook', 'academic', 'study', 'course', 'education'],
                furniture: ['furniture', 'home', 'decor', 'household', 'living', 'bedroom'],
                clothing: ['fashion', 'clothing', 'apparel', 'wear', 'style', 'outfit'],
                services: ['service', 'help', 'assistance', 'support', 'tutoring', 'consulting']
            };
            
            const category = document.getElementById('listingCategory').value;
            const categoryTags = tagMap[category] || [];
            
            // Extract words from title
            const words = title.split(/\s+/).filter(word => word.length > 2);
            
            // Combine and deduplicate
            const allTags = [...new Set([...words, ...categoryTags])].slice(0, 5);
            
            tagSuggestions.innerHTML = allTags.map(tag => 
                `<span class="suggestion-tag" data-tag="${tag}">${tag}</span>`
            ).join('');
            
            // Add click listeners to tag suggestions
            tagSuggestions.querySelectorAll('.suggestion-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const currentTags = listingTags.value ? listingTags.value.split(',').map(t => t.trim()) : [];
                    const newTag = this.getAttribute('data-tag');
                    
                    if (!currentTags.includes(newTag)) {
                        currentTags.push(newTag);
                        listingTags.value = currentTags.join(', ');
                    }
                });
            });
        }

        // Update user UI
        function updateUserUI(user) {
            if (userAvatar) {
                userAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=6366f1&color=fff&size=40`;
            }
            
            if (userName) {
                userName.textContent = user.displayName || 'User';
            }
            
            if (userStatus && userData) {
                userStatus.textContent = userData.status || 'Student';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'border-red-500' : type === 'warning' ? 'border-yellow-500' : type === 'success' ? 'border-green-500' : 'border-indigo-500'}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} 
                        ${type === 'error' ? 'text-red-500' : type === 'warning' ? 'text-yellow-500' : type === 'success' ? 'text-green-500' : 'text-indigo-500'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('notificationContainer').appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Hide and remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (createListingModal && createListingModal.classList.contains('active')) {
                if (e.target === createListingModal) {
                    closeCreateListingModal();
                }
            }
            
            if (productModal && productModal.classList.contains('active')) {
                if (e.target === productModal) {
                    closeProductModalFunc();
                }
            }
            
            if (searchSuggestions && !searchSuggestions.classList.contains('hidden')) {
                if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                    searchSuggestions.classList.add('hidden');
                }
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (createListingModal && createListingModal.classList.contains('active')) {
                    closeCreateListingModal();
                }
                
                if (productModal && productModal.classList.contains('active')) {
                    closeProductModalFunc();
                }
                
                if (searchSuggestions && !searchSuggestions.classList.contains('hidden')) {
                    searchSuggestions.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>