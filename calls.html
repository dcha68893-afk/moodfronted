<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call</title>
    <link rel="stylesheet" href="/css/calls.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Script loading order: api.js first, then dependencies -->
    <script src="/js/api.js" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    
    <link rel="stylesheet" href="calls.css">


    <style>
        /* Three dots menu styles */
        .menu-dots-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow);
        }
        
        .menu-dots-dropdown {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--bg-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 250px;
            z-index: 1001;
            display: none;
            overflow: hidden;
        }
        
        .menu-dots-dropdown.active {
            display: block;
        }
        
        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:hover {
            background-color: var(--secondary-color);
        }
        
        .menu-item i {
            width: 20px;
            color: var(--primary-color);
        }
        
        .menu-item .badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: auto;
        }

        /* Additional styles for features not fully covered in calls.css */
        .url-param-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1005;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .url-param-overlay.active {
            display: flex;
        }
        
        .url-param-modal {
            width: 90%;
            max-width: 400px;
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .url-param-title {
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .url-param-text {
            margin-bottom: 20px;
            color: var(--text-secondary);
        }
        
        .url-param-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .url-param-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .url-param-btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .url-param-btn.secondary {
            background-color: var(--secondary-color);
            color: var(--text-primary);
        }
        
        .notification-area {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 300px;
            z-index: 999;
            pointer-events: none;
        }
        
        .call-notification {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .call-notification-content {
            flex: 1;
        }
        
        .call-notification-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .call-notification-message {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .call-notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
        }
        
        .pulsing-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            animation: ringPulse 2s infinite;
        }
        
        @keyframes ringPulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        .whiteboard-tool-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tool-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
        }
        
        .tool-color.selected {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .tool-size {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .size-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--text-primary);
        }
        
        .relationship-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .badge-frequent {
            background-color: rgba(52, 199, 89, 0.2);
            color: var(--success-color);
        }
        
        .badge-regular {
            background-color: rgba(0, 132, 255, 0.2);
            color: var(--primary-color);
        }
        
        .badge-occasional {
            background-color: rgba(255, 149, 0, 0.2);
            color: var(--warning-color);
        }
        
        .notes-history-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .notes-history-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .notes-history-item:hover {
            background-color: var(--secondary-color);
        }
        
        .notes-history-date {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .premium-limit-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1006;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .premium-limit-overlay.active {
            display: flex;
        }
        
        .premium-limit-modal {
            width: 90%;
            max-width: 400px;
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .premium-limit-title {
            font-size: 22px;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .premium-limit-text {
            margin-bottom: 25px;
            color: var(--text-secondary);
        }
        
        .api-status-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 9999;
            display: none;
        }
        
        .api-status-indicator.connected {
            background-color: rgba(52, 199, 89, 0.7);
        }
        
        .api-status-indicator.disconnected {
            background-color: rgba(255, 59, 48, 0.7);
        }
        
        .api-status-indicator.connecting {
            background-color: rgba(255, 149, 0, 0.7);
            animation: pulse 2s infinite;
        }
        
        /* Floating reaction styles */
        .floating-reaction {
            position: absolute;
            font-size: 32px;
            pointer-events: none;
            z-index: 100;
            animation: floatUp 3s ease-in-out forwards;
        }
        
        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }
        }
        
        /* Poll styles */
        .poll-option-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poll-option-item:hover {
            background-color: var(--secondary-color);
        }
        
        .poll-option-item.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        .poll-option-text {
            flex: 1;
        }
        
        .poll-option-votes {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .poll-result-bar {
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .poll-result-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .poll-result-percentage {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Relationship insights styles */
        .insight-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .insight-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .insight-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .insight-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .insight-trend {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 10px;
        }
        
        .trend-up {
            background: rgba(52, 199, 89, 0.2);
            color: var(--success-color);
        }
        
        .trend-down {
            background: rgba(255, 59, 48, 0.2);
            color: var(--error-color);
        }
        
        .trend-neutral {
            background: rgba(142, 142, 147, 0.2);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Three Dots Menu Button -->
    <button class="menu-dots-btn" id="menuDotsBtn">
        <i class="fas fa-ellipsis-v"></i>
    </button>
    
    <!-- Three Dots Menu Dropdown -->
    <div class="menu-dots-dropdown" id="menuDotsDropdown">
        <div class="menu-item" id="menuParticipants">
            <i class="fas fa-users"></i>
            <span>Participants</span>
            <span class="badge" id="participantBadge">0</span>
        </div>
        <div class="menu-item" id="menuChat">
            <i class="fas fa-comment"></i>
            <span>Chat</span>
            <span class="badge" id="chatBadge">0</span>
        </div>
        <div class="menu-item" id="menuWhiteboard">
            <i class="fas fa-paint-brush"></i>
            <span>Whiteboard</span>
        </div>
        <div class="menu-item" id="menuNotes">
            <i class="fas fa-sticky-note"></i>
            <span>Notes</span>
        </div>
        <div class="menu-item" id="menuPolls">
            <i class="fas fa-poll"></i>
            <span>Polls</span>
        </div>
        <div class="menu-item" id="menuRelationship">
            <i class="fas fa-heart"></i>
            <span>Relationship</span>
        </div>
    </div>
    
    <!-- Offline Banner -->
    <div class="offline-banner" id="offlineBanner">
        <i class="fas fa-wifi-slash"></i>
        <span>You are currently offline. Calls may not work properly.</span>
    </div>
    
    <!-- API Status Indicator -->
    <div class="api-status-indicator" id="apiStatusIndicator">
        <span id="apiStatusText">Waiting for parent API...</span>
    </div>
    
    <!-- URL Parameter Call Overlay -->
    <div class="url-param-overlay" id="urlParamOverlay">
        <div class="url-param-modal">
            <h3 class="url-param-title">Join Call</h3>
            <p class="url-param-text" id="urlParamText">You've been invited to join a call. Would you like to join now?</p>
            <div class="url-param-buttons">
                <button class="url-param-btn secondary" id="urlParamCancelBtn">Cancel</button>
                <button class="url-param-btn primary" id="urlParamJoinBtn">Join Call</button>
            </div>
        </div>
    </div>
    
    <!-- Incoming Call Modal -->
    <div class="incoming-call-modal" id="incomingCallModal">
        <div class="incoming-call-container">
            <div class="pulsing-ring"></div>
            <div class="incoming-call-avatar" id="incomingCallAvatar">
                <!-- Avatar will be set dynamically -->
            </div>
            <h3 class="incoming-call-name" id="incomingCallName">Caller Name</h3>
            <p class="incoming-call-type" id="incomingCallType">Voice Call</p>
            <div class="incoming-call-actions">
                <button class="control-btn danger" id="declineCallBtn">
                    <i class="fas fa-phone-slash"></i>
                </button>
                <button class="control-btn" id="acceptCallBtn">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="control-btn" id="acceptVideoCallBtn">
                    <i class="fas fa-video"></i>
                </button>
            </div>
            <div class="mood-indicator mood-neutral" id="incomingCallMood" style="margin-top: 20px; display: none;">
                <i class="fas fa-smile"></i>
                <span>Neutral</span>
            </div>
            <div class="intention-indicator intention-checkin" id="incomingCallIntention" style="margin-top: 10px; display: none;">
                <i class="fas fa-heart"></i>
                <span>Check-in</span>
            </div>
            <div id="autoDeclineTimer" style="margin-top: 15px; color: var(--text-secondary); font-size: 14px;">
                Auto declining in <span id="declineTimer">45</span>s
            </div>
        </div>
    </div>
    
    <!-- New Call Modal -->
    <div class="new-call-modal" id="newCallModal">
        <div class="new-call-container">
            <div class="new-call-header">
                <h3>New Call</h3>
                <button id="closeNewCallModal" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="new-call-tabs">
                <button class="new-call-tab active" data-tab="contacts">Contacts</button>
                <button class="new-call-tab" data-tab="groups">Groups</button>
                <button class="new-call-tab" data-tab="link">Call Link</button>
            </div>
            <div class="new-call-content">
                <!-- Contacts Tab -->
                <div class="new-call-tab-content active" id="contactsTab">
                    <div class="contact-search">
                        <input type="text" class="search-input" id="contactSearch" placeholder="Search contacts...">
                    </div>
                    <div class="contacts-list" id="contactsList">
                        <!-- Contacts will be loaded dynamically -->
                        <div class="offline-contacts-message" id="offlineContactsMessage" style="display: none;">
                            <i class="fas fa-users-slash"></i>
                            <p>Contacts unavailable offline</p>
                            <p class="subtext">Connect to the internet to load contacts</p>
                        </div>
                        <div class="loading-placeholder" id="contactsLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading contacts...</p>
                        </div>
                    </div>
                    <div class="quick-actions" style="margin-top: 20px; padding: 0;">
                        <button class="quick-action-btn" id="startVoiceCallBtn">
                            <i class="fas fa-phone quick-action-icon"></i>
                            <span class="quick-action-text">Voice Call</span>
                        </button>
                        <button class="quick-action-btn" id="startVideoCallBtn">
                            <i class="fas fa-video quick-action-icon"></i>
                            <span class="quick-action-text">Video Call</span>
                        </button>
                    </div>
                </div>
                
                <!-- Groups Tab -->
                <div class="new-call-tab-content" id="groupsTab">
                    <div class="group-call-options">
                        <div class="option-item" id="instantGroupOption">
                            <div class="option-title">
                                <i class="fas fa-bolt"></i>
                                Instant Group Call
                            </div>
                            <p class="option-desc">Start a group call immediately with selected contacts</p>
                        </div>
                        <div class="option-item" id="scheduledGroupOption">
                            <div class="option-title">
                                <i class="fas fa-calendar-alt"></i>
                                Schedule Group Call
                            </div>
                            <p class="option-desc">Plan a group call for a later time</p>
                        </div>
                    </div>
                    <div class="contact-search" style="margin-top: 20px;">
                        <input type="text" class="search-input" id="groupContactSearch" placeholder="Search contacts for group call...">
                    </div>
                    <div class="contacts-list" id="groupContactsList" style="max-height: 200px;">
                        <!-- Group contacts will be loaded dynamically -->
                    </div>
                    <div class="quick-actions" style="margin-top: 20px; padding: 0;">
                        <button class="quick-action-btn" id="startGroupCallBtn" disabled>
                            <i class="fas fa-users quick-action-icon"></i>
                            <span class="quick-action-text">Start Group Call</span>
                        </button>
                    </div>
                </div>
                
                <!-- Call Link Tab -->
                <div class="new-call-tab-content" id="linkTab">
                    <div class="link-tab-content">
                        <div class="link-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <h3>Create a Call Link</h3>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">Generate a shareable link that anyone can use to join your call</p>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" class="search-input" id="callLinkInput" readonly placeholder="Call link will appear here...">
                            <button class="quick-action-btn" id="copyLinkBtn" style="width: 50px; padding: 10px;">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="quick-action-btn" id="shareLinkBtn" style="width: 50px; padding: 10px;">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                        <div class="quick-actions" style="padding: 0;">
                            <button class="quick-action-btn" id="generateVoiceLinkBtn">
                                <i class="fas fa-phone quick-action-icon"></i>
                                <span class="quick-action-text">Voice Link</span>
                            </button>
                            <button class="quick-action-btn" id="generateVideoLinkBtn">
                                <i class="fas fa-video quick-action-icon"></i>
                                <span class="quick-action-text">Video Link</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div class="payment-modal" id="paymentModal">
        <div class="payment-container">
            <div class="payment-header">
                <h3>Upgrade to Premium</h3>
                <p>Get unlimited calls, advanced features, and more</p>
            </div>
            <div class="payment-amount">$9.99/month</div>
            <div class="payment-option selected" id="mpesaOption">
                <div class="payment-icon">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <div class="payment-details">
                    <h4>M-Pesa</h4>
                    <p>Pay via mobile money (Kenya)</p>
                </div>
            </div>
            <div class="payment-form" id="mpesaForm">
                <div class="form-group">
                    <label class="form-label" for="phoneNumber">Phone Number</label>
                    <input type="tel" class="form-input" id="phoneNumber" placeholder="07XX XXX XXX">
                </div>
                <div class="form-group">
                    <label class="form-label" for="paymentAmount">Amount (KES)</label>
                    <input type="number" class="form-input" id="paymentAmount" value="1000" min="100" step="100">
                </div>
            </div>
            <div class="payment-buttons">
                <button class="payment-btn secondary" id="cancelPaymentBtn">Cancel</button>
                <button class="payment-btn primary" id="processPaymentBtn">Pay Now</button>
            </div>
        </div>
    </div>
    
    <!-- Premium Limit Overlay -->
    <div class="premium-limit-overlay" id="premiumLimitOverlay">
        <div class="premium-limit-modal">
            <h3 class="premium-limit-title">Premium Feature</h3>
            <p class="premium-limit-text" id="premiumLimitText">You've reached the free limit for this feature. Upgrade to premium to continue.</p>
            <div class="payment-buttons">
                <button class="payment-btn secondary" id="cancelUpgradeBtn">Not Now</button>
                <button class="payment-btn primary" id="upgradeNowBtn">Upgrade Now</button>
            </div>
        </div>
    </div>
    
    <!-- Mood Selection Modal -->
    <div class="mood-selection-modal" id="moodSelectionModal">
        <div class="mood-selection-container">
            <h3 class="mood-selection-title">How are you feeling?</h3>
            <div class="mood-options">
                <div class="mood-option" data-mood="happy">
                    <div class="mood-emoji">üòä</div>
                    <div class="mood-name">Happy</div>
                </div>
                <div class="mood-option" data-mood="neutral">
                    <div class="mood-emoji">üòê</div>
                    <div class="mood-name">Neutral</div>
                </div>
                <div class="mood-option" data-mood="sad">
                    <div class="mood-emoji">üòî</div>
                    <div class="mood-name">Sad</div>
                </div>
                <div class="mood-option" data-mood="angry">
                    <div class="mood-emoji">üò†</div>
                    <div class="mood-name">Angry</div>
                </div>
                <div class="mood-option" data-mood="tired">
                    <div class="mood-emoji">üò¥</div>
                    <div class="mood-name">Tired</div>
                </div>
                <div class="mood-option" data-mood="excited">
                    <div class="mood-emoji">ü§©</div>
                    <div class="mood-name">Excited</div>
                </div>
            </div>
            <div class="payment-buttons">
                <button class="payment-btn secondary" id="cancelMoodBtn">Cancel</button>
                <button class="payment-btn primary" id="setMoodBtn">Set Mood</button>
            </div>
        </div>
    </div>
    
    <!-- Intention Selection Modal -->
    <div class="intention-selection-modal" id="intentionSelectionModal">
        <div class="intention-selection-container">
            <h3 class="intention-selection-title">What's the purpose of this call?</h3>
            <div class="intention-options">
                <div class="intention-option" data-intention="quick">
                    <div class="intention-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="intention-text">
                        <div class="intention-title">Quick Chat</div>
                        <div class="intention-desc">Just checking in or a brief update</div>
                    </div>
                </div>
                <div class="intention-option" data-intention="important">
                    <div class="intention-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="intention-text">
                        <div class="intention-title">Important Discussion</div>
                        <div class="intention-desc">Needs focus and attention</div>
                    </div>
                </div>
                <div class="intention-option" data-intention="emergency">
                    <div class="intention-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="intention-text">
                        <div class="intention-title">Emergency</div>
                        <div class="intention-desc">Urgent matter requiring immediate attention</div>
                    </div>
                </div>
                <div class="intention-option" data-intention="checkin">
                    <div class="intention-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="intention-text">
                        <div class="intention-title">Check-in</div>
                        <div class="intention-desc">Just seeing how you're doing</div>
                    </div>
                </div>
                <div class="intention-option" data-intention="work">
                    <div class="intention-icon">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="intention-text">
                        <div class="intention-title">Work/Business</div>
                        <div class="intention-desc">Professional or work-related discussion</div>
                    </div>
                </div>
            </div>
            <div class="payment-buttons">
                <button class="payment-btn secondary" id="cancelIntentionBtn">Cancel</button>
                <button class="payment-btn primary" id="setIntentionBtn">Set Intention</button>
            </div>
        </div>
    </div>
    
    <!-- Private Notes Modal -->
    <div class="private-notes-modal" id="privateNotesModal">
        <div class="private-notes-container">
            <div class="private-notes-header">
                <h3 id="privateNotesTitle">Private Notes</h3>
                <p id="privateNotesSubtitle">Add private notes about this call (only visible to you)</p>
            </div>
            <textarea class="private-notes-textarea" id="privateNotesTextarea" placeholder="Enter your notes here..."></textarea>
            <div class="private-notes-buttons">
                <button class="payment-btn secondary" id="skipNotesBtn">Skip</button>
                <button class="payment-btn primary" id="saveNotesBtn">Save Notes</button>
            </div>
        </div>
    </div>
    
    <!-- Call Summary Modal -->
    <div class="call-summary-modal" id="callSummaryModal">
        <div class="call-summary-container">
            <div class="call-summary-header">
                <h3>Call Summary</h3>
                <p>Review details of your completed call</p>
            </div>
            <div class="call-summary-content">
                <div class="summary-item">
                    <span class="summary-label">Duration:</span>
                    <span class="summary-value" id="summaryDuration">--:--</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Time:</span>
                    <span class="summary-value" id="summaryTime">--:-- --</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Type:</span>
                    <span class="summary-value" id="summaryType">Voice Call</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Mood:</span>
                    <span class="summary-value" id="summaryMood">Neutral</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Intention:</span>
                    <span class="summary-value" id="summaryIntention">Quick Chat</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Participants:</span>
                    <span class="summary-value" id="summaryParticipants">2</span>
                </div>
                <div class="payment-buttons" style="margin-top: 25px;">
                    <button class="payment-btn primary" id="summaryDoneBtn">Done</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Calls</h2>
                <button class="new-call-btn" id="newCallBtn" title="New Call">
                    <i class="fas fa-phone-plus"></i>
                </button>
            </div>
            
            <div class="call-categories">
                <button class="category-btn active" data-category="all">All</button>
                <button class="category-btn" data-category="missed">Missed</button>
                <button class="category-btn" data-category="group">Group</button>
            </div>
            
            <div class="call-list">
                <div class="call-list-content">
                    <div class="quick-actions">
                        <button class="quick-action-btn" id="quickVoiceBtn">
                            <i class="fas fa-phone quick-action-icon"></i>
                            <span class="quick-action-text">Voice Call</span>
                        </button>
                        <button class="quick-action-btn" id="quickVideoBtn">
                            <i class="fas fa-video quick-action-icon"></i>
                            <span class="quick-action-text">Video Call</span>
                        </button>
                        <button class="quick-action-btn premium-feature" id="quickGroupBtn">
                            <span class="premium-badge-small">PRO</span>
                            <i class="fas fa-users quick-action-icon"></i>
                            <span class="quick-action-text">Group Call</span>
                        </button>
                    </div>
                    
                    <div class="call-settings">
                        <div class="settings-toggle" id="settingsToggle">
                            <div class="settings-toggle-title">
                                <i class="fas fa-cog settings-toggle-icon"></i>
                                <span>Call Settings</span>
                            </div>
                            <i class="fas fa-chevron-down" id="settingsToggleIcon"></i>
                        </div>
                        <div class="settings-panel" id="settingsPanel">
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <i class="fas fa-laugh settings-item-icon"></i>
                                    <span>Emotional Context</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emotionalContextToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <i class="fas fa-bullseye settings-item-icon"></i>
                                    <span>Call Intention</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="callIntentionToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <i class="fas fa-comment-dots settings-item-icon"></i>
                                    <span>In-Call Chat</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="inCallChatToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <i class="fas fa-paint-brush settings-item-icon"></i>
                                    <span>Shared Whiteboard</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="whiteboardToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <i class="fas fa-poll settings-item-icon"></i>
                                    <span>Polls</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="pollsToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <i class="fas fa-sticky-note settings-item-icon"></i>
                                    <span>Shared Notes</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="notesToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <i class="fas fa-eye settings-item-icon"></i>
                                    <span>Focus Mode</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="focusModeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-label">
                                    <i class="fas fa-sync settings-item-icon"></i>
                                    <span>Live Reactions</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="liveReactionsToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="payment-buttons" style="margin-top: 15px;">
                                <button class="payment-btn secondary" id="resetSettingsBtn">Reset Settings</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recent-calls">
                        <div class="section-title">
                            <span>Recent Calls</span>
                            <span class="sync-indicator" id="syncIndicator">
                                <i class="fas fa-sync"></i>
                                <span>Waiting for API...</span>
                            </span>
                        </div>
                        
                        <div class="calls-section active" id="allCallsSection">
                            <div class="calls-list" id="allCallsList">
                                <!-- All calls will be loaded here -->
                                <div class="offline-state" id="offlineCallsState" style="display: none;">
                                    <i class="fas fa-cloud-slash"></i>
                                    <p>Cannot load calls while offline</p>
                                    <p class="subtext">Connect to the internet to sync your call history</p>
                                </div>
                                <div class="loading-placeholder" id="callsLoading">
                                    <div class="loading-spinner"></div>
                                    <p>Waiting for API to load calls...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="calls-section" id="missedCallsSection">
                            <div class="calls-list" id="missedCallsList">
                                <!-- Missed calls will be loaded here -->
                                <div class="offline-state" style="display: flex;">
                                    <i class="fas fa-phone-slash"></i>
                                    <p>No missed calls</p>
                                    <p class="subtext">All calls have been answered</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="calls-section" id="groupCallsSection">
                            <div class="calls-list" id="groupCallsList">
                                <!-- Group calls will be loaded here -->
                                <div class="offline-state" style="display: flex;">
                                    <i class="fas fa-users-slash"></i>
                                    <p>No group calls yet</p>
                                    <p class="subtext">Start your first group call to see it here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Call Container -->
        <div class="call-container" id="callContainer">
            <!-- Focus Mode Button -->
            <button class="focus-mode-btn control-btn" id="focusModeBtn" title="Focus Mode" style="display: none;">
                <i class="fas fa-eye"></i>
            </button>
            
            <!-- Call Header -->
            <div class="call-header" id="callHeader">
                <div class="call-info-bar">
                    <div class="call-type-icon" id="callTypeIcon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="call-info-text">
                        <h4 id="callWithName">Connecting...</h4>
                        <p id="callStatusText">Waiting for API...</p>
                        <div id="callMoodIndicator" style="display: none;"></div>
                        <div id="callIntentionIndicator" style="display: none;"></div>
                    </div>
                </div>
                <div class="call-duration" id="callDuration">00:00</div>
            </div>
            
            <!-- Video Grid -->
            <div class="video-grid" id="videoGrid">
                <!-- Video containers will be added dynamically -->
                <div class="offline-call-placeholder" id="offlineCallPlaceholder" style="display: none;">
                    <i class="fas fa-wifi-slash"></i>
                    <h3>Call Unavailable Offline</h3>
                    <p>You need an internet connection to make or receive calls. Please check your connection and try again.</p>
                </div>
            </div>
            
            <!-- Reactions Container -->
            <div class="reactions-container" id="reactionsContainer">
                <div class="reaction-btn" data-reaction="üëç">
                    üëç
                </div>
                <div class="reaction-btn" data-reaction="üëè">
                    üëè
                </div>
                <div class="reaction-btn" data-reaction="üòÇ">
                    üòÇ
                </div>
                <div class="reaction-btn" data-reaction="‚ù§Ô∏è">
                    ‚ù§Ô∏è
                </div>
                <div class="reaction-btn" data-reaction="üî•">
                    üî•
                </div>
            </div>
            
            <!-- Call Controls -->
            <div class="call-controls" id="callControls">
                <button class="control-btn" id="muteBtn" title="Mute">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="control-btn" id="videoBtn" title="Turn Video Off">
                    <i class="fas fa-video"></i>
                </button>
                <button class="control-btn premium-feature" id="screenShareBtn" title="Share Screen">
                    <span class="premium-badge-small">PRO</span>
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="control-btn" id="speakerBtn" title="Speaker">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button class="control-btn" id="moodBtn" title="Set Mood">
                    <i class="fas fa-smile"></i>
                </button>
                <button class="control-btn" id="intentionBtn" title="Set Intention">
                    <i class="fas fa-bullseye"></i>
                </button>
                <button class="control-btn danger" id="endCallBtn" title="End Call">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
            
            <!-- Picture in Picture -->
            <div class="pip-container" id="pipContainer">
                <video class="pip-video" id="pipVideo" autoplay playsinline></video>
                <div class="pip-controls">
                    <button class="video-action-btn" id="pipCloseBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Area -->
    <div class="notification-area" id="notificationArea"></div>
    
    <!-- Notification Toast -->
    <div class="notification" id="notificationToast">
        <i class="fas fa-check-circle"></i>
        <span id="notificationMessage">Success!</span>
    </div>
    
    <script>
        // Global state object
        const AppState = {
            // Authentication state
            isAuthenticated: false,
            authChecked: false,
            user: null,
            
            // API state
            apiReady: false,
            apiCheckInterval: null,
            
            // User state
            currentUser: null,
            userPermissions: {},
            callPermissions: {},
            
            // Call state
            isInCall: false,
            currentCall: null,
            activeCallId: null,
            callType: null,
            callParticipants: [],
            callStartTime: null,
            callDurationInterval: null,
            
            // Media state
            localStream: null,
            remoteStreams: new Map(),
            screenStream: null,
            isMuted: false,
            isVideoOff: false,
            isScreenSharing: false,
            isSpeakerOn: true,
            
            // PeerJS state
            peer: null,
            connections: new Map(),
            
            // UI state
            currentMood: 'neutral',
            currentIntention: 'quick',
            currentFocusMode: false,
            currentPanel: 'participants',
            currentCategory: 'all',
            
            // Data state
            contacts: [],
            callHistory: [],
            cachedData: {
                contacts: [],
                calls: [],
                notes: {},
                relationshipData: {}
            },
            
            // Settings state
            settings: {
                emotionalContext: true,
                callIntention: true,
                inCallChat: true,
                whiteboard: true,
                polls: true,
                notes: true,
                focusMode: false,
                liveReactions: true,
                theme: 'light'
            },
            
            // Offline state
            isOnline: navigator.onLine,
            syncPending: false,
            
            // Premium state
            isPremium: false,
            trialDaysLeft: 30,
            premiumFeatures: {
                groupCalls: false,
                screenSharing: false,
                whiteboard: false,
                polls: false,
                relationshipInsights: false,
                callLinks: false
            },
            
            // Chat state
            chatMessages: [],
            unreadChatCount: 0,
            
            // Poll state
            activePoll: null,
            userVotes: {},
            
            // Relationship data
            relationshipInsights: {}
        };
        
        // DOM Elements
        const elements = {};
        
        // ==================== BOOTSTRAP FUNCTION ====================
        async function bootstrapIframe() {
            console.log('Bootstrapping calls iframe...');
            
            // Show connecting status
            elements.apiStatusIndicator.style.display = 'block';
            elements.apiStatusIndicator.className = 'api-status-indicator connecting';
            elements.apiStatusText.textContent = 'Authenticating...';
            
            try {
                // Wait for API to be ready (from parent api.js)
                if (typeof window.waitForAuthReady === 'function') {
                    console.log('Waiting for auth to be ready via parent API...');
                    await window.waitForAuthReady();
                } else {
                    // Fallback: check token directly
                    console.log('Parent API not available, checking token directly...');
                    await checkAuthToken();
                }
                
                console.log('Auth ready, proceeding with initialization...');
                
                // Now initialize the app
                initializeApp();
                
            } catch (error) {
                console.error('Bootstrap error:', error);
                showApiError('Authentication failed: ' + error.message);
                handleAuthError();
            }
        }
        
        async function checkAuthToken() {
            // Check for token with retry logic
            let attempts = 0;
            const maxAttempts = 10;
            
            while (attempts < maxAttempts) {
                const token = localStorage.getItem('accessToken') || 
                              localStorage.getItem('moodchat_token') || 
                              localStorage.getItem('token');
                
                if (token) {
                    console.log('Token found on attempt', attempts + 1);
                    return token;
                }
                
                console.log('Token not found, waiting... attempt', attempts + 1);
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
            }
            
            throw new Error('No authentication token found after multiple attempts');
        }
        
        function redirectToLogin() {
            console.log('Redirecting to login...');
            const currentPath = window.location.pathname;
            window.location.href = `/index.html?redirect=${encodeURIComponent(currentPath)}`;
        }
        
        function handleAuthError() {
            console.error('Authentication error detected');
            
            // Clear all auth-related storage
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('moodchat_token');
            localStorage.removeItem('token');
            
            // Show error status
            elements.apiStatusIndicator.className = 'api-status-indicator disconnected';
            elements.apiStatusText.textContent = 'Authentication failed';
            
            // Redirect after delay
            setTimeout(() => {
                redirectToLogin();
            }, 2000);
        }
        
        function showApiError(message) {
            elements.apiStatusIndicator.className = 'api-status-indicator disconnected';
            elements.apiStatusText.textContent = message;
            
            // Show error in UI
            showNotification(message, 'error');
        }
        
        // ==================== API WRAPPER ====================
        const ApiClient = {
            async request(endpoint, options = {}) {
                // Get token
                const token = localStorage.getItem('accessToken') || 
                              localStorage.getItem('moodchat_token') || 
                              localStorage.getItem('token');
                
                if (!token) {
                    handleAuthError();
                    throw new Error('No authentication token available');
                }
                
                // Prepare headers
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                // Make request
                const response = await fetch(`/api${endpoint}`, {
                    ...options,
                    headers
                });
                
                // Handle auth errors
                if (response.status === 401 || response.status === 403) {
                    console.log('Auth error detected in API call, redirecting...');
                    handleAuthError();
                    throw new Error('Authentication required');
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response;
            },
            
            async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            },
            
            async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            },
            
            async put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            },
            
            async delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            },
            
            // Specific API methods
            async getUserInfo() {
                const response = await this.get('/user/info');
                return response.json();
            },
            
            async getCallPermissions() {
                const response = await this.get('/calls/permissions');
                return response.json();
            },
            
            async getContacts() {
                const response = await this.get('/contacts');
                return response.json();
            },
            
            async getCallHistory() {
                const response = await this.get('/calls/history');
                return response.json();
            },
            
            async getPremiumStatus() {
                const response = await this.get('/user/premium');
                return response.json();
            },
            
            async startCall(callData) {
                const response = await this.post('/calls/start', callData);
                return response.json();
            },
            
            async endCall(callData) {
                const response = await this.post('/calls/end', callData);
                return response.json();
            },
            
            async sendPeerId(peerData) {
                const response = await this.post('/calls/peer', peerData);
                return response.json();
            }
        };
        
        // Initialize function - wrapped in bootstrap
        function initializeApp() {
            console.log('Initializing call app...');
            
            // Cache all DOM elements
            cacheElements();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize offline detection
            initializeOfflineDetection();
            
            // Initialize UI state
            initializeUI();
            
            // Check URL parameters for call links
            checkUrlParameters();
            
            // Load initial data asynchronously
            setTimeout(() => {
                loadInitialData();
            }, 100);
            
            console.log('Call app initialization complete');
        }
        
        function cacheElements() {
            // Three dots menu elements
            elements.menuDotsBtn = document.getElementById('menuDotsBtn');
            elements.menuDotsDropdown = document.getElementById('menuDotsDropdown');
            elements.menuParticipants = document.getElementById('menuParticipants');
            elements.menuChat = document.getElementById('menuChat');
            elements.menuWhiteboard = document.getElementById('menuWhiteboard');
            elements.menuNotes = document.getElementById('menuNotes');
            elements.menuPolls = document.getElementById('menuPolls');
            elements.menuRelationship = document.getElementById('menuRelationship');
            elements.participantBadge = document.getElementById('participantBadge');
            elements.chatBadge = document.getElementById('chatBadge');
            
            // Offline elements
            elements.offlineBanner = document.getElementById('offlineBanner');
            elements.apiStatusIndicator = document.getElementById('apiStatusIndicator');
            elements.apiStatusText = document.getElementById('apiStatusText');
            
            // Modal elements
            elements.urlParamOverlay = document.getElementById('urlParamOverlay');
            elements.urlParamText = document.getElementById('urlParamText');
            elements.urlParamCancelBtn = document.getElementById('urlParamCancelBtn');
            elements.urlParamJoinBtn = document.getElementById('urlParamJoinBtn');
            
            elements.incomingCallModal = document.getElementById('incomingCallModal');
            elements.incomingCallAvatar = document.getElementById('incomingCallAvatar');
            elements.incomingCallName = document.getElementById('incomingCallName');
            elements.incomingCallType = document.getElementById('incomingCallType');
            elements.incomingCallMood = document.getElementById('incomingCallMood');
            elements.incomingCallIntention = document.getElementById('incomingCallIntention');
            elements.declineCallBtn = document.getElementById('declineCallBtn');
            elements.acceptCallBtn = document.getElementById('acceptCallBtn');
            elements.acceptVideoCallBtn = document.getElementById('acceptVideoCallBtn');
            elements.autoDeclineTimer = document.getElementById('autoDeclineTimer');
            elements.declineTimer = document.getElementById('declineTimer');
            
            elements.newCallModal = document.getElementById('newCallModal');
            elements.newCallBtn = document.getElementById('newCallBtn');
            elements.closeNewCallModal = document.getElementById('closeNewCallModal');
            
            // New call modal tabs
            elements.contactSearch = document.getElementById('contactSearch');
            elements.contactsList = document.getElementById('contactsList');
            elements.offlineContactsMessage = document.getElementById('offlineContactsMessage');
            elements.contactsLoading = document.getElementById('contactsLoading');
            elements.startVoiceCallBtn = document.getElementById('startVoiceCallBtn');
            elements.startVideoCallBtn = document.getElementById('startVideoCallBtn');
            
            elements.groupContactSearch = document.getElementById('groupContactSearch');
            elements.groupContactsList = document.getElementById('groupContactsList');
            elements.instantGroupOption = document.getElementById('instantGroupOption');
            elements.scheduledGroupOption = document.getElementById('scheduledGroupOption');
            elements.startGroupCallBtn = document.getElementById('startGroupCallBtn');
            
            elements.callLinkInput = document.getElementById('callLinkInput');
            elements.copyLinkBtn = document.getElementById('copyLinkBtn');
            elements.shareLinkBtn = document.getElementById('shareLinkBtn');
            elements.generateVoiceLinkBtn = document.getElementById('generateVoiceLinkBtn');
            elements.generateVideoLinkBtn = document.getElementById('generateVideoLinkBtn');
            
            // Payment elements
            elements.paymentModal = document.getElementById('paymentModal');
            elements.mpesaOption = document.getElementById('mpesaOption');
            elements.mpesaForm = document.getElementById('mpesaForm');
            elements.phoneNumber = document.getElementById('phoneNumber');
            elements.paymentAmount = document.getElementById('paymentAmount');
            elements.cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
            elements.processPaymentBtn = document.getElementById('processPaymentBtn');
            
            elements.premiumLimitOverlay = document.getElementById('premiumLimitOverlay');
            elements.premiumLimitText = document.getElementById('premiumLimitText');
            elements.cancelUpgradeBtn = document.getElementById('cancelUpgradeBtn');
            elements.upgradeNowBtn = document.getElementById('upgradeNowBtn');
            
            // Mood and intention elements
            elements.moodSelectionModal = document.getElementById('moodSelectionModal');
            elements.cancelMoodBtn = document.getElementById('cancelMoodBtn');
            elements.setMoodBtn = document.getElementById('setMoodBtn');
            
            elements.intentionSelectionModal = document.getElementById('intentionSelectionModal');
            elements.cancelIntentionBtn = document.getElementById('cancelIntentionBtn');
            elements.setIntentionBtn = document.getElementById('setIntentionBtn');
            
            // Notes and summary elements
            elements.privateNotesModal = document.getElementById('privateNotesModal');
            elements.privateNotesTitle = document.getElementById('privateNotesTitle');
            elements.privateNotesSubtitle = document.getElementById('privateNotesSubtitle');
            elements.privateNotesTextarea = document.getElementById('privateNotesTextarea');
            elements.skipNotesBtn = document.getElementById('skipNotesBtn');
            elements.saveNotesBtn = document.getElementById('saveNotesBtn');
            
            elements.callSummaryModal = document.getElementById('callSummaryModal');
            elements.summaryDuration = document.getElementById('summaryDuration');
            elements.summaryTime = document.getElementById('summaryTime');
            elements.summaryType = document.getElementById('summaryType');
            elements.summaryMood = document.getElementById('summaryMood');
            elements.summaryIntention = document.getElementById('summaryIntention');
            elements.summaryParticipants = document.getElementById('summaryParticipants');
            elements.summaryDoneBtn = document.getElementById('summaryDoneBtn');
            
            // Sidebar elements
            elements.appContainer = document.getElementById('appContainer');
            elements.sidebar = document.getElementById('sidebar');
            elements.quickVoiceBtn = document.getElementById('quickVoiceBtn');
            elements.quickVideoBtn = document.getElementById('quickVideoBtn');
            elements.quickGroupBtn = document.getElementById('quickGroupBtn');
            
            // Settings elements
            elements.settingsToggle = document.getElementById('settingsToggle');
            elements.settingsToggleIcon = document.getElementById('settingsToggleIcon');
            elements.settingsPanel = document.getElementById('settingsPanel');
            elements.emotionalContextToggle = document.getElementById('emotionalContextToggle');
            elements.callIntentionToggle = document.getElementById('callIntentionToggle');
            elements.inCallChatToggle = document.getElementById('inCallChatToggle');
            elements.whiteboardToggle = document.getElementById('whiteboardToggle');
            elements.pollsToggle = document.getElementById('pollsToggle');
            elements.notesToggle = document.getElementById('notesToggle');
            elements.focusModeToggle = document.getElementById('focusModeToggle');
            elements.liveReactionsToggle = document.getElementById('liveReactionsToggle');
            elements.resetSettingsBtn = document.getElementById('resetSettingsBtn');
            
            // Call history elements
            elements.syncIndicator = document.getElementById('syncIndicator');
            elements.allCallsSection = document.getElementById('allCallsSection');
            elements.missedCallsSection = document.getElementById('missedCallsSection');
            elements.groupCallsSection = document.getElementById('groupCallsSection');
            elements.allCallsList = document.getElementById('allCallsList');
            elements.missedCallsList = document.getElementById('missedCallsList');
            elements.groupCallsList = document.getElementById('groupCallsList');
            elements.offlineCallsState = document.getElementById('offlineCallsState');
            elements.callsLoading = document.getElementById('callsLoading');
            
            // Call container elements
            elements.callContainer = document.getElementById('callContainer');
            elements.focusModeBtn = document.getElementById('focusModeBtn');
            elements.callHeader = document.getElementById('callHeader');
            elements.callTypeIcon = document.getElementById('callTypeIcon');
            elements.callWithName = document.getElementById('callWithName');
            elements.callStatusText = document.getElementById('callStatusText');
            elements.callMoodIndicator = document.getElementById('callMoodIndicator');
            elements.callIntentionIndicator = document.getElementById('callIntentionIndicator');
            elements.callDuration = document.getElementById('callDuration');
            
            elements.videoGrid = document.getElementById('videoGrid');
            elements.offlineCallPlaceholder = document.getElementById('offlineCallPlaceholder');
            
            elements.reactionsContainer = document.getElementById('reactionsContainer');
            
            elements.callControls = document.getElementById('callControls');
            elements.muteBtn = document.getElementById('muteBtn');
            elements.videoBtn = document.getElementById('videoBtn');
            elements.screenShareBtn = document.getElementById('screenShareBtn');
            elements.speakerBtn = document.getElementById('speakerBtn');
            elements.moodBtn = document.getElementById('moodBtn');
            elements.intentionBtn = document.getElementById('intentionBtn');
            elements.endCallBtn = document.getElementById('endCallBtn');
            
            elements.pipContainer = document.getElementById('pipContainer');
            elements.pipVideo = document.getElementById('pipVideo');
            elements.pipCloseBtn = document.getElementById('pipCloseBtn');
            
            // Notification elements
            elements.notificationArea = document.getElementById('notificationArea');
            elements.notificationToast = document.getElementById('notificationToast');
            elements.notificationMessage = document.getElementById('notificationMessage');
        }
        
        function setupEventListeners() {
            // Three dots menu events
            elements.menuDotsBtn.addEventListener('click', toggleMenuDots);
            
            // Menu item events
            elements.menuParticipants.addEventListener('click', () => {
                closeMenuDots();
                showNotification('Participants feature accessed from menu', 'info');
            });
            
            elements.menuChat.addEventListener('click', () => {
                closeMenuDots();
                showNotification('Chat feature accessed from menu', 'info');
            });
            
            elements.menuWhiteboard.addEventListener('click', () => {
                closeMenuDots();
                if (checkPremiumFeature('whiteboard')) {
                    showNotification('Whiteboard feature accessed from menu', 'info');
                }
            });
            
            elements.menuNotes.addEventListener('click', () => {
                closeMenuDots();
                showNotification('Notes feature accessed from menu', 'info');
            });
            
            elements.menuPolls.addEventListener('click', () => {
                closeMenuDots();
                if (checkPremiumFeature('polls')) {
                    showNotification('Polls feature accessed from menu', 'info');
                }
            });
            
            elements.menuRelationship.addEventListener('click', () => {
                closeMenuDots();
                if (checkPremiumFeature('relationshipInsights')) {
                    showNotification('Relationship insights accessed from menu', 'info');
                }
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!elements.menuDotsBtn.contains(e.target) && !elements.menuDotsDropdown.contains(e.target)) {
                    closeMenuDots();
                }
            });
            
            // Window events
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            window.addEventListener('storage', handleStorageEvent);
            
            // Incoming call events
            elements.declineCallBtn.addEventListener('click', declineIncomingCall);
            elements.acceptCallBtn.addEventListener('click', acceptIncomingCall);
            elements.acceptVideoCallBtn.addEventListener('click', acceptIncomingCallAsVideo);
            
            // New call modal events
            elements.newCallBtn.addEventListener('click', openNewCallModal);
            elements.closeNewCallModal.addEventListener('click', closeNewCallModal);
            
            // Contact search events
            elements.contactSearch.addEventListener('input', debounce(searchContacts, 300));
            elements.groupContactSearch.addEventListener('input', debounce(searchGroupContacts, 300));
            
            // Call type buttons
            elements.startVoiceCallBtn.addEventListener('click', startVoiceCall);
            elements.startVideoCallBtn.addEventListener('click', startVideoCall);
            elements.startGroupCallBtn.addEventListener('click', startGroupCall);
            
            // Group call options
            elements.instantGroupOption.addEventListener('click', selectGroupOption);
            elements.scheduledGroupOption.addEventListener('click', selectGroupOption);
            
            // Call link events
            elements.copyLinkBtn.addEventListener('click', copyCallLink);
            elements.shareLinkBtn.addEventListener('click', shareCallLink);
            elements.generateVoiceLinkBtn.addEventListener('click', generateVoiceCallLink);
            elements.generateVideoLinkBtn.addEventListener('click', generateVideoCallLink);
            
            // Payment events
            elements.mpesaOption.addEventListener('click', selectPaymentOption);
            elements.cancelPaymentBtn.addEventListener('click', closePaymentModal);
            elements.processPaymentBtn.addEventListener('click', processPayment);
            elements.cancelUpgradeBtn.addEventListener('click', closePremiumLimitModal);
            elements.upgradeNowBtn.addEventListener('click', openPaymentModal);
            
            // Mood and intention events
            elements.cancelMoodBtn.addEventListener('click', closeMoodSelectionModal);
            elements.setMoodBtn.addEventListener('click', setMood);
            elements.cancelIntentionBtn.addEventListener('click', closeIntentionSelectionModal);
            elements.setIntentionBtn.addEventListener('click', setIntention);
            
            // Mood option click events
            document.querySelectorAll('.mood-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // Intention option click events
            document.querySelectorAll('.intention-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.intention-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // Notes and summary events
            elements.skipNotesBtn.addEventListener('click', skipPrivateNotes);
            elements.saveNotesBtn.addEventListener('click', savePrivateNotes);
            elements.summaryDoneBtn.addEventListener('click', closeCallSummary);
            
            // URL parameter events
            elements.urlParamCancelBtn.addEventListener('click', closeUrlParamOverlay);
            elements.urlParamJoinBtn.addEventListener('click', joinUrlParamCall);
            
            // Quick action buttons
            elements.quickVoiceBtn.addEventListener('click', openNewCallModal);
            elements.quickVideoBtn.addEventListener('click', openNewCallModal);
            elements.quickGroupBtn.addEventListener('click', openNewCallModal);
            
            // Settings events
            elements.settingsToggle.addEventListener('click', toggleSettingsPanel);
            elements.resetSettingsBtn.addEventListener('click', resetSettings);
            
            // Settings toggles
            elements.emotionalContextToggle.addEventListener('change', updateSetting);
            elements.callIntentionToggle.addEventListener('change', updateSetting);
            elements.inCallChatToggle.addEventListener('change', updateSetting);
            elements.whiteboardToggle.addEventListener('change', updateSetting);
            elements.pollsToggle.addEventListener('change', updateSetting);
            elements.notesToggle.addEventListener('change', updateSetting);
            elements.focusModeToggle.addEventListener('change', updateSetting);
            elements.liveReactionsToggle.addEventListener('change', updateSetting);
            
            // Call category tabs
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.dataset.category;
                    switchCallCategory(category);
                });
            });
            
            // New call modal tabs
            document.querySelectorAll('.new-call-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchNewCallTab(tabId);
                });
            });
            
            // Call control events
            elements.muteBtn.addEventListener('click', toggleMute);
            elements.videoBtn.addEventListener('click', toggleVideo);
            elements.screenShareBtn.addEventListener('click', toggleScreenShare);
            elements.speakerBtn.addEventListener('click', toggleSpeaker);
            elements.moodBtn.addEventListener('click', openMoodSelectionModal);
            elements.intentionBtn.addEventListener('click', openIntentionSelectionModal);
            elements.endCallBtn.addEventListener('click', endCall);
            
            // Focus mode
            elements.focusModeBtn.addEventListener('click', toggleFocusMode);
            
            // Reactions
            document.querySelectorAll('.reaction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reaction = this.dataset.reaction;
                    sendReaction(reaction);
                });
            });
            
            // PIP events
            elements.pipCloseBtn.addEventListener('click', closePip);
            
            // Make PIP draggable
            makeDraggable(elements.pipContainer);
        }
        
        function loadInitialData() {
            console.log('Starting to load initial data...');
            
            // Check if we can safely make API calls
            if (!AppState.isOnline) {
                console.log('Offline, loading from cache');
                loadCachedData();
                return;
            }
            
            // Check authentication status
            const token = localStorage.getItem('accessToken') || 
                         localStorage.getItem('moodchat_token') || 
                         localStorage.getItem('token');
            
            if (!token) {
                console.log('No authentication token found, loading from cache');
                loadCachedData();
                return;
            }
            
            console.log('Making API calls for initial data...');
            
            // Set authentication state
            AppState.isAuthenticated = true;
            AppState.apiReady = true;
            
            // Update API status
            elements.apiStatusIndicator.className = 'api-status-indicator connected';
            elements.apiStatusText.textContent = 'Authenticated';
            
            // Hide API status after successful auth
            setTimeout(() => {
                elements.apiStatusIndicator.style.display = 'none';
            }, 2000);
            
            // Load data with proper error handling
            Promise.allSettled([
                loadContacts(),
                loadCallHistory(),
                loadSettings(),
                checkPremiumStatus()
            ])
            .then(() => {
                enableUI();
                
                // Schedule incoming call simulation only if we have contacts
                setTimeout(() => {
                    if (AppState.contacts.length > 0) {
                        simulateIncomingCall();
                    }
                }, 10000);
            })
            .catch(error => {
                console.error('Error in initial data loading:', error);
                loadCachedData();
                enableUI();
            });
        }
        
        function loadContacts() {
            if (!AppState.isOnline) {
                console.log('Offline, loading contacts from cache');
                const cachedContacts = getCachedData('contacts');
                if (cachedContacts) {
                    AppState.contacts = cachedContacts;
                    renderContacts();
                }
                return Promise.resolve();
            }
            
            console.log('Loading contacts via API...');
            return ApiClient.getContacts()
                .then(contacts => {
                    AppState.contacts = contacts;
                    console.log('Contacts loaded:', contacts.length);
                    
                    // Cache contacts
                    cacheData('contacts', contacts);
                    
                    // Update UI if new call modal is open
                    if (elements.newCallModal.classList.contains('active')) {
                        renderContacts();
                    }
                    
                    return contacts;
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    
                    // Load from cache as fallback
                    const cachedContacts = getCachedData('contacts');
                    if (cachedContacts) {
                        AppState.contacts = cachedContacts;
                        renderContacts();
                    }
                    
                    // Don't throw error to prevent breaking the entire app
                    return [];
                });
        }
        
        function loadCallHistory() {
            if (!AppState.isOnline) {
                console.log('Offline, loading call history from cache');
                const cachedCalls = getCachedData('calls');
                if (cachedCalls) {
                    AppState.callHistory = cachedCalls;
                    renderCallHistory();
                }
                return Promise.resolve();
            }
            
            console.log('Loading call history via API...');
            return ApiClient.getCallHistory()
                .then(history => {
                    AppState.callHistory = history;
                    console.log('Call history loaded:', history.length);
                    
                    cacheData('calls', history);
                    
                    renderCallHistory();
                    
                    return history;
                })
                .catch(error => {
                    console.error('Error loading call history:', error);
                    
                    // Load from cache as fallback
                    const cachedCalls = getCachedData('calls');
                    if (cachedCalls) {
                        AppState.callHistory = cachedCalls;
                        renderCallHistory();
                    }
                    
                    return [];
                });
        }
        
        function loadCachedData() {
            try {
                const savedSettings = localStorage.getItem('callSettings');
                if (savedSettings) {
                    AppState.settings = { ...AppState.settings, ...JSON.parse(savedSettings) };
                }
                
                const cachedData = localStorage.getItem('cachedCallData');
                if (cachedData) {
                    AppState.cachedData = JSON.parse(cachedData);
                }
                
                const savedMood = localStorage.getItem('currentMood');
                if (savedMood) AppState.currentMood = savedMood;
                
                const savedIntention = localStorage.getItem('currentIntention');
                if (savedIntention) AppState.currentIntention = savedIntention;
                
                const savedChat = localStorage.getItem('chatMessages');
                if (savedChat) AppState.chatMessages = JSON.parse(savedChat);
                
                const savedPolls = localStorage.getItem('polls');
                if (savedPolls) AppState.userVotes = JSON.parse(savedPolls);
                
                const savedInsights = localStorage.getItem('relationshipInsights');
                if (savedInsights) AppState.relationshipInsights = JSON.parse(savedInsights);
                
                // Load contacts and calls from cache
                if (AppState.cachedData.contacts && AppState.cachedData.contacts.length > 0) {
                    AppState.contacts = AppState.cachedData.contacts;
                    renderContacts();
                }
                
                if (AppState.cachedData.calls && AppState.cachedData.calls.length > 0) {
                    AppState.callHistory = AppState.cachedData.calls;
                    renderCallHistory();
                }
                
                return Promise.resolve();
            } catch (error) {
                console.error('Error loading cached data:', error);
                return Promise.resolve();
            }
        }
        
        function loadCachedDataToUI() {
            if (AppState.contacts.length === 0 && AppState.cachedData.contacts.length > 0) {
                AppState.contacts = AppState.cachedData.contacts;
                if (elements.newCallModal.classList.contains('active')) {
                    renderContacts();
                }
            }
            
            if (AppState.callHistory.length === 0 && AppState.cachedData.calls.length > 0) {
                AppState.callHistory = AppState.cachedData.calls;
                renderCallHistory();
            }
        }
        
        function cacheData(key, data) {
            AppState.cachedData[key] = data;
            
            try {
                localStorage.setItem('cachedCallData', JSON.stringify(AppState.cachedData));
            } catch (error) {
                console.error('Error caching data:', error);
            }
        }
        
        function getCachedData(key) {
            return AppState.cachedData[key] || null;
        }
        
        function syncData() {
            if (!AppState.isOnline) {
                console.log('Cannot sync data - offline');
                return Promise.resolve();
            }
            
            console.log('Syncing data...');
            
            return Promise.allSettled([
                loadContacts(),
                loadCallHistory()
            ])
            .then(() => {
                elements.syncIndicator.innerHTML = '<i class="fas fa-sync"></i><span>Synced</span>';
                elements.syncIndicator.classList.remove('syncing');
                
                AppState.syncPending = false;
                console.log('Data sync complete');
            })
            .catch(error => {
                console.error('Error syncing data:', error);
                elements.syncIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Sync Failed</span>';
                AppState.syncPending = true;
            });
        }
        
        function loadSettings() {
            return new Promise((resolve) => {
                const savedSettings = localStorage.getItem('callSettings');
                if (savedSettings) {
                    try {
                        AppState.settings = { ...AppState.settings, ...JSON.parse(savedSettings) };
                        applySettingsToUI();
                    } catch (error) {
                        console.error('Error loading settings:', error);
                    }
                }
                resolve();
            });
        }
        
        function saveSettings() {
            try {
                localStorage.setItem('callSettings', JSON.stringify(AppState.settings));
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }
        
        function applySettingsToUI() {
            elements.emotionalContextToggle.checked = AppState.settings.emotionalContext;
            elements.callIntentionToggle.checked = AppState.settings.callIntention;
            elements.inCallChatToggle.checked = AppState.settings.inCallChat;
            elements.whiteboardToggle.checked = AppState.settings.whiteboard;
            elements.pollsToggle.checked = AppState.settings.polls;
            elements.notesToggle.checked = AppState.settings.notes;
            elements.focusModeToggle.checked = AppState.settings.focusMode;
            elements.liveReactionsToggle.checked = AppState.settings.liveReactions;
        }
        
        function updateSetting(event) {
            const setting = event.target.id.replace('Toggle', '');
            AppState.settings[setting] = event.target.checked;
            saveSettings();
            
            applySettingChange(setting, event.target.checked);
        }
        
        function applySettingChange(setting, value) {
            switch (setting) {
                case 'emotionalContext':
                    if (!value) {
                        elements.callMoodIndicator.style.display = 'none';
                        elements.callIntentionIndicator.style.display = 'none';
                    }
                    break;
                case 'focusMode':
                    if (AppState.isInCall) {
                        if (value) {
                            enableFocusMode();
                        } else {
                            disableFocusMode();
                        }
                    }
                    break;
                case 'liveReactions':
                    if (value) {
                        elements.reactionsContainer.style.display = 'flex';
                    } else {
                        elements.reactionsContainer.style.display = 'none';
                    }
                    break;
                case 'inCallChat':
                    if (!value && AppState.isInCall) {
                        showNotification('Chat disabled', 'info');
                    }
                    break;
            }
        }
        
        function resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                AppState.settings = {
                    emotionalContext: true,
                    callIntention: true,
                    inCallChat: true,
                    whiteboard: true,
                    polls: true,
                    notes: true,
                    focusMode: false,
                    liveReactions: true,
                    theme: 'light'
                };
                
                saveSettings();
                applySettingsToUI();
                
                showNotification('Settings reset to defaults', 'success');
            }
        }
        
        function checkPremiumStatus() {
            if (!AppState.isOnline) {
                console.log('Offline, using default premium status');
                AppState.isPremium = false;
                AppState.trialDaysLeft = 30;
                updatePremiumUI();
                return Promise.resolve();
            }
            
            console.log('Checking premium status via API...');
            return ApiClient.getPremiumStatus()
                .then(premiumData => {
                    AppState.isPremium = premiumData.isPremium;
                    AppState.trialDaysLeft = premiumData.trialDaysLeft || 30;
                    AppState.premiumFeatures = premiumData.features || AppState.premiumFeatures;
                    
                    console.log('Premium status:', AppState.isPremium, 'Days left:', AppState.trialDaysLeft);
                    
                    updatePremiumUI();
                    
                    return premiumData;
                })
                .catch(error => {
                    console.error('Error checking premium status:', error);
                    
                    AppState.isPremium = false;
                    AppState.trialDaysLeft = 30;
                    updatePremiumUI();
                    
                    return { isPremium: false, trialDaysLeft: 30 };
                });
        }
        
        function updatePremiumUI() {
            if (AppState.isPremium) {
                document.querySelectorAll('.premium-badge-small').forEach(badge => {
                    badge.style.display = 'none';
                });
                
                elements.quickGroupBtn.disabled = false;
                elements.screenShareBtn.disabled = false;
            } else {
                document.querySelectorAll('.premium-badge-small').forEach(badge => {
                    badge.style.display = 'block';
                });
                
                elements.quickGroupBtn.disabled = true;
                elements.screenShareBtn.disabled = true;
            }
        }
        
        function checkPremiumFeature(feature) {
            if (AppState.isPremium || AppState.premiumFeatures[feature]) {
                return true;
            }
            
            let message = '';
            switch (feature) {
                case 'groupCalls':
                    message = 'Group calls are a premium feature. Upgrade to connect with multiple people at once.';
                    break;
                case 'screenSharing':
                    message = 'Screen sharing is a premium feature. Upgrade to share your screen during calls.';
                    break;
                case 'whiteboard':
                    message = 'Collaborative whiteboard is a premium feature. Upgrade to draw and brainstorm together.';
                    break;
                case 'polls':
                    message = 'In-call polls are a premium feature. Upgrade to create and vote on polls during calls.';
                    break;
                case 'relationshipInsights':
                    message = 'Relationship insights are a premium feature. Upgrade to see call patterns and history.';
                    break;
                default:
                    message = 'This is a premium feature. Upgrade to access all advanced features.';
            }
            
            elements.premiumLimitText.textContent = message;
            elements.premiumLimitOverlay.classList.add('active');
            
            return false;
        }
        
        function openNewCallModal() {
            if (!AppState.isOnline) {
                showNotification('Cannot load contacts while offline', 'warning');
                return;
            }
            
            elements.newCallModal.classList.add('active');
            
            if (AppState.contacts.length === 0) {
                loadContacts();
            } else {
                renderContacts();
            }
            
            switchNewCallTab('contacts');
        }
        
        function closeNewCallModal() {
            elements.newCallModal.classList.remove('active');
            
            document.querySelectorAll('.contact-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            
            elements.contactSearch.value = '';
            elements.groupContactSearch.value = '';
            
            elements.instantGroupOption.classList.remove('selected');
            elements.scheduledGroupOption.classList.remove('selected');
            elements.startGroupCallBtn.disabled = true;
        }
        
        function renderContacts() {
            if (AppState.contacts.length === 0) {
                elements.contactsList.innerHTML = '<div class="offline-state"><i class="fas fa-users-slash"></i><p>No contacts available</p></div>';
                return;
            }
            
            let html = '';
            
            AppState.contacts.forEach(contact => {
                const isOnline = Math.random() > 0.3;
                const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                html += `
                    <div class="contact-item" data-id="${contact.id}">
                        <input type="checkbox" class="contact-checkbox" id="contact-${contact.id}">
                        <div class="call-avatar" style="background-color: ${stringToColor(contact.name)}">
                            ${contact.avatar ? `<img src="${contact.avatar}" alt="${contact.name}">` : initials}
                            <div class="call-status-icon ${isOnline ? 'incoming' : 'offline'}">
                                <i class="fas fa-circle"></i>
                            </div>
                        </div>
                        <div class="call-info">
                            <div class="call-name">
                                ${contact.name}
                                ${contact.isPremium ? '<span class="premium-badge">PRO</span>' : ''}
                            </div>
                            <div class="call-details">
                                <span>${isOnline ? 'Online' : 'Offline'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            elements.contactsList.innerHTML = html;
            elements.contactsLoading.style.display = 'none';
            
            document.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.type === 'checkbox') return;
                    
                    const checkbox = this.querySelector('.contact-checkbox');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('selected', checkbox.checked);
                    
                    updateGroupCallButton();
                });
            });
            
            renderGroupContacts();
        }
        
        function renderGroupContacts() {
            let html = '';
            
            AppState.contacts.forEach(contact => {
                const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                html += `
                    <div class="contact-item" data-id="${contact.id}">
                        <input type="checkbox" class="contact-checkbox group-contact" id="group-contact-${contact.id}">
                        <div class="call-avatar" style="background-color: ${stringToColor(contact.name)}">
                            ${contact.avatar ? `<img src="${contact.avatar}" alt="${contact.name}">` : initials}
                        </div>
                        <div class="call-info">
                            <div class="call-name">
                                ${contact.name}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            elements.groupContactsList.innerHTML = html;
            
            document.querySelectorAll('.group-contact').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const item = this.closest('.contact-item');
                    item.classList.toggle('selected', this.checked);
                    
                    updateGroupCallButton();
                });
            });
        }
        
        function searchContacts() {
            const query = elements.contactSearch.value.toLowerCase();
            
            document.querySelectorAll('.contact-item').forEach(item => {
                const name = item.querySelector('.call-name').textContent.toLowerCase();
                if (name.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function searchGroupContacts() {
            const query = elements.groupContactSearch.value.toLowerCase();
            
            document.querySelectorAll('.contact-item[data-id]').forEach(item => {
                const name = item.querySelector('.call-name').textContent.toLowerCase();
                if (name.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function selectGroupOption(event) {
            const option = event.currentTarget;
            
            if (option.id === 'instantGroupOption') {
                elements.scheduledGroupOption.classList.remove('selected');
            } else {
                elements.instantGroupOption.classList.remove('selected');
            }
            
            option.classList.add('selected');
        }
        
        function updateGroupCallButton() {
            const selectedContacts = document.querySelectorAll('.group-contact:checked').length;
            const hasGroupOption = document.querySelector('.option-item.selected') !== null;
            
            elements.startGroupCallBtn.disabled = !(selectedContacts >= 1 && hasGroupOption);
        }
        
        function startVoiceCall() {
            const selectedContacts = getSelectedContacts();
            
            if (selectedContacts.length === 0) {
                showNotification('Please select at least one contact', 'warning');
                return;
            }
            
            if (selectedContacts.length > 1 && !checkPremiumFeature('groupCalls')) {
                return;
            }
            
            startCall('voice', selectedContacts);
            closeNewCallModal();
        }
        
        function startVideoCall() {
            const selectedContacts = getSelectedContacts();
            
            if (selectedContacts.length === 0) {
                showNotification('Please select at least one contact', 'warning');
                return;
            }
            
            if (selectedContacts.length > 1 && !checkPremiumFeature('groupCalls')) {
                return;
            }
            
            startCall('video', selectedContacts);
            closeNewCallModal();
        }
        
        function startGroupCall() {
            const selectedContacts = getSelectedGroupContacts();
            const groupOption = document.querySelector('.option-item.selected');
            
            if (selectedContacts.length < 2) {
                showNotification('Please select at least 2 contacts for group call', 'warning');
                return;
            }
            
            if (!groupOption) {
                showNotification('Please select a group call option', 'warning');
                return;
            }
            
            if (!checkPremiumFeature('groupCalls')) {
                return;
            }
            
            const isInstant = groupOption.id === 'instantGroupOption';
            
            if (isInstant) {
                startCall('video', selectedContacts);
                closeNewCallModal();
            } else {
                scheduleGroupCall(selectedContacts);
            }
        }
        
        function getSelectedContacts() {
            const selected = [];
            document.querySelectorAll('.contact-checkbox:checked').forEach(checkbox => {
                const contactId = checkbox.id.replace('contact-', '');
                const contact = AppState.contacts.find(c => c.id === contactId);
                if (contact) {
                    selected.push(contact);
                }
            });
            return selected;
        }
        
        function getSelectedGroupContacts() {
            const selected = [];
            document.querySelectorAll('.group-contact:checked').forEach(checkbox => {
                const contactId = checkbox.id.replace('group-contact-', '');
                const contact = AppState.contacts.find(c => c.id === contactId);
                if (contact) {
                    selected.push(contact);
                }
            });
            return selected;
        }
        
        function startCall(type, participants) {
            if (AppState.isInCall) {
                showNotification('You are already in a call', 'warning');
                return;
            }
            
            console.log(`Starting ${type} call with ${participants.length} participants`);
            
            requestMediaPermissions(type)
                .then(stream => {
                    AppState.localStream = stream;
                    AppState.callType = type;
                    AppState.callParticipants = participants;
                    
                    // Simulate API call
                    console.log('Starting call simulation...');
                    
                    AppState.activeCallId = 'call-' + Date.now();
                    AppState.currentCall = {
                        id: AppState.activeCallId,
                        type: type,
                        participants: participants.map(p => p.id)
                    };
                    
                    initializePeer();
                    
                    showCallUI();
                    
                    startCallTimer();
                    
                    initializeCallFeatures();
                    
                    showNotification(`Starting ${type} call with ${participants.length} participant(s)`, 'success');
                })
                .catch(error => {
                    console.error('Error starting call:', error);
                    
                    if (AppState.localStream) {
                        AppState.localStream.getTracks().forEach(track => track.stop());
                        AppState.localStream = null;
                    }
                    
                    showNotification(`Failed to start call: ${error.message}`, 'error');
                });
        }
        
        function requestMediaPermissions(type) {
            const constraints = {
                audio: true,
                video: type === 'video'
            };
            
            return navigator.mediaDevices.getUserMedia(constraints)
                .catch(error => {
                    console.error('Error getting media permissions:', error);
                    
                    let errorMessage = 'Could not access ';
                    if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMessage += 'camera/microphone. Please check your devices.';
                    } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage += 'camera/microphone. Please allow permissions.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMessage += 'camera/microphone. Device may be in use by another application.';
                    } else {
                        errorMessage += 'camera/microphone. Unknown error.';
                    }
                    
                    throw new Error(errorMessage);
                });
        }
        
        function initializePeer() {
            const peerId = 'user-' + Math.random().toString(36).substr(2, 9);
            
            AppState.peer = new Peer(peerId, {
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            AppState.peer.on('open', (id) => {
                console.log('Peer connected with ID:', id);
            });
            
            AppState.peer.on('call', (call) => {
                call.answer(AppState.localStream);
                
                call.on('stream', (remoteStream) => {
                    addRemoteStream(call.peer, remoteStream);
                });
                
                call.on('close', () => {
                    removeRemoteStream(call.peer);
                });
                
                AppState.connections.set(call.peer, call);
            });
            
            AppState.peer.on('error', (error) => {
                console.error('PeerJS error:', error);
                showNotification('Connection error: ' + error.type, 'error');
            });
            
            setTimeout(() => {
                if (AppState.callParticipants && AppState.callParticipants.length > 0) {
                    AppState.callParticipants.forEach((participant, index) => {
                        setTimeout(() => {
                            simulateRemoteConnection(participant.id);
                        }, index * 1000);
                    });
                }
            }, 1000);
        }
        
        function simulateRemoteConnection(participantId) {
            const fakePeerId = 'remote-' + participantId;
            
            // Create a dummy video element for simulation
            const participant = AppState.callParticipants.find(p => p.id === participantId);
            if (participant) {
                addRemoteStream(fakePeerId, null);
            }
        }
        
        function addRemoteStream(peerId, stream) {
            AppState.remoteStreams.set(peerId, stream);
            
            updateVideoGrid();
        }
        
        function removeRemoteStream(peerId) {
            AppState.remoteStreams.delete(peerId);
            
            updateVideoGrid();
        }
        
        function showCallUI() {
            elements.sidebar.style.display = 'none';
            
            elements.callContainer.classList.add('active');
            
            const participantNames = AppState.callParticipants.map(p => p.name).join(', ');
            elements.callWithName.textContent = participantNames;
            elements.callStatusText.textContent = 'In call';
            
            const icon = AppState.callType === 'video' ? 'fa-video' : 'fa-phone';
            elements.callTypeIcon.innerHTML = `<i class="fas ${icon}"></i>`;
            
            if (AppState.settings.emotionalContext) {
                updateMoodIndicator(AppState.currentMood);
                updateIntentionIndicator(AppState.currentIntention);
            }
            
            elements.focusModeBtn.style.display = 'block';
            
            updateParticipantBadge();
            
            AppState.isInCall = true;
        }
        
        function startCallTimer() {
            AppState.callStartTime = Date.now();
            
            clearInterval(AppState.callDurationInterval);
            
            AppState.callDurationInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - AppState.callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                elements.callDuration.textContent = `${minutes}:${seconds}`;
            }, 1000);
        }
        
        function initializeCallFeatures() {
            if (AppState.localStream && AppState.callType === 'video') {
                createVideoElement('local', 'You', AppState.localStream, true);
            }
            
            if (AppState.settings.liveReactions) {
                elements.reactionsContainer.style.display = 'flex';
            }
            
            if (AppState.settings.focusMode) {
                enableFocusMode();
            }
        }
        
        function updateVideoGrid() {
            const videoContainers = elements.videoGrid.querySelectorAll('.video-container:not([data-id="local"])');
            videoContainers.forEach(container => container.remove());
            
            elements.offlineCallPlaceholder.style.display = 'none';
            elements.videoGrid.style.display = 'grid';
            
            let index = 0;
            AppState.remoteStreams.forEach((stream, peerId) => {
                let participantName = 'Participant';
                let participant = null;
                
                for (const p of AppState.callParticipants) {
                    if ('remote-' + p.id === peerId) {
                        participant = p;
                        participantName = p.name;
                        break;
                    }
                }
                
                createVideoElement(peerId, participantName, stream, false, participant);
                index++;
            });
            
            updateVideoLayout();
        }
        
        function createVideoElement(id, name, stream, isLocal = false, participant = null) {
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-container';
            videoContainer.dataset.id = id;
            
            if (isLocal) {
                videoContainer.classList.add('pinned');
            }
            
            const video = document.createElement('video');
            video.className = 'video-element';
            video.autoplay = true;
            video.playsInline = true;
            video.muted = isLocal;
            
            if (stream) {
                video.srcObject = stream;
            } else {
                // Create a placeholder for simulated participants
                video.style.backgroundColor = '#333';
                video.style.display = 'flex';
                video.style.alignItems = 'center';
                video.style.justifyContent = 'center';
                video.innerHTML = `<div style="color: white; font-size: 24px;">${name.charAt(0)}</div>`;
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'video-name';
            
            const statusSpan = document.createElement('span');
            statusSpan.className = 'video-status';
            statusSpan.textContent = isLocal ? 'You' : (participant ? 'Connected' : 'Remote');
            
            nameDiv.innerHTML = `<span>${name}</span>`;
            nameDiv.appendChild(statusSpan);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'video-actions';
            
            const pinBtn = document.createElement('button');
            pinBtn.className = 'video-action-btn' + (isLocal ? ' active' : '');
            pinBtn.innerHTML = '<i class="fas fa-thumbtack"></i>';
            pinBtn.title = isLocal ? 'Pinned (You)' : 'Pin video';
            pinBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                togglePinVideo(id);
            });
            
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.className = 'video-action-btn';
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'Fullscreen';
            fullscreenBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFullscreen(video);
            });
            
            actionsDiv.appendChild(pinBtn);
            actionsDiv.appendChild(fullscreenBtn);
            
            overlay.appendChild(nameDiv);
            overlay.appendChild(actionsDiv);
            
            videoContainer.appendChild(video);
            videoContainer.appendChild(overlay);
            
            videoContainer.addEventListener('click', () => {
                spotlightVideo(id);
            });
            
            elements.videoGrid.appendChild(videoContainer);
            
            if (stream) {
                video.play().catch(e => console.error('Error playing video:', e));
            }
        }
        
        function updateVideoLayout() {
            const videoContainers = elements.videoGrid.querySelectorAll('.video-container');
            const count = videoContainers.length;
            
            videoContainers.forEach(container => {
                container.classList.remove('large');
            });
            
            if (count === 1) {
                videoContainers[0].classList.add('large');
            } else if (count === 3) {
                const pinned = elements.videoGrid.querySelector('.video-container.pinned');
                if (pinned) {
                    pinned.classList.add('large');
                } else {
                    videoContainers[0].classList.add('large');
                }
            }
        }
        
        function togglePinVideo(videoId) {
            const videoContainer = elements.videoGrid.querySelector(`.video-container[data-id="${videoId}"]`);
            
            if (!videoContainer) return;
            
            elements.videoGrid.querySelectorAll('.video-container.pinned').forEach(container => {
                if (container.dataset.id !== videoId) {
                    container.classList.remove('pinned');
                    const pinBtn = container.querySelector('.video-action-btn');
                    if (pinBtn) {
                        pinBtn.classList.remove('active');
                        pinBtn.title = 'Pin video';
                    }
                }
            });
            
            const isPinned = videoContainer.classList.contains('pinned');
            
            if (isPinned) {
                videoContainer.classList.remove('pinned');
            } else {
                videoContainer.classList.add('pinned');
            }
            
            const pinBtn = videoContainer.querySelector('.video-action-btn');
            if (pinBtn) {
                pinBtn.classList.toggle('active', !isPinned);
                pinBtn.title = !isPinned ? 'Pinned' : 'Pin video';
            }
            
            updateVideoLayout();
        }
        
        function spotlightVideo(videoId) {
            const videoContainer = elements.videoGrid.querySelector(`.video-container[data-id="${videoId}"]`);
            
            if (!videoContainer) return;
            
            const isSpotlight = videoContainer.style.gridColumn === '1 / -1';
            
            if (isSpotlight) {
                videoContainer.style.gridColumn = '';
                videoContainer.style.gridRow = '';
            } else {
                videoContainer.style.gridColumn = '1 / -1';
                videoContainer.style.gridRow = '1 / -1';
                videoContainer.style.zIndex = '10';
                
                let exitBtn = videoContainer.querySelector('.spotlight-exit');
                if (!exitBtn) {
                    exitBtn = document.createElement('button');
                    exitBtn.className = 'video-action-btn danger';
                    exitBtn.innerHTML = '<i class="fas fa-times"></i>';
                    exitBtn.title = 'Exit spotlight';
                    exitBtn.style.position = 'absolute';
                    exitBtn.style.top = '10px';
                    exitBtn.style.right = '10px';
                    exitBtn.classList.add('spotlight-exit');
                    
                    exitBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        spotlightVideo(videoId);
                    });
                    
                    videoContainer.querySelector('.video-overlay').appendChild(exitBtn);
                }
            }
            
            updateVideoLayout();
        }
        
        function toggleFullscreen(videoElement) {
            if (!document.fullscreenElement) {
                videoElement.requestFullscreen().catch(err => {
                    console.error('Error attempting to enable fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        function updateParticipantBadge() {
            const count = AppState.callParticipants.length + 1;
            elements.participantBadge.textContent = count;
        }
        
        function updateChatBadge() {
            elements.chatBadge.textContent = AppState.unreadChatCount;
            if (AppState.unreadChatCount > 0) {
                elements.chatBadge.style.display = 'block';
            } else {
                elements.chatBadge.style.display = 'none';
            }
        }
        
        function toggleMute() {
            if (!AppState.localStream) return;
            
            const audioTracks = AppState.localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                AppState.isMuted = !AppState.isMuted;
                audioTracks.forEach(track => {
                    track.enabled = !AppState.isMuted;
                });
                
                const icon = elements.muteBtn.querySelector('i');
                if (AppState.isMuted) {
                    icon.className = 'fas fa-microphone-slash';
                    elements.muteBtn.title = 'Unmute';
                } else {
                    icon.className = 'fas fa-microphone';
                    elements.muteBtn.title = 'Mute';
                }
                
                showNotification(AppState.isMuted ? 'Microphone muted' : 'Microphone unmuted', 'info');
            }
        }
        
        function toggleVideo() {
            if (!AppState.localStream) return;
            
            const videoTracks = AppState.localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                AppState.isVideoOff = !AppState.isVideoOff;
                videoTracks.forEach(track => {
                    track.enabled = !AppState.isVideoOff;
                });
                
                const icon = elements.videoBtn.querySelector('i');
                if (AppState.isVideoOff) {
                    icon.className = 'fas fa-video-slash';
                    elements.videoBtn.title = 'Turn Video On';
                    
                    const localVideo = elements.videoGrid.querySelector('.video-container[data-id="local"]');
                    if (localVideo) {
                        localVideo.style.display = 'none';
                    }
                } else {
                    icon.className = 'fas fa-video';
                    elements.videoBtn.title = 'Turn Video Off';
                    
                    const localVideo = elements.videoGrid.querySelector('.video-container[data-id="local"]');
                    if (localVideo) {
                        localVideo.style.display = 'block';
                    }
                }
                
                showNotification(AppState.isVideoOff ? 'Camera turned off' : 'Camera turned on', 'info');
            }
        }
        
        function toggleScreenShare() {
            if (!checkPremiumFeature('screenSharing')) {
                return;
            }
            
            if (AppState.isScreenSharing) {
                stopScreenShare();
            } else {
                startScreenShare();
            }
        }
        
        function startScreenShare() {
            if (!navigator.mediaDevices.getDisplayMedia) {
                showNotification('Screen sharing is not supported in your browser', 'error');
                return;
            }
            
            navigator.mediaDevices.getDisplayMedia({ video: true, audio: true })
                .then(stream => {
                    AppState.screenStream = stream;
                    AppState.isScreenSharing = true;
                    
                    const videoTrack = stream.getVideoTracks()[0];
                    const oldVideoTrack = AppState.localStream.getVideoTracks()[0];
                    
                    elements.screenShareBtn.classList.add('active');
                    elements.screenShareBtn.title = 'Stop Sharing';
                    
                    const localVideo = elements.videoGrid.querySelector('.video-container[data-id="local"] video');
                    if (localVideo) {
                        const newStream = new MediaStream();
                        newStream.addTrack(videoTrack);
                        newStream.addTrack(AppState.localStream.getAudioTracks()[0]);
                        
                        localVideo.srcObject = newStream;
                    }
                    
                    stream.getVideoTracks()[0].addEventListener('ended', () => {
                        stopScreenShare();
                    });
                    
                    showNotification('Screen sharing started', 'success');
                })
                .catch(error => {
                    console.error('Error starting screen share:', error);
                    
                    if (error.name === 'NotAllowedError') {
                        showNotification('Screen sharing permission denied', 'error');
                    } else {
                        showNotification('Failed to start screen sharing', 'error');
                    }
                });
        }
        
        function stopScreenShare() {
            if (!AppState.screenStream) return;
            
            AppState.screenStream.getTracks().forEach(track => track.stop());
            AppState.screenStream = null;
            AppState.isScreenSharing = false;
            
            if (AppState.localStream) {
                const localVideo = elements.videoGrid.querySelector('.video-container[data-id="local"] video');
                if (localVideo) {
                    localVideo.srcObject = AppState.localStream;
                }
            }
            
            elements.screenShareBtn.classList.remove('active');
            elements.screenShareBtn.title = 'Share Screen';
            
            showNotification('Screen sharing stopped', 'info');
        }
        
        function toggleSpeaker() {
            AppState.isSpeakerOn = !AppState.isSpeakerOn;
            
            const icon = elements.speakerBtn.querySelector('i');
            if (AppState.isSpeakerOn) {
                icon.className = 'fas fa-volume-up';
                elements.speakerBtn.title = 'Switch to Headphones';
            } else {
                icon.className = 'fas fa-headphones';
                elements.speakerBtn.title = 'Switch to Speaker';
            }
            
            showNotification(`Switched to ${AppState.isSpeakerOn ? 'speaker' : 'headphones'}`, 'info');
        }
        
        function endCall() {
            if (!AppState.isInCall) return;
            
            if (confirm('End the call?')) {
                if (AppState.localStream) {
                    AppState.localStream.getTracks().forEach(track => track.stop());
                    AppState.localStream = null;
                }
                
                if (AppState.screenStream) {
                    AppState.screenStream.getTracks().forEach(track => track.stop());
                    AppState.screenStream = null;
                }
                
                AppState.remoteStreams.forEach(stream => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                });
                AppState.remoteStreams.clear();
                
                if (AppState.peer) {
                    AppState.peer.destroy();
                    AppState.peer = null;
                }
                
                AppState.connections.clear();
                
                clearInterval(AppState.callDurationInterval);
                
                const callDuration = AppState.callStartTime ? 
                    Math.floor((Date.now() - AppState.callStartTime) / 1000) : 0;
                
                AppState.isInCall = false;
                AppState.activeCallId = null;
                AppState.currentCall = null;
                AppState.callType = null;
                AppState.callParticipants = [];
                AppState.callStartTime = null;
                
                elements.callContainer.classList.remove('active');
                elements.sidebar.style.display = 'flex';
                
                elements.focusModeBtn.style.display = 'none';
                
                if (AppState.currentFocusMode) {
                    disableFocusMode();
                }
                
                setTimeout(() => {
                    showPrivateNotesModal();
                }, 500);
                
                showNotification('Call ended', 'info');
            }
        }
        
        function showPrivateNotesModal() {
            const lastContact = AppState.callParticipants[0];
            
            if (lastContact) {
                elements.privateNotesTitle.textContent = `Notes about call with ${lastContact.name}`;
                elements.privateNotesSubtitle.textContent = 'Add private notes about this call (only visible to you)';
                
                const previousNotes = getPrivateNotes(lastContact.id);
                if (previousNotes) {
                    elements.privateNotesTextarea.value = previousNotes;
                } else {
                    elements.privateNotesTextarea.value = '';
                }
                
                elements.privateNotesModal.classList.add('active');
            } else {
                showCallSummary();
            }
        }
        
        function skipPrivateNotes() {
            elements.privateNotesModal.classList.remove('active');
            showCallSummary();
        }
        
        function savePrivateNotes() {
            const notes = elements.privateNotesTextarea.value.trim();
            const lastContact = AppState.callParticipants[0];
            
            if (lastContact && notes) {
                savePrivateNotesToStorage(lastContact.id, notes);
                showNotification('Notes saved', 'success');
            }
            
            elements.privateNotesModal.classList.remove('active');
            showCallSummary();
        }
        
        function savePrivateNotesToStorage(contactId, notes) {
            try {
                const allNotes = JSON.parse(localStorage.getItem('privateCallNotes') || '{}');
                allNotes[contactId] = {
                    notes: notes,
                    timestamp: new Date().toISOString(),
                    callId: AppState.activeCallId
                };
                localStorage.setItem('privateCallNotes', JSON.stringify(allNotes));
            } catch (error) {
                console.error('Error saving private notes:', error);
            }
        }
        
        function getPrivateNotes(contactId) {
            try {
                const allNotes = JSON.parse(localStorage.getItem('privateCallNotes') || '{}');
                return allNotes[contactId] ? allNotes[contactId].notes : null;
            } catch (error) {
                console.error('Error loading private notes:', error);
                return null;
            }
        }
        
        function showCallSummary() {
            const callDuration = AppState.callStartTime ? 
                Math.floor((Date.now() - AppState.callStartTime) / 1000) : 0;
            
            const minutes = Math.floor(callDuration / 60);
            const seconds = callDuration % 60;
            
            elements.summaryDuration.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            elements.summaryTime.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            elements.summaryType.textContent = AppState.callType === 'video' ? 'Video Call' : 'Voice Call';
            elements.summaryMood.textContent = AppState.currentMood.charAt(0).toUpperCase() + AppState.currentMood.slice(1);
            elements.summaryIntention.textContent = AppState.currentIntention === 'quick' ? 'Quick Chat' : 
                                                  AppState.currentIntention === 'important' ? 'Important Discussion' :
                                                  AppState.currentIntention === 'emergency' ? 'Emergency' :
                                                  AppState.currentIntention === 'checkin' ? 'Check-in' : 'Work/Business';
            elements.summaryParticipants.textContent = AppState.callParticipants.length + 1;
            
            elements.callSummaryModal.classList.add('active');
        }
        
        function closeCallSummary() {
            elements.callSummaryModal.classList.remove('active');
        }
        
        function openMoodSelectionModal() {
            elements.moodSelectionModal.classList.add('active');
            
            document.querySelectorAll('.mood-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.mood === AppState.currentMood) {
                    option.classList.add('selected');
                }
            });
        }
        
        function closeMoodSelectionModal() {
            elements.moodSelectionModal.classList.remove('active');
        }
        
        function setMood() {
            const selectedOption = document.querySelector('.mood-option.selected');
            if (selectedOption) {
                const newMood = selectedOption.dataset.mood;
                AppState.currentMood = newMood;
                
                localStorage.setItem('currentMood', newMood);
                
                updateMoodIndicator(newMood);
                
                if (AppState.isInCall) {
                    broadcastData({ type: 'mood', mood: newMood });
                }
                
                closeMoodSelectionModal();
                showNotification(`Mood set to ${newMood}`, 'success');
            }
        }
        
        function updateMoodIndicator(mood) {
            if (!AppState.settings.emotionalContext) return;
            
            const moodNames = {
                happy: 'Happy',
                neutral: 'Neutral',
                sad: 'Sad',
                angry: 'Angry',
                tired: 'Tired',
                excited: 'Excited'
            };
            
            elements.callMoodIndicator.innerHTML = `
                <div class="mood-indicator mood-${mood}" style="display: inline-flex; margin-top: 5px;">
                    <i class="fas fa-smile"></i>
                    <span>${moodNames[mood] || mood}</span>
                </div>
            `;
            elements.callMoodIndicator.style.display = 'block';
        }
        
        function openIntentionSelectionModal() {
            elements.intentionSelectionModal.classList.add('active');
            
            document.querySelectorAll('.intention-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.intention === AppState.currentIntention) {
                    option.classList.add('selected');
                }
            });
        }
        
        function closeIntentionSelectionModal() {
            elements.intentionSelectionModal.classList.remove('active');
        }
        
        function setIntention() {
            const selectedOption = document.querySelector('.intention-option.selected');
            if (selectedOption) {
                const newIntention = selectedOption.dataset.intention;
                AppState.currentIntention = newIntention;
                
                localStorage.setItem('currentIntention', newIntention);
                
                updateIntentionIndicator(newIntention);
                
                if (AppState.isInCall) {
                    broadcastData({ type: 'intention', intention: newIntention });
                }
                
                closeIntentionSelectionModal();
                showNotification(`Intention set to ${newIntention}`, 'success');
            }
        }
        
        function updateIntentionIndicator(intention) {
            if (!AppState.settings.callIntention) return;
            
            const intentionNames = {
                quick: 'Quick Chat',
                important: 'Important Discussion',
                emergency: 'Emergency',
                checkin: 'Check-in',
                work: 'Work/Business'
            };
            
            elements.callIntentionIndicator.innerHTML = `
                <div class="intention-indicator intention-${intention}" style="display: inline-flex; margin-top: 5px;">
                    <i class="fas fa-bullseye"></i>
                    <span>${intentionNames[intention] || intention}</span>
                </div>
            `;
            elements.callIntentionIndicator.style.display = 'block';
        }
        
        function toggleFocusMode() {
            if (AppState.currentFocusMode) {
                disableFocusMode();
            } else {
                enableFocusMode();
            }
        }
        
        function enableFocusMode() {
            AppState.currentFocusMode = true;
            elements.appContainer.classList.add('focus-mode');
            elements.focusModeBtn.classList.add('active');
            elements.focusModeBtn.title = 'Exit Focus Mode';
            
            showNotification('Focus mode enabled', 'info');
        }
        
        function disableFocusMode() {
            AppState.currentFocusMode = false;
            elements.appContainer.classList.remove('focus-mode');
            elements.focusModeBtn.classList.remove('active');
            elements.focusModeBtn.title = 'Focus Mode';
        }
        
        function sendReaction(reaction) {
            if (!AppState.isInCall) return;
            
            createFloatingReaction(reaction);
            
            broadcastData({ type: 'reaction', reaction: reaction });
            
            showNotification(`Sent ${reaction} reaction`, 'info');
        }
        
        function createFloatingReaction(reaction) {
            const reactionEl = document.createElement('div');
            reactionEl.className = 'floating-reaction';
            reactionEl.textContent = reaction;
            reactionEl.style.left = Math.random() * 80 + 10 + '%';
            reactionEl.style.top = Math.random() * 80 + 10 + '%';
            
            elements.callContainer.appendChild(reactionEl);
            
            setTimeout(() => {
                reactionEl.remove();
            }, 3000);
        }
        
        function broadcastData(data) {
            console.log('Broadcasting data:', data);
            
            if (data.type === 'reaction' && Math.random() > 0.5) {
                setTimeout(() => {
                    createFloatingReaction(data.reaction);
                }, Math.random() * 1000 + 500);
            }
        }
        
        function scheduleGroupCall(participants) {
            showNotification('Group call scheduled successfully', 'success');
            closeNewCallModal();
        }
        
        function generateVoiceCallLink() {
            generateCallLink('voice');
        }
        
        function generateVideoCallLink() {
            generateCallLink('video');
        }
        
        function generateCallLink(type) {
            const callId = 'call-' + Math.random().toString(36).substr(2, 9);
            const baseUrl = window.location.origin + window.location.pathname;
            const callUrl = `${baseUrl}?call=${callId}&type=${type}`;
            
            elements.callLinkInput.value = callUrl;
            
            showNotification(`${type === 'voice' ? 'Voice' : 'Video'} call link generated`, 'success');
        }
        
        function copyCallLink() {
            const link = elements.callLinkInput.value;
            
            if (!link) {
                showNotification('Generate a call link first', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(link)
                .then(() => {
                    showNotification('Call link copied to clipboard', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showNotification('Failed to copy link', 'error');
                });
        }
        
        function shareCallLink() {
            const link = elements.callLinkInput.value;
            
            if (!link) {
                showNotification('Generate a call link first', 'warning');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join my call',
                    text: 'Join my call using this link',
                    url: link,
                })
                .then(() => {
                    showNotification('Call link shared', 'success');
                })
                .catch(err => {
                    console.error('Error sharing:', err);
                    showNotification('Failed to share link', 'error');
                });
            } else {
                copyCallLink();
            }
        }
        
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const callId = urlParams.get('call');
            const callType = urlParams.get('type');
            
            if (callId) {
                elements.urlParamText.textContent = `You've been invited to join a ${callType || 'voice'} call. Would you like to join now?`;
                elements.urlParamOverlay.classList.add('active');
            }
        }
        
        function closeUrlParamOverlay() {
            elements.urlParamOverlay.classList.remove('active');
            
            const url = new URL(window.location);
            url.searchParams.delete('call');
            url.searchParams.delete('type');
            window.history.replaceState({}, '', url);
        }
        
        function joinUrlParamCall() {
            const urlParams = new URLSearchParams(window.location.search);
            const callId = urlParams.get('call');
            const callType = urlParams.get('type') || 'voice';
            
            showNotification(`Joining ${callType} call...`, 'info');
            
            closeUrlParamOverlay();
            
            setTimeout(() => {
                const randomContact = AppState.contacts.length > 0 ? 
                    AppState.contacts[0] : 
                    { id: 'remote', name: 'Remote Participant' };
                
                AppState.isInCall = true;
                AppState.callType = callType;
                AppState.callParticipants = [randomContact];
                
                showCallUI();
                startCallTimer();
                initializeCallFeatures();
                
                showNotification(`Joined ${callType} call`, 'success');
            }, 1000);
        }
        
        function renderCallHistory() {
            elements.callsLoading.style.display = 'none';
            
            if (AppState.callHistory.length === 0) {
                elements.allCallsList.innerHTML = '<div class="offline-state"><i class="fas fa-phone-slash"></i><p>No call history</p><p class="subtext">Make your first call to see it here</p></div>';
                return;
            }
            
            let allCallsHtml = '';
            let missedCallsHtml = '';
            let groupCallsHtml = '';
            
            AppState.callHistory.forEach(call => {
                const callItem = createCallHistoryItem(call);
                
                allCallsHtml += callItem;
                
                if (call.status === 'missed') {
                    missedCallsHtml += callItem;
                }
                
                if (call.isGroup) {
                    groupCallsHtml += callItem;
                }
            });
            
            elements.allCallsList.innerHTML = allCallsHtml || '<div class="offline-state"><i class="fas fa-phone-slash"></i><p>No calls</p></div>';
            elements.missedCallsList.innerHTML = missedCallsHtml || '<div class="offline-state"><i class="fas fa-phone-slash"></i><p>No missed calls</p><p class="subtext">All calls have been answered</p></div>';
            elements.groupCallsList.innerHTML = groupCallsHtml || '<div class="offline-state"><i class="fas fa-users-slash"></i><p>No group calls yet</p><p class="subtext">Start your first group call to see it here</p></div>';
            
            document.querySelectorAll('.call-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const callItem = this.closest('.call-item');
                    const contactId = callItem.dataset.contactId;
                    const contact = AppState.contacts.find(c => c.id === contactId);
                    
                    if (contact) {
                        startCall('voice', [contact]);
                    }
                });
            });
        }
        
        function createCallHistoryItem(call) {
            const contact = AppState.contacts.find(c => c.id === call.contactId) || { name: call.contactName || 'Unknown' };
            const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const timeAgo = formatTimeAgo(call.timestamp);
            
            let statusIcon = '';
            let statusClass = '';
            
            if (call.status === 'incoming') {
                statusIcon = '<i class="fas fa-phone-alt"></i>';
                statusClass = 'incoming';
            } else if (call.status === 'outgoing') {
                statusIcon = '<i class="fas fa-phone-alt"></i>';
                statusClass = 'outgoing';
            } else if (call.status === 'missed') {
                statusIcon = '<i class="fas fa-phone-slash"></i>';
                statusClass = 'missed';
            }
            
            return `
                <div class="call-item" data-contact-id="${call.contactId}">
                    <div class="call-avatar" style="background-color: ${stringToColor(contact.name)}">
                        ${contact.avatar ? `<img src="${contact.avatar}" alt="${contact.name}">` : initials}
                        <div class="call-status-icon ${statusClass}">
                            ${statusIcon}
                        </div>
                    </div>
                    <div class="call-info">
                        <div class="call-name">
                            <span>${contact.name}</span>
                            <span class="call-time">${timeAgo}</span>
                        </div>
                        <div class="call-details">
                            <span>${call.type === 'video' ? 'Video Call' : 'Voice Call'}</span>
                            ${call.duration ? `<span>‚Ä¢ ${formatDuration(call.duration)}</span>` : ''}
                            ${call.isGroup ? '<span class="premium-badge">Group</span>' : ''}
                        </div>
                        ${call.mood ? `<div class="mood-indicator mood-${call.mood}"><i class="fas fa-smile"></i><span>${call.mood}</span></div>` : ''}
                        ${call.intention ? `<div class="intention-indicator intention-${call.intention}"><i class="fas fa-bullseye"></i><span>${call.intention}</span></div>` : ''}
                    </div>
                    <button class="call-action-btn" title="Call back">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>
            `;
        }
        
        function switchCallCategory(category) {
            AppState.currentCategory = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                }
            });
            
            elements.allCallsSection.classList.remove('active');
            elements.missedCallsSection.classList.remove('active');
            elements.groupCallsSection.classList.remove('active');
            
            if (category === 'all') {
                elements.allCallsSection.classList.add('active');
            } else if (category === 'missed') {
                elements.missedCallsSection.classList.add('active');
            } else if (category === 'group') {
                elements.groupCallsSection.classList.add('active');
            }
        }
        
        function switchNewCallTab(tabId) {
            document.querySelectorAll('.new-call-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.new-call-tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId + 'Tab') {
                    content.classList.add('active');
                }
            });
        }
        
        function toggleMenuDots() {
            elements.menuDotsDropdown.classList.toggle('active');
        }
        
        function closeMenuDots() {
            elements.menuDotsDropdown.classList.remove('active');
        }
        
        function openPaymentModal() {
            elements.paymentModal.classList.add('active');
            elements.premiumLimitOverlay.classList.remove('active');
        }
        
        function closePaymentModal() {
            elements.paymentModal.classList.remove('active');
        }
        
        function selectPaymentOption(event) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
        }
        
        function processPayment() {
            const phoneNumber = elements.phoneNumber.value.trim();
            const amount = elements.paymentAmount.value;
            
            if (!phoneNumber || !/^07\d{8}$/.test(phoneNumber)) {
                showNotification('Please enter a valid Kenyan phone number (07XXXXXXXX)', 'error');
                return;
            }
            
            if (!amount || amount < 100) {
                showNotification('Please enter a valid amount (minimum 100 KES)', 'error');
                return;
            }
            
            showNotification('Processing payment...', 'info');
            
            setTimeout(() => {
                closePaymentModal();
                AppState.isPremium = true;
                updatePremiumUI();
                showNotification('Payment successful! Premium features unlocked.', 'success');
            }, 2000);
        }
        
        function closePremiumLimitModal() {
            elements.premiumLimitOverlay.classList.remove('active');
        }
        
        function initializeNotifications() {
            elements.notificationToast.style.display = 'none';
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `call-notification ${type}`;
            
            notification.innerHTML = `
                <div class="call-notification-content">
                    <div class="call-notification-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="call-notification-message">${message}</div>
                </div>
                <button class="call-notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            elements.notificationArea.appendChild(notification);
            
            notification.querySelector('.call-notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            if (element.querySelector('.pip-controls')) {
                element.querySelector('.pip-controls').onmousedown = dragMouseDown;
            } else {
                element.onmousedown = dragMouseDown;
            }
            
            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
        
        function closePip() {
            elements.pipContainer.style.display = 'none';
        }
        
        function initializeOfflineDetection() {
            AppState.isOnline = navigator.onLine;
            
            if (!AppState.isOnline) {
                handleOffline();
            }
        }
        
        function handleOnline() {
            console.log('App is online');
            AppState.isOnline = true;
            
            elements.offlineBanner.classList.remove('active');
            
            elements.appContainer.classList.remove('offline-ui');
            
            elements.syncIndicator.innerHTML = '<i class="fas fa-sync"></i><span>Syncing...</span>';
            elements.syncIndicator.classList.add('syncing');
            
            syncData();
            
            enableUI();
        }
        
        function handleOffline() {
            console.log('App is offline');
            AppState.isOnline = false;
            
            elements.offlineBanner.classList.add('active');
            
            elements.appContainer.classList.add('offline-ui');
            
            elements.syncIndicator.innerHTML = '<i class="fas fa-cloud-slash"></i><span>Offline</span>';
            elements.syncIndicator.classList.remove('syncing');
            
            showOfflineUI();
        }
        
        function showOfflineUI() {
            if (elements.callContainer.classList.contains('active')) {
                elements.offlineCallPlaceholder.style.display = 'flex';
                elements.videoGrid.style.display = 'none';
            }
            
            elements.offlineContactsMessage.style.display = 'block';
            
            elements.offlineCallsState.style.display = 'flex';
            elements.callsLoading.style.display = 'none';
            
            loadCachedDataToUI();
        }
        
        function enableUI() {
            console.log('Enabling UI elements...');
            
            elements.newCallBtn.disabled = false;
            
            elements.quickVoiceBtn.disabled = false;
            elements.quickVideoBtn.disabled = false;
            
            if (AppState.premiumFeatures.groupCalls) {
                elements.quickGroupBtn.disabled = false;
            }
            
            if (AppState.isOnline) {
                elements.syncIndicator.innerHTML = '<i class="fas fa-sync"></i><span>Synced</span>';
                
                elements.offlineCallsState.style.display = 'none';
                elements.offlineContactsMessage.style.display = 'none';
                
                if (AppState.syncPending) {
                    syncData();
                }
            } else {
                elements.syncIndicator.innerHTML = '<i class="fas fa-cloud-slash"></i><span>Offline</span>';
                showOfflineUI();
            }
            
            applySettingsToUI();
        }
        
        function initializeUI() {
            elements.callsLoading.style.display = 'none';
            elements.contactsLoading.style.display = 'none';
            
            updateMoodIndicator('neutral');
            updateIntentionIndicator('quick');
            
            initializeNotifications();
        }
        
        function simulateIncomingCall() {
            if (AppState.isInCall || elements.incomingCallModal.classList.contains('active')) {
                return;
            }
            
            if (AppState.contacts.length === 0) return;
            
            const randomContact = AppState.contacts[Math.floor(Math.random() * AppState.contacts.length)];
            const isVideoCall = Math.random() > 0.5;
            
            elements.incomingCallName.textContent = randomContact.name;
            elements.incomingCallType.textContent = isVideoCall ? 'Video Call' : 'Voice Call';
            
            const initials = randomContact.name.split(' ').map(n => n[0]).join('').toUpperCase();
            elements.incomingCallAvatar.innerHTML = initials;
            elements.incomingCallAvatar.style.backgroundColor = stringToColor(randomContact.name);
            
            if (Math.random() > 0.5) {
                const moods = ['happy', 'neutral', 'sad', 'angry', 'tired'];
                const randomMood = moods[Math.floor(Math.random() * moods.length)];
                elements.incomingCallMood.innerHTML = `<i class="fas fa-smile"></i><span>${randomMood}</span>`;
                elements.incomingCallMood.className = `mood-indicator mood-${randomMood}`;
                elements.incomingCallMood.style.display = 'inline-flex';
            } else {
                elements.incomingCallMood.style.display = 'none';
            }
            
            if (Math.random() > 0.5) {
                const intentions = ['quick', 'important', 'emergency', 'checkin', 'work'];
                const randomIntention = intentions[Math.floor(Math.random() * intentions.length)];
                elements.incomingCallIntention.innerHTML = `<i class="fas fa-bullseye"></i><span>${randomIntention}</span>`;
                elements.incomingCallIntention.className = `intention-indicator intention-${randomIntention}`;
                elements.incomingCallIntention.style.display = 'inline-flex';
            } else {
                elements.incomingCallIntention.style.display = 'none';
            }
            
            let timeLeft = 45;
            elements.declineTimer.textContent = timeLeft;
            
            const countdown = setInterval(() => {
                timeLeft--;
                elements.declineTimer.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    declineIncomingCall();
                }
            }, 1000);
            
            elements.incomingCallModal.dataset.timer = countdown;
            
            elements.incomingCallModal.classList.add('active');
            
            showNotification(`Incoming ${isVideoCall ? 'video' : 'voice'} call from ${randomContact.name}`, 'info');
        }
        
        function declineIncomingCall() {
            if (elements.incomingCallModal.dataset.timer) {
                clearInterval(parseInt(elements.incomingCallModal.dataset.timer));
            }
            
            elements.incomingCallModal.classList.remove('active');
            
            showNotification('Call declined', 'info');
        }
        
        function acceptIncomingCall() {
            acceptIncomingCallGeneric(false);
        }
        
        function acceptIncomingCallAsVideo() {
            acceptIncomingCallGeneric(true);
        }
        
        function acceptIncomingCallGeneric(asVideo) {
            if (elements.incomingCallModal.dataset.timer) {
                clearInterval(parseInt(elements.incomingCallModal.dataset.timer));
            }
            
            const callerName = elements.incomingCallName.textContent;
            const isVideoCall = elements.incomingCallType.textContent.includes('Video');
            const callType = asVideo ? 'video' : (isVideoCall ? 'video' : 'voice');
            
            elements.incomingCallModal.classList.remove('active');
            
            showNotification(`Accepting ${callType} call from ${callerName}...`, 'info');
            
            const simulatedParticipant = {
                id: 'incoming-caller',
                name: callerName
            };
            
            requestMediaPermissions(callType)
                .then(stream => {
                    AppState.localStream = stream;
                    AppState.callType = callType;
                    AppState.callParticipants = [simulatedParticipant];
                    
                    showCallUI();
                    startCallTimer();
                    initializeCallFeatures();
                    
                    showNotification(`${callType} call started`, 'success');
                })
                .catch(error => {
                    showNotification(`Failed to start call: ${error.message}`, 'error');
                });
        }
        
        function handleStorageEvent(event) {
            if (event.key === 'callSettings') {
                try {
                    const newSettings = JSON.parse(event.newValue);
                    AppState.settings = { ...AppState.settings, ...newSettings };
                    applySettingsToUI();
                } catch (error) {
                    console.error('Error parsing updated settings:', error);
                }
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const color = Math.floor(Math.abs((Math.sin(hash) * 16777215) % 16777215)).toString(16);
            return '#' + '0'.repeat(6 - color.length) + color;
        }
        
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Start the bootstrap process when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            bootstrapIframe().catch(error => {
                console.error('Failed to bootstrap iframe:', error);
                showApiError('Failed to initialize app');
            });
        });
        
        window.CallApp = {
            simulateIncomingCall,
            startTestCall: () => {
                if (AppState.contacts.length > 0) {
                    startCall('video', [AppState.contacts[0]]);
                } else {
                    console.log('Cannot start test call - no contacts available');
                }
            },
            getState: () => AppState,
            checkApiStatus: () => {
                return {
                    isAuthenticated: AppState.isAuthenticated,
                    apiReady: AppState.apiReady,
                    tokens: {
                        accessToken: localStorage.getItem('accessToken') ? 'Available' : 'Missing',
                        refreshToken: localStorage.getItem('refreshToken') ? 'Available' : 'Missing',
                        moodchat_token: localStorage.getItem('moodchat_token') ? 'Available' : 'Missing',
                        token: localStorage.getItem('token') ? 'Available' : 'Missing'
                    }
                };
            },
            // Expose bootstrap for testing
            bootstrapIframe
        };
    </script>
</body>
</html>