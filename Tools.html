<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="icon" href="../icons/moodchat-192.png">
    <link rel="icon" href="../icons/moodchat-512.png">
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marketplace | Knecta Chat</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Color Picker Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
    
    <!-- Emoji Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/css/picker.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/index.js"></script>
    
    <!-- Video Player -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.21.5/video.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.21.5/video-js.min.css" rel="stylesheet">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CSS with same structure as status.html */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #0084ff;
            --secondary-color: #f0f2f5;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --info-color: #5ac8fa;
            --text-primary: #050505;
            --text-secondary: #65676b;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --marketplace-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
            --service-busy: linear-gradient(45deg, #ff6b6b, #ffa726);
            --service-free: linear-gradient(45deg, #4caf50, #8bc34a);
            --service-urgent: linear-gradient(45deg, #ff3b30, #ff9500);
            --dark-bg: #121212;
            --dark-card: #1e1e1e;
            --dark-text: #e4e6eb;
            --premium-gold: linear-gradient(45deg, #FFD700, #FFA500);
            --premium-purple: linear-gradient(45deg, #8A2BE2, #4B0082);
            --featured-gradient: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FFEAA7);
            --team-color: #6C63FF;
        }
        
        [data-theme="dark"] {
            --bg-color: var(--dark-bg);
            --secondary-color: var(--dark-card);
            --text-primary: var(--dark-text);
            --text-secondary: #a0a0a0;
            --border-color: #333;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 380px;
            background-color: var(--bg-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }
        
        @media (min-width: 769px) {
            .sidebar {
                display: flex;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: flex !important;
                position: relative !important;
                width: 100% !important;
                height: 100vh !important;
                border-right: none !important;
                z-index: auto !important;
            }
            
            .marketplace-detail-panel {
                position: relative !important;
                width: 100% !important;
                height: auto !important;
                z-index: auto !important;
            }
            
            .app-container {
                flex-direction: column !important;
                height: auto !important;
                min-height: 100vh !important;
            }
            
            .marketplace-list-content {
                padding-bottom: 20px !important;
            }
        }
        
        .sidebar-header {
            padding: 20px;
            background: var(--marketplace-gradient);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .add-listing-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .add-listing-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* Premium Badge */
        .premium-badge {
            background: var(--premium-gold);
            color: #000;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        
        .featured-badge {
            background: var(--featured-gradient);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        .verified-badge {
            background: linear-gradient(45deg, #00C9FF, #92FE9D);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        
        .team-badge {
            background-color: var(--team-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        
        /* Marketplace Categories */
        .marketplace-categories {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-color);
            flex-shrink: 0;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .marketplace-categories::-webkit-scrollbar {
            display: none;
        }
        
        .marketplace-category-btn {
            padding: 15px 20px;
            text-align: center;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .marketplace-category-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .marketplace-category-btn:hover {
            background-color: var(--secondary-color);
        }
        
        /* Spotlight Section */
        .spotlight-section {
            padding: 15px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            margin-bottom: 10px;
            border-radius: 0 0 12px 12px;
        }
        
        .spotlight-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: #FFA500;
            font-weight: 600;
        }
        
        .spotlight-listings {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .spotlight-item {
            min-width: 250px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 12px;
            overflow: hidden;
            background: white;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }
        
        [data-theme="dark"] .spotlight-item {
            background: var(--dark-card);
        }
        
        .spotlight-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.3);
        }
        
        .spotlight-preview {
            height: 100px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .spotlight-info {
            padding: 10px;
        }
        
        .spotlight-title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* My Listings Section */
        .my-listings-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .my-listings-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .my-listings-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .my-listings-info {
            flex: 1;
        }
        
        .my-listings-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .my-listings-text {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .my-listings-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .my-listing-action-btn {
            flex: 1;
            padding: 12px;
            background-color: var(--secondary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .my-listing-action-btn:hover {
            background-color: #e4e6e9;
        }
        
        .my-listing-action-btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .my-listing-action-btn.primary:hover {
            background-color: #0073e6;
        }
        
        .my-listing-action-btn.premium {
            background: var(--premium-gold);
            color: #000;
            font-weight: 700;
        }
        
        .my-listing-action-btn.premium:hover {
            background: linear-gradient(45deg, #FFC107, #FF9800);
        }
        
        /* Marketplace List */
        .marketplace-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .marketplace-list-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .section-title {
            padding: 15px 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .listing-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--bg-color);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .listing-item.featured {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.05), rgba(255, 215, 0, 0.02));
            border-left: 4px solid #FFD700;
        }
        
        .listing-item:hover {
            background-color: var(--secondary-color);
        }
        
        .listing-avatar {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .listing-info {
            flex: 1;
            min-width: 0;
        }
        
        .listing-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .listing-time {
            color: var(--text-secondary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .listing-preview {
            color: var(--text-secondary);
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .listing-price {
            background-color: var(--primary-color);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        .availability-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            color: white;
            margin-left: 5px;
        }
        
        .availability-busy {
            background: var(--service-busy);
        }
        
        .availability-free {
            background: var(--service-free);
        }
        
        .availability-urgent {
            background: var(--service-urgent);
        }
        
        /* Mood Filter Badge */
        .mood-filter-badge {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 4px 12px;
            font-size: 12px;
            margin-left: 10px;
            backdrop-filter: blur(10px);
        }
        
        /* Marketplace Detail Panel */
        .marketplace-detail-panel {
            flex: 1;
            background-color: var(--bg-color);
            position: relative;
            display: none;
            overflow: hidden;
        }
        
        .marketplace-detail-panel.active {
            display: flex;
            flex-direction: column;
        }
        
        .marketplace-detail-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0) 100%);
        }
        
        [data-theme="dark"] .marketplace-detail-header {
            background: linear-gradient(to bottom, rgba(30,30,30,0.95) 0%, rgba(30,30,30,0) 100%);
        }
        
        .back-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .marketplace-detail-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }
        
        .marketplace-detail-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .marketplace-detail-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .marketplace-detail-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .marketplace-detail-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 80px 20px 20px;
            overflow-y: auto;
        }
        
        .listing-detail-media {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .listing-detail-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .listing-detail-price {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .listing-detail-description {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .listing-detail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .meta-badge {
            background-color: var(--secondary-color);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trust-badge {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }
        
        .marketplace-detail-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to top, var(--bg-color) 0%, rgba(255,255,255,0) 100%);
            border-top: 1px solid var(--border-color);
        }
        
        .marketplace-detail-actions {
            display: flex;
            gap: 15px;
        }
        
        .marketplace-action-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background-color: var(--secondary-color);
        }
        
        .marketplace-action-btn:hover {
            background-color: #e4e6e9;
            transform: scale(1.1);
        }
        
        .marketplace-action-btn.tip-btn {
            background: var(--premium-gold);
            color: #000;
            font-weight: 600;
        }
        
        /* Tip Button Styles */
        .tip-container {
            position: relative;
        }
        
        .tip-amounts {
            position: absolute;
            bottom: 60px;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            min-width: 200px;
        }
        
        [data-theme="dark"] .tip-amounts {
            background: var(--dark-card);
        }
        
        .tip-amounts.show {
            display: flex;
        }
        
        .tip-option {
            padding: 10px 15px;
            background: var(--secondary-color);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tip-option:hover {
            background: var(--primary-color);
            color: white;
        }
        
        /* Create Listing Modal */
        .create-listing-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .create-listing-modal.active {
            display: flex;
        }
        
        .create-listing-container {
            width: 90%;
            max-width: 600px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            box-shadow: var(--shadow-lg);
        }
        
        .create-listing-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--marketplace-gradient);
            color: white;
        }
        
        .create-listing-header h3 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .create-listing-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        .create-listing-tab {
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .create-listing-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .create-listing-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }
        
        .create-listing-tab-content {
            display: none;
        }
        
        .create-listing-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Premium Tab Styles */
        .premium-feature-tag {
            background: var(--premium-gold);
            color: #000;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
            margin-left: 5px;
        }
        
        .premium-feature {
            border: 2px solid #FFD700;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.05), rgba(255, 215, 0, 0.02));
        }
        
        /* Service Listing Tab */
        .service-listing-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .text-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .textarea-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            min-height: 100px;
            resize: vertical;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }
        
        .availability-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .availability-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .availability-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        /* Digital Items Tab */
        .digital-items-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.05);
        }
        
        .file-upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .file-preview {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .file-preview img,
        .file-preview video {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
        }
        
        .file-info {
            padding: 10px;
            background-color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Trust Circles Tab */
        .trust-circles-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .circles-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .circle-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .circle-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        /* Premium Templates Tab */
        .premium-templates-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .template-option {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .template-option.premium {
            border-color: #FFD700;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.05), rgba(255, 215, 0, 0.02));
        }
        
        .template-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        .template-option.premium.selected {
            border-color: #FFA500;
            background: linear-gradient(45deg, rgba(255, 165, 0, 0.1), rgba(255, 215, 0, 0.05));
        }
        
        .template-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .template-option.premium .template-icon {
            color: #FFD700;
        }
        
        .template-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .template-description {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Mood Filter Section */
        .mood-filter-container {
            background-color: var(--secondary-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .mood-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .mood-option {
            padding: 8px 16px;
            background-color: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mood-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        /* Duration Options */
        .duration-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .duration-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .duration-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        /* Notes Section */
        .notes-container {
            margin-top: 20px;
        }
        
        .private-notes {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            min-height: 60px;
            resize: vertical;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .action-btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .action-btn.primary:hover {
            background-color: #0073e6;
        }
        
        .action-btn.secondary {
            background-color: var(--secondary-color);
            color: var(--text-primary);
        }
        
        .action-btn.secondary:hover {
            background-color: #e4e6e9;
        }
        
        .action-btn.premium {
            background: var(--premium-gold);
            color: #000;
            font-weight: 700;
        }
        
        .action-btn.premium:hover {
            background: linear-gradient(45deg, #FFC107, #FF9800);
        }
        
        /* Saved Items Modal */
        .saved-items-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .saved-items-modal.active {
            display: flex;
        }
        
        .saved-items-container {
            width: 90%;
            max-width: 600px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .saved-items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
            overflow-y: auto;
        }
        
        @media (max-width: 480px) {
            .saved-items-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .saved-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .saved-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .saved-item-preview {
            height: 120px;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        
        .saved-item-info {
            padding: 10px;
            background-color: var(--bg-color);
        }
        
        .saved-item-title {
            font-weight: 600;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .saved-item-price {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        /* My Notes Modal */
        .my-notes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .my-notes-modal.active {
            display: flex;
        }
        
        .my-notes-container {
            width: 90%;
            max-width: 500px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .my-notes-list {
            padding: 20px;
            overflow-y: auto;
        }
        
        .note-item {
            background-color: var(--secondary-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        .note-content {
            margin-bottom: 10px;
        }
        
        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Trust Stats Modal */
        .trust-stats-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .trust-stats-modal.active {
            display: flex;
        }
        
        .trust-stats-container {
            width: 90%;
            max-width: 500px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .trust-stats-content {
            padding: 20px;
            overflow-y: auto;
        }
        
        .trust-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .trust-stat-label {
            color: var(--text-secondary);
        }
        
        .trust-stat-value {
            font-weight: 600;
        }
        
        /* Analytics Dashboard Modal */
        .analytics-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .analytics-modal.active {
            display: flex;
        }
        
        .analytics-container {
            width: 90%;
            max-width: 800px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .analytics-content {
            padding: 20px;
            overflow-y: auto;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .analytics-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .analytics-card-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .analytics-card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .analytics-card-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .analytics-card-change.positive {
            color: var(--success-color);
        }
        
        .analytics-card-change.negative {
            color: var(--danger-color);
        }
        
        .chart-container {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            height: 300px;
            position: relative;
        }
        
        .heatmap-container {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        
        .heatmap-cell {
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            transition: all 0.2s;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 1;
        }
        
        /* Premium Options Modal */
        .premium-options-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .premium-options-modal.active {
            display: flex;
        }
        
        .premium-options-container {
            width: 90%;
            max-width: 500px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .premium-plans {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 20px;
        }
        
        .premium-plan {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .premium-plan.popular {
            border-color: #FFD700;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.05), rgba(255, 215, 0, 0.02));
            position: relative;
            overflow: hidden;
        }
        
        .premium-plan.popular::before {
            content: "POPULAR";
            position: absolute;
            top: 10px;
            right: -30px;
            background: var(--premium-gold);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 30px;
            transform: rotate(45deg);
        }
        
        .premium-plan:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .plan-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .plan-price {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .plan-features {
            text-align: left;
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        .plan-feature {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Team Management Modal */
        .team-management-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .team-management-modal.active {
            display: flex;
        }
        
        .team-management-container {
            width: 90%;
            max-width: 600px;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .team-members {
            padding: 20px;
            overflow-y: auto;
        }
        
        .team-member {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--secondary-color);
            border-radius: 12px;
            margin-bottom: 10px;
        }
        
        .team-member-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .team-member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .team-member-role {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Streak & Gamification */
        .streak-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--secondary-color);
            border-radius: 12px;
            margin-bottom: 10px;
        }
        
        .leaderboard-rank {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            min-width: 30px;
        }
        
        .leaderboard-info {
            flex: 1;
            margin-left: 15px;
        }
        
        .leaderboard-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .notification.active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.warning {
            background-color: var(--warning-color);
        }
        
        .notification.info {
            background-color: var(--info-color);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body {
                overflow: auto;
            }
            
            .app-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow: hidden;
            }
            
            .sidebar {
                width: 100% !important;
                height: 100vh !important;
                max-height: 100vh !important;
                border-right: none !important;
                display: flex !important;
                position: relative !important;
                z-index: auto !important;
            }
            
            .marketplace-detail-panel {
                position: relative !important;
                width: 100% !important;
                height: auto !important;
                z-index: auto !important;
            }
            
            .marketplace-categories {
                padding: 0 10px;
                overflow-x: auto;
            }
            
            .marketplace-category-btn {
                padding: 12px 15px;
                font-size: 14px;
                min-width: 120px;
            }
            
            .create-listing-tabs {
                overflow-x: auto;
            }
            
            .create-listing-tab {
                min-width: 80px;
                padding: 12px;
                font-size: 14px;
            }
            
            .circles-selection {
                grid-template-columns: 1fr;
            }
            
            .marketplace-list-content {
                padding-bottom: 20px !important;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .premium-templates-container {
                grid-template-columns: 1fr;
            }
            
            .premium-plans {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar-header h2 {
                font-size: 20px;
            }
            
            .marketplace-categories {
                padding: 0 5px;
            }
            
            .marketplace-category-btn {
                padding: 10px 12px;
                font-size: 13px;
                min-width: 100px;
            }
        }
        
        /* Dark mode preview */
        .dark-mode-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: none;
        }
        
        [data-theme="dark"] .dark-mode-preview {
            display: block;
        }
        
        /* Upload Progress */
        .upload-progress {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--primary-color);
            width: 0%;
            z-index: 3000;
            transition: width 0.3s ease;
        }
        
        /* Trust Indicator */
        .trust-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .trust-responsive {
            background-color: rgba(0, 132, 255, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(0, 132, 255, 0.2);
        }
        
        .trust-reliable {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }
        
        .trust-new {
            background-color: rgba(255, 149, 0, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }
        
        .trust-verified {
            background: linear-gradient(45deg, #00C9FF, #92FE9D);
            color: white;
            border: none;
        }
        
        .trust-pro {
            background: var(--premium-gold);
            color: #000;
            border: none;
            font-weight: 700;
        }
        
        /* Reserve Badge */
        .reserve-badge {
            background-color: rgba(255, 149, 0, 0.1);
            color: var(--warning-color);
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            border: 1px solid rgba(255, 149, 0, 0.2);
        }
        
        /* Mood Filter Indicator */
        .mood-filter-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: rgba(0, 132, 255, 0.1);
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 132, 255, 0.2);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 132, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Premium Features Grid */
        .premium-features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .premium-feature-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .premium-feature-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        /* Export Options */
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .export-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .export-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        /* Schedule Options */
        .schedule-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .schedule-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .schedule-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        /* Bulk Upload */
        .bulk-upload-container {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .bulk-upload-container:hover {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.05);
        }
        
        .bulk-upload-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .bulk-upload-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: var(--secondary-color);
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        /* Exclusive Reactions */
        .reaction-picker {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .reaction-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }
        
        .reaction-option:hover {
            transform: scale(1.2);
        }
        
        .reaction-option.premium {
            background: var(--premium-gold);
            color: #000;
        }
        
        /* Payment Processing */
        .payment-container {
            padding: 20px;
            background: var(--secondary-color);
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .payment-methods {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .payment-method {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .payment-method.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        .payment-form {
            margin-top: 20px;
        }
        
        .payment-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-primary);
        }
        
        /* AR Preview Container */
        .ar-preview-container {
            width: 100%;
            height: 300px;
            background: var(--secondary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .ar-preview-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar with marketplace list -->
        <div class="sidebar active" id="sidebar">
            <div class="sidebar-header">
                <h2>Marketplace <span class="premium-badge" id="premiumStatusBadge" style="display: none;">PRO</span></h2>
                <div style="display: flex; gap: 10px;">
                    <button class="add-listing-btn" id="viewAnalyticsBtn" title="Analytics">
                        <i class="fas fa-chart-bar"></i>
                    </button>
                    <button class="add-listing-btn" id="viewSavedBtn" title="Saved Items">
                        <i class="fas fa-bookmark"></i>
                    </button>
                    <button class="add-listing-btn" id="viewNotesBtn" title="My Notes">
                        <i class="fas fa-sticky-note"></i>
                    </button>
                    <button class="add-listing-btn" id="createListingBtn" title="Create Listing">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="marketplace-categories">
                <button class="marketplace-category-btn active" id="allTab">All Listings</button>
                <button class="marketplace-category-btn" id="servicesTab">Services <span class="listing-price" id="servicesCount">0</span></button>
                <button class="marketplace-category-btn" id="digitalTab">Digital Items</button>
                <button class="marketplace-category-btn" id="friendsTab">Friends Only</button>
                <button class="marketplace-category-btn" id="groupsTab">Group Listings</button>
                <button class="marketplace-category-btn" id="myTab">My Listings</button>
                <button class="marketplace-category-btn" id="premiumTab">Premium <span class="premium-badge" style="font-size: 8px; padding: 1px 4px;">PRO</span></button>
                <button class="marketplace-category-btn" id="spotlightTab">Spotlight <span class="featured-badge" style="font-size: 8px; padding: 1px 4px;">FEATURED</span></button>
            </div>
            
            <!-- Spotlight Section -->
            <div class="spotlight-section" id="spotlightSection" style="display: none;">
                <div class="spotlight-header">
                    <i class="fas fa-star"></i>
                    <span>Featured Listings</span>
                </div>
                <div class="spotlight-listings" id="spotlightListings">
                    <!-- Spotlight items will be loaded here -->
                </div>
            </div>
            
            <!-- Mood Filter Indicator -->
            <div class="mood-filter-indicator" id="moodFilterIndicator" style="display: none;">
                <i class="fas fa-filter"></i>
                <span id="currentMoodFilter">Browsing</span>
            </div>
            
            <!-- My Listings Section -->
            <div class="my-listings-section">
                <div class="my-listings-header">
                    <div class="my-listings-avatar" id="myListingsAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="my-listings-info">
                        <div class="my-listings-name" id="myListingsName">
                            My Marketplace
                            <span class="streak-indicator" id="listingStreak" style="display: none;">
                                <i class="fas fa-fire"></i> <span id="streakCount">0</span>
                            </span>
                        </div>
                        <div class="my-listings-text" id="myListingsText">Tap to create your first listing</div>
                    </div>
                </div>
                <div class="my-listings-actions">
                    <button class="my-listing-action-btn" id="sellServiceBtn">
                        <i class="fas fa-tools"></i> Service
                    </button>
                    <button class="my-listing-action-btn" id="sellDigitalBtn">
                        <i class="fas fa-file-alt"></i> Digital
                    </button>
                    <button class="my-listing-action-btn premium" id="premiumOptionsBtn">
                        <i class="fas fa-crown"></i> Premium
                    </button>
                    <button class="my-listing-action-btn primary" id="createListingQuickBtn">
                        <i class="fas fa-plus"></i> Create
                    </button>
                </div>
            </div>
            
            <div class="marketplace-list">
                <div class="section-title">
                    <span>Available Now</span>
                    <span class="section-count" id="availableListingsCount">0</span>
                </div>
                
                <div class="marketplace-list-content" id="marketplaceListContent">
                    <!-- Listing items will be loaded here -->
                    <div class="loading-placeholder" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
                        <p>Loading marketplace listings...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Marketplace Detail Panel -->
        <div class="marketplace-detail-panel" id="marketplaceDetailPanel">
            <div class="marketplace-detail-header">
                <button class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="marketplace-detail-info">
                    <div class="marketplace-detail-avatar" id="detailAvatar"></div>
                    <div>
                        <div class="marketplace-detail-name" id="detailName"></div>
                        <div class="marketplace-detail-time" id="detailTime"></div>
                    </div>
                </div>
                <button class="marketplace-action-btn" id="detailMenuBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
            
            <div class="marketplace-detail-content" id="marketplaceDetailContent">
                <!-- Listing detail content will be loaded here -->
            </div>
            
            <div class="marketplace-detail-controls">
                <div class="marketplace-detail-actions">
                    <div class="tip-container">
                        <button class="marketplace-action-btn tip-btn" id="tipBtn">
                            <i class="fas fa-gift"></i>
                        </button>
                        <div class="tip-amounts" id="tipAmounts">
                            <div class="tip-option" data-amount="1">$1 <i class="fas fa-coffee"></i></div>
                            <div class="tip-option" data-amount="5">$5 <i class="fas fa-pizza-slice"></i></div>
                            <div class="tip-option" data-amount="10">$10 <i class="fas fa-hamburger"></i></div>
                            <div class="tip-option" data-amount="20">$20 <i class="fas fa-wine-bottle"></i></div>
                            <div class="tip-option" data-amount="custom">Custom Amount</div>
                        </div>
                    </div>
                    <button class="marketplace-action-btn" id="saveListingBtn">
                        <i class="fas fa-bookmark"></i>
                    </button>
                    <button class="marketplace-action-btn" id="addNoteBtn">
                        <i class="fas fa-sticky-note"></i>
                    </button>
                    <button class="marketplace-action-btn" id="addReactionBtn">
                        <i class="fas fa-smile"></i>
                    </button>
                    <button class="marketplace-action-btn" id="reserveBtn">
                        <i class="fas fa-calendar-plus"></i>
                    </button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn secondary" id="shareListingBtn">
                        <i class="fas fa-share"></i> Share
                    </button>
                    <button class="action-btn primary" id="contactSellerBtn">
                        <i class="fas fa-comment"></i> Contact
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Listing Modal -->
    <div class="create-listing-modal" id="createListingModal">
        <div class="create-listing-container">
            <div class="create-listing-header">
                <h3>Create Listing</h3>
                <button class="add-listing-btn" id="closeCreateListingModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="create-listing-tabs">
                <button class="create-listing-tab active" data-tab="service">Service</button>
                <button class="create-listing-tab" data-tab="digital">Digital Item</button>
                <button class="create-listing-tab" data-tab="premium">Premium <span class="premium-feature-tag">PRO</span></button>
                <button class="create-listing-tab" data-tab="templates">Templates</button>
                <button class="create-listing-tab" data-tab="circles">Trust Circles</button>
                <button class="create-listing-tab" data-tab="options">Options</button>
                <button class="create-listing-tab" data-tab="bulk">Bulk <span class="premium-feature-tag">PRO</span></button>
            </div>
            
            <div class="create-listing-content">
                <!-- Service Listing Tab -->
                <div class="create-listing-tab-content active" id="serviceTab">
                    <div class="service-listing-container">
                        <div class="input-group">
                            <label for="serviceTitle">Service Title</label>
                            <input type="text" class="text-input" id="serviceTitle" placeholder="e.g., Graphic Design, Math Tutoring, Phone Repair">
                        </div>
                        
                        <div class="input-group">
                            <label for="serviceDescription">Description</label>
                            <textarea class="textarea-input" id="serviceDescription" placeholder="Describe your service in detail..."></textarea>
                        </div>
                        
                        <div class="input-group">
                            <label for="servicePrice">Price (Optional)</label>
                            <input type="text" class="text-input" id="servicePrice" placeholder="e.g., $20, Free, Negotiable">
                        </div>
                        
                        <div class="input-group">
                            <label>Availability Mood</label>
                            <div class="availability-options">
                                <div class="availability-option" data-availability="free">
                                    <i class="fas fa-check-circle"></i>
                                    <div>Free</div>
                                    <small>Available now</small>
                                </div>
                                <div class="availability-option" data-availability="busy">
                                    <i class="fas fa-clock"></i>
                                    <div>Busy</div>
                                    <small>Limited availability</small>
                                </div>
                                <div class="availability-option" data-availability="urgent">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <div>Urgent</div>
                                    <small>Quick response needed</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Digital Items Tab -->
                <div class="create-listing-tab-content" id="digitalTab">
                    <div class="digital-items-container">
                        <div class="input-group">
                            <label for="digitalTitle">Item Title</label>
                            <input type="text" class="text-input" id="digitalTitle" placeholder="e.g., Study Notes, Resume Template, Design Assets">
                        </div>
                        
                        <div class="input-group">
                            <label for="digitalDescription">Description</label>
                            <textarea class="textarea-input" id="digitalDescription" placeholder="Describe the digital item..."></textarea>
                        </div>
                        
                        <div class="input-group">
                            <label for="digitalPrice">Price (Optional)</label>
                            <input type="text" class="text-input" id="digitalPrice" placeholder="e.g., $5, Free download, Pay what you want">
                        </div>
                        
                        <div class="file-upload-area" id="digitalUploadArea">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h4>Upload Digital File</h4>
                            <p style="color: var(--text-secondary); margin-top: 10px;">Supports: PDF, DOC, ZIP, Images, Audio</p>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Max: 50MB (Premium: 500MB)</p>
                            <input type="file" id="digitalUploadInput" accept=".pdf,.doc,.docx,.zip,.jpg,.jpeg,.png,.mp3,.wav,.mp4,.mov,.avi" style="display: none;">
                        </div>
                        
                        <div class="file-preview" id="digitalPreview">
                            <!-- File preview will be shown here -->
                        </div>
                        
                        <!-- Premium AR Preview Option -->
                        <div class="premium-feature" id="arPreviewFeature" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-vr-cardboard" style="color: #FFD700;"></i>
                                <div style="font-weight: 600;">AR Preview (Premium)</div>
                            </div>
                            <div class="ar-preview-container">
                                <div class="ar-preview-placeholder">
                                    <i class="fas fa-vr-cardboard" style="font-size: 48px; margin-bottom: 10px;"></i>
                                    <p>3D/AR Preview Available</p>
                                    <p style="font-size: 12px;">Upgrade to Premium to enable</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Premium Features Tab -->
                <div class="create-listing-tab-content" id="premiumTab">
                    <div class="premium-features-grid">
                        <div class="premium-feature-card">
                            <div class="premium-feature-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Featured Listing</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Appear in Spotlight section</div>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="featuredListingCheckbox">
                                <label for="featuredListingCheckbox" style="font-size: 12px;">Enable ($5/day)</label>
                            </div>
                        </div>
                        
                        <div class="premium-feature-card">
                            <div class="premium-feature-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Boost Listing</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">2x more visibility</div>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="boostListingCheckbox">
                                <label for="boostListingCheckbox" style="font-size: 12px;">Enable ($3/day)</label>
                            </div>
                        </div>
                        
                        <div class="premium-feature-card">
                            <div class="premium-feature-icon">
                                <i class="fas fa-file-video"></i>
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Video Intro</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Add video presentation</div>
                            <div style="margin-top: 10px;">
                                <button class="action-btn secondary" style="padding: 8px 12px; font-size: 12px;" id="uploadVideoBtn">
                                    <i class="fas fa-upload"></i> Upload Video
                                </button>
                            </div>
                        </div>
                        
                        <div class="premium-feature-card">
                            <div class="premium-feature-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Priority Messaging</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Messages appear first</div>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="priorityMessagingCheckbox">
                                <label for="priorityMessagingCheckbox" style="font-size: 12px;">Enable ($2/day)</label>
                            </div>
                        </div>
                        
                        <div class="premium-feature-card">
                            <div class="premium-feature-icon">
                                <i class="fas fa-sync-alt"></i>
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Auto-Renew</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Keep listing active</div>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="autoRenewCheckbox">
                                <label for="autoRenewCheckbox" style="font-size: 12px;">Enable ($1/day)</label>
                            </div>
                        </div>
                        
                        <div class="premium-feature-card">
                            <div class="premium-feature-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Verified Badge</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Build trust instantly</div>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="verifiedBadgeCheckbox">
                                <label for="verifiedBadgeCheckbox" style="font-size: 12px;">Enable ($10/month)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group" style="margin-top: 20px;">
                        <label>Advanced Analytics</label>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 5px;">
                            Premium users get detailed performance insights for each listing.
                        </div>
                    </div>
                </div>
                
                <!-- Templates Tab -->
                <div class="create-listing-tab-content" id="templatesTab">
                    <div class="premium-templates-container">
                        <div class="template-option" data-template="basic">
                            <div class="template-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="template-name">Basic Template</div>
                            <div class="template-description">Simple and clean layout</div>
                        </div>
                        
                        <div class="template-option premium" data-template="business">
                            <div class="template-icon">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <div class="template-name">Business</div>
                            <div class="template-description">Professional look</div>
                        </div>
                        
                        <div class="template-option premium" data-template="coaching">
                            <div class="template-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="template-name">Coaching</div>
                            <div class="template-description">For mentors & teachers</div>
                        </div>
                        
                        <div class="template-option" data-template="creative">
                            <div class="template-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="template-name">Creative</div>
                            <div class="template-description">Artistic layout</div>
                        </div>
                        
                        <div class="template-option premium" data-template="vip">
                            <div class="template-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="template-name">VIP Service</div>
                            <div class="template-description">Exclusive offerings</div>
                        </div>
                        
                        <div class="template-option" data-template="digital">
                            <div class="template-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="template-name">Digital Product</div>
                            <div class="template-description">For downloads & files</div>
                        </div>
                    </div>
                    
                    <div class="input-group" style="margin-top: 20px;">
                        <label>Custom Template Settings</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                            <div>
                                <label style="font-size: 12px;">Primary Color</label>
                                <input type="color" class="text-input" id="templatePrimaryColor" value="#0084ff" style="height: 40px;">
                            </div>
                            <div>
                                <label style="font-size: 12px;">Font Style</label>
                                <select class="text-input" id="templateFont">
                                    <option>Default</option>
                                    <option>Modern</option>
                                    <option>Elegant</option>
                                    <option>Bold</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trust Circles Tab -->
                <div class="create-listing-tab-content" id="circlesTab">
                    <div class="trust-circles-container">
                        <div class="input-group">
                            <label>Who can see this listing?</label>
                            <div class="circles-selection">
                                <div class="circle-option" data-circle="friends">
                                    <i class="fas fa-user-friends"></i>
                                    <div>Friends Only</div>
                                    <small>Safer, trusted</small>
                                </div>
                                <div class="circle-option" data-circle="groups">
                                    <i class="fas fa-users"></i>
                                    <div>My Groups</div>
                                    <small>Community-based</small>
                                </div>
                                <div class="circle-option" data-circle="selected">
                                    <i class="fas fa-user-check"></i>
                                    <div>Selected People</div>
                                    <small>Manual selection</small>
                                </div>
                                <div class="circle-option premium" data-circle="premium">
                                    <i class="fas fa-crown"></i>
                                    <div>Premium Users Only</div>
                                    <small>Exclusive audience</small>
                                </div>
                                <div class="circle-option" data-circle="public">
                                    <i class="fas fa-globe"></i>
                                    <div>All Users</div>
                                    <small>Maximum visibility</small>
                                </div>
                                <div class="circle-option premium" data-circle="micro">
                                    <i class="fas fa-bullseye"></i>
                                    <div>Micro-Audience</div>
                                    <small>Highly targeted</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group" id="groupSelectionContainer" style="display: none;">
                            <label>Select Groups</label>
                            <div id="groupsList">
                                <!-- Groups will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="input-group" id="peopleSelectionContainer" style="display: none;">
                            <label>Select People</label>
                            <input type="text" class="text-input" id="peopleSearch" placeholder="Search friends...">
                            <div id="peopleList" style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                                <!-- People will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="premium-feature" id="scheduleVisibilityFeature" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-clock" style="color: #FFD700;"></i>
                                <div style="font-weight: 600;">Schedule Visibility (Premium)</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div>
                                    <label style="font-size: 12px;">Show From</label>
                                    <input type="datetime-local" class="text-input" id="visibilityStart">
                                </div>
                                <div>
                                    <label style="font-size: 12px;">Show Until</label>
                                    <input type="datetime-local" class="text-input" id="visibilityEnd">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Options Tab -->
                <div class="create-listing-tab-content" id="optionsTab">
                    <div class="mood-filter-container">
                        <div class="input-group">
                            <label>Mood Context</label>
                            <div class="mood-options">
                                <div class="mood-option" data-mood="help">
                                    <i class="fas fa-hands-helping"></i>
                                    <span>Need Help Now</span>
                                </div>
                                <div class="mood-option" data-mood="browse">
                                    <i class="fas fa-search"></i>
                                    <span>Just Browsing</span>
                                </div>
                                <div class="mood-option" data-mood="learn">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span>Learning Mode</span>
                                </div>
                                <div class="mood-option" data-mood="urgent">
                                    <i class="fas fa-bolt"></i>
                                    <span>Urgent Need</span>
                                </div>
                                <div class="mood-option premium" data-mood="creative">
                                    <i class="fas fa-palette"></i>
                                    <span>Creative Mode</span>
                                </div>
                                <div class="mood-option premium" data-mood="business">
                                    <i class="fas fa-briefcase"></i>
                                    <span>Business Mode</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Listing Duration</label>
                        <div class="duration-options">
                            <div class="duration-option" data-duration="24h">24 Hours</div>
                            <div class="duration-option" data-duration="3d">3 Days</div>
                            <div class="duration-option" data-duration="7d">7 Days</div>
                            <div class="duration-option premium" data-duration="30d">30 Days</div>
                            <div class="duration-option" data-duration="event">Event-Based</div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="expiryDate">Custom Expiry (Optional)</label>
                        <input type="datetime-local" class="text-input" id="expiryDate">
                    </div>
                    
                    <div class="premium-feature" id="recurringPromoFeature" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-sync-alt" style="color: #FFD700;"></i>
                            <div style="font-weight: 600;">Recurring Promotions (Premium)</div>
                        </div>
                        <div class="schedule-options">
                            <div class="schedule-option" data-schedule="daily">
                                Daily
                            </div>
                            <div class="schedule-option" data-schedule="weekly">
                                Weekly
                            </div>
                            <div class="schedule-option" data-schedule="monthly">
                                Monthly
                            </div>
                            <div class="schedule-option" data-schedule="custom">
                                Custom
                            </div>
                        </div>
                    </div>
                    
                    <div class="notes-container">
                        <label for="sellerNotes">Private Notes (For you)</label>
                        <textarea class="private-notes" id="sellerNotes" placeholder="Add private notes about this listing..."></textarea>
                    </div>
                    
                    <div class="premium-feature" id="teamNotesFeature" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-users" style="color: var(--team-color);"></i>
                            <div style="font-weight: 600;">Team Notes (Premium)</div>
                        </div>
                        <textarea class="private-notes" id="teamNotes" placeholder="Add shared notes for your team..."></textarea>
                    </div>
                </div>
                
                <!-- Bulk Upload Tab -->
                <div class="create-listing-tab-content" id="bulkTab">
                    <div class="bulk-upload-container" id="bulkUploadArea">
                        <div class="file-upload-icon">
                            <i class="fas fa-folder-plus"></i>
                        </div>
                        <h4>Bulk Upload Listings</h4>
                        <p style="color: var(--text-secondary); margin-top: 10px;">Upload CSV or JSON file with multiple listings</p>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Supports: CSV, JSON (Max: 100 listings)</p>
                        <input type="file" id="bulkUploadInput" accept=".csv,.json" style="display: none;">
                    </div>
                    
                    <div class="bulk-upload-list" id="bulkUploadList">
                        <!-- Bulk upload items will be shown here -->
                    </div>
                    
                    <div class="input-group">
                        <label>Template for Bulk Upload</label>
                        <select class="text-input" id="bulkTemplate">
                            <option value="service">Services</option>
                            <option value="digital">Digital Items</option>
                            <option value="premium">Premium Templates</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Processing Options</label>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <input type="checkbox" id="autoPublishBulk">
                                <span>Auto-publish after upload</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="scheduleBulk">
                                <span>Schedule listings</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn secondary" id="saveDraftBtn">
                    <i class="fas fa-save"></i> Save Draft
                </button>
                <button class="action-btn premium" id="publishPremiumBtn" style="display: none;">
                    <i class="fas fa-crown"></i> Publish Premium
                </button>
                <button class="action-btn primary" id="publishListingBtn">
                    <i class="fas fa-paper-plane"></i> Publish
                </button>
            </div>
        </div>
    </div>
    
    <!-- Analytics Dashboard Modal -->
    <div class="analytics-modal" id="analyticsModal">
        <div class="analytics-container">
            <div class="create-listing-header">
                <h3>Listing Analytics Dashboard</h3>
                <button class="add-listing-btn" id="closeAnalyticsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="analytics-content">
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-card-title">Total Views</div>
                        <div class="analytics-card-value" id="analyticsViews">0</div>
                        <div class="analytics-card-change positive" id="viewsChange">
                            <i class="fas fa-arrow-up"></i> 0%
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-card-title">Saves</div>
                        <div class="analytics-card-value" id="analyticsSaves">0</div>
                        <div class="analytics-card-change positive" id="savesChange">
                            <i class="fas fa-arrow-up"></i> 0%
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-card-title">Shares</div>
                        <div class="analytics-card-value" id="analyticsShares">0</div>
                        <div class="analytics-card-change positive" id="sharesChange">
                            <i class="fas fa-arrow-up"></i> 0%
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-card-title">Messages</div>
                        <div class="analytics-card-value" id="analyticsMessages">0</div>
                        <div class="analytics-card-change positive" id="messagesChange">
                            <i class="fas fa-arrow-up"></i> 0%
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-card-title">Conversion Rate</div>
                        <div class="analytics-card-value" id="analyticsConversion">0%</div>
                        <div class="analytics-card-change positive" id="conversionChange">
                            <i class="fas fa-arrow-up"></i> 0%
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-card-title">Avg. Engagement</div>
                        <div class="analytics-card-value" id="analyticsEngagement">0s</div>
                        <div class="analytics-card-change positive" id="engagementChange">
                            <i class="fas fa-arrow-up"></i> 0%
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="analyticsChart"></canvas>
                </div>
                
                <div class="heatmap-container">
                    <div style="font-weight: 600; margin-bottom: 10px;">Engagement Heatmap</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">Best times for your listings</div>
                    <div class="heatmap-grid" id="engagementHeatmap">
                        <!-- Heatmap cells will be generated here -->
                    </div>
                </div>
                
                <div class="analytics-card" style="margin-top: 20px;">
                    <div class="analytics-card-title">Competitor Insights (Premium)</div>
                    <div style="font-size: 14px; margin-top: 10px;" id="competitorInsights">
                        Upgrade to Premium to see competitor data and trends
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 20px;">
                    <label>Export Reports</label>
                    <div class="export-options">
                        <div class="export-option" data-format="csv">
                            <i class="fas fa-file-csv"></i>
                            <div>CSV</div>
                        </div>
                        <div class="export-option" data-format="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <div>PDF</div>
                        </div>
                        <div class="export-option premium" data-format="excel">
                            <i class="fas fa-file-excel"></i>
                            <div>Excel</div>
                        </div>
                    </div>
                </div>
                
                <div class="premium-feature" id="analyticsAlertsFeature" style="display: none; margin-top: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-bell" style="color: #FFD700;"></i>
                        <div style="font-weight: 600;">Analytics Alerts (Premium)</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="checkbox" id="alertPoorPerformance">
                            <span>Alert on poor performance</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="alertTrending">
                            <span>Alert when trending</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn secondary" id="refreshAnalyticsBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="action-btn primary" id="exportAnalyticsBtn">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
    
    <!-- Premium Options Modal -->
    <div class="premium-options-modal" id="premiumOptionsModal">
        <div class="premium-options-container">
            <div class="create-listing-header">
                <h3>Upgrade to Premium</h3>
                <button class="add-listing-btn" id="closePremiumModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="premium-plans">
                <div class="premium-plan" data-plan="monthly">
                    <div class="plan-name">Monthly</div>
                    <div class="plan-price">$9.99<span style="font-size: 14px; color: var(--text-secondary);">/month</span></div>
                    <div class="plan-features">
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Featured Listings</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Advanced Analytics</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Priority Messaging</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>500MB Uploads</span>
                        </div>
                    </div>
                    <button class="action-btn primary" data-plan-select="monthly">
                        Select Plan
                    </button>
                </div>
                
                <div class="premium-plan popular" data-plan="quarterly">
                    <div class="plan-name">Quarterly</div>
                    <div class="plan-price">$24.99<span style="font-size: 14px; color: var(--text-secondary);">/3 months</span></div>
                    <div class="plan-features">
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Everything in Monthly</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Verified Badge</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Team Collaboration</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Bulk Upload</span>
                        </div>
                    </div>
                    <button class="action-btn premium" data-plan-select="quarterly">
                        Most Popular
                    </button>
                </div>
                
                <div class="premium-plan" data-plan="yearly">
                    <div class="plan-name">Yearly</div>
                    <div class="plan-price">$79.99<span style="font-size: 14px; color: var(--text-secondary);">/year</span></div>
                    <div class="plan-features">
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Everything in Quarterly</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>AR Previews</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Unlimited Offline Storage</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Priority Sync</span>
                        </div>
                    </div>
                    <button class="action-btn primary" data-plan-select="yearly">
                        Best Value
                    </button>
                </div>
                
                <div class="premium-plan" data-plan="business">
                    <div class="plan-name">Business</div>
                    <div class="plan-price">$199.99<span style="font-size: 14px; color: var(--text-secondary);">/year</span></div>
                    <div class="plan-features">
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Everything in Yearly</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>5 Team Members</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>Custom Branding</span>
                        </div>
                        <div class="plan-feature">
                            <i class="fas fa-check" style="color: var(--success-color);"></i>
                            <span>API Access</span>
                        </div>
                    </div>
                    <button class="action-btn primary" data-plan-select="business">
                        For Teams
                    </button>
                </div>
            </div>
            
            <div class="payment-container" id="paymentContainer" style="display: none; margin: 20px;">
                <h4 style="margin-bottom: 15px;">Payment Information</h4>
                <div class="payment-methods">
                    <div class="payment-method" data-method="card">
                        <i class="fas fa-credit-card" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>Credit Card</div>
                    </div>
                    <div class="payment-method" data-method="paypal">
                        <i class="fab fa-paypal" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>PayPal</div>
                    </div>
                    <div class="payment-method" data-method="crypto">
                        <i class="fas fa-coins" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>Crypto</div>
                    </div>
                </div>
                
                <div class="payment-form" id="cardPaymentForm" style="display: none;">
                    <input type="text" placeholder="Card Number" id="cardNumber">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" placeholder="MM/YY" id="cardExpiry">
                        <input type="text" placeholder="CVC" id="cardCvc">
                    </div>
                    <input type="text" placeholder="Cardholder Name" id="cardName">
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn secondary" id="cancelPaymentBtn">
                        Cancel
                    </button>
                    <button class="action-btn primary" id="completePaymentBtn">
                        Complete Payment
                    </button>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn secondary" id="restorePurchaseBtn">
                    <i class="fas fa-history"></i> Restore Purchase
                </button>
                <button class="action-btn premium" id="startFreeTrialBtn">
                    <i class="fas fa-play-circle"></i> Start 7-Day Free Trial
                </button>
            </div>
        </div>
    </div>
    
    <!-- Team Management Modal -->
    <div class="team-management-modal" id="teamManagementModal">
        <div class="team-management-container">
            <div class="create-listing-header">
                <h3>Team Management</h3>
                <button class="add-listing-btn" id="closeTeamModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="team-members" id="teamMembersList">
                <!-- Team members will be loaded here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn secondary" id="inviteTeamMemberBtn">
                    <i class="fas fa-user-plus"></i> Invite Member
                </button>
                <button class="action-btn primary" id="saveTeamBtn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Saved Items Modal -->
    <div class="saved-items-modal" id="savedItemsModal">
        <div class="saved-items-container">
            <div class="create-listing-header">
                <h3>Saved Items</h3>
                <button class="add-listing-btn" id="closeSavedModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="saved-items-grid" id="savedItemsGrid">
                <!-- Saved items will be added here -->
            </div>
            <div class="action-buttons">
                <button class="action-btn secondary" id="clearSavedBtn">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
        </div>
    </div>
    
    <!-- My Notes Modal -->
    <div class="my-notes-modal" id="myNotesModal">
        <div class="my-notes-container">
            <div class="create-listing-header">
                <h3>My Private Notes</h3>
                <button class="add-listing-btn" id="closeNotesModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="my-notes-list" id="myNotesList">
                <!-- Notes will be added here -->
            </div>
            <div class="action-buttons">
                <button class="action-btn primary" id="addNewNoteBtn">
                    <i class="fas fa-plus"></i> Add Note
                </button>
            </div>
        </div>
    </div>
    
    <!-- Trust Stats Modal -->
    <div class="trust-stats-modal" id="trustStatsModal">
        <div class="trust-stats-container">
            <div class="create-listing-header">
                <h3>Trust Statistics</h3>
            </div>
            <div class="trust-stats-content">
                <div class="trust-stat-item">
                    <span class="trust-stat-label">Listings Created</span>
                    <span class="trust-stat-value" id="listingsCreated">0</span>
                </div>
                <div class="trust-stat-item">
                    <span class="trust-stat-label">Successful Transactions</span>
                    <span class="trust-stat-value" id="successfulTransactions">0</span>
                </div>
                <div class="trust-stat-item">
                    <span class="trust-stat-label">Responsive Rate</span>
                    <span class="trust-stat-value" id="responsiveRate">0%</span>
                </div>
                <div class="trust-stat-item">
                    <span class="trust-stat-label">Trust Score</span>
                    <span class="trust-stat-value" id="trustScore">New</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn secondary" id="closeTrustStatsModal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Leaderboard Modal -->
    <div class="my-notes-modal" id="leaderboardModal">
        <div class="my-notes-container">
            <div class="create-listing-header">
                <h3>Top Sellers Leaderboard</h3>
                <button class="add-listing-btn" id="closeLeaderboardModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="my-notes-list" id="leaderboardList">
                <!-- Leaderboard items will be added here -->
            </div>
            <div class="action-buttons">
                <button class="action-btn secondary" id="refreshLeaderboardBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>
    
    <!-- Reaction Picker Modal -->
    <div class="create-listing-modal" id="reactionPickerModal">
        <div class="create-listing-container" style="max-width: 400px;">
            <div class="create-listing-header">
                <h3>React to Listing</h3>
                <button class="add-listing-btn" id="closeReactionModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 20px;">
                <div class="reaction-picker" id="reactionPicker">
                    <div class="reaction-option" data-reaction="">
                        
                    </div>
                    <div class="reaction-option" data-reaction="">
                        
                    </div>
                    <div class="reaction-option" data-reaction="">
                        
                    </div>
                    <div class="reaction-option" data-reaction="">
                        
                    </div>
                    <div class="reaction-option premium" data-reaction="">
                        
                    </div>
                    <div class="reaction-option premium" data-reaction="">
                        
                    </div>
                    <div class="reaction-option premium" data-reaction="">
                        
                    </div>
                    <div class="reaction-option premium" data-reaction="">
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operation completed successfully</span>
    </div>
    
    <!-- Upload Progress Bar -->
    <div class="upload-progress" id="uploadProgress"></div>

    <!-- Load api.js first -->
    <script src="js/api.js"></script>
    
    <script>
        // =============================================
        // ENHANCED MARKETPLACE SYSTEM WITH PREMIUM FEATURES
        // =============================================

        // Global variables
        let currentUser = null;
        let userData = null;
        let myListings = [];
        let allListings = [];
        let savedItems = [];
        let privateNotes = [];
        let userGroups = [];
        let userFriends = [];
        let currentMoodFilter = null;
        let offlineDrafts = [];
        let trustStats = {};
        let userSubscription = null;
        let teamMembers = [];
        let leaderboardData = [];
        let analyticsData = {};
        let streakData = {};
        let premiumFeatures = {};
        let paymentMethods = [];
        
        // Listing types
        const LISTING_TYPES = {
            SERVICE: 'service',
            DIGITAL: 'digital',
            PHYSICAL: 'physical'
        };
        
        // Availability status
        const AVAILABILITY = {
            FREE: 'free',
            BUSY: 'busy',
            URGENT: 'urgent'
        };
        
        // Mood contexts
        const MOOD_CONTEXTS = {
            HELP: 'help',
            BROWSE: 'browse',
            LEARN: 'learn',
            URGENT: 'urgent',
            CREATIVE: 'creative',
            BUSINESS: 'business'
        };
        
        // Trust circles
        const TRUST_CIRCLES = {
            FRIENDS: 'friends',
            GROUPS: 'groups',
            SELECTED: 'selected',
            PUBLIC: 'public',
            PREMIUM: 'premium',
            MICRO: 'micro'
        };
        
        // Duration options
        const DURATION_OPTIONS = {
            '24h': 24 * 60 * 60 * 1000,
            '3d': 3 * 24 * 60 * 60 * 1000,
            '7d': 7 * 24 * 60 * 60 * 1000,
            '30d': 30 * 24 * 60 * 60 * 1000,
            'event': null
        };
        
        // Trust indicators
        const TRUST_INDICATORS = {
            NEW: { text: 'New', class: 'trust-new' },
            RESPONSIVE: { text: 'Responsive', class: 'trust-responsive' },
            RELIABLE: { text: 'Reliable', class: 'trust-reliable' },
            VERIFIED: { text: 'Verified', class: 'trust-verified' },
            PRO: { text: 'Pro', class: 'trust-pro' }
        };
        
        // Premium subscription plans
        const SUBSCRIPTION_PLANS = {
            MONTHLY: { id: 'monthly', price: 9.99, name: 'Monthly' },
            QUARTERLY: { id: 'quarterly', price: 24.99, name: 'Quarterly' },
            YEARLY: { id: 'yearly', price: 79.99, name: 'Yearly' },
            BUSINESS: { id: 'business', price: 199.99, name: 'Business' }
        };
        
        // Service categories for quick selection
        const SERVICE_CATEGORIES = [
            'Tutoring', 'Design', 'Repair', 'Writing', 'Consulting',
            'Programming', 'Marketing', 'Cleaning', 'Cooking', 'Fitness',
            'Music Lessons', 'Art', 'Photography', 'Video Editing', 'Translation'
        ];
        
        // Premium service categories
        const PREMIUM_CATEGORIES = [
            'Business Consulting', 'Executive Coaching', 'VIP Services',
            'Enterprise Solutions', 'Premium Content', 'Exclusive Access'
        ];
        
        // Digital item types
        const DIGITAL_TYPES = [
            'Study Notes', 'Templates', 'Design Assets', 'E-books', 'Guides',
            'Worksheets', 'Presentations', 'Code Snippets', 'Audio Lessons', 'Wallpapers'
        ];
        
        // Premium digital types
        const PREMIUM_DIGITAL_TYPES = [
            'Premium Templates', 'Master Classes', 'Pro Tools',
            'Exclusive Content', 'AR Assets', '3D Models'
        ];
        
        // Template types
        const TEMPLATE_TYPES = {
            BASIC: 'basic',
            BUSINESS: 'business',
            COACHING: 'coaching',
            CREATIVE: 'creative',
            VIP: 'vip',
            DIGITAL: 'digital'
        };
        
        // Local Storage Keys
        const LOCAL_STORAGE_KEYS = {
            USER: 'knecta_current_user',
            USER_PROFILE: 'knecta_user_profile',
            MY_LISTINGS: 'knecta_my_listings',
            ALL_LISTINGS: 'knecta_all_listings',
            SAVED_ITEMS: 'knecta_saved_items',
            PRIVATE_NOTES: 'knecta_private_notes',
            OFFLINE_DRAFTS: 'knecta_marketplace_drafts',
            TRUST_STATS: 'knecta_trust_stats',
            MOOD_FILTER: 'knecta_marketplace_mood',
            USER_GROUPS: 'knecta_user_groups',
            USER_FRIENDS: 'knecta_user_friends',
            USER_SUBSCRIPTION: 'knecta_user_subscription',
            TEAM_MEMBERS: 'knecta_team_members',
            LEADERBOARD: 'knecta_leaderboard',
            ANALYTICS: 'knecta_analytics',
            STREAK_DATA: 'knecta_streak_data',
            PREMIUM_FEATURES: 'knecta_premium_features',
            PAYMENT_METHODS: 'knecta_payment_methods',
            PREMIUM_LISTINGS: 'knecta_premium_listings',
            SPOTLIGHT_LISTINGS: 'knecta_spotlight_listings'
        };
        
        // DOM Elements
        const marketplaceDetailPanel = document.getElementById('marketplaceDetailPanel');
        const createListingModal = document.getElementById('createListingModal');
        const savedItemsModal = document.getElementById('savedItemsModal');
        const myNotesModal = document.getElementById('myNotesModal');
        const trustStatsModal = document.getElementById('trustStatsModal');
        const analyticsModal = document.getElementById('analyticsModal');
        const premiumOptionsModal = document.getElementById('premiumOptionsModal');
        const teamManagementModal = document.getElementById('teamManagementModal');
        const leaderboardModal = document.getElementById('leaderboardModal');
        const reactionPickerModal = document.getElementById('reactionPickerModal');
        const notification = document.getElementById('notification');
        
        // Marketplace sections
        const marketplaceListContent = document.getElementById('marketplaceListContent');
        const myListingsAvatar = document.getElementById('myListingsAvatar');
        const myListingsName = document.getElementById('myListingsName');
        const myListingsText = document.getElementById('myListingsText');
        const spotlightSection = document.getElementById('spotlightSection');
        const spotlightListings = document.getElementById('spotlightListings');
        const premiumStatusBadge = document.getElementById('premiumStatusBadge');
        const listingStreak = document.getElementById('listingStreak');
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Handle iframe token passing
            if (window.self !== window.top) {
                handleIframeAuth();
            }
            
            // Load data from localStorage for instant display
            loadCachedDataInstantly();
            
            // Initialize app after a short delay
            setTimeout(() => {
                initializeEnhancedMarketplace();
            }, 100);
        });
        
        function handleIframeAuth() {
            try {
                if (window.parent && window.parent.getAuthToken) {
                    const token = window.parent.getAuthToken();
                    if (token) {
                        localStorage.setItem('knecta_auth_token', token);
                    }
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const tokenFromUrl = urlParams.get('token');
                if (tokenFromUrl) {
                    localStorage.setItem('knecta_auth_token', tokenFromUrl);
                }
                
            } catch (error) {
                console.log('Iframe auth handling:', error);
            }
        }
        
        function loadCachedDataInstantly() {
            console.log('=== INSTANT MARKETPLACE CACHE LOAD START ===');
            
            try {
                // Load user from cache immediately
                const cachedUser = localStorage.getItem(LOCAL_STORAGE_KEYS.USER);
                if (cachedUser) {
                    currentUser = JSON.parse(cachedUser);
                }
                
                // Load user profile from cache
                const cachedProfile = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_PROFILE);
                if (cachedProfile) {
                    userData = JSON.parse(cachedProfile);
                    
                    // Update my listings section
                    if (myListingsAvatar) {
                        if (userData.photoURL) {
                            myListingsAvatar.style.backgroundImage = `url('${escapeHtml(userData.photoURL)}')`;
                            myListingsAvatar.innerHTML = '';
                        } else {
                            const initials = userData.displayName ? 
                                userData.displayName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2) : 
                                'ME';
                            myListingsAvatar.innerHTML = `<span style="color: white; font-size: 20px;">${initials}</span>`;
                        }
                    }
                    
                    if (myListingsName) {
                        myListingsName.textContent = userData.displayName || 'My Marketplace';
                    }
                }
                
                // Load my listings from cache
                const myListingsData = localStorage.getItem(LOCAL_STORAGE_KEYS.MY_LISTINGS);
                if (myListingsData) {
                    myListings = JSON.parse(myListingsData);
                    updateMyListingsPreview();
                }
                
                // Load all listings
                const allListingsData = localStorage.getItem(LOCAL_STORAGE_KEYS.ALL_LISTINGS);
                if (allListingsData) {
                    allListings = JSON.parse(allListingsData);
                    allListings = allListings.filter(listing => !isListingExpired(listing));
                }
                
                // Load premium listings
                const premiumListingsData = localStorage.getItem(LOCAL_STORAGE_KEYS.PREMIUM_LISTINGS);
                if (premiumListingsData) {
                    const premiumListings = JSON.parse(premiumListingsData);
                    allListings = [...allListings, ...premiumListings];
                }
                
                // Load spotlight listings
                const spotlightListingsData = localStorage.getItem(LOCAL_STORAGE_KEYS.SPOTLIGHT_LISTINGS);
                if (spotlightListingsData) {
                    const spotlightData = JSON.parse(spotlightListingsData);
                    renderSpotlightListings(spotlightData);
                }
                
                // Load saved items
                const savedItemsData = localStorage.getItem(LOCAL_STORAGE_KEYS.SAVED_ITEMS);
                if (savedItemsData) {
                    savedItems = JSON.parse(savedItemsData);
                }
                
                // Load private notes
                const privateNotesData = localStorage.getItem(LOCAL_STORAGE_KEYS.PRIVATE_NOTES);
                if (privateNotesData) {
                    privateNotes = JSON.parse(privateNotesData);
                }
                
                // Load offline drafts
                const draftsData = localStorage.getItem(LOCAL_STORAGE_KEYS.OFFLINE_DRAFTS);
                if (draftsData) {
                    offlineDrafts = JSON.parse(draftsData);
                }
                
                // Load trust stats
                const trustStatsData = localStorage.getItem(LOCAL_STORAGE_KEYS.TRUST_STATS);
                if (trustStatsData) {
                    trustStats = JSON.parse(trustStatsData);
                }
                
                // Load mood filter
                const moodFilterData = localStorage.getItem(LOCAL_STORAGE_KEYS.MOOD_FILTER);
                if (moodFilterData) {
                    currentMoodFilter = moodFilterData;
                    updateMoodFilterIndicator();
                }
                
                // Load user groups
                const groupsData = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_GROUPS);
                if (groupsData) {
                    userGroups = JSON.parse(groupsData);
                }
                
                // Load user friends
                const friendsData = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_FRIENDS);
                if (friendsData) {
                    userFriends = JSON.parse(friendsData);
                }
                
                // Load user subscription
                const subscriptionData = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION);
                if (subscriptionData) {
                    userSubscription = JSON.parse(subscriptionData);
                    updatePremiumStatusUI();
                }
                
                // Load team members
                const teamData = localStorage.getItem(LOCAL_STORAGE_KEYS.TEAM_MEMBERS);
                if (teamData) {
                    teamMembers = JSON.parse(teamData);
                }
                
                // Load leaderboard
                const leaderboardDataCache = localStorage.getItem(LOCAL_STORAGE_KEYS.LEADERBOARD);
                if (leaderboardDataCache) {
                    leaderboardData = JSON.parse(leaderboardDataCache);
                }
                
                // Load analytics
                const analyticsDataCache = localStorage.getItem(LOCAL_STORAGE_KEYS.ANALYTICS);
                if (analyticsDataCache) {
                    analyticsData = JSON.parse(analyticsDataCache);
                }
                
                // Load streak data
                const streakDataCache = localStorage.getItem(LOCAL_STORAGE_KEYS.STREAK_DATA);
                if (streakDataCache) {
                    streakData = JSON.parse(streakDataCache);
                    updateStreakIndicator();
                }
                
                // Load premium features
                const premiumFeaturesCache = localStorage.getItem(LOCAL_STORAGE_KEYS.PREMIUM_FEATURES);
                if (premiumFeaturesCache) {
                    premiumFeatures = JSON.parse(premiumFeaturesCache);
                }
                
                // Load payment methods
                const paymentMethodsCache = localStorage.getItem(LOCAL_STORAGE_KEYS.PAYMENT_METHODS);
                if (paymentMethodsCache) {
                    paymentMethods = JSON.parse(paymentMethodsCache);
                }
                
                console.log('=== INSTANT MARKETPLACE CACHE LOAD COMPLETE ===');
                
            } catch (error) {
                console.error('Error in instant cache load:', error);
            }
        }
        
        async function initializeEnhancedMarketplace() {
            console.log('=== ENHANCED MARKETPLACE SYSTEM INITIALIZATION START ===');
            
            // Initialize settings manager
            if (typeof settingsManager !== 'undefined') {
                settingsManager.initializeSettings();
            }
            
            // Check for dark mode preference
            checkDarkMode();
            
            // Load user from cache first
            await loadUserFromCache();
            
            // Check premium status
            await checkUserPremiumStatus();
            
            // Load initial data from backend in background
            loadEnhancedMarketplaceData();
            
            // Setup event listeners
            setupEnhancedEventListeners();
            
            // Load service categories
            loadServiceCategories();
            
            // Load groups for selection
            loadGroupsForSelection();
            
            // Load friends for selection
            loadFriendsForSelection();
            
            // Check for expired listings
            cleanupExpiredListings();
            
            // Initialize analytics chart
            initializeAnalyticsChart();
            
            // Generate heatmap
            generateHeatmap();
            
            console.log('=== ENHANCED MARKETPLACE SYSTEM INITIALIZATION COMPLETE ===');
        }
        
        async function loadUserFromCache() {
            try {
                // Try to get user from localStorage first
                const cachedUser = localStorage.getItem(LOCAL_STORAGE_KEYS.USER);
                if (cachedUser) {
                    currentUser = JSON.parse(cachedUser);
                }
                
                // Try to get user data from app.js
                if (window.appState && window.appState.currentUser) {
                    currentUser = window.appState.currentUser;
                }
                
                // Load user profile from cache
                const cachedProfile = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_PROFILE);
                if (cachedProfile) {
                    userData = JSON.parse(cachedProfile);
                }
                
                // If no user found, try to fetch from backend
                if (!currentUser || !currentUser.id) {
                    try {
                        // Use window.api instead of api
                        const response = await window.api('GET', '/api/auth/me');
                        if (response && response.user) {
                            currentUser = response.user;
                            userData = response.user;
                            localStorage.setItem(LOCAL_STORAGE_KEYS.USER, JSON.stringify(currentUser));
                            localStorage.setItem(LOCAL_STORAGE_KEYS.USER_PROFILE, JSON.stringify(userData));
                        }
                    } catch (error) {
                        console.log('No authenticated user found, will use offline mode');
                        currentUser = {
                            id: 'offline_user_' + Date.now(),
                            displayName: 'Guest User',
                            photoURL: '',
                            isOffline: true
                        };
                        userData = currentUser;
                    }
                }
                
            } catch (error) {
                console.error('Error loading user:', error);
                currentUser = {
                    id: 'offline_user_' + Date.now(),
                    displayName: 'Guest User',
                    photoURL: '',
                    isOffline: true
                };
                userData = currentUser;
            }
        }
        
        async function checkUserPremiumStatus() {
            try {
                // Check local storage first
                const localSubscription = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION);
                if (localSubscription) {
                    userSubscription = JSON.parse(localSubscription);
                    
                    // Check if subscription is still valid
                    if (userSubscription.expiresAt && new Date(userSubscription.expiresAt) < new Date()) {
                        userSubscription = null;
                        localStorage.removeItem(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION);
                    } else {
                        updatePremiumStatusUI();
                        return;
                    }
                }
                
                // Check with backend
                const response = await window.api('GET', '/api/user/subscription');
                if (response && response.subscription) {
                    userSubscription = response.subscription;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION, JSON.stringify(userSubscription));
                    updatePremiumStatusUI();
                }
                
            } catch (error) {
                console.error('Error checking premium status:', error);
            }
        }
        
        async function loadEnhancedMarketplaceData() {
            // Load data from backend in background
            setTimeout(async () => {
                try {
                    await loadListingsFromBackend();
                    await loadUserGroups();
                    await loadUserFriends();
                    await loadTeamMembers();
                    await loadLeaderboard();
                    await loadAnalyticsData();
                    await loadPremiumFeatures();
                    await loadSpotlightListingsFromBackend();
                    
                    updateListingCounts();
                    showNotification('Marketplace data loaded', 'success');
                } catch (error) {
                    console.error('Error loading marketplace data:', error);
                    showNotification('Using cached marketplace data', 'info');
                }
            }, 500);
        }
        
        async function loadListingsFromBackend() {
            try {
                // Use window.api instead of api
                const response = await window.api('GET', '/api/marketplace/listings');
                
                if (response && response.listings) {
                    allListings = response.listings;
                    
                    // Filter out expired listings
                    allListings = allListings.filter(listing => !isListingExpired(listing));
                    
                    // Update UI
                    renderMarketplaceList();
                    updateAvailableListingsCount();
                    
                    console.log(`Loaded ${allListings.length} listings from backend`);
                } else {
                    // If no listings from backend, use cache
                    const cachedListings = localStorage.getItem('knecta_marketplace_listings');
                    if (cachedListings) {
                        allListings = JSON.parse(cachedListings);
                        allListings = allListings.filter(listing => !isListingExpired(listing));
                        renderMarketplaceList();
                        updateAvailableListingsCount();
                    }
                }
                
                // Save to cache
                localStorage.setItem('knecta_marketplace_listings', JSON.stringify(allListings));
                
            } catch (error) {
                console.error('Error loading listings from backend:', error);
                const cachedListings = localStorage.getItem('knecta_marketplace_listings');
                if (cachedListings) {
                    allListings = JSON.parse(cachedListings);
                    allListings = allListings.filter(listing => !isListingExpired(listing));
                    renderMarketplaceList();
                    updateAvailableListingsCount();
                }
            }
        }
        
        async function loadUserGroups() {
            try {
                // Use window.api instead of api
                const response = await window.api('GET', '/api/user/groups');
                
                if (response && response.groups) {
                    userGroups = response.groups;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER_GROUPS, JSON.stringify(userGroups));
                }
                
            } catch (error) {
                console.error('Error loading user groups:', error);
            }
        }
        
        async function loadUserFriends() {
            try {
                // Use window.api instead of api
                const response = await window.api('GET', '/api/user/friends');
                
                if (response && response.friends) {
                    userFriends = response.friends;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER_FRIENDS, JSON.stringify(userFriends));
                }
                
            } catch (error) {
                console.error('Error loading user friends:', error);
            }
        }
        
        async function loadTeamMembers() {
            try {
                // Only load if user has team subscription
                if (userSubscription && (userSubscription.plan === 'business' || userSubscription.plan === 'team')) {
                    const response = await window.api('GET', '/api/team/members');
                    
                    if (response && response.members) {
                        teamMembers = response.members;
                        localStorage.setItem(LOCAL_STORAGE_KEYS.TEAM_MEMBERS, JSON.stringify(teamMembers));
                    }
                }
                
            } catch (error) {
                console.error('Error loading team members:', error);
            }
        }
        
        async function loadLeaderboard() {
            try {
                const response = await window.api('GET', '/api/marketplace/leaderboard');
                
                if (response && response.leaderboard) {
                    leaderboardData = response.leaderboard;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.LEADERBOARD, JSON.stringify(leaderboardData));
                }
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }
        
        async function loadAnalyticsData() {
            try {
                if (isUserPremium()) {
                    const response = await window.api('GET', '/api/marketplace/analytics');
                    
                    if (response && response.analytics) {
                        analyticsData = response.analytics;
                        localStorage.setItem(LOCAL_STORAGE_KEYS.ANALYTICS, JSON.stringify(analyticsData));
                        updateAnalyticsDashboard();
                    }
                }
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        async function loadPremiumFeatures() {
            try {
                const response = await window.api('GET', '/api/premium/features');
                
                if (response && response.features) {
                    premiumFeatures = response.features;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.PREMIUM_FEATURES, JSON.stringify(premiumFeatures));
                }
                
            } catch (error) {
                console.error('Error loading premium features:', error);
            }
        }
        
        async function loadSpotlightListingsFromBackend() {
            try {
                const response = await window.api('GET', '/api/marketplace/spotlight');
                
                if (response && response.spotlightListings) {
                    renderSpotlightListings(response.spotlightListings);
                    localStorage.setItem(LOCAL_STORAGE_KEYS.SPOTLIGHT_LISTINGS, JSON.stringify(response.spotlightListings));
                }
                
            } catch (error) {
                console.error('Error loading spotlight listings:', error);
            }
        }
        
        function updatePremiumStatusUI() {
            if (userSubscription && userSubscription.status === 'active') {
                premiumStatusBadge.style.display = 'inline-flex';
                document.getElementById('premiumOptionsBtn').innerHTML = '<i class="fas fa-crown"></i> Premium';
                
                // Show premium features in create modal
                document.querySelectorAll('.premium-feature').forEach(feature => {
                    feature.style.display = 'block';
                });
                
                // Show premium tabs
                document.getElementById('publishPremiumBtn').style.display = 'flex';
                
                // Enable premium uploads
                document.querySelector('#digitalUploadArea p:nth-child(4)').textContent = 'Max: 500MB';
                
                // Show AR preview option
                document.getElementById('arPreviewFeature').style.display = 'block';
                
                // Show team features
                if (userSubscription.plan === 'business' || userSubscription.plan === 'team') {
                    document.getElementById('teamNotesFeature').style.display = 'block';
                    document.getElementById('teamManagementBtn').style.display = 'block';
                }
                
                // Show analytics features
                document.getElementById('analyticsAlertsFeature').style.display = 'block';
                
            } else {
                premiumStatusBadge.style.display = 'none';
                document.getElementById('premiumOptionsBtn').innerHTML = '<i class="fas fa-crown"></i> Premium';
                
                // Hide premium features
                document.querySelectorAll('.premium-feature').forEach(feature => {
                    feature.style.display = 'none';
                });
                
                document.getElementById('publishPremiumBtn').style.display = 'none';
            }
        }
        
        function updateStreakIndicator() {
            if (streakData.currentStreak > 0) {
                listingStreak.style.display = 'flex';
                document.getElementById('streakCount').textContent = streakData.currentStreak;
            } else {
                listingStreak.style.display = 'none';
            }
        }
        
        function updateMyListingsPreview() {
            if (myListings.length > 0) {
                const activeListings = myListings.filter(listing => !isListingExpired(listing));
                myListingsText.textContent = `${activeListings.length} active listings`;
            } else {
                myListingsText.textContent = 'Tap to create your first listing';
            }
        }
        
        function renderSpotlightListings(spotlightData) {
            if (!spotlightData || spotlightData.length === 0) {
                spotlightSection.style.display = 'none';
                return;
            }
            
            spotlightSection.style.display = 'block';
            spotlightListings.innerHTML = '';
            
            spotlightData.forEach(listing => {
                if (isListingExpired(listing)) return;
                
                const spotlightItem = document.createElement('div');
                spotlightItem.className = 'spotlight-item';
                spotlightItem.dataset.listingId = listing.id;
                
                spotlightItem.innerHTML = `
                    <div class="spotlight-preview">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="spotlight-info">
                        <div class="spotlight-title">
                            <span>${escapeHtml(listing.title.substring(0, 30))}${listing.title.length > 30 ? '...' : ''}</span>
                            <span class="featured-badge">FEATURED</span>
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">
                            ${escapeHtml(listing.description?.substring(0, 50) || '')}${listing.description?.length > 50 ? '...' : ''}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: var(--primary-color);">${listing.price || 'Free'}</span>
                            <span style="font-size: 12px; color: var(--text-secondary);">
                                ${formatTimeAgo(new Date(listing.createdAt))}
                            </span>
                        </div>
                    </div>
                `;
                
                if (listing.mediaUrl) {
                    spotlightItem.querySelector('.spotlight-preview').style.backgroundImage = `url('${escapeHtml(listing.mediaUrl)}')`;
                    spotlightItem.querySelector('.spotlight-preview').innerHTML = '';
                }
                
                spotlightItem.addEventListener('click', () => {
                    viewListingDetail(listing);
                });
                
                spotlightListings.appendChild(spotlightItem);
            });
        }
        
        function renderMarketplaceList() {
            marketplaceListContent.innerHTML = '';
            
            if (allListings.length === 0) {
                marketplaceListContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-store-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>No listings available yet</p>
                        <p class="subtext">Be the first to create a listing!</p>
                    </div>
                `;
                return;
            }
            
            // Apply mood filter if set
            let filteredListings = allListings;
            if (currentMoodFilter) {
                filteredListings = filterListingsByMood(allListings, currentMoodFilter);
            }
            
            // Sort listings: featured/boosted first, then regular
            filteredListings.sort((a, b) => {
                const aIsFeatured = a.featured || a.boosted;
                const bIsFeatured = b.featured || b.boosted;
                
                if (aIsFeatured && !bIsFeatured) return -1;
                if (!aIsFeatured && bIsFeatured) return 1;
                
                // Then sort by creation date (newest first)
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // Render each listing
            filteredListings.forEach(listing => {
                if (isListingVisibleToUser(listing)) {
                    addListingItem(listing);
                }
            });
        }
        
        function isListingVisibleToUser(listing) {
            // Check if listing is expired
            if (isListingExpired(listing)) {
                return false;
            }
            
            // Check trust circles
            if (listing.visibility === TRUST_CIRCLES.FRIENDS) {
                // Only show to friends
                return userFriends.some(friend => friend.id === listing.userId);
            } else if (listing.visibility === TRUST_CIRCLES.GROUPS) {
                // Only show to group members
                return listing.allowedGroups && listing.allowedGroups.some(groupId => 
                    userGroups.some(group => group.id === groupId)
                );
            } else if (listing.visibility === TRUST_CIRCLES.SELECTED) {
                // Only show to selected people
                return listing.allowedUsers && listing.allowedUsers.includes(currentUser.id);
            } else if (listing.visibility === TRUST_CIRCLES.PREMIUM) {
                // Only show to premium users
                return isUserPremium();
            } else if (listing.visibility === TRUST_CIRCLES.MICRO) {
                // Show to selected premium users
                return isUserPremium() && listing.allowedUsers && listing.allowedUsers.includes(currentUser.id);
            }
            
            // Public listings are visible to all
            return true;
        }
        
        function filterListingsByMood(listings, mood) {
            switch (mood) {
                case MOOD_CONTEXTS.HELP:
                    // Show listings with urgent availability
                    return listings.filter(listing => 
                        listing.availability === AVAILABILITY.URGENT || 
                        listing.moodContext === MOOD_CONTEXTS.URGENT
                    );
                case MOOD_CONTEXTS.LEARN:
                    // Show digital items and educational services
                    return listings.filter(listing => 
                        listing.type === LISTING_TYPES.DIGITAL ||
                        listing.category?.toLowerCase().includes('tutor') ||
                        listing.category?.toLowerCase().includes('lesson') ||
                        listing.title?.toLowerCase().includes('learn')
                    );
                case MOOD_CONTEXTS.URGENT:
                    // Show listings that need quick response
                    return listings.filter(listing => 
                        listing.availability === AVAILABILITY.URGENT ||
                        listing.expiresSoon
                    );
                case MOOD_CONTEXTS.CREATIVE:
                    // Show creative services and digital art
                    return listings.filter(listing => 
                        listing.category?.toLowerCase().includes('art') ||
                        listing.category?.toLowerCase().includes('design') ||
                        listing.category?.toLowerCase().includes('creative') ||
                        listing.template === 'creative'
                    );
                case MOOD_CONTEXTS.BUSINESS:
                    // Show business and premium services
                    return listings.filter(listing => 
                        listing.category?.toLowerCase().includes('business') ||
                        listing.category?.toLowerCase().includes('consult') ||
                        listing.template === 'business' ||
                        listing.template === 'vip' ||
                        listing.premium === true
                    );
                default:
                    // Browse mode - show all
                    return listings;
            }
        }
        
        function addListingItem(listingData) {
            const listingItem = document.createElement('div');
            listingItem.className = 'listing-item';
            if (listingData.featured || listingData.boosted) {
                listingItem.classList.add('featured');
            }
            listingItem.dataset.listingId = listingData.id;
            listingItem.dataset.userId = listingData.userId;
            
            const userAvatar = listingData.user?.photoURL || '';
            const userName = listingData.user?.displayName || 'Unknown User';
            const userInitials = userName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
            
            const availabilityClass = `availability-${listingData.availability || 'free'}`;
            const availabilityText = listingData.availability ? listingData.availability.charAt(0).toUpperCase() + listingData.availability.slice(1) : 'Available';
            
            listingItem.innerHTML = `
                <div class="listing-avatar" style="${listingData.type === LISTING_TYPES.DIGITAL ? 'background-color: #4caf50;' : ''}">
                    ${listingData.type === LISTING_TYPES.DIGITAL ? '<i class="fas fa-file-alt"></i>' : 
                      listingData.type === LISTING_TYPES.SERVICE ? '<i class="fas fa-tools"></i>' :
                      userAvatar ? '' : `<span style="color: white; font-size: 18px;">${userInitials}</span>`}
                </div>
                <div class="listing-info">
                    <div class="listing-name">
                        <span>${escapeHtml(listingData.title)}</span>
                        ${listingData.price ? `<span class="listing-price">${escapeHtml(listingData.price)}</span>` : ''}
                        ${listingData.featured ? '<span class="featured-badge">FEATURED</span>' : ''}
                        ${listingData.boosted ? '<span class="premium-badge">BOOSTED</span>' : ''}
                        ${listingData.verified ? '<span class="verified-badge">VERIFIED</span>' : ''}
                        ${listingData.teamListing ? '<span class="team-badge">TEAM</span>' : ''}
                    </div>
                    <div class="listing-time">
                        <span>${formatTimeAgo(new Date(listingData.createdAt))}</span>
                        <span class="availability-badge ${availabilityClass}">${availabilityText}</span>
                        ${getTrustIndicator(listingData.userId, listingData.user?.trustLevel)}
                    </div>
                    <div class="listing-preview">
                        ${escapeHtml(listingData.description?.substring(0, 60) || '')}${listingData.description?.length > 60 ? '...' : ''}
                    </div>
                </div>
            `;
            
            if (userAvatar && listingData.type === LISTING_TYPES.SERVICE) {
                listingItem.querySelector('.listing-avatar').style.backgroundImage = `url('${escapeHtml(userAvatar)}')`;
                listingItem.querySelector('.listing-avatar').innerHTML = '';
            }
            
            listingItem.addEventListener('click', () => {
                viewListingDetail(listingData);
            });
            
            marketplaceListContent.appendChild(listingItem);
        }
        
        function getTrustIndicator(userId, trustLevel) {
            if (trustLevel) {
                return `<span class="trust-indicator ${TRUST_INDICATORS[trustLevel.toUpperCase()]?.class || 'trust-new'}">${TRUST_INDICATORS[trustLevel.toUpperCase()]?.text || 'New'}</span>`;
            }
            
            // In real implementation, fetch trust data for the user
            // For now, return a simple indicator
            return '<span class="trust-indicator trust-new">New</span>';
        }
        
        function isUserPremium() {
            return userSubscription && userSubscription.status === 'active';
        }
        
        function viewListingDetail(listingData) {
            // Update detail panel
            document.getElementById('detailName').textContent = listingData.user?.displayName || 'User';
            document.getElementById('detailTime').textContent = formatTimeAgo(new Date(listingData.createdAt));
            
            // Update avatar
            const detailAvatar = document.getElementById('detailAvatar');
            if (listingData.user?.photoURL) {
                detailAvatar.style.backgroundImage = `url('${escapeHtml(listingData.user.photoURL)}')`;
                detailAvatar.innerHTML = '';
            } else {
                const initials = listingData.user?.displayName?.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2) || 'U';
                detailAvatar.innerHTML = `<span style="color: white; font-size: 20px;">${initials}</span>`;
            }
            
            // Clear previous content
            const detailContent = document.getElementById('marketplaceDetailContent');
            detailContent.innerHTML = '';
            
            // Load listing detail based on type
            loadListingDetail(listingData, detailContent);
            
            // Show detail panel
            marketplaceDetailPanel.classList.add('active');
            
            // Store current listing ID
            window.currentListingId = listingData.id;
            window.currentListingData = listingData;
            
            // Track view
            trackListingView(listingData.id);
        }
        
        function loadListingDetail(listingData, container) {
            let detailHTML = '';
            
            // Add video intro if available (premium feature)
            if (listingData.videoIntro) {
                detailHTML += `
                    <div class="file-preview" style="margin-bottom: 20px;">
                        <video controls class="listing-detail-media">
                            <source src="${escapeHtml(listingData.videoIntro)}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
            }
            
            if (listingData.mediaUrl) {
                detailHTML += `
                    <div class="file-preview">
                        <img src="${escapeHtml(listingData.mediaUrl)}" class="listing-detail-media" alt="${escapeHtml(listingData.title)}">
                    </div>
                `;
            }
            
            // Add AR preview placeholder for premium users
            if (listingData.arPreview && isUserPremium()) {
                detailHTML += `
                    <div class="ar-preview-container" style="margin-bottom: 20px;">
                        <div class="ar-preview-placeholder">
                            <i class="fas fa-vr-cardboard" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <p>AR Preview Available</p>
                            <button class="action-btn secondary" style="margin-top: 10px;">
                                <i class="fas fa-eye"></i> View in AR
                            </button>
                        </div>
                    </div>
                `;
            }
            
            detailHTML += `
                <h1 class="listing-detail-title">
                    ${escapeHtml(listingData.title)}
                    ${listingData.featured ? '<span class="featured-badge">FEATURED</span>' : ''}
                    ${listingData.boosted ? '<span class="premium-badge">BOOSTED</span>' : ''}
                    ${listingData.verified ? '<span class="verified-badge">VERIFIED</span>' : ''}
                </h1>
                
                <div class="listing-detail-price">
                    ${listingData.price ? escapeHtml(listingData.price) : 'Free'}
                    ${listingData.acceptsTips ? '<span style="font-size: 14px; color: var(--text-secondary); margin-left: 10px;">(Accepts Tips)</span>' : ''}
                </div>
                
                <div class="listing-detail-description">
                    ${escapeHtml(listingData.description || 'No description provided.')}
                </div>
                
                <div class="listing-detail-meta">
                    <span class="meta-badge">
                        <i class="fas fa-${listingData.type === LISTING_TYPES.DIGITAL ? 'file-alt' : 'tools'}"></i>
                        ${listingData.type === LISTING_TYPES.DIGITAL ? 'Digital Item' : 'Service'}
                    </span>
                    
                    <span class="meta-badge availability-${listingData.availability || 'free'}">
                        <i class="fas fa-${listingData.availability === 'urgent' ? 'exclamation-circle' : 
                                          listingData.availability === 'busy' ? 'clock' : 'check-circle'}"></i>
                        ${listingData.availability ? listingData.availability.charAt(0).toUpperCase() + listingData.availability.slice(1) : 'Available'}
                    </span>
                    
                    ${listingData.visibility ? `
                    <span class="meta-badge ${listingData.visibility === 'premium' || listingData.visibility === 'micro' ? 'premium-feature' : ''}">
                        <i class="fas fa-${listingData.visibility === 'friends' ? 'user-friends' : 
                                         listingData.visibility === 'groups' ? 'users' : 
                                         listingData.visibility === 'selected' ? 'user-check' : 
                                         listingData.visibility === 'premium' ? 'crown' :
                                         listingData.visibility === 'micro' ? 'bullseye' : 'globe'}"></i>
                        ${listingData.visibility === 'friends' ? 'Friends Only' :
                          listingData.visibility === 'groups' ? 'Group Members' :
                          listingData.visibility === 'selected' ? 'Selected People' :
                          listingData.visibility === 'premium' ? 'Premium Only' :
                          listingData.visibility === 'micro' ? 'Micro-Audience' : 'Public'}
                    </span>
                    ` : ''}
                    
                    ${listingData.moodContext ? `
                    <span class="meta-badge ${listingData.moodContext === 'creative' || listingData.moodContext === 'business' ? 'premium-feature' : ''}">
                        <i class="fas fa-${listingData.moodContext === 'help' ? 'hands-helping' :
                                         listingData.moodContext === 'learn' ? 'graduation-cap' :
                                         listingData.moodContext === 'urgent' ? 'bolt' :
                                         listingData.moodContext === 'creative' ? 'palette' :
                                         listingData.moodContext === 'business' ? 'briefcase' : 'search'}"></i>
                        ${listingData.moodContext === 'help' ? 'Help Needed' :
                          listingData.moodContext === 'learn' ? 'Learning' :
                          listingData.moodContext === 'urgent' ? 'Urgent' :
                          listingData.moodContext === 'creative' ? 'Creative' :
                          listingData.moodContext === 'business' ? 'Business' : 'Browsing'}
                    </span>
                    ` : ''}
                    
                    ${listingData.template ? `
                    <span class="meta-badge ${listingData.template === 'business' || listingData.template === 'coaching' || listingData.template === 'vip' ? 'premium-feature' : ''}">
                        <i class="fas fa-${listingData.template === 'business' ? 'briefcase' :
                                         listingData.template === 'coaching' ? 'chalkboard-teacher' :
                                         listingData.template === 'creative' ? 'palette' :
                                         listingData.template === 'vip' ? 'crown' :
                                         listingData.template === 'digital' ? 'download' : 'file-alt'}"></i>
                        ${listingData.template === 'business' ? 'Business' :
                          listingData.template === 'coaching' ? 'Coaching' :
                          listingData.template === 'creative' ? 'Creative' :
                          listingData.template === 'vip' ? 'VIP' :
                          listingData.template === 'digital' ? 'Digital' : 'Basic'}
                    </span>
                    ` : ''}
                    
                    <span class="meta-badge trust-${listingData.user?.trustLevel || 'new'}">
                        <i class="fas fa-${listingData.user?.trustLevel === 'verified' ? 'shield-alt' : 
                                         listingData.user?.trustLevel === 'pro' ? 'crown' :
                                         listingData.user?.trustLevel === 'responsive' ? 'comments' : 'star'}"></i>
                        ${listingData.user?.trustLevel ? listingData.user.trustLevel.charAt(0).toUpperCase() + listingData.user.trustLevel.slice(1) : 'New'}
                    </span>
                </div>
                
                ${listingData.teamMembers ? `
                <div style="margin-top: 20px; padding: 15px; background-color: var(--team-color); border-radius: 12px; color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-users"></i>
                        <div style="font-weight: 600;">Team Listing</div>
                    </div>
                    <div style="font-size: 14px;">
                        Managed by ${listingData.teamMembers.length} team members
                    </div>
                </div>
                ` : ''}
                
                ${listingData.expiresAt ? `
                <div style="margin-top: 20px; padding: 15px; background-color: var(--secondary-color); border-radius: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-clock" style="color: var(--warning-color);"></i>
                        <div>
                            <div style="font-weight: 500;">Expires ${formatTimeRemaining(new Date(listingData.expiresAt))}</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                Listed ${formatTimeAgo(new Date(listingData.createdAt))}
                            </div>
                        </div>
                    </div>
                    ${listingData.autoRenew ? `
                    <div style="margin-top: 10px; padding: 10px; background-color: rgba(52, 199, 89, 0.1); border-radius: 8px; border: 1px solid rgba(52, 199, 89, 0.2);">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-sync-alt" style="color: var(--success-color);"></i>
                            <span style="font-size: 14px;">Auto-renew enabled</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
                
                ${listingData.reactions && listingData.reactions.length > 0 ? `
                <div style="margin-top: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">Reactions</div>
                    <div class="reaction-picker">
                        ${listingData.reactions.map(reaction => `
                            <div class="reaction-option ${reaction.premium ? 'premium' : ''}">
                                ${reaction.emoji}
                                <span style="font-size: 12px; margin-left: 5px;">${reaction.count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            container.innerHTML = detailHTML;
            
            // Add download button for digital items
            if (listingData.type === LISTING_TYPES.DIGITAL && listingData.fileUrl) {
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'action-btn primary';
                downloadBtn.style.marginTop = '20px';
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download File';
                downloadBtn.addEventListener('click', () => {
                    downloadDigitalFile(listingData.id, listingData.fileUrl);
                });
                container.appendChild(downloadBtn);
            }
        }
        
        async function downloadDigitalFile(listingId, fileUrl) {
            try {
                // Track download
                await window.api('POST', `/api/marketplace/listings/${listingId}/download`);
                
                // Create download link
                const link = document.createElement('a');
                link.href = fileUrl;
                link.download = fileUrl.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Download started', 'success');
                
            } catch (error) {
                console.error('Error downloading file:', error);
                showNotification('Download failed', 'error');
            }
        }
        
        function formatTimeRemaining(date) {
            const now = new Date();
            const diffMs = date - now;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (diffDays > 0) return `in ${diffDays} day${diffDays > 1 ? 's' : ''}`;
            if (diffHours > 0) return `in ${diffHours} hour${diffHours > 1 ? 's' : ''}`;
            return 'soon';
        }
        
        // Premium Listing Creation Functions
        async function createPremiumServiceListing(title, description, premiumOptions = {}) {
            const listingId = 'listing_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const listing = {
                id: listingId,
                userId: currentUser.id || currentUser._id,
                user: userData,
                type: LISTING_TYPES.SERVICE,
                title: title,
                description: description,
                price: premiumOptions.price,
                availability: premiumOptions.availability || AVAILABILITY.FREE,
                visibility: premiumOptions.visibility || TRUST_CIRCLES.FRIENDS,
                moodContext: premiumOptions.moodContext,
                template: premiumOptions.template,
                featured: premiumOptions.featured || false,
                boosted: premiumOptions.boosted || false,
                verified: premiumOptions.verified || false,
                videoIntro: premiumOptions.videoIntro,
                acceptsTips: premiumOptions.acceptsTips || false,
                autoRenew: premiumOptions.autoRenew || false,
                teamMembers: premiumOptions.teamMembers || [],
                allowedGroups: premiumOptions.allowedGroups,
                allowedUsers: premiumOptions.allowedUsers,
                visibilitySchedule: premiumOptions.visibilitySchedule,
                expiresAt: premiumOptions.expiresAt || new Date(Date.now() + DURATION_OPTIONS['7d']).toISOString(),
                privateNotes: premiumOptions.privateNotes,
                teamNotes: premiumOptions.teamNotes,
                premium: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Process premium features
            if (premiumOptions.featured) {
                await processFeaturedListing(listing);
            }
            
            if (premiumOptions.boosted) {
                await processBoostedListing(listing);
            }
            
            // Add to my listings
            myListings.unshift(listing);
            
            // Update local storage
            saveToLocalStorage(LOCAL_STORAGE_KEYS.MY_LISTINGS, myListings);
            
            // Save to premium listings
            const premiumListings = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.PREMIUM_LISTINGS) || '[]');
            premiumListings.unshift(listing);
            localStorage.setItem(LOCAL_STORAGE_KEYS.PREMIUM_LISTINGS, JSON.stringify(premiumListings));
            
            // Send to backend using window.api
            try {
                const response = await window.api('POST', '/api/marketplace/listings/premium', listing);
                if (response && response.listing) {
                    listing.id = response.listing.id || listingId;
                    console.log('Premium service listing posted to backend');
                }
            } catch (error) {
                console.log('Offline: Premium listing saved locally');
                queueForSync(listing, 'premium_listing');
            }
            
            // Update UI
            updateMyListingsPreview();
            addListingItem(listing);
            updateAvailableListingsCount();
            
            // Update streak
            updateListingStreak();
            
            // Update all listings
            allListings.unshift(listing);
            localStorage.setItem('knecta_marketplace_listings', JSON.stringify(allListings));
            
            // Update trust stats
            updateTrustStats('listingCreated');
            
            showNotification('Premium service listing published successfully', 'success');
            
            // Process payment if needed
            if (premiumOptions.featured || premiumOptions.boosted) {
                processPremiumPayment(listing, premiumOptions);
            }
            
            return listing;
        }
        
        async function createPremiumDigitalListing(title, description, fileData, premiumOptions = {}) {
            const listingId = 'listing_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const listing = {
                id: listingId,
                userId: currentUser.id || currentUser._id,
                user: userData,
                type: LISTING_TYPES.DIGITAL,
                title: title,
                description: description,
                price: premiumOptions.price,
                mediaUrl: fileData.url,
                fileUrl: fileData.url,
                fileName: fileData.name,
                fileSize: fileData.size,
                fileType: fileData.type,
                visibility: premiumOptions.visibility || TRUST_CIRCLES.FRIENDS,
                moodContext: premiumOptions.moodContext,
                template: premiumOptions.template,
                featured: premiumOptions.featured || false,
                boosted: premiumOptions.boosted || false,
                verified: premiumOptions.verified || false,
                arPreview: premiumOptions.arPreview,
                videoIntro: premiumOptions.videoIntro,
                acceptsTips: premiumOptions.acceptsTips || false,
                autoRenew: premiumOptions.autoRenew || false,
                teamMembers: premiumOptions.teamMembers || [],
                allowedGroups: premiumOptions.allowedGroups,
                allowedUsers: premiumOptions.allowedUsers,
                visibilitySchedule: premiumOptions.visibilitySchedule,
                expiresAt: premiumOptions.expiresAt || new Date(Date.now() + DURATION_OPTIONS['7d']).toISOString(),
                privateNotes: premiumOptions.privateNotes,
                teamNotes: premiumOptions.teamNotes,
                premium: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Process premium features
            if (premiumOptions.featured) {
                await processFeaturedListing(listing);
            }
            
            if (premiumOptions.boosted) {
                await processBoostedListing(listing);
            }
            
            // Add to my listings
            myListings.unshift(listing);
            
            // Update local storage
            saveToLocalStorage(LOCAL_STORAGE_KEYS.MY_LISTINGS, myListings);
            
            // Save to premium listings
            const premiumListings = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.PREMIUM_LISTINGS) || '[]');
            premiumListings.unshift(listing);
            localStorage.setItem(LOCAL_STORAGE_KEYS.PREMIUM_LISTINGS, JSON.stringify(premiumListings));
            
            // Send to backend using window.api
            try {
                const response = await window.api('POST', '/api/marketplace/listings/premium', listing);
                if (response && response.listing) {
                    listing.id = response.listing.id || listingId;
                    console.log('Premium digital listing posted to backend');
                }
            } catch (error) {
                console.log('Offline: Premium listing saved locally');
                queueForSync(listing, 'premium_listing');
            }
            
            // Update UI
            updateMyListingsPreview();
            addListingItem(listing);
            updateAvailableListingsCount();
            
            // Update streak
            updateListingStreak();
            
            // Update all listings
            allListings.unshift(listing);
            localStorage.setItem('knecta_marketplace_listings', JSON.stringify(allListings));
            
            // Update trust stats
            updateTrustStats('listingCreated');
            
            showNotification('Premium digital listing published successfully', 'success');
            
            // Process payment if needed
            if (premiumOptions.featured || premiumOptions.boosted) {
                processPremiumPayment(listing, premiumOptions);
            }
            
            return listing;
        }
        
        async function processFeaturedListing(listing) {
            try {
                // Add to spotlight listings
                const spotlightListings = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.SPOTLIGHT_LISTINGS) || '[]');
                spotlightListings.unshift(listing);
                localStorage.setItem(LOCAL_STORAGE_KEYS.SPOTLIGHT_LISTINGS, JSON.stringify(spotlightListings));
                
                // Update UI
                renderSpotlightListings(spotlightListings);
                
                // Send to backend
                await window.api('POST', '/api/marketplace/spotlight', { listingId: listing.id });
                
            } catch (error) {
                console.error('Error processing featured listing:', error);
            }
        }
        
        async function processBoostedListing(listing) {
            try {
                // Send boost request to backend
                await window.api('POST', '/api/marketplace/boost', { 
                    listingId: listing.id,
                    duration: '24h'
                });
                
            } catch (error) {
                console.error('Error processing boosted listing:', error);
            }
        }
        
        async function processPremiumPayment(listing, options) {
            const paymentAmount = calculatePremiumCost(options);
            
            try {
                const paymentData = {
                    amount: paymentAmount,
                    currency: 'USD',
                    listingId: listing.id,
                    features: {
                        featured: options.featured,
                        boosted: options.boosted,
                        verified: options.verified,
                        autoRenew: options.autoRenew
                    }
                };
                
                const response = await window.api('POST', '/api/payments/process', paymentData);
                
                if (response && response.success) {
                    showNotification('Premium features activated successfully', 'success');
                    return true;
                }
                
            } catch (error) {
                console.error('Payment processing failed:', error);
                showNotification('Payment failed. Please try again.', 'error');
            }
            
            return false;
        }
        
        function calculatePremiumCost(options) {
            let cost = 0;
            
            if (options.featured) cost += 5; // $5 per day
            if (options.boosted) cost += 3; // $3 per day
            if (options.verified) cost += 10; // $10 one-time
            if (options.autoRenew) cost += 1; // $1 per day
            
            return cost;
        }
        
        // Tip System
        async function sendTip(listingId, amount, customAmount = null) {
            const finalAmount = customAmount || amount;
            
            try {
                const tipData = {
                    listingId: listingId,
                    amount: finalAmount,
                    currency: 'USD',
                    message: 'Thanks for your great listing!'
                };
                
                const response = await window.api('POST', '/api/marketplace/tips', tipData);
                
                if (response && response.success) {
                    showNotification(`Tip of $${finalAmount} sent successfully!`, 'success');
                    
                    // Update analytics
                    updateAnalyticsData('tipReceived', finalAmount);
                    
                    return true;
                }
                
            } catch (error) {
                console.error('Error sending tip:', error);
                showNotification('Failed to send tip. Please try again.', 'error');
            }
            
            return false;
        }
        
        // Analytics Functions
        function initializeAnalyticsChart() {
            const ctx = document.getElementById('analyticsChart');
            if (!ctx) return;
            
            window.analyticsChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Views',
                        data: [12, 19, 15, 25, 22, 30, 28],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'Saves',
                        data: [5, 8, 6, 12, 10, 15, 13],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
        
        function updateAnalyticsDashboard() {
            if (!analyticsData) return;
            
            // Update summary cards
            document.getElementById('analyticsViews').textContent = analyticsData.views || 0;
            document.getElementById('analyticsSaves').textContent = analyticsData.saves || 0;
            document.getElementById('analyticsShares').textContent = analyticsData.shares || 0;
            document.getElementById('analyticsMessages').textContent = analyticsData.messages || 0;
            document.getElementById('analyticsConversion').textContent = analyticsData.conversionRate ? `${analyticsData.conversionRate}%` : '0%';
            document.getElementById('analyticsEngagement').textContent = analyticsData.avgEngagement ? `${analyticsData.avgEngagement}s` : '0s';
            
            // Update changes
            updateChangeIndicator('viewsChange', analyticsData.viewsChange);
            updateChangeIndicator('savesChange', analyticsData.savesChange);
            updateChangeIndicator('sharesChange', analyticsData.sharesChange);
            updateChangeIndicator('messagesChange', analyticsData.messagesChange);
            updateChangeIndicator('conversionChange', analyticsData.conversionChange);
            updateChangeIndicator('engagementChange', analyticsData.engagementChange);
            
            // Update competitor insights for premium users
            if (isUserPremium() && analyticsData.competitorInsights) {
                document.getElementById('competitorInsights').innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>Category Average:</strong> ${analyticsData.competitorInsights.categoryAvg} views/day
                    </div>
                    <div>
                        <strong>Top Performers:</strong> ${analyticsData.competitorInsights.topPerformers} views/day
                    </div>
                `;
            }
        }
        
        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            if (!element || change === undefined) return;
            
            const isPositive = change >= 0;
            element.className = `analytics-card-change ${isPositive ? 'positive' : 'negative'}`;
            element.innerHTML = `
                <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i>
                ${Math.abs(change)}%
            `;
        }
        
        function generateHeatmap() {
            const heatmapGrid = document.getElementById('engagementHeatmap');
            if (!heatmapGrid) return;
            
            heatmapGrid.innerHTML = '';
            
            // Generate 7x24 heatmap cells (7 days, 24 hours)
            for (let hour = 0; hour < 24; hour++) {
                for (let day = 0; day < 7; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    
                    // Simulated engagement data (in real app, use actual data)
                    const engagement = Math.floor(Math.random() * 100);
                    const intensity = Math.min(Math.floor(engagement / 20), 4);
                    
                    const colors = [
                        'rgba(75, 192, 192, 0.1)',
                        'rgba(75, 192, 192, 0.3)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(75, 192, 192, 0.9)'
                    ];
                    
                    cell.style.backgroundColor = colors[intensity];
                    cell.title = `${engagement} engagements`;
                    
                    if (engagement > 50) {
                        cell.innerHTML = '';
                    }
                    
                    heatmapGrid.appendChild(cell);
                }
            }
        }
        
        function updateAnalyticsData(type, value) {
            if (!analyticsData[type]) {
                analyticsData[type] = 0;
            }
            
            analyticsData[type] += value;
            localStorage.setItem(LOCAL_STORAGE_KEYS.ANALYTICS, JSON.stringify(analyticsData));
            
            // Update dashboard if open
            if (analyticsModal.classList.contains('active')) {
                updateAnalyticsDashboard();
            }
        }
        
        // Streak System
        function updateListingStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (!streakData.lastListingDate) {
                // First listing ever
                streakData = {
                    currentStreak: 1,
                    longestStreak: 1,
                    lastListingDate: today,
                    totalListings: 1
                };
            } else if (streakData.lastListingDate === today) {
                // Already listed today
                streakData.totalListings++;
            } else if (streakData.lastListingDate === yesterday) {
                // Listed yesterday - continue streak
                streakData.currentStreak++;
                streakData.totalListings++;
                streakData.lastListingDate = today;
                
                if (streakData.currentStreak > streakData.longestStreak) {
                    streakData.longestStreak = streakData.currentStreak;
                }
            } else {
                // Streak broken
                streakData.currentStreak = 1;
                streakData.totalListings++;
                streakData.lastListingDate = today;
            }
            
            // Save streak data
            localStorage.setItem(LOCAL_STORAGE_KEYS.STREAK_DATA, JSON.stringify(streakData));
            
            // Update UI
            updateStreakIndicator();
            
            // Check for streak rewards
            checkStreakRewards();
        }
        
        function checkStreakRewards() {
            const rewards = {
                3: ' 3-day streak! Keep going!',
                7: ' Weekly streak! You earned a badge!',
                30: ' Monthly streak! Premium features unlocked for a week!'
            };
            
            if (rewards[streakData.currentStreak]) {
                showNotification(rewards[streakData.currentStreak], 'success');
                
                if (streakData.currentStreak === 30) {
                    // Award temporary premium access
                    awardTemporaryPremium(7); // 7 days
                }
            }
        }
        
        function awardTemporaryPremium(days) {
            const tempPremium = {
                status: 'active',
                plan: 'temporary',
                expiresAt: new Date(Date.now() + days * 86400000).toISOString(),
                features: ['featured_listings', 'advanced_analytics']
            };
            
            userSubscription = tempPremium;
            localStorage.setItem(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION, JSON.stringify(tempPremium));
            
            updatePremiumStatusUI();
            showNotification(` You've earned ${days} days of premium access!`, 'success');
        }
        
        // Bulk Upload Functions
        async function processBulkUpload(file) {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const content = e.target.result;
                let listings = [];
                
                if (file.type === 'application/json') {
                    listings = JSON.parse(content);
                } else if (file.type === 'text/csv') {
                    listings = parseCSV(content);
                }
                
                if (listings.length > 0) {
                    await uploadBulkListings(listings);
                }
            };
            
            if (file.type === 'application/json') {
                reader.readAsText(file);
            } else if (file.type === 'text/csv') {
                reader.readAsText(file);
            }
        }
        
        function parseCSV(content) {
            const lines = content.split('\n');
            const headers = lines[0].split(',');
            const listings = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const listing = {};
                
                for (let j = 0; j < headers.length; j++) {
                    listing[headers[j].trim()] = values[j] ? values[j].trim() : '';
                }
                
                listings.push(listing);
            }
            
            return listings;
        }
        
        async function uploadBulkListings(listings) {
            const bulkUploadList = document.getElementById('bulkUploadList');
            bulkUploadList.innerHTML = '';
            
            for (let i = 0; i < listings.length; i++) {
                const listing = listings[i];
                
                // Add to UI
                const item = document.createElement('div');
                item.className = 'bulk-upload-item';
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">${escapeHtml(listing.title || 'Untitled')}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${listing.type || 'service'}</div>
                    </div>
                    <div class="loading-spinner"></div>
                `;
                
                bulkUploadList.appendChild(item);
                
                try {
                    // Upload listing
                    const response = await window.api('POST', '/api/marketplace/listings/bulk', listing);
                    
                    if (response && response.success) {
                        item.querySelector('.loading-spinner').style.display = 'none';
                        item.innerHTML += '<i class="fas fa-check" style="color: var(--success-color);"></i>';
                    }
                } catch (error) {
                    item.querySelector('.loading-spinner').style.display = 'none';
                    item.innerHTML += '<i class="fas fa-times" style="color: var(--danger-color);"></i>';
                }
            }
            
            showNotification(`Processed ${listings.length} listings`, 'success');
        }
        
        // Team Management Functions
        function renderTeamMembers() {
            const teamMembersList = document.getElementById('teamMembersList');
            if (!teamMembersList) return;
            
            teamMembersList.innerHTML = '';
            
            if (teamMembers.length === 0) {
                teamMembersList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>No team members yet</p>
                        <p style="font-size: 14px; margin-top: 10px;">Invite team members to collaborate</p>
                    </div>
                `;
                return;
            }
            
            teamMembers.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'team-member';
                
                memberElement.innerHTML = `
                    <div class="team-member-info">
                        <div class="team-member-avatar">
                            ${member.photoURL ? '' : '<i class="fas fa-user"></i>'}
                        </div>
                        <div>
                            <div style="font-weight: 500;">${escapeHtml(member.displayName)}</div>
                            <div class="team-member-role">${member.role || 'Member'}</div>
                        </div>
                    </div>
                    <div>
                        <select class="text-input" style="font-size: 12px; padding: 5px 10px;" data-member-id="${member.id}">
                            <option value="member" ${member.role === 'member' ? 'selected' : ''}>Member</option>
                            <option value="editor" ${member.role === 'editor' ? 'selected' : ''}>Editor</option>
                            <option value="admin" ${member.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        <button class="marketplace-action-btn remove-member-btn" style="width: 30px; height: 30px; margin-left: 10px;" data-member-id="${member.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                if (member.photoURL) {
                    memberElement.querySelector('.team-member-avatar').style.backgroundImage = `url('${escapeHtml(member.photoURL)}')`;
                    memberElement.querySelector('.team-member-avatar').innerHTML = '';
                }
                
                teamMembersList.appendChild(memberElement);
            });
        }
        
        // Leaderboard Functions
        function renderLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;
            
            leaderboardList.innerHTML = '';
            
            if (leaderboardData.length === 0) {
                leaderboardList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-trophy" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>No leaderboard data yet</p>
                        <p style="font-size: 14px; margin-top: 10px;">Create listings to appear on the leaderboard</p>
                    </div>
                `;
                return;
            }
            
            leaderboardData.forEach((user, index) => {
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                leaderboardItem.innerHTML = `
                    <div class="leaderboard-rank">${index + 1}</div>
                    <div class="team-member-avatar" style="width: 40px; height: 40px;">
                        ${user.photoURL ? '' : '<i class="fas fa-user"></i>'}
                    </div>
                    <div class="leaderboard-info">
                        <div style="font-weight: 500;">${escapeHtml(user.displayName)}</div>
                        <div class="leaderboard-stats">
                            <span><i class="fas fa-list"></i> ${user.listingsCount}</span>
                            <span><i class="fas fa-star"></i> ${user.rating || '5.0'}</span>
                            <span><i class="fas fa-check-circle"></i> ${user.successfulTransactions}</span>
                        </div>
                    </div>
                    <div style="font-weight: 700; color: var(--primary-color);">
                        ${user.points || 0} pts
                    </div>
                `;
                
                if (user.photoURL) {
                    leaderboardItem.querySelector('.team-member-avatar').style.backgroundImage = `url('${escapeHtml(user.photoURL)}')`;
                    leaderboardItem.querySelector('.team-member-avatar').innerHTML = '';
                }
                
                // Add podium styling for top 3
                if (index === 0) {
                    leaderboardItem.style.background = 'linear-gradient(45deg, #FFD700, #FFA500)';
                    leaderboardItem.style.color = '#000';
                } else if (index === 1) {
                    leaderboardItem.style.background = 'linear-gradient(45deg, #C0C0C0, #A9A9A9)';
                } else if (index === 2) {
                    leaderboardItem.style.background = 'linear-gradient(45deg, #CD7F32, #8B4513)';
                    leaderboardItem.style.color = '#fff';
                }
                
                leaderboardList.appendChild(leaderboardItem);
            });
        }
        
        // Export Functions
        async function exportAnalytics(format) {
            try {
                const response = await window.api('GET', `/api/analytics/export?format=${format}`);
                
                if (response && response.downloadUrl) {
                    // Create download link
                    const link = document.createElement('a');
                    link.href = response.downloadUrl;
                    link.download = `analytics_${new Date().toISOString().split('T')[0]}.${format}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification(`Exported as ${format.toUpperCase()}`, 'success');
                }
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('Export failed', 'error');
            }
        }
        
        // Backup & Restore Functions
        async function backupMarketplaceData() {
            try {
                const backupData = {
                    myListings: myListings,
                    savedItems: savedItems,
                    privateNotes: privateNotes,
                    offlineDrafts: offlineDrafts,
                    trustStats: trustStats,
                    analyticsData: analyticsData,
                    premiumFeatures: premiumFeatures,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `marketplace_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                showNotification('Backup created successfully', 'success');
                
            } catch (error) {
                console.error('Backup failed:', error);
                showNotification('Backup failed', 'error');
            }
        }
        
        async function restoreMarketplaceData(file) {
            try {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup data
                    if (!backupData.timestamp || !backupData.myListings) {
                        throw new Error('Invalid backup file');
                    }
                    
                    // Restore data
                    myListings = backupData.myListings || [];
                    savedItems = backupData.savedItems || [];
                    privateNotes = backupData.privateNotes || [];
                    offlineDrafts = backupData.offlineDrafts || [];
                    trustStats = backupData.trustStats || {};
                    analyticsData = backupData.analyticsData || {};
                    premiumFeatures = backupData.premiumFeatures || {};
                    
                    // Save to localStorage
                    saveToLocalStorage(LOCAL_STORAGE_KEYS.MY_LISTINGS, myListings);
                    saveToLocalStorage(LOCAL_STORAGE_KEYS.SAVED_ITEMS, savedItems);
                    saveToLocalStorage(LOCAL_STORAGE_KEYS.PRIVATE_NOTES, privateNotes);
                    saveToLocalStorage(LOCAL_STORAGE_KEYS.OFFLINE_DRAFTS, offlineDrafts);
                    saveToLocalStorage(LOCAL_STORAGE_KEYS.TRUST_STATS, trustStats);
                    saveToLocalStorage(LOCAL_STORAGE_KEYS.ANALYTICS, analyticsData);
                    saveToLocalStorage(LOCAL_STORAGE_KEYS.PREMIUM_FEATURES, premiumFeatures);
                    
                    // Update UI
                    updateMyListingsPreview();
                    renderMarketplaceList();
                    updateAvailableListingsCount();
                    
                    showNotification('Data restored successfully', 'success');
                };
                
                reader.readAsText(file);
                
            } catch (error) {
                console.error('Restore failed:', error);
                showNotification('Restore failed: Invalid backup file', 'error');
            }
        }
        
        // Helper Functions
        function isListingExpired(listing) {
            if (!listing.expiresAt) return false;
            return new Date(listing.expiresAt) < new Date();
        }
        
        function cleanupExpiredListings() {
            const expiredListings = allListings.filter(listing => isListingExpired(listing));
            if (expiredListings.length > 0) {
                allListings = allListings.filter(listing => !isListingExpired(listing));
                localStorage.setItem('knecta_marketplace_listings', JSON.stringify(allListings));
                
                // Also clean up my listings
                myListings = myListings.filter(listing => !isListingExpired(listing));
                saveToLocalStorage(LOCAL_STORAGE_KEYS.MY_LISTINGS, myListings);
                
                console.log(`Cleaned up ${expiredListings.length} expired listings`);
            }
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return `${Math.floor(diffDays / 7)}w ago`;
        }
        
        function showNotification(message, type = 'success') {
            const notificationText = document.getElementById('notificationText');
            if (!notificationText) return;
            
            notificationText.textContent = message;
            
            notification.className = 'notification';
            notification.classList.add(type);
            
            notification.classList.add('active');
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function checkDarkMode() {
            if (typeof settingsManager !== 'undefined') {
                const darkMode = settingsManager.getSetting('darkMode');
                if (darkMode) {
                    document.body.setAttribute('data-theme', 'dark');
                }
            }
        }
        
        function queueForSync(data, type) {
            const syncQueue = JSON.parse(localStorage.getItem('knecta_sync_queue') || '[]');
            syncQueue.push({
                type: 'marketplace_' + type,
                data: data,
                timestamp: Date.now(),
                retryCount: 0
            });
            localStorage.setItem('knecta_sync_queue', JSON.stringify(syncQueue));
        }
        
        function updateMoodFilterIndicator() {
            const indicator = document.getElementById('moodFilterIndicator');
            const filterText = document.getElementById('currentMoodFilter');
            
            if (currentMoodFilter) {
                indicator.style.display = 'flex';
                
                switch (currentMoodFilter) {
                    case MOOD_CONTEXTS.HELP:
                        filterText.textContent = 'Help Needed';
                        break;
                    case MOOD_CONTEXTS.LEARN:
                        filterText.textContent = 'Learning Mode';
                        break;
                    case MOOD_CONTEXTS.URGENT:
                        filterText.textContent = 'Urgent';
                        break;
                    case MOOD_CONTEXTS.CREATIVE:
                        filterText.textContent = 'Creative Mode';
                        break;
                    case MOOD_CONTEXTS.BUSINESS:
                        filterText.textContent = 'Business Mode';
                        break;
                    default:
                        filterText.textContent = 'Browsing';
                }
            } else {
                indicator.style.display = 'none';
            }
        }
        
        function loadServiceCategories() {
            const serviceTitleInput = document.getElementById('serviceTitle');
            if (serviceTitleInput) {
                // Create datalist for suggestions
                const datalist = document.createElement('datalist');
                datalist.id = 'serviceCategories';
                
                SERVICE_CATEGORIES.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    datalist.appendChild(option);
                });
                
                PREMIUM_CATEGORIES.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.className = 'premium-option';
                    datalist.appendChild(option);
                });
                
                document.body.appendChild(datalist);
                serviceTitleInput.setAttribute('list', 'serviceCategories');
            }
        }
        
        function loadGroupsForSelection() {
            const groupsList = document.getElementById('groupsList');
            if (!groupsList) return;
            
            groupsList.innerHTML = '';
            
            userGroups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'circle-option';
                groupItem.dataset.groupId = group.id;
                
                groupItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #ccc; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <div style="font-weight: 500;">${escapeHtml(group.name)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${group.memberCount || 0} members</div>
                        </div>
                    </div>
                `;
                
                groupItem.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
                
                groupsList.appendChild(groupItem);
            });
        }
        
        function loadFriendsForSelection() {
            const peopleList = document.getElementById('peopleList');
            if (!peopleList) return;
            
            peopleList.innerHTML = '';
            
            userFriends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'circle-option';
                friendItem.dataset.friendId = friend.id;
                
                friendItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #ccc; display: flex; align-items: center; justify-content: center;">
                            ${friend.photoURL ? '' : '<i class="fas fa-user"></i>'}
                        </div>
                        <div style="font-weight: 500;">${escapeHtml(friend.displayName)}</div>
                    </div>
                `;
                
                if (friend.photoURL) {
                    friendItem.querySelector('div').style.backgroundImage = `url('${escapeHtml(friend.photoURL)}')`;
                    friendItem.querySelector('div').innerHTML = '';
                }
                
                friendItem.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
                
                peopleList.appendChild(friendItem);
            });
        }
        
        function updateListingCounts() {
            const servicesCount = document.getElementById('servicesCount');
            if (servicesCount) {
                const serviceListings = allListings.filter(listing => listing.type === LISTING_TYPES.SERVICE);
                servicesCount.textContent = serviceListings.length;
            }
            
            updateAvailableListingsCount();
        }
        
        function updateAvailableListingsCount() {
            const availableCount = document.getElementById('availableListingsCount');
            if (availableCount) {
                availableCount.textContent = allListings.length;
            }
        }
        
        // Enhanced Event Listeners Setup
        function setupEnhancedEventListeners() {
            // Category tabs
            document.getElementById('allTab').addEventListener('click', function() {
                document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                renderMarketplaceList();
            });
            
            document.getElementById('servicesTab').addEventListener('click', function() {
                document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                renderServicesList();
            });
            
            document.getElementById('digitalTab').addEventListener('click', function() {
                document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                renderDigitalList();
            });
            
            document.getElementById('friendsTab').addEventListener('click', function() {
                document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                renderFriendsListings();
            });
            
            document.getElementById('groupsTab').addEventListener('click', function() {
                document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                renderGroupListings();
            });
            
            document.getElementById('myTab').addEventListener('click', function() {
                document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                renderMyListings();
            });
            
            document.getElementById('premiumTab').addEventListener('click', function() {
                document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                renderPremiumListings();
            });
            
            document.getElementById('spotlightTab').addEventListener('click', function() {
                document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                renderSpotlightTab();
            });
            
            // Create listing buttons
            document.getElementById('createListingBtn').addEventListener('click', () => {
                showCreateListingModal();
            });
            
            document.getElementById('createListingQuickBtn').addEventListener('click', () => {
                showCreateListingModal();
            });
            
            document.getElementById('sellServiceBtn').addEventListener('click', () => {
                showCreateListingModal();
                document.querySelector('.create-listing-tab[data-tab="service"]').click();
            });
            
            document.getElementById('sellDigitalBtn').addEventListener('click', () => {
                showCreateListingModal();
                document.querySelector('.create-listing-tab[data-tab="digital"]').click();
            });
            
            document.getElementById('premiumOptionsBtn').addEventListener('click', () => {
                if (isUserPremium()) {
                    showPremiumOptionsModal();
                } else {
                    showPremiumOptionsModal();
                }
            });
            
            // View analytics
            document.getElementById('viewAnalyticsBtn').addEventListener('click', () => {
                if (isUserPremium()) {
                    showAnalyticsModal();
                } else {
                    showNotification('Upgrade to Premium for advanced analytics', 'info');
                    showPremiumOptionsModal();
                }
            });
            
            // View saved items
            document.getElementById('viewSavedBtn').addEventListener('click', () => {
                showSavedItemsModal();
            });
            
            // View notes
            document.getElementById('viewNotesBtn').addEventListener('click', () => {
                showMyNotesModal();
            });
            
            // Create listing modal tabs
            document.querySelectorAll('.create-listing-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    document.querySelectorAll('.create-listing-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.create-listing-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabContent = document.getElementById(`${tabName}Tab`);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                    
                    // Show/hide selection containers based on trust circle
                    if (tabName === 'circles') {
                        updateTrustCircleSelection();
                    }
                    
                    // Handle premium features visibility
                    if (tabName === 'premium' && !isUserPremium()) {
                        document.getElementById('publishPremiumBtn').style.display = 'none';
                        document.getElementById('publishListingBtn').style.display = 'flex';
                    } else if (tabName === 'premium' && isUserPremium()) {
                        document.getElementById('publishPremiumBtn').style.display = 'flex';
                        document.getElementById('publishListingBtn').style.display = 'none';
                    } else {
                        document.getElementById('publishPremiumBtn').style.display = 'none';
                        document.getElementById('publishListingBtn').style.display = 'flex';
                    }
                });
            });
            
            // Availability options
            document.querySelectorAll('.availability-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.availability-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedAvailability = this.dataset.availability;
                });
            });
            
            // Trust circle options
            document.querySelectorAll('.circle-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.circle-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedTrustCircle = this.dataset.circle;
                    updateTrustCircleSelection();
                });
            });
            
            // Template options
            document.querySelectorAll('.template-option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('premium') && !isUserPremium()) {
                        showNotification('Upgrade to Premium for premium templates', 'info');
                        return;
                    }
                    
                    document.querySelectorAll('.template-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedTemplate = this.dataset.template;
                });
            });
            
            // Mood options
            document.querySelectorAll('.mood-option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('premium') && !isUserPremium()) {
                        showNotification('Upgrade to Premium for premium mood filters', 'info');
                        return;
                    }
                    
                    document.querySelectorAll('.mood-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedMoodContext = this.dataset.mood;
                });
            });
            
            // Duration options
            document.querySelectorAll('.duration-option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('premium') && !isUserPremium()) {
                        showNotification('Upgrade to Premium for extended durations', 'info');
                        return;
                    }
                    
                    document.querySelectorAll('.duration-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedDuration = this.dataset.duration;
                });
            });
            
            // Schedule options
            document.querySelectorAll('.schedule-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.schedule-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    window.selectedSchedule = this.dataset.schedule;
                });
            });
            
            // Export options
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('premium') && !isUserPremium()) {
                        showNotification('Upgrade to Premium for Excel exports', 'info');
                        return;
                    }
                    
                    document.querySelectorAll('.export-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    const format = this.dataset.format;
                    exportAnalytics(format);
                });
            });
            
            // File upload
            const digitalUploadArea = document.getElementById('digitalUploadArea');
            const digitalUploadInput = document.getElementById('digitalUploadInput');
            
            if (digitalUploadArea && digitalUploadInput) {
                digitalUploadArea.addEventListener('click', () => {
                    digitalUploadInput.click();
                });
                
                digitalUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    digitalUploadArea.style.borderColor = 'var(--primary-color)';
                    digitalUploadArea.style.backgroundColor = 'rgba(0, 132, 255, 0.05)';
                });
                
                digitalUploadArea.addEventListener('dragleave', () => {
                    digitalUploadArea.style.borderColor = '';
                    digitalUploadArea.style.backgroundColor = '';
                });
                
                digitalUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    digitalUploadArea.style.borderColor = '';
                    digitalUploadArea.style.backgroundColor = '';
                    
                    if (e.dataTransfer.files.length > 0) {
                        handleFileUpload(e.dataTransfer.files[0]);
                    }
                });
                
                digitalUploadInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFileUpload(e.target.files[0]);
                    }
                });
            }
            
            // Bulk upload
            const bulkUploadArea = document.getElementById('bulkUploadArea');
            const bulkUploadInput = document.getElementById('bulkUploadInput');
            
            if (bulkUploadArea && bulkUploadInput) {
                bulkUploadArea.addEventListener('click', () => {
                    if (!isUserPremium()) {
                        showNotification('Upgrade to Premium for bulk uploads', 'info');
                        return;
                    }
                    bulkUploadInput.click();
                });
                
                bulkUploadInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        processBulkUpload(e.target.files[0]);
                    }
                });
            }
            
            // Video upload button
            document.getElementById('uploadVideoBtn')?.addEventListener('click', () => {
                if (!isUserPremium()) {
                    showNotification('Upgrade to Premium for video intros', 'info');
                    return;
                }
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'video/*';
                input.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleVideoUpload(e.target.files[0]);
                    }
                });
                input.click();
            });
            
            // Publish listing buttons
            document.getElementById('publishListingBtn').addEventListener('click', () => {
                publishListingFromModal();
            });
            
            document.getElementById('publishPremiumBtn').addEventListener('click', () => {
                publishPremiumListingFromModal();
            });
            
            // Save draft button
            document.getElementById('saveDraftBtn').addEventListener('click', () => {
                saveCurrentAsDraft();
            });
            
            // Close modals
            document.getElementById('closeCreateListingModal').addEventListener('click', () => {
                createListingModal.classList.remove('active');
            });
            
            document.getElementById('closeAnalyticsModal').addEventListener('click', () => {
                analyticsModal.classList.remove('active');
            });
            
            document.getElementById('closePremiumModal').addEventListener('click', () => {
                premiumOptionsModal.classList.remove('active');
            });
            
            document.getElementById('closeTeamModal').addEventListener('click', () => {
                teamManagementModal.classList.remove('active');
            });
            
            document.getElementById('closeLeaderboardModal').addEventListener('click', () => {
                leaderboardModal.classList.remove('active');
            });
            
            document.getElementById('closeReactionModal').addEventListener('click', () => {
                reactionPickerModal.classList.remove('active');
            });
            
            document.getElementById('closeSavedModal').addEventListener('click', () => {
                savedItemsModal.classList.remove('active');
            });
            
            document.getElementById('closeNotesModal').addEventListener('click', () => {
                myNotesModal.classList.remove('active');
            });
            
            document.getElementById('closeTrustStatsModal').addEventListener('click', () => {
                trustStatsModal.classList.remove('active');
            });
            
            // Back button in detail panel
            document.getElementById('backBtn').addEventListener('click', () => {
                marketplaceDetailPanel.classList.remove('active');
            });
            
            // Detail panel actions
            document.getElementById('saveListingBtn').addEventListener('click', () => {
                const listingId = getCurrentListingId();
                if (listingId) {
                    saveToSavedItems(listingId);
                }
            });
            
            document.getElementById('addNoteBtn').addEventListener('click', () => {
                const listingId = getCurrentListingId();
                if (listingId) {
                    showAddNoteDialog(listingId);
                }
            });
            
            document.getElementById('addReactionBtn').addEventListener('click', () => {
                const listingId = getCurrentListingId();
                if (listingId) {
                    showReactionPicker(listingId);
                }
            });
            
            document.getElementById('reserveBtn').addEventListener('click', () => {
                const listingId = getCurrentListingId();
                if (listingId) {
                    reserveListing(listingId);
                }
            });
            
            // Tip button
            document.getElementById('tipBtn').addEventListener('click', () => {
                const tipAmounts = document.getElementById('tipAmounts');
                tipAmounts.classList.toggle('show');
            });
            
            // Tip options
            document.querySelectorAll('.tip-option').forEach(option => {
                option.addEventListener('click', async function() {
                    const listingId = getCurrentListingId();
                    if (!listingId) return;
                    
                    const amount = this.dataset.amount;
                    
                    if (amount === 'custom') {
                        const customAmount = prompt('Enter custom tip amount ($):');
                        if (customAmount && !isNaN(customAmount) && parseFloat(customAmount) > 0) {
                            await sendTip(listingId, null, parseFloat(customAmount));
                        }
                    } else {
                        await sendTip(listingId, parseFloat(amount));
                    }
                    
                    document.getElementById('tipAmounts').classList.remove('show');
                });
            });
            
            document.getElementById('contactSellerBtn').addEventListener('click', () => {
                const currentListing = getCurrentListing();
                if (currentListing) {
                    openChat(currentListing.userId, currentListing.user?.displayName || 'Seller');
                }
            });
            
            document.getElementById('shareListingBtn').addEventListener('click', () => {
                const currentListing = getCurrentListing();
                if (currentListing) {
                    shareListing(currentListing);
                }
            });
            
            // Detail menu button
            document.getElementById('detailMenuBtn').addEventListener('click', () => {
                showDetailMenu();
            });
            
            // People search
            const peopleSearch = document.getElementById('peopleSearch');
            if (peopleSearch) {
                peopleSearch.addEventListener('input', (e) => {
                    filterFriends(e.target.value);
                });
            }
            
            // Mood filter indicator click
            document.getElementById('moodFilterIndicator').addEventListener('click', () => {
                clearMoodFilter();
            });
            
            // Analytics refresh button
            document.getElementById('refreshAnalyticsBtn').addEventListener('click', async () => {
                try {
                    await loadAnalyticsData();
                    showNotification('Analytics refreshed', 'success');
                } catch (error) {
                    showNotification('Failed to refresh analytics', 'error');
                }
            });
            
            // Analytics export button
            document.getElementById('exportAnalyticsBtn').addEventListener('click', () => {
                const selectedFormat = document.querySelector('.export-option.selected')?.dataset.format || 'csv';
                exportAnalytics(selectedFormat);
            });
            
            // Premium subscription buttons
            document.querySelectorAll('[data-plan-select]').forEach(button => {
                button.addEventListener('click', function() {
                    const plan = this.dataset.planSelect;
                    showPaymentForm(plan);
                });
            });
            
            // Payment methods
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    const methodType = this.dataset.method;
                    showPaymentFormForMethod(methodType);
                });
            });
            
            // Complete payment button
            document.getElementById('completePaymentBtn').addEventListener('click', async () => {
                await processSubscriptionPayment();
            });
            
            // Cancel payment button
            document.getElementById('cancelPaymentBtn').addEventListener('click', () => {
                document.getElementById('paymentContainer').style.display = 'none';
            });
            
            // Free trial button
            document.getElementById('startFreeTrialBtn').addEventListener('click', async () => {
                await startFreeTrial();
            });
            
            // Restore purchase button
            document.getElementById('restorePurchaseBtn').addEventListener('click', async () => {
                await restorePurchase();
            });
            
            // Team management buttons
            document.getElementById('inviteTeamMemberBtn')?.addEventListener('click', () => {
                inviteTeamMember();
            });
            
            document.getElementById('saveTeamBtn')?.addEventListener('click', async () => {
                await saveTeamChanges();
            });
            
            // Leaderboard refresh
            document.getElementById('refreshLeaderboardBtn')?.addEventListener('click', async () => {
                await loadLeaderboard();
                renderLeaderboard();
                showNotification('Leaderboard refreshed', 'success');
            });
            
            // Reaction picker
            document.querySelectorAll('.reaction-option').forEach(option => {
                option.addEventListener('click', function() {
                    if (this.classList.contains('premium') && !isUserPremium()) {
                        showNotification('Upgrade to Premium for exclusive reactions', 'info');
                        return;
                    }
                    
                    const reaction = this.dataset.reaction;
                    const listingId = window.currentListingId;
                    
                    if (listingId) {
                        addReaction(listingId, reaction);
                    }
                });
            });
            
            // Network status for offline support
            window.addEventListener('online', () => {
                showNotification('Back online - syncing marketplace data', 'info');
                syncOfflineMarketplaceData();
            });
            
            window.addEventListener('offline', () => {
                showNotification('Marketplace working offline', 'info');
            });
            
            // Before unload
            window.addEventListener('beforeunload', () => {
                saveAllMarketplaceData();
            });
            
            // Backup and restore buttons (added dynamically)
            setupBackupRestoreButtons();
        }
        
        function getCurrentListingId() {
            return window.currentListingId;
        }
        
        function getCurrentListing() {
            return window.currentListingData;
        }
        
        function updateTrustCircleSelection() {
            const groupsContainer = document.getElementById('groupSelectionContainer');
            const peopleContainer = document.getElementById('peopleSelectionContainer');
            
            if (window.selectedTrustCircle === TRUST_CIRCLES.GROUPS) {
                groupsContainer.style.display = 'block';
                peopleContainer.style.display = 'none';
            } else if (window.selectedTrustCircle === TRUST_CIRCLES.SELECTED || window.selectedTrustCircle === TRUST_CIRCLES.MICRO) {
                groupsContainer.style.display = 'none';
                peopleContainer.style.display = 'block';
            } else {
                groupsContainer.style.display = 'none';
                peopleContainer.style.display = 'none';
            }
        }
        
        function handleFileUpload(file) {
            const preview = document.getElementById('digitalPreview');
            if (!preview) return;
            
            // Check file type and size
            const allowedTypes = ['.pdf', '.doc', '.docx', '.zip', '.jpg', '.jpeg', '.png', '.mp3', '.wav', '.mp4', '.mov', '.avi'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                showNotification('File type not supported', 'error');
                return;
            }
            
            const maxSize = isUserPremium() ? 500 * 1024 * 1024 : 50 * 1024 * 1024;
            
            if (file.size > maxSize) {
                showNotification(`File size must be less than ${isUserPremium() ? '500MB' : '50MB'}`, 'error');
                return;
            }
            
            // Show upload progress
            const progressBar = document.getElementById('uploadProgress');
            progressBar.style.width = '0%';
            
            // Create preview
            const reader = new FileReader();
            reader.onloadstart = function() {
                progressBar.style.width = '10%';
            };
            
            reader.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentLoaded = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentLoaded + '%';
                }
            };
            
            reader.onload = function(e) {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 500);
                
                preview.innerHTML = '';
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100%';
                    img.style.maxHeight = '200px';
                    img.style.objectFit = 'contain';
                    preview.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = e.target.result;
                    video.controls = true;
                    video.style.width = '100%';
                    video.style.maxHeight = '200px';
                    preview.appendChild(video);
                } else {
                    const icon = document.createElement('div');
                    icon.style.textAlign = 'center';
                    icon.style.padding = '40px';
                    icon.innerHTML = `
                        <i class="fas fa-file-alt" style="font-size: 64px; color: var(--primary-color); margin-bottom: 15px;"></i>
                        <div style="font-weight: 500;">${escapeHtml(file.name)}</div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 5px;">
                            ${formatFileSize(file.size)}
                        </div>
                    `;
                    preview.appendChild(icon);
                }
                
                // Add file info
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                fileInfo.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">${escapeHtml(file.name)}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${formatFileSize(file.size)}  ${fileExtension.toUpperCase().replace('.', '')}</div>
                    </div>
                    <button class="marketplace-action-btn remove-file-btn" style="width: 36px; height: 36px;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                fileInfo.querySelector('.remove-file-btn').addEventListener('click', () => {
                    preview.innerHTML = '';
                    window.selectedDigitalFile = null;
                });
                
                preview.appendChild(fileInfo);
                
                // Store file data
                window.selectedDigitalFile = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: e.target.result
                };
            };
            
            reader.readAsDataURL(file);
        }
        
        function handleVideoUpload(file) {
            const maxSize = isUserPremium() ? 500 * 1024 * 1024 : 50 * 1024 * 1024;
            
            if (file.size > maxSize) {
                showNotification(`Video size must be less than ${isUserPremium() ? '500MB' : '50MB'}`, 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                window.selectedVideoIntro = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: e.target.result
                };
                
                showNotification('Video intro uploaded successfully', 'success');
            };
            
            reader.readAsDataURL(file);
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function filterFriends(searchTerm) {
            const peopleList = document.getElementById('peopleList');
            if (!peopleList) return;
            
            const friendItems = peopleList.querySelectorAll('.circle-option');
            friendItems.forEach(item => {
                const friendName = item.querySelector('div:nth-child(2)').textContent.toLowerCase();
                if (friendName.includes(searchTerm.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function showCreateListingModal() {
            createListingModal.classList.add('active');
            
            // Reset form
            document.getElementById('serviceTitle').value = '';
            document.getElementById('serviceDescription').value = '';
            document.getElementById('servicePrice').value = '';
            document.getElementById('digitalTitle').value = '';
            document.getElementById('digitalDescription').value = '';
            document.getElementById('digitalPrice').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('sellerNotes').value = '';
            document.getElementById('teamNotes').value = '';
            document.getElementById('visibilityStart').value = '';
            document.getElementById('visibilityEnd').value = '';
            document.getElementById('templatePrimaryColor').value = '#0084ff';
            document.getElementById('templateFont').value = 'Default';
            
            // Reset selections
            document.querySelectorAll('.availability-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelectorAll('.circle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelectorAll('.template-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelectorAll('.mood-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelectorAll('.duration-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelectorAll('.schedule-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Clear file preview
            const digitalPreview = document.getElementById('digitalPreview');
            if (digitalPreview) {
                digitalPreview.innerHTML = '';
            }
            
            // Reset premium checkboxes
            document.getElementById('featuredListingCheckbox').checked = false;
            document.getElementById('boostListingCheckbox').checked = false;
            document.getElementById('priorityMessagingCheckbox').checked = false;
            document.getElementById('autoRenewCheckbox').checked = false;
            document.getElementById('verifiedBadgeCheckbox').checked = false;
            document.getElementById('alertPoorPerformance').checked = false;
            document.getElementById('alertTrending').checked = false;
            document.getElementById('autoPublishBulk').checked = false;
            document.getElementById('scheduleBulk').checked = false;
            
            window.selectedAvailability = AVAILABILITY.FREE;
            window.selectedTrustCircle = TRUST_CIRCLES.FRIENDS;
            window.selectedTemplate = TEMPLATE_TYPES.BASIC;
            window.selectedMoodContext = MOOD_CONTEXTS.BROWSE;
            window.selectedDuration = '7d';
            window.selectedSchedule = 'daily';
            window.selectedDigitalFile = null;
            window.selectedVideoIntro = null;
            
            // Set default selections
            document.querySelector('.availability-option[data-availability="free"]').classList.add('selected');
            document.querySelector('.circle-option[data-circle="friends"]').classList.add('selected');
            document.querySelector('.template-option[data-template="basic"]').classList.add('selected');
            document.querySelector('.mood-option[data-mood="browse"]').classList.add('selected');
            document.querySelector('.duration-option[data-duration="7d"]').classList.add('selected');
            
            // Show/hide premium features based on user status
            updatePremiumFeaturesVisibility();
        }
        
        function updatePremiumFeaturesVisibility() {
            if (isUserPremium()) {
                document.querySelectorAll('.premium-feature').forEach(feature => {
                    feature.style.display = 'block';
                });
                document.querySelectorAll('.premium-option').forEach(option => {
                    option.disabled = false;
                });
            } else {
                document.querySelectorAll('.premium-feature').forEach(feature => {
                    feature.style.display = 'none';
                });
            }
        }
        
        function showAnalyticsModal() {
            analyticsModal.classList.add('active');
            updateAnalyticsDashboard();
        }
        
        function showPremiumOptionsModal() {
            premiumOptionsModal.classList.add('active');
            document.getElementById('paymentContainer').style.display = 'none';
        }
        
        function showTeamManagementModal() {
            teamManagementModal.classList.add('active');
            renderTeamMembers();
        }
        
        function showLeaderboardModal() {
            leaderboardModal.classList.add('active');
            renderLeaderboard();
        }
        
        function showReactionPicker(listingId) {
            reactionPickerModal.classList.add('active');
            window.currentListingId = listingId;
        }
        
        function publishListingFromModal() {
            const activeTab = document.querySelector('.create-listing-tab.active');
            if (!activeTab) return;
            
            const tabName = activeTab.dataset.tab;
            
            // Get common options
            const price = tabName === 'service' ? 
                document.getElementById('servicePrice').value.trim() : 
                document.getElementById('digitalPrice').value.trim();
            
            const visibility = window.selectedTrustCircle || TRUST_CIRCLES.FRIENDS;
            const moodContext = window.selectedMoodContext || MOOD_CONTEXTS.BROWSE;
            const duration = window.selectedDuration || '7d';
            const expiresAt = duration === 'event' ? null : new Date(Date.now() + DURATION_OPTIONS[duration]).toISOString();
            
            const customExpiry = document.getElementById('expiryDate').value;
            const finalExpiry = customExpiry ? new Date(customExpiry).toISOString() : expiresAt;
            
            const privateNotes = document.getElementById('sellerNotes').value.trim();
            const teamNotes = document.getElementById('teamNotes').value.trim();
            
            // Get allowed groups/users based on visibility
            let allowedGroups = [];
            let allowedUsers = [];
            
            if (visibility === TRUST_CIRCLES.GROUPS) {
                allowedGroups = Array.from(document.querySelectorAll('#groupsList .circle-option.selected'))
                    .map(opt => opt.dataset.groupId);
            } else if (visibility === TRUST_CIRCLES.SELECTED || visibility === TRUST_CIRCLES.MICRO) {
                allowedUsers = Array.from(document.querySelectorAll('#peopleList .circle-option.selected'))
                    .map(opt => opt.dataset.friendId);
            }
            
            // Get visibility schedule
            const visibilityStart = document.getElementById('visibilityStart').value;
            const visibilityEnd = document.getElementById('visibilityEnd').value;
            const visibilitySchedule = (visibilityStart && visibilityEnd) ? {
                start: new Date(visibilityStart).toISOString(),
                end: new Date(visibilityEnd).toISOString()
            } : null;
            
            switch (tabName) {
                case 'service':
                    const serviceTitle = document.getElementById('serviceTitle').value.trim();
                    const serviceDescription = document.getElementById('serviceDescription').value.trim();
                    
                    if (!serviceTitle) {
                        showNotification('Please enter a service title', 'error');
                        return;
                    }
                    
                    const serviceData = {
                        title: serviceTitle,
                        description: serviceDescription,
                        price: price,
                        availability: window.selectedAvailability || AVAILABILITY.FREE,
                        visibility: visibility,
                        moodContext: moodContext,
                        template: window.selectedTemplate || TEMPLATE_TYPES.BASIC,
                        allowedGroups: allowedGroups,
                        allowedUsers: allowedUsers,
                        visibilitySchedule: visibilitySchedule,
                        expiresAt: finalExpiry,
                        privateNotes: privateNotes,
                        teamNotes: teamNotes
                    };
                    
                    createServiceListing(serviceTitle, serviceDescription, serviceData);
                    break;
                    
                case 'digital':
                    const digitalTitle = document.getElementById('digitalTitle').value.trim();
                    const digitalDescription = document.getElementById('digitalDescription').value.trim();
                    
                    if (!digitalTitle) {
                        showNotification('Please enter an item title', 'error');
                        return;
                    }
                    
                    if (!window.selectedDigitalFile) {
                        showNotification('Please upload a digital file', 'error');
                        return;
                    }
                    
                    const digitalData = {
                        title: digitalTitle,
                        description: digitalDescription,
                        price: price,
                        visibility: visibility,
                        moodContext: moodContext,
                        template: window.selectedTemplate || TEMPLATE_TYPES.BASIC,
                        allowedGroups: allowedGroups,
                        allowedUsers: allowedUsers,
                        visibilitySchedule: visibilitySchedule,
                        expiresAt: finalExpiry,
                        privateNotes: privateNotes,
                        teamNotes: teamNotes
                    };
                    
                    createDigitalListing(digitalTitle, digitalDescription, window.selectedDigitalFile, digitalData);
                    break;
                    
                default:
                    showNotification('Please complete the listing form', 'info');
                    return;
            }
            
            // Close modal
            createListingModal.classList.remove('active');
        }
        
        function publishPremiumListingFromModal() {
            const activeTab = document.querySelector('.create-listing-tab.active');
            if (!activeTab) return;
            
            const tabName = activeTab.dataset.tab;
            
            // Get premium options
            const featured = document.getElementById('featuredListingCheckbox').checked;
            const boosted = document.getElementById('boostListingCheckbox').checked;
            const priorityMessaging = document.getElementById('priorityMessagingCheckbox').checked;
            const autoRenew = document.getElementById('autoRenewCheckbox').checked;
            const verified = document.getElementById('verifiedBadgeCheckbox').checked;
            const acceptsTips = true; // Premium listings always accept tips
            
            // Get common options
            const price = tabName === 'service' ? 
                document.getElementById('servicePrice').value.trim() : 
                document.getElementById('digitalPrice').value.trim();
            
            const visibility = window.selectedTrustCircle || TRUST_CIRCLES.FRIENDS;
            const moodContext = window.selectedMoodContext || MOOD_CONTEXTS.BROWSE;
            const duration = window.selectedDuration || '7d';
            const expiresAt = duration === 'event' ? null : new Date(Date.now() + DURATION_OPTIONS[duration]).toISOString();
            
            const customExpiry = document.getElementById('expiryDate').value;
            const finalExpiry = customExpiry ? new Date(customExpiry).toISOString() : expiresAt;
            
            const privateNotes = document.getElementById('sellerNotes').value.trim();
            const teamNotes = document.getElementById('teamNotes').value.trim();
            
            // Get template settings
            const template = window.selectedTemplate || TEMPLATE_TYPES.BASIC;
            const templateColor = document.getElementById('templatePrimaryColor').value;
            const templateFont = document.getElementById('templateFont').value;
            
            // Get recurring promotions
            const schedule = window.selectedSchedule || 'daily';
            
            // Get allowed groups/users based on visibility
            let allowedGroups = [];
            let allowedUsers = [];
            
            if (visibility === TRUST_CIRCLES.GROUPS) {
                allowedGroups = Array.from(document.querySelectorAll('#groupsList .circle-option.selected'))
                    .map(opt => opt.dataset.groupId);
            } else if (visibility === TRUST_CIRCLES.SELECTED || visibility === TRUST_CIRCLES.MICRO) {
                allowedUsers = Array.from(document.querySelectorAll('#peopleList .circle-option.selected'))
                    .map(opt => opt.dataset.friendId);
            }
            
            // Get visibility schedule
            const visibilityStart = document.getElementById('visibilityStart').value;
            const visibilityEnd = document.getElementById('visibilityEnd').value;
            const visibilitySchedule = (visibilityStart && visibilityEnd) ? {
                start: new Date(visibilityStart).toISOString(),
                end: new Date(visibilityEnd).toISOString()
            } : null;
            
            // Get team members if business plan
            let teamMembersList = [];
            if (userSubscription && (userSubscription.plan === 'business' || userSubscription.plan === 'team')) {
                teamMembersList = teamMembers.map(member => ({
                    id: member.id,
                    role: member.role || 'member'
                }));
            }
            
            switch (tabName) {
                case 'service':
                    const serviceTitle = document.getElementById('serviceTitle').value.trim();
                    const serviceDescription = document.getElementById('serviceDescription').value.trim();
                    
                    if (!serviceTitle) {
                        showNotification('Please enter a service title', 'error');
                        return;
                    }
                    
                    const premiumServiceData = {
                        title: serviceTitle,
                        description: serviceDescription,
                        price: price,
                        availability: window.selectedAvailability || AVAILABILITY.FREE,
                        visibility: visibility,
                        moodContext: moodContext,
                        template: template,
                        templateSettings: {
                            color: templateColor,
                            font: templateFont
                        },
                        featured: featured,
                        boosted: boosted,
                        priorityMessaging: priorityMessaging,
                        verified: verified,
                        acceptsTips: acceptsTips,
                        autoRenew: autoRenew,
                        videoIntro: window.selectedVideoIntro?.url,
                        teamMembers: teamMembersList,
                        allowedGroups: allowedGroups,
                        allowedUsers: allowedUsers,
                        visibilitySchedule: visibilitySchedule,
                        recurringPromotions: featured ? schedule : null,
                        expiresAt: finalExpiry,
                        privateNotes: privateNotes,
                        teamNotes: teamNotes
                    };
                    
                    createPremiumServiceListing(serviceTitle, serviceDescription, premiumServiceData);
                    break;
                    
                case 'digital':
                    const digitalTitle = document.getElementById('digitalTitle').value.trim();
                    const digitalDescription = document.getElementById('digitalDescription').value.trim();
                    
                    if (!digitalTitle) {
                        showNotification('Please enter an item title', 'error');
                        return;
                    }
                    
                    if (!window.selectedDigitalFile) {
                        showNotification('Please upload a digital file', 'error');
                        return;
                    }
                    
                    const premiumDigitalData = {
                        title: digitalTitle,
                        description: digitalDescription,
                        price: price,
                        visibility: visibility,
                        moodContext: moodContext,
                        template: template,
                        templateSettings: {
                            color: templateColor,
                            font: templateFont
                        },
                        featured: featured,
                        boosted: boosted,
                        priorityMessaging: priorityMessaging,
                        verified: verified,
                        acceptsTips: acceptsTips,
                        autoRenew: autoRenew,
                        arPreview: true, // Premium digital items get AR preview
                        videoIntro: window.selectedVideoIntro?.url,
                        teamMembers: teamMembersList,
                        allowedGroups: allowedGroups,
                        allowedUsers: allowedUsers,
                        visibilitySchedule: visibilitySchedule,
                        recurringPromotions: featured ? schedule : null,
                        expiresAt: finalExpiry,
                        privateNotes: privateNotes,
                        teamNotes: teamNotes
                    };
                    
                    createPremiumDigitalListing(digitalTitle, digitalDescription, window.selectedDigitalFile, premiumDigitalData);
                    break;
                    
                default:
                    showNotification('Please complete the premium listing form', 'info');
                    return;
            }
            
            // Close modal
            createListingModal.classList.remove('active');
        }
        
        function saveCurrentAsDraft() {
            const activeTab = document.querySelector('.create-listing-tab.active');
            if (!activeTab) return;
            
            const tabName = activeTab.dataset.tab;
            let draftData = {};
            
            switch (tabName) {
                case 'service':
                    const serviceTitle = document.getElementById('serviceTitle').value.trim();
                    const serviceDescription = document.getElementById('serviceDescription').value.trim();
                    
                    if (!serviceTitle) {
                        showNotification('No service to save as draft', 'warning');
                        return;
                    }
                    
                    draftData = {
                        type: 'service',
                        title: serviceTitle,
                        description: serviceDescription,
                        price: document.getElementById('servicePrice').value.trim(),
                        availability: window.selectedAvailability,
                        visibility: window.selectedTrustCircle,
                        moodContext: window.selectedMoodContext,
                        template: window.selectedTemplate,
                        duration: window.selectedDuration
                    };
                    break;
                    
                case 'digital':
                    const digitalTitle = document.getElementById('digitalTitle').value.trim();
                    const digitalDescription = document.getElementById('digitalDescription').value.trim();
                    
                    if (!digitalTitle) {
                        showNotification('No digital item to save as draft', 'warning');
                        return;
                    }
                    
                    draftData = {
                        type: 'digital',
                        title: digitalTitle,
                        description: digitalDescription,
                        price: document.getElementById('digitalPrice').value.trim(),
                        file: window.selectedDigitalFile,
                        visibility: window.selectedTrustCircle,
                        moodContext: window.selectedMoodContext,
                        template: window.selectedTemplate,
                        duration: window.selectedDuration
                    };
                    break;
                    
                case 'premium':
                    const premiumTitle = document.getElementById('serviceTitle').value.trim() || document.getElementById('digitalTitle').value.trim();
                    
                    if (!premiumTitle) {
                        showNotification('No premium listing to save as draft', 'warning');
                        return;
                    }
                    
                    draftData = {
                        type: 'premium',
                        title: premiumTitle,
                        featured: document.getElementById('featuredListingCheckbox').checked,
                        boosted: document.getElementById('boostListingCheckbox').checked,
                        verified: document.getElementById('verifiedBadgeCheckbox').checked,
                        autoRenew: document.getElementById('autoRenewCheckbox').checked,
                        videoIntro: window.selectedVideoIntro,
                        visibility: window.selectedTrustCircle,
                        duration: window.selectedDuration
                    };
                    break;
                    
                default:
                    showNotification('Cannot save draft from this tab', 'warning');
                    return;
            }
            
            // Add notes
            draftData.privateNotes = document.getElementById('sellerNotes').value.trim();
            draftData.teamNotes = document.getElementById('teamNotes').value.trim();
            draftData.savedAt = new Date().toISOString();
            draftData.id = 'draft_' + Date.now();
            
            offlineDrafts.unshift(draftData);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.OFFLINE_DRAFTS, offlineDrafts);
            
            showNotification('Draft saved', 'success');
        }
        
        function showPaymentForm(plan) {
            document.getElementById('paymentContainer').style.display = 'block';
            window.selectedPlan = plan;
        }
        
        function showPaymentFormForMethod(method) {
            // Hide all payment forms
            document.getElementById('cardPaymentForm').style.display = 'none';
            
            // Show selected payment form
            if (method === 'card') {
                document.getElementById('cardPaymentForm').style.display = 'block';
            }
            // Add other payment methods as needed
        }
        
        async function processSubscriptionPayment() {
            const selectedMethod = document.querySelector('.payment-method.selected')?.dataset.method;
            
            if (!selectedMethod) {
                showNotification('Please select a payment method', 'error');
                return;
            }
            
            try {
                const paymentData = {
                    plan: window.selectedPlan,
                    paymentMethod: selectedMethod,
                    amount: SUBSCRIPTION_PLANS[window.selectedPlan.toUpperCase()].price
                };
                
                if (selectedMethod === 'card') {
                    paymentData.cardDetails = {
                        number: document.getElementById('cardNumber').value,
                        expiry: document.getElementById('cardExpiry').value,
                        cvc: document.getElementById('cardCvc').value,
                        name: document.getElementById('cardName').value
                    };
                }
                
                const response = await window.api('POST', '/api/subscriptions/purchase', paymentData);
                
                if (response && response.success) {
                    userSubscription = response.subscription;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION, JSON.stringify(userSubscription));
                    
                    updatePremiumStatusUI();
                    premiumOptionsModal.classList.remove('active');
                    
                    showNotification('Premium subscription activated successfully!', 'success');
                }
                
            } catch (error) {
                console.error('Payment failed:', error);
                showNotification('Payment failed. Please try again.', 'error');
            }
        }
        
        async function startFreeTrial() {
            try {
                const response = await window.api('POST', '/api/subscriptions/trial');
                
                if (response && response.success) {
                    userSubscription = response.subscription;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION, JSON.stringify(userSubscription));
                    
                    updatePremiumStatusUI();
                    premiumOptionsModal.classList.remove('active');
                    
                    showNotification('7-day free trial started!', 'success');
                }
                
            } catch (error) {
                console.error('Free trial failed:', error);
                showNotification('Free trial not available', 'error');
            }
        }
        
        async function restorePurchase() {
            try {
                const response = await window.api('POST', '/api/subscriptions/restore');
                
                if (response && response.success) {
                    userSubscription = response.subscription;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION, JSON.stringify(userSubscription));
                    
                    updatePremiumStatusUI();
                    premiumOptionsModal.classList.remove('active');
                    
                    showNotification('Purchase restored successfully!', 'success');
                } else {
                    showNotification('No previous purchase found', 'info');
                }
                
            } catch (error) {
                console.error('Restore failed:', error);
                showNotification('Restore failed', 'error');
            }
        }
        
        async function inviteTeamMember() {
            const email = prompt('Enter team member email:');
            if (!email) return;
            
            try {
                const response = await window.api('POST', '/api/team/invite', { email });
                
                if (response && response.success) {
                    showNotification('Invitation sent successfully', 'success');
                }
                
            } catch (error) {
                console.error('Invitation failed:', error);
                showNotification('Invitation failed', 'error');
            }
        }
        
        async function saveTeamChanges() {
            try {
                // Collect role changes
                const roleChanges = [];
                document.querySelectorAll('select[data-member-id]').forEach(select => {
                    roleChanges.push({
                        memberId: select.dataset.memberId,
                        role: select.value
                    });
                });
                
                const response = await window.api('POST', '/api/team/update', { roleChanges });
                
                if (response && response.success) {
                    showNotification('Team updated successfully', 'success');
                    teamManagementModal.classList.remove('active');
                }
                
            } catch (error) {
                console.error('Team update failed:', error);
                showNotification('Team update failed', 'error');
            }
        }
        
        async function addReaction(listingId, reaction) {
            try {
                const response = await window.api('POST', `/api/marketplace/listings/${listingId}/reactions`, {
                    reaction: reaction,
                    premium: reaction.length > 2 // Premium reactions are usually longer emoji sequences
                });
                
                if (response && response.success) {
                    showNotification('Reaction added!', 'success');
                    reactionPickerModal.classList.remove('active');
                }
                
            } catch (error) {
                console.error('Reaction failed:', error);
                showNotification('Failed to add reaction', 'error');
            }
        }
        
        function setupBackupRestoreButtons() {
            // Add backup button to my listings section
            const backupBtn = document.createElement('button');
            backupBtn.className = 'my-listing-action-btn secondary';
            backupBtn.id = 'backupDataBtn';
            backupBtn.innerHTML = '<i class="fas fa-download"></i> Backup';
            backupBtn.addEventListener('click', backupMarketplaceData);
            
            // Add restore button
            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'my-listing-action-btn secondary';
            restoreBtn.id = 'restoreDataBtn';
            restoreBtn.innerHTML = '<i class="fas fa-upload"></i> Restore';
            restoreBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        restoreMarketplaceData(e.target.files[0]);
                    }
                });
                input.click();
            });
            
            // Add to my listings actions if premium user
            if (isUserPremium()) {
                const actionsContainer = document.querySelector('.my-listings-actions');
                if (actionsContainer) {
                    actionsContainer.appendChild(backupBtn);
                    actionsContainer.appendChild(restoreBtn);
                }
            }
        }
        
        function renderPremiumListings() {
            const premiumListings = allListings.filter(listing => 
                listing.premium === true && 
                isListingVisibleToUser(listing)
            );
            
            renderFilteredListings(premiumListings, 'No premium listings found');
        }
        
        function renderSpotlightTab() {
            const spotlightListings = allListings.filter(listing => 
                listing.featured === true && 
                isListingVisibleToUser(listing)
            );
            
            renderFilteredListings(spotlightListings, 'No featured listings found');
        }
        
        function renderServicesList() {
            const serviceListings = allListings.filter(listing => 
                listing.type === LISTING_TYPES.SERVICE && 
                isListingVisibleToUser(listing)
            );
            
            renderFilteredListings(serviceListings, 'No services found');
        }
        
        function renderDigitalList() {
            const digitalListings = allListings.filter(listing => 
                listing.type === LISTING_TYPES.DIGITAL && 
                isListingVisibleToUser(listing)
            );
            
            renderFilteredListings(digitalListings, 'No digital items found');
        }
        
        function renderFriendsListings() {
            const friendIds = userFriends.map(friend => friend.id);
            const friendListings = allListings.filter(listing => 
                friendIds.includes(listing.userId) &&
                isListingVisibleToUser(listing)
            );
            
            renderFilteredListings(friendListings, 'No friend listings found');
        }
        
        function renderGroupListings() {
            const groupListings = allListings.filter(listing => 
                listing.visibility === TRUST_CIRCLES.GROUPS &&
                isListingVisibleToUser(listing)
            );
            
            renderFilteredListings(groupListings, 'No group listings found');
        }
        
        function renderMyListings() {
            const myActiveListings = myListings.filter(listing => !isListingExpired(listing));
            renderFilteredListings(myActiveListings, 'You have no active listings');
        }
        
        function renderFilteredListings(listings, emptyMessage) {
            marketplaceListContent.innerHTML = '';
            
            if (listings.length === 0) {
                marketplaceListContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>${emptyMessage}</p>
                        <p class="subtext">Try a different category or create your own listing</p>
                    </div>
                `;
                return;
            }
            
            listings.forEach(listing => {
                addListingItem(listing);
            });
        }
        
        async function syncOfflineMarketplaceData() {
            const syncQueue = JSON.parse(localStorage.getItem('knecta_sync_queue') || '[]');
            const marketplaceItems = syncQueue.filter(item => item.type.startsWith('marketplace_'));
            
            if (marketplaceItems.length === 0) return;
            
            showNotification(`Syncing ${marketplaceItems.length} marketplace items...`, 'info');
            
            for (let i = 0; i < marketplaceItems.length; i++) {
                const item = marketplaceItems[i];
                try {
                    if (item.type === 'marketplace_listing') {
                        await window.api('POST', '/api/marketplace/listings', item.data);
                        syncQueue.splice(syncQueue.indexOf(item), 1);
                    } else if (item.type === 'marketplace_premium_listing') {
                        await window.api('POST', '/api/marketplace/listings/premium', item.data);
                        syncQueue.splice(syncQueue.indexOf(item), 1);
                    }
                } catch (error) {
                    console.log('Sync failed for marketplace item:', item);
                    item.retryCount = (item.retryCount || 0) + 1;
                    
                    if (item.retryCount > 3) {
                        syncQueue.splice(syncQueue.indexOf(item), 1);
                    }
                }
            }
            
            localStorage.setItem('knecta_sync_queue', JSON.stringify(syncQueue));
            
            if (marketplaceItems.length > 0) {
                showNotification('Marketplace data synced', 'success');
            }
        }
        
        function saveAllMarketplaceData() {
            saveToLocalStorage(LOCAL_STORAGE_KEYS.MY_LISTINGS, myListings);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.ALL_LISTINGS, allListings);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.SAVED_ITEMS, savedItems);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.PRIVATE_NOTES, privateNotes);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.OFFLINE_DRAFTS, offlineDrafts);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.TRUST_STATS, trustStats);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.ANALYTICS, analyticsData);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.STREAK_DATA, streakData);
            saveToLocalStorage(LOCAL_STORAGE_KEYS.PREMIUM_FEATURES, premiumFeatures);
            
            if (userSubscription) {
                saveToLocalStorage(LOCAL_STORAGE_KEYS.USER_SUBSCRIPTION, userSubscription);
            }
            
            console.log('All marketplace data saved to localStorage');
        }
        
        // Keep the existing functions that are still needed
        // ... (keep all other existing functions from the original code)
        
        console.log('Enhanced marketplace system initialized successfully');
        console.log('Premium features enabled: Featured Listings, Advanced Analytics, Team Tools, AR Previews, Bulk Uploads, Backup & Restore');
    </script>
    
    <!-- Load other scripts after api.js -->
    <script src="./js/settingsManager.js"></script>
</body>
</html>