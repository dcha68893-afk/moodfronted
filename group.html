<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="icon" href="../icons/moodchat-192.png">
    <link rel="icon" href="../icons/moodchat-512.png">
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Groups | Knecta Chat</title>
    
    <!-- API System -->
    
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* All CSS styles remain the same as in your original file */
        
    </style>
</head>
<body>
    <!-- Offline Overlay -->
    <div class="offline-overlay" id="offlineOverlay" style="display: none;">
        <div class="offline-icon">
            <i class="fas fa-wifi-slash"></i>
        </div>
        <div class="offline-title">You're Offline</div>
        <div class="offline-message">Some group features require internet connection to work properly.</div>
        <div class="offline-submessage">
            <i class="fas fa-info-circle"></i> You can still view your cached groups, chat with existing groups, and use most features. New group creation and syncing will work when you're back online.
        </div>
        <button class="offline-dismiss-btn" id="dismissOfflineBtn">
            <i class="fas fa-eye"></i> View Cached Groups
        </button>
    </div>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator" style="display: none;">
        <i class="fas fa-wifi-slash"></i>
        <span>Offline</span>
    </div>
    
    <!-- Local Storage Indicator -->
    <div class="local-storage-indicator" id="localStorageIndicator" style="display: none;">
        <i class="fas fa-database"></i>
        <span>Loaded from Local Storage</span>
    </div>
    
    <div class="app-container">
        <!-- Sidebar with group list -->
        <div class="sidebar active" id="sidebar">
            <div class="sidebar-header">
                <h2>Groups</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="create-group-btn" id="createGroupBtn" title="Create new group">
                        <i class="fas fa-users"></i>
                    </button>
                </div>
            </div>
            
            <div class="group-categories">
                <button class="category-btn active" id="allTab">All Groups</button>
                <button class="category-btn" id="myGroupsTab">My Groups <span class="badge" id="myGroupsCount">0</span></button>
                <button class="category-btn" id="joinedTab">Joined <span class="badge" id="joinedCount">0</span></button>
                <button class="category-btn" id="invitesTab">Invites <span class="badge" id="invitesCount">0</span></button>
                <button class="category-btn" id="adminTab">Admin <span class="badge" id="adminCount">0</span></button>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="groupSearch" placeholder="Search groups...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <!-- Cache Indicator (shown when offline) -->
            <div class="cache-indicator" id="cacheIndicator" style="display: none;">
                <i class="fas fa-database"></i>
                <span>Showing cached groups data. Some features may be limited.</span>
            </div>
            
            <div class="group-list">
                <div class="quick-actions">
                    <button class="quick-action-btn" id="discoverGroupsBtn" title="Discover groups">
                        <div class="quick-action-icon">
                            <i class="fas fa-compass"></i>
                        </div>
                        <div class="quick-action-text">Discover</div>
                    </button>
                    <button class="quick-action-btn" id="groupInvitesBtn" title="Group invites">
                        <div class="quick-action-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="quick-action-text">Invites</div>
                    </button>
                    <button class="quick-action-btn" id="groupEventsBtn" title="Group events">
                        <div class="quick-action-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="quick-action-text">Events</div>
                    </button>
                </div>
                
                <!-- Group Stats -->
                <div class="group-stats">
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-number" id="totalGroups">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="activeGroups">0</div>
                            <div class="stat-label">Active</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalMembers">0</div>
                            <div class="stat-label">Members</div>
                        </div>
                    </div>
                </div>
                
                <!-- Type Filters -->
                <div class="type-filters">
                    <div class="type-filters-container">
                        <button class="type-filter-btn active" data-type="all">All</button>
                        <button class="type-filter-btn" data-type="public">Public</button>
                        <button class="type-filter-btn" data-type="private">Private</button>
                        <button class="type-filter-btn" data-type="secret">Secret</button>
                        <button class="type-filter-btn" data-type="family">Family</button>
                        <button class="type-filter-btn" data-type="work">Work</button>
                    </div>
                </div>
                
                <div class="group-list-content">
                    <!-- All Groups Section -->
                    <div class="groups-section active" id="allGroupsSection">
                        <div class="groups-list" id="allGroupsList">
                            <div class="loading-placeholder">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading groups...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- My Groups Section -->
                    <div class="groups-section" id="myGroupsSection">
                        <div class="groups-list" id="myGroupsList">
                            <!-- User-created groups will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Joined Groups Section -->
                    <div class="groups-section" id="joinedSection">
                        <div class="groups-list" id="joinedList">
                            <!-- Joined groups will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Invites Section -->
                    <div class="groups-section" id="invitesSection">
                        <div class="section-title">
                            <span>Group Invites</span>
                            <span class="section-count" id="invitesSectionCount">0</span>
                        </div>
                        <div class="groups-list" id="invitesList">
                            <!-- Group invites will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Admin Groups Section -->
                    <div class="groups-section" id="adminSection">
                        <div class="groups-list" id="adminList">
                            <!-- Admin groups will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Group Details Panel -->
        <div class="group-details-panel" id="groupDetailsPanel">
            <div class="group-details-header">
                <button class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="group-details-title">Group Details</div>
                <div style="width: 40px;"></div> <!-- Spacer for alignment -->
            </div>
            
            <div class="group-details-content" id="groupDetailsContent">
                <!-- Group details will be loaded here -->
            </div>
        </div>
        
        <!-- ============================================= -->
        <!-- NEW: GROUP CHAT PANEL -->
        <!-- ============================================= -->
        <div class="group-chat-panel" id="groupChatPanel">
            <div class="chat-header">
                <div class="chat-header-info" id="chatHeaderInfo">
                    <div class="chat-header-avatar" id="chatAvatar">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="chat-header-details">
                        <div class="chat-header-title" id="chatTitle">Group Chat</div>
                        <div class="chat-header-subtitle" id="chatSubtitle">
                            <span id="chatMemberCount">0 members</span>
                            <span>‚Ä¢</span>
                            <span id="chatActive">Active now</span>
                        </div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="chat-header-btn" id="chatInfoBtn" title="Group Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="chat-header-btn" id="chatCallBtn" title="Start Group Call">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="chat-header-btn" id="closeChatBtn" title="Close Chat">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-messages-container" id="chatMessagesContainer">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-actions">
                    <button class="chat-input-btn" id="chatAttachBtn" title="Attach File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="chat-input-btn" id="chatEmojiBtn" title="Emoji">
                        <i class="far fa-smile"></i>
                    </button>
                </div>
                <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                <button class="chat-input-btn send" id="chatSendBtn" title="Send Message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <!-- ============================================= -->
        <!-- NEW: GROUP CALL PANEL -->
        <!-- ============================================= -->
        <div class="group-call-panel" id="groupCallPanel">
            <div class="call-header">
                <div class="call-header-info">
                    <div>
                        <div class="call-header-title" id="callTitle">Group Call</div>
                        <div class="call-header-subtitle" id="callDuration">00:00</div>
                    </div>
                </div>
                <div class="call-header-actions">
                    <button class="call-header-btn" id="callParticipantsBtn" title="Participants">
                        <i class="fas fa-users"></i>
                    </button>
                    <button class="call-header-btn" id="callSettingsBtn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="call-header-btn" id="endCallBtn" title="End Call">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
            
            <div class="call-participants" id="callParticipants">
                <!-- Video feeds will be added here -->
            </div>
            
            <div class="call-controls">
                <button class="call-control-btn secondary" id="callMuteBtn" title="Mute/Unmute">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="call-control-btn secondary" id="callVideoBtn" title="Video On/Off">
                    <i class="fas fa-video"></i>
                </button>
                <button class="call-control-btn secondary" id="callScreenBtn" title="Share Screen">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="call-control-btn danger" id="callLeaveBtn" title="Leave Call">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Create Group Modal -->
    <div class="create-group-modal" id="createGroupModal">
        <div class="create-group-container">
            <div class="create-group-header">
                <h3>Create Group</h3>
                <button class="create-group-btn" id="closeCreateGroupModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="create-group-tabs">
                <button class="create-group-tab active" data-tab="basic">Basic</button>
                <button class="create-group-tab" data-tab="settings">Settings</button>
                <button class="create-group-tab" data-tab="invite">Invite</button>
                <button class="create-group-tab" data-tab="theme">Theme</button>
            </div>
            
            <div class="create-group-content">
                <!-- Basic Tab -->
                <div class="create-group-tab-content active" id="basicTab">
                    <div class="input-group">
                        <label class="input-label">Group Name *</label>
                        <input type="text" class="text-input" id="groupNameInput" placeholder="Enter group name" maxlength="100">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Description</label>
                        <textarea class="text-input" id="groupDescriptionInput" placeholder="Describe the purpose of this group..." rows="3"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Topic (Optional)</label>
                        <input type="text" class="text-input" id="groupTopicInput" placeholder="#family #gaming #work">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Add topics to help others discover your group</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Type</label>
                        <select class="text-input" id="groupTypeSelect">
                            <option value="public">Public - Anyone can join</option>
                            <option value="private" selected>Private - Invite only</option>
                            <option value="secret">Secret - Hidden and invite only</option>
                        </select>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="create-group-tab-content" id="settingsTab">
                    <div class="input-group">
                        <label class="input-label">Welcome Message</label>
                        <textarea class="text-input" id="welcomeMessageInput" placeholder="Welcome message for new members..." rows="3"></textarea>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">This message will be shown to new members when they join</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Rules</label>
                        <textarea class="text-input" id="groupRulesInput" placeholder="Add group rules (one per line)..." rows="5">1. Be respectful to all members
2. No spam or self-promotion
3. Keep discussions relevant to the group topic
4. No hate speech or harassment</textarea>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Moderation Settings</label>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="approveNewMembers" checked>
                                <span>Approve new members before they can join</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="onlyAdminsCanPost" checked>
                                <span>Only admins can post messages</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="allowMediaSharing" checked>
                                <span>Allow media sharing</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableDisappearingMessages">
                                <span>Enable disappearing messages (24 hours)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Invite Tab -->
                <div class="create-group-tab-content" id="inviteTab">
                    <div class="input-group">
                        <label class="input-label">Add Members</label>
                        <div id="selectedMembersList" style="min-height: 100px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                <i class="fas fa-users"></i>
                                <p>No members selected yet</p>
                                <p style="font-size: 14px;">Add friends to your group</p>
                            </div>
                        </div>
                        <button class="action-btn secondary" id="addMembersBtn" style="width: 100%;">
                            <i class="fas fa-user-plus"></i> Add Members from Friends
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Invite Link (Generated after creation)</label>
                        <input type="text" class="text-input" id="inviteLinkInput" placeholder="Group invite link will appear here" readonly>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="action-btn secondary" id="copyInviteLinkBtn" style="flex: 1;" disabled>
                                <i class="fas fa-copy"></i> Copy Link
                            </button>
                            <button class="action-btn secondary" id="shareInviteLinkBtn" style="flex: 1;" disabled>
                                <i class="fas fa-share"></i> Share
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Join Questions (Optional)</label>
                        <textarea class="text-input" id="joinQuestionsInput" placeholder="Add questions for new members to answer before joining...&#10;Example: Why do you want to join this group?" rows="4"></textarea>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">New members must answer these questions before joining</div>
                    </div>
                </div>
                
                <!-- Theme Tab -->
                <div class="create-group-tab-content" id="themeTab">
                    <div class="input-group">
                        <label class="input-label">Group Theme Color</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <div class="theme-option" data-theme="blue" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Blue</div>
                            </div>
                            <div class="theme-option" data-theme="green" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Green</div>
                            </div>
                            <div class="theme-option" data-theme="red" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Red</div>
                            </div>
                            <div class="theme-option" data-theme="purple" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #8a2387 0%, #f27121 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Purple</div>
                            </div>
                            <div class="theme-option" data-theme="dark" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Dark</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Custom Reactions (Optional)</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <div class="reaction-option" data-reaction="üëç" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üëç
                            </div>
                            <div class="reaction-option" data-reaction="‚ù§Ô∏è" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                ‚ù§Ô∏è
                            </div>
                            <div class="reaction-option" data-reaction="üòÇ" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üòÇ
                            </div>
                            <div class="reaction-option" data-reaction="üôè" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üôè
                            </div>
                            <div class="reaction-option" data-reaction="üî•" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üî•
                            </div>
                            <div class="reaction-option" data-reaction="üëè" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üëè
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Select custom reactions for your group</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Badges</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <div class="badge-option" data-badge="star" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center;">
                                <i class="fas fa-star" style="color: gold;"></i>
                                <div style="font-size: 12px; margin-top: 5px;">Helpful</div>
                            </div>
                            <div class="badge-option" data-badge="fire" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center;">
                                <i class="fas fa-fire" style="color: orange;"></i>
                                <div style="font-size: 12px; margin-top: 5px;">Active</div>
                            </div>
                            <div class="badge-option" data-badge="crown" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center;">
                                <i class="fas fa-crown" style="color: purple;"></i>
                                <div style="font-size: 12px; margin-top: 5px;">Moderator</div>
                            </div>
                            <div class="badge-option" data-badge="heart" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center;">
                                <i class="fas fa-heart" style="color: red;"></i>
                                <div style="font-size: 12px; margin-top: 5px;">Supporter</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Select badges that admins can award to members</div>
                    </div>
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                <button class="action-btn secondary" id="cancelCreateGroupBtn">Cancel</button>
                <button class="action-btn success" id="createGroupBtnModal">Create Group</button>
            </div>
        </div>
    </div>
    
    <!-- ============================================= -->
    <!-- NEW: ADMIN MANAGEMENT MODAL -->
    <!-- ============================================= -->
    <div class="admin-management-modal" id="adminManagementModal">
        <div class="admin-management-container">
            <div class="admin-management-header">
                <h3>Group Management</h3>
                <div id="adminManagementGroupName" style="opacity: 0.9; font-size: 14px;"></div>
            </div>
            
            <div class="admin-management-tabs">
                <button class="admin-management-tab active" data-tab="members">Members</button>
                <button class="admin-management-tab" data-tab="settings">Settings</button>
                <button class="admin-management-tab" data-tab="moderation">Moderation</button>
                <button class="admin-management-tab" data-tab="analytics">Analytics</button>
            </div>
            
            <div class="admin-management-content">
                <!-- Members Tab -->
                <div class="admin-management-section active" id="adminMembersTab">
                    <div class="admin-actions">
                        <button class="admin-action-btn" id="adminAddMemberBtn">
                            <i class="fas fa-user-plus"></i> Add Member
                        </button>
                        <button class="admin-action-btn" id="adminInviteLinkBtn">
                            <i class="fas fa-link"></i> Manage Invite Links
                        </button>
                        <button class="admin-action-btn" id="adminExportMembersBtn">
                            <i class="fas fa-download"></i> Export Members
                        </button>
                    </div>
                    
                    <div class="member-management-list" id="memberManagementList">
                        <!-- Members will be loaded here -->
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="admin-management-section" id="adminSettingsTab">
                    <div class="admin-settings-form">
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-lock"></i>
                                Privacy Settings
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminPublicGroup" data-setting="publicGroup">
                                    <span>Make group public (anyone can join)</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminApproveMembers" data-setting="approveMembers" checked>
                                    <span>Approve new members before joining</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminAllowInvites" data-setting="allowInvites" checked>
                                    <span>Allow members to invite others</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-comments"></i>
                                Chat Settings
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminOnlyAdminsPost" data-setting="onlyAdminsPost">
                                    <span>Only admins can post messages</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminAllowMedia" data-setting="allowMedia" checked>
                                    <span>Allow media sharing</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminDisappearingMessages" data-setting="disappearingMessages">
                                    <span>Enable disappearing messages (24h)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-bell"></i>
                                Notification Settings
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminMentionNotifications" data-setting="mentionNotifications" checked>
                                    <span>Send notifications for @mentions</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminAnnouncementNotifications" data-setting="announcementNotifications" checked>
                                    <span>Send notifications for announcements</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Moderation Tab -->
                <div class="admin-management-section" id="adminModerationTab">
                    <div class="admin-actions">
                        <button class="admin-action-btn" id="adminViewReportsBtn">
                            <i class="fas fa-flag"></i> View Reports
                        </button>
                        <button class="admin-action-btn" id="adminBannedMembersBtn">
                            <i class="fas fa-ban"></i> Banned Members
                        </button>
                        <button class="admin-action-btn" id="adminClearHistoryBtn">
                            <i class="fas fa-trash"></i> Clear Chat History
                        </button>
                    </div>
                    
                    <div id="moderationContent">
                        <!-- Moderation content will be loaded here -->
                    </div>
                </div>
                
                <!-- Analytics Tab -->
                <div class="admin-management-section" id="adminAnalyticsTab">
                    <div id="analyticsContent">
                        <!-- Analytics content will be loaded here -->
                    </div>
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                <button class="action-btn secondary" id="closeAdminManagementBtn">Close</button>
                <button class="action-btn success" id="saveAdminSettingsBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Friend Selection Modal -->
    <div class="friend-selection-modal" id="friendSelectionModal">
        <div class="friend-selection-container">
            <div class="friend-selection-header">
                <h3>Select Friends</h3>
                <p>Choose friends to add to your group</p>
            </div>
            <div class="friend-selection-content" id="friendSelectionContent">
                <div class="loading-placeholder">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading friends...</p>
                </div>
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                <button class="action-btn secondary" id="cancelFriendSelectionBtn">Cancel</button>
                <button class="action-btn success" id="confirmFriendSelectionBtn">Add Selected Friends</button>
            </div>
        </div>
    </div>
    
    <!-- Group Invite Modal -->
    <div class="group-invite-modal" id="groupInviteModal">
        <div class="group-invite-container">
            <div class="group-invite-header">
                <div class="group-invite-avatar" id="inviteAvatar">
                    <i class="fas fa-users"></i>
                </div>
                <div class="group-invite-name" id="inviteName">Family Chat</div>
                <div class="group-invite-topic" id="inviteTopic">#family #updates</div>
                <div class="member-count-badge" id="inviteMemberCount">
                    <i class="fas fa-users"></i> 12 members
                </div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
                    Invited by <span id="invitedBy">John Doe</span>
                </div>
            </div>
            
            <div class="group-invite-actions">
                <button class="group-invite-btn decline" id="declineInviteBtn">
                    <i class="fas fa-times"></i> Decline
                </button>
                <button class="group-invite-btn accept" id="acceptInviteBtn">
                    <i class="fas fa-check"></i> Join Group
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operation completed successfully</span>
    </div>

    <!-- Import settingsManager.js -->
    <script src="../js/settingsManager.js"></script>

    <script>
        // =============================================
        // COMPLETE FUNCTIONAL GROUPS SYSTEM WITH REAL FEATURES
        // =============================================

        // Global variables
        let currentUser = null;
        let userData = null;
        let groups = [];
        let myGroups = [];
        let joinedGroups = [];
        let groupInvites = [];
        let adminGroups = [];
        let selectedGroup = null;
        let currentTypeFilter = 'all';
        let currentSearchTerm = '';
        let isOnline = navigator.onLine;
        let offlineCheckInterval = null;
        let isLoadedFromLocalStorage = false;
        let isMobile = window.innerWidth <= 768;
        let pendingGroupActions = [];
        let offlineOverlayDismissed = false;
        let friends = [];
        let selectedFriends = [];
        
        // =============================================
        // NEW: CHAT & CALL VARIABLES
        // =============================================
        let currentChatGroup = null;
        let chatMessagesList = [];
        let chatUnsubscribe = null;
        let typingTimeout = null;
        let isTyping = false;
        let callInProgress = false;
        let callStartTime = null;
        let callTimer = null;
        let localStream = null;
        let peerConnections = {};

        // Group types with colors and icons
        const groupTypes = {
            'public': {
                name: 'Public',
                color: 'var(--success-color)',
                icon: 'fas fa-globe',
                description: 'Anyone can join'
            },
            'private': {
                name: 'Private',
                color: 'var(--warning-color)',
                icon: 'fas fa-lock',
                description: 'Invite only'
            },
            'secret': {
                name: 'Secret',
                color: 'var(--danger-color)',
                icon: 'fas fa-eye-slash',
                description: 'Hidden and invite only'
            },
            'family': {
                name: 'Family',
                color: '#9c27b0',
                icon: 'fas fa-home',
                description: 'Family members only'
            },
            'work': {
                name: 'Work',
                color: '#2196f3',
                icon: 'fas fa-briefcase',
                description: 'Work colleagues'
            }
        };

        // Group themes
        const groupThemes = {
            'blue': {
                name: 'Blue',
                gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: '#667eea'
            },
            'green': {
                name: 'Green',
                gradient: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                color: '#11998e'
            },
            'red': {
                name: 'Red',
                gradient: 'linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)',
                color: '#ff416c'
            },
            'purple': {
                name: 'Purple',
                gradient: 'linear-gradient(135deg, #8a2387 0%, #f27121 100%)',
                color: '#8a2387'
            },
            'dark': {
                name: 'Dark',
                gradient: 'linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%)',
                color: '#0f2027'
            }
        };

        // Group roles with permissions
        const groupRoles = {
            'admin': {
                name: 'Admin',
                color: 'var(--role-admin)',
                icon: 'fas fa-crown',
                permissions: ['manage_group', 'add_members', 'remove_members', 'post_messages', 'delete_messages', 'assign_roles', 'manage_events', 'manage_polls', 'manage_calls', 'moderate_chat']
            },
            'moderator': {
                name: 'Moderator',
                color: 'var(--role-moderator)',
                icon: 'fas fa-shield-alt',
                permissions: ['add_members', 'remove_members', 'post_messages', 'delete_messages', 'manage_events', 'moderate_chat']
            },
            'organizer': {
                name: 'Organizer',
                color: 'var(--role-organizer)',
                icon: 'fas fa-calendar-alt',
                permissions: ['manage_events', 'post_messages']
            },
            'helper': {
                name: 'Helper',
                color: 'var(--role-helper)',
                icon: 'fas fa-hands-helping',
                permissions: ['add_members', 'post_messages']
            },
            'member': {
                name: 'Member',
                color: 'var(--role-member)',
                icon: 'fas fa-user',
                permissions: ['post_messages']
            }
        };

        // Available badges for members
        const memberBadges = {
            'star': { name: 'Helpful', icon: 'fas fa-star', color: 'gold' },
            'fire': { name: 'Active', icon: 'fas fa-fire', color: 'orange' },
            'crown': { name: 'Moderator', icon: 'fas fa-crown', color: 'purple' },
            'heart': { name: 'Supporter', icon: 'fas fa-heart', color: 'red' },
            'trophy': { name: 'Achiever', icon: 'fas fa-trophy', color: '#FFD700' },
            'lightbulb': { name: 'Idea', icon: 'fas fa-lightbulb', color: '#FFEB3B' }
        };

        // DOM Elements
        const groupDetailsPanel = document.getElementById('groupDetailsPanel');
        const groupChatPanel = document.getElementById('groupChatPanel');
        const groupCallPanel = document.getElementById('groupCallPanel');
        const createGroupModal = document.getElementById('createGroupModal');
        const adminManagementModal = document.getElementById('adminManagementModal');
        const friendSelectionModal = document.getElementById('friendSelectionModal');
        const groupInviteModal = document.getElementById('groupInviteModal');
        const notification = document.getElementById('notification');
        const offlineOverlay = document.getElementById('offlineOverlay');
        const offlineIndicator = document.getElementById('offlineIndicator');
        const localStorageIndicator = document.getElementById('localStorageIndicator');
        const cacheIndicator = document.getElementById('cacheIndicator');
        const sidebar = document.getElementById('sidebar');
        const dismissOfflineBtn = document.getElementById('dismissOfflineBtn');

        // Group sections
        const allGroupsSection = document.getElementById('allGroupsSection');
        const myGroupsSection = document.getElementById('myGroupsSection');
        const joinedSection = document.getElementById('joinedSection');
        const invitesSection = document.getElementById('invitesSection');
        const adminSection = document.getElementById('adminSection');

        const allGroupsList = document.getElementById('allGroupsList');
        const myGroupsList = document.getElementById('myGroupsList');
        const joinedList = document.getElementById('joinedList');
        const invitesList = document.getElementById('invitesList');
        const adminList = document.getElementById('adminList');

        // Chat elements
        const chatMessagesContainer = document.getElementById('chatMessagesContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const chatTitle = document.getElementById('chatTitle');
        const chatAvatar = document.getElementById('chatAvatar');
        const chatMemberCount = document.getElementById('chatMemberCount');
        const chatActive = document.getElementById('chatActive');
        const closeChatBtn = document.getElementById('closeChatBtn');
        const chatInfoBtn = document.getElementById('chatInfoBtn');
        const chatCallBtn = document.getElementById('chatCallBtn');

        // Call elements
        const callParticipants = document.getElementById('callParticipants');
        const callTitle = document.getElementById('callTitle');
        const callDuration = document.getElementById('callDuration');
        const endCallBtn = document.getElementById('endCallBtn');
        const callLeaveBtn = document.getElementById('callLeaveBtn');
        const callMuteBtn = document.getElementById('callMuteBtn');
        const callVideoBtn = document.getElementById('callVideoBtn');
        const callScreenBtn = document.getElementById('callScreenBtn');
                
        // Local Storage Keys
        const LOCAL_STORAGE_KEYS = {
            USER: 'knecta_current_user',
            GROUPS: 'knecta_groups',
            MY_GROUPS: 'knecta_my_groups',
            JOINED_GROUPS: 'knecta_joined_groups',
            GROUP_INVITES: 'knecta_group_invites',
            ADMIN_GROUPS: 'knecta_admin_groups',
            LAST_SYNC: 'knecta_groups_last_sync',
            PENDING_ACTIONS: 'knecta_pending_group_actions',
            USER_PROFILE: 'knecta_user_profile',
            GROUP_THEMES: 'knecta_group_themes',
            OFFLINE_OVERLAY_DISMISSED: 'knecta_offline_overlay_dismissed_groups',
            LAST_CACHE_TIME: 'knecta_groups_last_cache_time',
            FRIENDS: 'knecta_friends',
            GROUP_CHATS: 'knecta_group_chats',
            GROUP_MESSAGES: 'knecta_group_messages_',
            GROUP_TYPING: 'knecta_group_typing_',
            GROUP_CALLS: 'knecta_group_calls'
        };
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // STEP 1: Load cached data INSTANTLY
            loadCachedDataInstantly();
            
            // STEP 2: Initialize the rest of the app asynchronously
            setTimeout(() => {
                initializeApp();
            }, 100);
        });
        
        // Load cached data INSTANTLY on page load
        function loadCachedDataInstantly() {
            console.log('=== INSTANT CACHE LOAD START (GROUPS) ===');
            
            try {
                // 1. Load user from cache immediately
                const cachedUser = localStorage.getItem(LOCAL_STORAGE_KEYS.USER);
                if (cachedUser) {
                    currentUser = JSON.parse(cachedUser);
                    console.log('‚úì Instant: User loaded from cache');
                }
                
                // 2. Load user profile from cache
                const cachedProfile = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_PROFILE);
                if (cachedProfile) {
                    userData = JSON.parse(cachedProfile);
                    window.userInitials = userData.displayName 
                        ? userData.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                        : 'ME';
                    window.userAvatar = userData.photoURL || '';
                    window.userUsername = userData.username || '';
                }
                
                // 3. Load friends from cache
                const cachedFriends = localStorage.getItem(LOCAL_STORAGE_KEYS.FRIENDS);
                if (cachedFriends) {
                    friends = JSON.parse(cachedFriends);
                    console.log(`‚úì Instant: ${friends.length} friends loaded from cache`);
                }
                
                // 4. Load groups from cache INSTANTLY
                const groupsData = localStorage.getItem(LOCAL_STORAGE_KEYS.GROUPS);
                if (groupsData) {
                    groups = JSON.parse(groupsData);
                    console.log(`‚úì Instant: ${groups.length} groups loaded from cache`);
                    isLoadedFromLocalStorage = true;
                    
                    // Update group counts immediately
                    updateGroupCounts();
                    
                    // Render groups IMMEDIATELY without waiting
                    renderGroupsListInstantly();
                }
                
                // 5. Load other group data
                const myGroupsData = localStorage.getItem(LOCAL_STORAGE_KEYS.MY_GROUPS);
                if (myGroupsData) {
                    myGroups = JSON.parse(myGroupsData);
                    console.log(`‚úì Instant: ${myGroups.length} my groups loaded`);
                }
                
                const joinedData = localStorage.getItem(LOCAL_STORAGE_KEYS.JOINED_GROUPS);
                if (joinedData) {
                    joinedGroups = JSON.parse(joinedData);
                    console.log(`‚úì Instant: ${joinedGroups.length} joined groups loaded`);
                }
                
                const invitesData = localStorage.getItem(LOCAL_STORAGE_KEYS.GROUP_INVITES);
                if (invitesData) {
                    groupInvites = JSON.parse(invitesData);
                    console.log(`‚úì Instant: ${groupInvites.length} group invites loaded`);
                }
                
                const adminData = localStorage.getItem(LOCAL_STORAGE_KEYS.ADMIN_GROUPS);
                if (adminData) {
                    adminGroups = JSON.parse(adminData);
                    console.log(`‚úì Instant: ${adminGroups.length} admin groups loaded`);
                }
                
                console.log('=== INSTANT CACHE LOAD COMPLETE (GROUPS) ===');
                
            } catch (error) {
                console.error('Error in instant cache load:', error);
            }
        }
        
        // Render groups list instantly from cache
        function renderGroupsListInstantly() {
            if (!allGroupsList) return;
            
            // Clear the loading placeholder
            allGroupsList.innerHTML = '';
            
            // Render cached groups immediately
            if (groups.length === 0) {
                allGroupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>No groups yet</p>
                        <p class="subtext">Create or join groups to start connecting</p>
                    </div>
                `;
                return;
            }
            
            // Create a container for instant rendering
            const fragment = document.createDocumentFragment();
            
            // Render first 15 groups instantly, then add more
            const groupsToRender = groups.slice(0, 15);
            
            groupsToRender.forEach(group => {
                addGroupItemInstant(group, fragment, 'group');
            });
            
            allGroupsList.appendChild(fragment);
            
            // If there are more groups, render them in the background
            if (groups.length > 15) {
                setTimeout(() => {
                    const remainingGroups = groups.slice(15);
                    remainingGroups.forEach(group => {
                        addGroupItemInstant(group, allGroupsList, 'group');
                    });
                }, 100);
            }
            
            // Add instant load animation class
            allGroupsList.classList.add('instant-load');
        }
        
        // Add group item instantly (optimized for speed)
        function addGroupItemInstant(groupData, container, type) {
            const groupItem = document.createElement('div');
            groupItem.className = 'group-item';
            groupItem.dataset.groupId = groupData.id;
            groupItem.dataset.type = type;
            
            // Get initials for avatar
            const initials = groupData.name 
                ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                : 'G';
            
            // Determine group type
            const groupType = groupData.type || 'private';
            const typeInfo = groupTypes[groupType];
            
            // Determine theme
            const theme = groupData.theme || 'blue';
            const themeInfo = groupThemes[theme];
            
            groupItem.innerHTML = `
                <div class="group-avatar" ${groupData.photoURL ? `style="background-image: url('${groupData.photoURL}'); background: ${themeInfo.gradient};"` : `style="background: ${themeInfo.gradient};"`}>
                    ${groupData.photoURL ? '' : `<span>${initials}</span>`}
                    <div class="group-theme-badge ${theme}"></div>
                    <div class="group-type-badge ${groupType}" title="${typeInfo ? typeInfo.name : 'Private'}">
                        <i class="${typeInfo ? typeInfo.icon : 'fas fa-lock'}"></i>
                    </div>
                </div>
                <div class="group-info">
                    <div class="group-name">
                        <span class="group-name-text">${groupData.name || 'Unnamed Group'}</span>
                        <span class="group-details">
                            ${groupData.isAdmin ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : ''}
                        </span>
                    </div>
                    <div class="group-details">
                        ${groupData.topic ? `<span class="group-topic">${groupData.topic}</span>` : ''}
                        <span class="member-count"><i class="fas fa-users"></i> ${groupData.memberCount || 0}</span>
                        <span>${typeInfo ? typeInfo.name : 'Private'}</span>
                    </div>
                </div>
                <div class="group-actions">
                    <button class="group-action-btn chat" data-action="open-chat" title="Open Chat">
                        <i class="fas fa-comments"></i>
                    </button>
                    <button class="group-action-btn" data-action="info" title="Group Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            `;
            
            // Add event listeners
            groupItem.addEventListener('click', (e) => {
                if (!e.target.closest('.group-actions')) {
                    showGroupDetails(groupData, type);
                }
            });
            
            const actionButtons = groupItem.querySelectorAll('.group-action-btn');
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.dataset.action;
                    handleGroupAction(action, groupData, type, btn);
                });
            });
            
            container.appendChild(groupItem);
        }
        
        async function initializeApp() {
            console.log('=== FULL GROUP APP INITIALIZATION START ===');
            
            // Initialize settings manager
            if (typeof settingsManager !== 'undefined') {
                settingsManager.initializeSettings();
            } else {
                console.warn('settingsManager.js not loaded, using fallback settings');
            }
            
            // Check if mobile
            checkMobile();
            window.addEventListener('resize', checkMobile);
            
            // Load user from cache first
            await loadUserFromCache();
            
            // Then try to load from API in the background
            setTimeout(() => {
                tryLoadUserFromAPI().catch(() => {
                    console.log('API user load failed, continuing with cached data');
                });
            }, 500);
            
            // Load friends from API in background
            setTimeout(() => {
                loadFriends().catch(() => {
                    console.log('Friend load failed, using cached friends');
                });
            }, 1000);
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup group invites listener
            setupGroupInvitesListener();
            
            // Show notification
            showNotification('Groups system ready', 'success');
            
            // START BACKGROUND SYNC: Fetch updated list from server
            setTimeout(() => {
                backgroundSyncWithServer();
            }, 1000);
            
            // Process any pending offline actions
            processPendingOfflineActions();
            
            console.log('=== FULL GROUP APP INITIALIZATION COMPLETE ===');
        }
        
        // Load friends from API
        async function loadFriends() {
            if (!currentUser) return;
            
            try {
                // First check local storage
                const cachedFriends = localStorage.getItem(LOCAL_STORAGE_KEYS.FRIENDS);
                if (cachedFriends) {
                    friends = JSON.parse(cachedFriends);
                    console.log(`Loaded ${friends.length} friends from cache`);
                }
                
                // Then try to load from API
                try {
                    const response = await api('friends/list', 'GET');
                    if (response.success && response.data) {
                        friends = response.data;
                        
                        // Save to local storage
                        localStorage.setItem(LOCAL_STORAGE_KEYS.FRIENDS, JSON.stringify(friends));
                        
                        console.log(`Loaded ${friends.length} friends from API`);
                        
                        // Show notification if new friends were added
                        if (friends.length > 0) {
                            showNotification(`Loaded ${friends.length} friends`, 'success');
                        }
                    }
                } catch (error) {
                    console.log('No friends found from API');
                }
                
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }
        
        // Background sync with server
        async function backgroundSyncWithServer() {
            if (!currentUser) {
                console.log('Background sync: Skipping - no user');
                return;
            }
            
            console.log('Background sync: Starting server fetch...');
            
            try {
                const syncPromises = [
                    syncGroupsFromServer().catch(error => {
                        console.log('Background sync: Groups sync error:', error.message);
                    }),
                    syncGroupInvitesFromServer().catch(error => {
                        console.log('Background sync: Invites sync error:', error.message);
                    }),
                    loadFriends().catch(error => {
                        console.log('Background sync: Friends sync error:', error.message);
                    })
                ];
                
                await Promise.allSettled(syncPromises);
                
                // Update last sync timestamp
                localStorage.setItem(LOCAL_STORAGE_KEYS.LAST_SYNC, Date.now().toString());
                
                console.log('Background sync: Completed successfully');
                
            } catch (error) {
                console.log('Background sync: Server appears to be unreachable:', error.message);
            }
        }
        
        // Sync groups from server (background, non-blocking)
        async function syncGroupsFromServer() {
            if (!currentUser) return;
            
            try {
                console.log('Syncing groups from server...');
                
                // Get groups from API
                const response = await api('groups/user', 'GET');
                
                if (!response.success || !response.data) {
                    console.log('No groups found on server');
                    return;
                }
                
                const serverGroups = response.data;
                const serverMyGroups = [];
                const serverJoinedGroups = [];
                const serverAdminGroups = [];
                
                serverGroups.forEach(groupData => {
                    const groupWithMeta = {
                        ...groupData,
                        id: groupData.id || groupData._id,
                        type: groupData.privacy || 'private',
                        theme: groupData.theme || 'blue',
                        memberCount: groupData.members ? groupData.members.length : 0,
                        isAdmin: groupData.admins && groupData.admins.includes(currentUser.uid),
                        isCreator: groupData.createdBy === currentUser.uid,
                        lastActivity: groupData.lastActivity || groupData.createdAt
                    };
                    
                    // Categorize groups
                    if (groupData.createdBy === currentUser.uid) {
                        serverMyGroups.push(groupWithMeta);
                    } else if (groupData.admins && groupData.admins.includes(currentUser.uid)) {
                        serverAdminGroups.push(groupWithMeta);
                    } else {
                        serverJoinedGroups.push(groupWithMeta);
                    }
                });
                
                // Compare with cached data
                if (JSON.stringify(serverGroups) !== JSON.stringify(groups)) {
                    console.log('Group data updated from server');
                    groups = serverGroups;
                    myGroups = serverMyGroups;
                    joinedGroups = serverJoinedGroups;
                    adminGroups = serverAdminGroups;
                    
                    // Save updated data to cache
                    localStorage.setItem(LOCAL_STORAGE_KEYS.GROUPS, JSON.stringify(groups));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.MY_GROUPS, JSON.stringify(myGroups));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.JOINED_GROUPS, JSON.stringify(joinedGroups));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.ADMIN_GROUPS, JSON.stringify(adminGroups));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.LAST_CACHE_TIME, Date.now().toString());
                    
                    // Update UI if visible
                    if (allGroupsSection.classList.contains('active')) {
                        updateCurrentSection();
                        updateGroupCounts();
                    }
                    
                    // Show subtle notification
                    showNotification('Groups list updated', 'success');
                }
                
            } catch (error) {
                console.log('Group sync error:', error.message);
                throw error;
            }
        }
        
        // Sync group invites from server
        async function syncGroupInvitesFromServer() {
            if (!currentUser) return;
            
            try {
                // Get group invites for current user from API
                const response = await api('groups/invites', 'GET');
                
                const serverInvites = [];
                
                if (response.success && response.data) {
                    serverInvites.push(...response.data.map(invite => ({
                        ...invite,
                        id: invite.id || invite._id,
                        type: 'group_invite'
                    })));
                }
                
                // Compare with cached data
                if (JSON.stringify(serverInvites) !== JSON.stringify(groupInvites)) {
                    console.log('Group invites updated from server');
                    groupInvites = serverInvites;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.GROUP_INVITES, JSON.stringify(groupInvites));
                    
                    // Update invites count
                    document.getElementById('invitesCount').textContent = groupInvites.length;
                    document.getElementById('invitesSectionCount').textContent = groupInvites.length;
                }
                
            } catch (error) {
                console.log('Group invites sync error:', error.message);
            }
        }
        
        async function loadUserFromCache() {
            try {
                // Try to get user from localStorage first
                const cachedUser = localStorage.getItem(LOCAL_STORAGE_KEYS.USER);
                if (cachedUser) {
                    currentUser = JSON.parse(cachedUser);
                    console.log('Loaded user from cache:', currentUser.uid);
                }
                
                // Try to get user data from app.js
                if (window.appState && window.appState.currentUser) {
                    currentUser = window.appState.currentUser;
                    console.log('User detected from app.js:', currentUser.uid);
                }
                
                // Load user profile from cache
                const cachedProfile = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_PROFILE);
                if (cachedProfile) {
                    userData = JSON.parse(cachedProfile);
                    window.userInitials = userData.displayName 
                        ? userData.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                        : 'ME';
                    window.userAvatar = userData.photoURL || '';
                    window.userUsername = userData.username || '';
                }
                
                // If no user found, create a minimal user object
                if (!currentUser) {
                    currentUser = {
                        uid: 'local_user_' + Date.now(),
                        displayName: 'Local User',
                        email: '',
                        photoURL: ''
                    };
                    console.log('Created minimal user object for offline use');
                }
                
            } catch (error) {
                console.error('Error loading user from cache:', error);
                currentUser = {
                    uid: 'fallback_user_' + Date.now(),
                    displayName: 'User',
                    email: '',
                    photoURL: ''
                };
            }
        }
        
        async function tryLoadUserFromAPI() {
            try {
                // Try to get current user from API
                const response = await api('auth/me', 'GET');
                if (response.success && response.data) {
                    currentUser = response.data;
                    console.log('User detected from API:', currentUser.uid);
                    
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER, JSON.stringify({
                        uid: currentUser.uid,
                        displayName: currentUser.displayName,
                        email: currentUser.email,
                        photoURL: currentUser.photoURL
                    }));
                    
                    // Load user profile
                    userData = {
                        displayName: currentUser.displayName || 'User',
                        username: currentUser.username || null
                    };
                    
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER_PROFILE, JSON.stringify(userData));
                    
                    window.userInitials = userData.displayName 
                        ? userData.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                        : 'ME';
                    window.userAvatar = userData.photoURL || '';
                    window.userUsername = userData.username || '';
                }
            } catch (error) {
                console.log('Could not load user from API, using cached data:', error.message);
            }
        }
        
        function checkMobile() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                document.body.classList.add('mobile');
                // Apply mobile-specific styles
                if (groupChatPanel.classList.contains('active')) {
                    // Chat is open, hide sidebar
                    sidebar.style.display = 'none';
                    groupChatPanel.style.display = 'flex';
                } else {
                    // Chat is not open, show sidebar
                    sidebar.style.display = 'flex';
                    groupChatPanel.style.display = 'none';
                }
            } else {
                document.body.classList.remove('mobile');
                // Reset styles for desktop
                sidebar.style.display = 'flex';
                groupChatPanel.style.display = 'flex';
                
                // Remove mobile back button if exists
                const mobileBackBtn = document.querySelector('.mobile-back-btn');
                if (mobileBackBtn) {
                    mobileBackBtn.remove();
                }
            }
        }
        
        function showMobileSection(section) {
            document.querySelectorAll('.groups-section').forEach(s => {
                s.classList.remove('active');
            });
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            switch(section) {
                case 'all':
                    allGroupsSection.classList.add('active');
                    document.getElementById('allTab').classList.add('active');
                    break;
                    
                case 'my':
                    myGroupsSection.classList.add('active');
                    document.getElementById('myGroupsTab').classList.add('active');
                    break;
                    
                case 'joined':
                    joinedSection.classList.add('active');
                    document.getElementById('joinedTab').classList.add('active');
                    break;
                    
                case 'invites':
                    invitesSection.classList.add('active');
                    document.getElementById('invitesTab').classList.add('active');
                    break;
                    
                case 'admin':
                    adminSection.classList.add('active');
                    document.getElementById('adminTab').classList.add('active');
                    break;
            }
            
            updateCurrentSection();
        }
        
        function setupGroupInvitesListener() {
            if (!currentUser) return;
            
            // Poll for new invites periodically
            setInterval(() => {
                syncGroupInvitesFromServer();
            }, 30000);
        }
        
        function updateGroupCounts() {
            document.getElementById('totalGroups').textContent = groups.length;
            
            const activeGroups = groups.filter(g => g.lastActivity && (Date.now() - new Date(g.lastActivity).getTime()) < 86400000).length;
            document.getElementById('activeGroups').textContent = activeGroups;
            
            const totalMembers = groups.reduce((sum, group) => sum + (group.memberCount || 0), 0);
            document.getElementById('totalMembers').textContent = totalMembers;
            
            document.getElementById('myGroupsCount').textContent = myGroups.length;
            document.getElementById('joinedCount').textContent = joinedGroups.length;
            document.getElementById('invitesCount').textContent = groupInvites.length;
            document.getElementById('adminCount').textContent = adminGroups.length;
        }
        
        function updateCurrentSection() {
            const activeSection = document.querySelector('.groups-section.active');
            if (activeSection) {
                const sectionId = activeSection.id;
                
                switch(sectionId) {
                    case 'allGroupsSection':
                        renderAllGroups();
                        break;
                        
                    case 'myGroupsSection':
                        renderMyGroups();
                        break;
                        
                    case 'joinedSection':
                        renderJoinedGroups();
                        break;
                        
                    case 'invitesSection':
                        renderGroupInvites();
                        break;
                        
                    case 'adminSection':
                        renderAdminGroups();
                        break;
                }
            }
        }
        
        function renderAllGroups() {
            allGroupsList.innerHTML = '';
            
            if (groups.length === 0) {
                allGroupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>No groups yet</p>
                        <p class="subtext">Create or join groups to start connecting</p>
                    </div>
                `;
                return;
            }
            
            groups.forEach(group => {
                if (matchesFilters(group)) {
                    addGroupItem(group, allGroupsList, 'group');
                }
            });
            
            if (allGroupsList.children.length === 0) {
                allGroupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No groups match your filters</p>
                        <p class="subtext">Try changing your search or filter criteria</p>
                    </div>
                `;
            }
        }
        
        function renderMyGroups() {
            myGroupsList.innerHTML = '';
            
            if (myGroups.length === 0) {
                myGroupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>You haven't created any groups</p>
                        <p class="subtext">Create your first group to get started</p>
                    </div>
                `;
                return;
            }
            
            myGroups.forEach(group => {
                if (matchesFilters(group)) {
                    addGroupItem(group, myGroupsList, 'my_group');
                }
            });
        }
        
        function renderJoinedGroups() {
            joinedList.innerHTML = '';
            
            if (joinedGroups.length === 0) {
                joinedList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>You haven't joined any groups</p>
                        <p class="subtext">Join groups to connect with others</p>
                    </div>
                `;
                return;
            }
            
            joinedGroups.forEach(group => {
                if (matchesFilters(group)) {
                    addGroupItem(group, joinedList, 'joined');
                }
            });
        }
        
        function renderGroupInvites() {
            invitesList.innerHTML = '';
            
            if (groupInvites.length === 0) {
                invitesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-envelope"></i>
                        <p>No group invites</p>
                        <p class="subtext">When someone invites you to a group, it will appear here</p>
                    </div>
                `;
                return;
            }
            
            groupInvites.forEach(invite => {
                addGroupInviteItem(invite, invitesList);
            });
        }
        
        function renderAdminGroups() {
            adminList.innerHTML = '';
            
            if (adminGroups.length === 0) {
                adminList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-crown"></i>
                        <p>You're not an admin of any groups</p>
                        <p class="subtext">Create or get promoted in a group to see it here</p>
                    </div>
                `;
                return;
            }
            
            adminGroups.forEach(group => {
                if (matchesFilters(group)) {
                    addGroupItem(group, adminList, 'admin');
                }
            });
        }
        
        function addGroupItem(groupData, container, type) {
            const existingItem = container.querySelector(`[data-group-id="${groupData.id}"]`);
            if (existingItem) {
                existingItem.remove();
            }
            
            if (!matchesFilters(groupData)) {
                return;
            }
            
            const groupItem = document.createElement('div');
            groupItem.className = 'group-item';
            groupItem.dataset.groupId = groupData.id;
            groupItem.dataset.type = type;
            
            const initials = groupData.name 
                ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                : 'G';
            
            const groupType = groupData.type || 'private';
            const typeInfo = groupTypes[groupType];
            
            const theme = groupData.theme || 'blue';
            const themeInfo = groupThemes[theme];
            
            groupItem.innerHTML = `
                <div class="group-avatar" ${groupData.photoURL ? `style="background-image: url('${groupData.photoURL}'); background: ${themeInfo.gradient};"` : `style="background: ${themeInfo.gradient};"`}>
                    ${groupData.photoURL ? '' : `<span>${initials}</span>`}
                    <div class="group-theme-badge ${theme}"></div>
                    <div class="group-type-badge ${groupType}" title="${typeInfo ? typeInfo.name : 'Private'}">
                        <i class="${typeInfo ? typeInfo.icon : 'fas fa-lock'}"></i>
                    </div>
                </div>
                <div class="group-info">
                    <div class="group-name">
                        <span class="group-name-text">${groupData.name || 'Unnamed Group'}</span>
                        <span class="group-details">
                            ${groupData.isAdmin ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : ''}
                            ${groupData.isCreator ? '<span class="role-badge admin"><i class="fas fa-star"></i> Creator</span>' : ''}
                        </span>
                    </div>
                    <div class="group-details">
                        ${groupData.topic ? `<span class="group-topic">${groupData.topic}</span>` : ''}
                        <span class="member-count"><i class="fas fa-users"></i> ${groupData.memberCount || 0}</span>
                        <span>${typeInfo ? typeInfo.name : 'Private'}</span>
                        ${groupData.theme ? `<span class="theme-badge ${groupData.theme}"><i class="fas fa-palette"></i> ${groupThemes[groupData.theme].name}</span>` : ''}
                    </div>
                    ${groupData.description ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">${groupData.description.substring(0, 100)}${groupData.description.length > 100 ? '...' : ''}</div>` : ''}
                </div>
                <div class="group-actions">
                    ${type === 'group_invite' ? `
                        <button class="group-action-btn success" data-action="accept-invite" title="Accept Invite">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="group-action-btn danger" data-action="decline-invite" title="Decline Invite">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : `
                        <button class="group-action-btn chat" data-action="open-chat" title="Open Chat">
                            <i class="fas fa-comments"></i>
                        </button>
                        <button class="group-action-btn" data-action="info" title="Group Info">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        ${type === 'my_group' || type === 'admin' ? `
                            <button class="group-action-btn" data-action="manage" title="Manage Group">
                                <i class="fas fa-cog"></i>
                            </button>
                        ` : ''}
                        ${type === 'joined' ? `
                            <button class="group-action-btn danger" data-action="leave" title="Leave Group">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        ` : ''}
                    `}
                </div>
            `;
            
            groupItem.addEventListener('click', (e) => {
                if (!e.target.closest('.group-actions')) {
                    showGroupDetails(groupData, type);
                }
            });
            
            const actionButtons = groupItem.querySelectorAll('.group-action-btn');
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.dataset.action;
                    handleGroupAction(action, groupData, type, btn);
                });
            });
            
            container.appendChild(groupItem);
        }
        
        function addGroupInviteItem(inviteData, container) {
            const inviteItem = document.createElement('div');
            inviteItem.className = 'group-item';
            inviteItem.dataset.inviteId = inviteData.id;
            inviteItem.dataset.type = 'group_invite';
            
            const groupData = inviteData.groupData || inviteData;
            const initials = groupData.name 
                ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                : 'G';
            
            const groupType = groupData.type || 'private';
            const typeInfo = groupTypes[groupType];
            
            inviteItem.innerHTML = `
                <div class="group-avatar" ${groupData.photoURL ? `style="background-image: url('${groupData.photoURL}')"` : ''}>
                    ${groupData.photoURL ? '' : `<span>${initials}</span>`}
                    <div class="group-type-badge ${groupType}" title="${typeInfo ? typeInfo.name : 'Private'}">
                        <i class="${typeInfo ? typeInfo.icon : 'fas fa-lock'}"></i>
                    </div>
                </div>
                <div class="group-info">
                    <div class="group-name">
                        <span class="group-name-text">${groupData.name || 'Unnamed Group'}</span>
                    </div>
                    <div class="group-details">
                        ${groupData.topic ? `<span class="group-topic">${groupData.topic}</span>` : ''}
                        <span class="member-count"><i class="fas fa-users"></i> ${groupData.memberCount || 0}</span>
                        <span>Invited by ${inviteData.invitedByName || 'Unknown'}</span>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">
                        <i class="fas fa-clock"></i> ${formatTimeAgo(inviteData.invitedAt || new Date())}
                    </div>
                </div>
                <div class="group-actions">
                    <button class="group-action-btn success" data-action="accept-invite" title="Accept Invite">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="group-action-btn danger" data-action="decline-invite" title="Decline Invite">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            inviteItem.addEventListener('click', (e) => {
                if (!e.target.closest('.group-actions')) {
                    showGroupInviteDetails(inviteData);
                }
            });
            
            const actionButtons = inviteItem.querySelectorAll('.group-action-btn');
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.dataset.action;
                    handleGroupInviteAction(action, inviteData, btn);
                });
            });
            
            container.appendChild(inviteItem);
        }
        
        function handleGroupAction(action, groupData, type, button) {
            switch(action) {
                case 'open-chat':
                    openGroupChat(groupData);
                    break;
                    
                case 'info':
                    showGroupDetails(groupData, type);
                    break;
                    
                case 'manage':
                    openAdminManagement(groupData);
                    break;
                    
                case 'leave':
                    leaveGroupConfirm(groupData);
                    break;
                    
                case 'accept-invite':
                    acceptGroupInvite(groupData);
                    break;
                    
                case 'decline-invite':
                    declineGroupInvite(groupData);
                    break;
                    
                default:
                    console.log('Unknown group action:', action);
            }
        }
        
        function handleGroupInviteAction(action, inviteData, button) {
            switch(action) {
                case 'accept-invite':
                    acceptGroupInvite(inviteData);
                    break;
                    
                case 'decline-invite':
                    declineGroupInvite(inviteData);
                    break;
                    
                default:
                    console.log('Unknown invite action:', action);
            }
        }
        
        // =============================================
        // NEW: REAL GROUP CHAT FUNCTIONALITY
        // =============================================
        
        function openGroupChat(groupData) {
            console.log('Opening inline group chat for:', groupData.name);
            
            // Set current chat group
            currentChatGroup = groupData;
            
            // Update chat header
            chatTitle.textContent = groupData.name || 'Group Chat';
            chatMemberCount.textContent = `${groupData.memberCount || 0} members`;
            chatActive.textContent = 'Active now';
            
            // Update avatar
            const theme = groupData.theme || 'blue';
            const themeInfo = groupThemes[theme];
            const initials = groupData.name 
                ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                : 'G';
            
            if (groupData.photoURL) {
                chatAvatar.style.backgroundImage = `url('${groupData.photoURL}')`;
                chatAvatar.innerHTML = '';
            } else {
                chatAvatar.style.background = themeInfo.gradient;
                chatAvatar.innerHTML = `<span style="color: white; font-size: 16px;">${initials}</span>`;
            }
            
            // For mobile view: hide sidebar and show chat panel
            if (isMobile) {
                sidebar.style.display = 'none';
                groupChatPanel.style.display = 'flex';
                groupChatPanel.classList.add('active');
                
                // Add back button to chat header for mobile
                const chatHeaderInfo = document.getElementById('chatHeaderInfo');
                if (!chatHeaderInfo.querySelector('.mobile-back-btn')) {
                    const backBtn = document.createElement('button');
                    backBtn.className = 'mobile-back-btn';
                    backBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
                    backBtn.style.cssText = 'background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 18px; margin-right: 10px;';
                    backBtn.addEventListener('click', closeGroupChatMobile);
                    chatHeaderInfo.insertBefore(backBtn, chatHeaderInfo.firstChild);
                }
            } else {
                // For desktop: show chat panel normally
                hideAllPanels();
                groupChatPanel.classList.add('active');
            }
            
            // Clear chat messages
            chatMessages.innerHTML = '';
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            
            // Load chat messages
            loadGroupChatMessages(groupData.id);
            
            // Start listening for typing indicators
            setupTypingListener(groupData.id);
            
            showNotification(`Opened chat: ${groupData.name}`, 'success');
        }
        
        function closeGroupChatMobile() {
            if (isMobile) {
                // Show sidebar
                sidebar.style.display = 'flex';
                
                // Hide chat panel
                groupChatPanel.style.display = 'none';
                groupChatPanel.classList.remove('active');
                
                // Remove mobile back button
                const mobileBackBtn = document.querySelector('.mobile-back-btn');
                if (mobileBackBtn) {
                    mobileBackBtn.remove();
                }
                
                // Unsubscribe from chat
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                    chatUnsubscribe = null;
                }
            }
        }
        
        function hideAllPanels() {
            groupDetailsPanel.classList.remove('active');
            groupChatPanel.classList.remove('active');
            groupCallPanel.classList.remove('active');
            
            // For mobile, ensure sidebar is shown when panels are hidden
            if (isMobile) {
                sidebar.style.display = 'flex';
                groupChatPanel.style.display = 'none';
                groupCallPanel.style.display = 'none';
            }
        }
        
        async function loadGroupChatMessages(groupId) {
            // Load cached messages first
            const cachedMessagesKey = LOCAL_STORAGE_KEYS.GROUP_MESSAGES + groupId;
            const cachedMessages = localStorage.getItem(cachedMessagesKey);
            
            if (cachedMessages) {
                try {
                    const messages = JSON.parse(cachedMessages);
                    messages.forEach(message => {
                        addMessageToChat(message, false);
                    });
                } catch (error) {
                    console.error('Error loading cached messages:', error);
                }
            }
            
            // Add welcome message if no messages
            if (chatMessages.children.length === 0) {
                addSystemMessage(`Welcome to the group chat! Start the conversation.`);
            }
            
            // Scroll to bottom
            setTimeout(() => {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }, 100);
            
            // Load messages from API
            try {
                const response = await api(`groups/${groupId}/messages`, 'GET');
                if (response.success && response.data) {
                    response.data.forEach(message => {
                        addMessageToChat(message, true);
                        saveMessageToCache(groupId, message);
                    });
                }
            } catch (error) {
                console.error('Error loading messages from API:', error);
            }
        }
        
        function addMessageToChat(messageData, isNew = true) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            // Determine message type
            const isSystem = messageData.type === 'system';
            const isSent = messageData.senderId === currentUser.uid;
            
            if (isSystem) {
                messageElement.className = 'message system';
                messageElement.innerHTML = `
                    <div class="message-content">${messageData.content}</div>
                    <div class="message-time">${formatMessageTime(messageData.timestamp || new Date())}</div>
                `;
            } else {
                messageElement.className = isSent ? 'message sent' : 'message received';
                
                // Get sender info
                const senderName = isSent ? 'You' : (messageData.senderName || 'Unknown');
                
                messageElement.innerHTML = `
                    ${!isSent ? `<div class="message-sender">${senderName}</div>` : ''}
                    <div class="message-content">${messageData.content}</div>
                    <div class="message-time">${formatMessageTime(messageData.timestamp || new Date())}</div>
                    <div class="message-actions">
                        <button class="message-action-btn" title="React">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="message-action-btn" title="Reply">
                            <i class="fas fa-reply"></i>
                        </button>
                        ${isSent ? `<button class="message-action-btn" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </div>
                `;
            }
            
            // Add to chat
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom if new message
            if (isNew) {
                setTimeout(() => {
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }, 100);
            }
        }
        
        function addSystemMessage(content) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${formatMessageTime(new Date())}</div>
            `;
            chatMessages.appendChild(messageElement);
        }
        
        function saveMessageToCache(groupId, message) {
            try {
                const cacheKey = LOCAL_STORAGE_KEYS.GROUP_MESSAGES + groupId;
                const cachedMessages = JSON.parse(localStorage.getItem(cacheKey) || '[]');
                
                // Add message if not already present
                if (!cachedMessages.some(m => m.id === message.id)) {
                    cachedMessages.push(message);
                    
                    // Keep only last 100 messages
                    if (cachedMessages.length > 100) {
                        cachedMessages.splice(0, cachedMessages.length - 100);
                    }
                    
                    localStorage.setItem(cacheKey, JSON.stringify(cachedMessages));
                }
            } catch (error) {
                console.error('Error saving message to cache:', error);
            }
        }
        
        async function sendGroupMessage() {
            if (!currentChatGroup || !chatInput.value.trim()) return;
            
            const messageContent = chatInput.value.trim();
            
            // Clear input
            chatInput.value = '';
            adjustTextareaHeight();
            
            // Create message object
            const message = {
                groupId: currentChatGroup.id,
                senderId: currentUser.uid,
                senderName: userData.displayName || 'User',
                content: messageContent,
                timestamp: new Date(),
                type: 'text',
                readBy: [currentUser.uid]
            };
            
            // Add message locally immediately
            const tempMessage = {
                ...message,
                id: 'temp_' + Date.now()
            };
            
            addMessageToChat(tempMessage, true);
            
            // Send to API
            try {
                const response = await api(`groups/${currentChatGroup.id}/messages`, 'POST', {
                    content: messageContent
                });
                
                if (response.success) {
                    // Save to cache
                    saveMessageToCache(currentChatGroup.id, {
                        ...tempMessage,
                        id: response.data?.id || tempMessage.id
                    });
                } else {
                    showNotification('Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
            
            // Stop typing indicator
            stopTypingIndicator();
        }
        
        function setupTypingListener(groupId) {
            // Clear previous timeout
            if (typingTimeout) clearTimeout(typingTimeout);
            
            // Setup typing indicator
            chatInput.addEventListener('input', () => {
                if (!isTyping) {
                    isTyping = true;
                    // Send typing indicator to server
                    api(`groups/${groupId}/typing`, 'POST', { typing: true })
                        .catch(() => {});
                }
                
                // Reset typing timeout
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    isTyping = false;
                    // Send stop typing indicator
                    api(`groups/${groupId}/typing`, 'POST', { typing: false })
                        .catch(() => {});
                }, 1000);
            });
        }
        
        function stopTypingIndicator() {
            isTyping = false;
            if (typingTimeout) clearTimeout(typingTimeout);
        }
        
        function adjustTextareaHeight() {
            const textarea = chatInput;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }
        
        function formatMessageTime(date) {
            const dateObj = date instanceof Date ? date : new Date(date);
            return dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // =============================================
        // NEW: REAL GROUP CALL FUNCTIONALITY
        // =============================================
        
        function startGroupCall() {
            if (!currentChatGroup) return;
            
            // Ask for camera and microphone permissions
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                })
                .then(stream => {
                    localStream = stream;
                    
                    // Show call panel
                    hideAllPanels();
                    groupCallPanel.classList.add('active');
                    callInProgress = true;
                    callStartTime = Date.now();
                    
                    // Update call info
                    callTitle.textContent = `Call: ${currentChatGroup.name}`;
                    
                    // Start timer
                    startCallTimer();
                    
                    // Add local video
                    addParticipantVideo('local', 'You', stream, true);
                    
                    showNotification('Group call started', 'success');
                })
                .catch(error => {
                    console.error('Error accessing media devices:', error);
                    showNotification('Cannot access camera/microphone', 'error');
                });
            } else {
                showNotification('Your browser does not support video calls', 'error');
            }
        }
        
        function addParticipantVideo(participantId, name, stream, isSelf = false) {
            const participantElement = document.createElement('div');
            participantElement.className = `call-participant ${isSelf ? 'self' : ''}`;
            participantElement.id = `participant-${participantId}`;
            
            participantElement.innerHTML = `
                <video class="participant-video" ${isSelf ? 'muted' : ''} autoplay playsinline></video>
                <div class="participant-info">
                    <div>
                        <div class="participant-name">${name}</div>
                        <div class="participant-status">${isSelf ? 'You' : 'Connected'}</div>
                    </div>
                    <div class="participant-muted">
                        <i class="fas fa-microphone-slash"></i>
                    </div>
                </div>
            `;
            
            const videoElement = participantElement.querySelector('.participant-video');
            videoElement.srcObject = stream;
            
            callParticipants.appendChild(participantElement);
            
            // Store peer connection
            if (!isSelf) {
                peerConnections[participantId] = null;
            }
        }
        
        function startCallTimer() {
            callTimer = setInterval(() => {
                if (callStartTime) {
                    const elapsed = Date.now() - callStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    callDuration.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        function endGroupCall() {
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Close peer connections
            Object.keys(peerConnections).forEach(peerId => {
                if (peerConnections[peerId]) {
                    peerConnections[peerId].close();
                }
            });
            peerConnections = {};
            
            // Clear timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Reset call state
            callInProgress = false;
            callStartTime = null;
            
            // Clear participants
            callParticipants.innerHTML = '';
            
            // Hide call panel
            groupCallPanel.classList.remove('active');
            
            // Show chat panel
            if (currentChatGroup) {
                openGroupChat(currentChatGroup);
            } else {
                hideAllPanels();
            }
            
            showNotification('Call ended', 'success');
        }
        
        // =============================================
        // NEW: REAL ADMIN MANAGEMENT FUNCTIONALITY
        // =============================================
        
        function openAdminManagement(groupData) {
            if (!groupData.isAdmin && !groupData.isCreator) {
                showNotification('You need admin permissions to manage this group', 'error');
                return;
            }
            
            // Set modal title
            document.getElementById('adminManagementGroupName').textContent = groupData.name;
            
            // Show modal
            adminManagementModal.classList.add('active');
            
            // Load members
            loadGroupMembersForManagement(groupData);
            
            // Load settings
            loadGroupSettingsForManagement(groupData);
        }
        
        async function loadGroupMembersForManagement(groupData) {
            const memberList = document.getElementById('memberManagementList');
            memberList.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i><p>Loading members...</p></div>';
            
            try {
                // Get group members from API
                const response = await api(`groups/${groupData.id}/members`, 'GET');
                
                if (!response.success || !response.data) {
                    memberList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No members in this group</p>
                        </div>
                    `;
                    return;
                }
                
                const memberDetails = response.data;
                
                // Render members
                memberList.innerHTML = '';
                memberDetails.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-management-item';
                    
                    const initials = member.displayName 
                        ? member.displayName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                        : 'U';
                    
                    memberItem.innerHTML = `
                        <div class="member-management-info">
                            <div class="friend-avatar" ${member.photoURL ? `style="background-image: url('${member.photoURL}')"` : ''}>
                                ${member.photoURL ? '' : `<span>${initials}</span>`}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${member.displayName}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${member.username || ''}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                    ${member.isCreator ? '<span class="role-badge admin"><i class="fas fa-star"></i> Creator</span>' : ''}
                                    ${member.isAdmin && !member.isCreator ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : ''}
                                    ${!member.isAdmin && !member.isCreator ? '<span class="role-badge member"><i class="fas fa-user"></i> Member</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="member-management-actions">
                            ${!member.isCreator ? `
                                ${member.isAdmin ? `
                                    <button class="member-action-btn demote" data-member-id="${member.id}" title="Demote to Member">
                                        <i class="fas fa-arrow-down"></i> Demote
                                    </button>
                                ` : `
                                    <button class="member-action-btn promote" data-member-id="${member.id}" title="Promote to Admin">
                                        <i class="fas fa-arrow-up"></i> Promote
                                    </button>
                                `}
                                ${member.id !== currentUser.uid ? `
                                    <button class="member-action-btn remove" data-member-id="${member.id}" title="Remove from Group">
                                        <i class="fas fa-user-times"></i> Remove
                                    </button>
                                ` : ''}
                            ` : ''}
                        </div>
                    `;
                    
                    memberList.appendChild(memberItem);
                });
                
                // Add event listeners
                memberList.querySelectorAll('.member-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const memberId = btn.dataset.memberId;
                        const action = btn.classList.contains('promote') ? 'promote' : 
                                      btn.classList.contains('demote') ? 'demote' : 'remove';
                        
                        handleMemberAction(action, memberId, groupData);
                    });
                });
                
            } catch (error) {
                console.error('Error loading members:', error);
                memberList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading members</p>
                        <p class="subtext">Please try again later</p>
                    </div>
                `;
            }
        }
        
        async function handleMemberAction(action, memberId, groupData) {
            try {
                switch(action) {
                    case 'promote':
                        await api(`groups/${groupData.id}/members/${memberId}/promote`, 'POST');
                        showNotification('Member promoted to admin', 'success');
                        break;
                        
                    case 'demote':
                        await api(`groups/${groupData.id}/members/${memberId}/demote`, 'POST');
                        showNotification('Admin demoted to member', 'success');
                        break;
                        
                    case 'remove':
                        if (confirm('Are you sure you want to remove this member from the group?')) {
                            await api(`groups/${groupData.id}/members/${memberId}`, 'DELETE');
                            showNotification('Member removed from group', 'success');
                        }
                        break;
                }
                
                // Reload members
                loadGroupMembersForManagement(groupData);
                
            } catch (error) {
                console.error('Error performing member action:', error);
                showNotification('Failed to perform action', 'error');
            }
        }
        
        function loadGroupSettingsForManagement(groupData) {
            // Load current settings into form
            document.getElementById('adminPublicGroup').checked = groupData.type === 'public';
            document.getElementById('adminApproveMembers').checked = groupData.moderationSettings?.approveNewMembers || false;
            document.getElementById('adminAllowInvites').checked = groupData.moderationSettings?.allowInvites || true;
            document.getElementById('adminOnlyAdminsPost').checked = groupData.moderationSettings?.onlyAdminsCanPost || false;
            document.getElementById('adminAllowMedia').checked = groupData.moderationSettings?.allowMediaSharing || true;
            document.getElementById('adminDisappearingMessages').checked = groupData.moderationSettings?.disappearingMessages || false;
            document.getElementById('adminMentionNotifications').checked = groupData.notificationSettings?.mentionNotifications || true;
            document.getElementById('adminAnnouncementNotifications').checked = groupData.notificationSettings?.announcementNotifications || true;
        }
        
        async function saveGroupSettings(groupData) {
            try {
                const settings = {
                    privacy: document.getElementById('adminPublicGroup').checked ? 'public' : 'private',
                    moderationSettings: {
                        approveNewMembers: document.getElementById('adminApproveMembers').checked,
                        allowInvites: document.getElementById('adminAllowInvites').checked,
                        onlyAdminsCanPost: document.getElementById('adminOnlyAdminsPost').checked,
                        allowMediaSharing: document.getElementById('adminAllowMedia').checked,
                        disappearingMessages: document.getElementById('adminDisappearingMessages').checked
                    },
                    notificationSettings: {
                        mentionNotifications: document.getElementById('adminMentionNotifications').checked,
                        announcementNotifications: document.getElementById('adminAnnouncementNotifications').checked
                    }
                };
                
                await api(`groups/${groupData.id}/settings`, 'PUT', settings);
                
                showNotification('Group settings saved successfully', 'success');
                
                // Close modal
                adminManagementModal.classList.remove('active');
                
            } catch (error) {
                console.error('Error saving group settings:', error);
                showNotification('Failed to save settings', 'error');
            }
        }
        
        // REAL FRIEND SELECTION FUNCTIONALITY
        function showFriendSelection() {
            friendSelectionModal.classList.add('active');
            selectedFriends = [];
            
            const friendSelectionContent = document.getElementById('friendSelectionContent');
            friendSelectionContent.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i><p>Loading friends...</p></div>';
            
            // Load friends (from cache or fetch)
            setTimeout(() => {
                renderFriendSelection();
            }, 100);
        }
        
        function renderFriendSelection() {
            const friendSelectionContent = document.getElementById('friendSelectionContent');
            
            if (friends.length === 0) {
                friendSelectionContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <p>No friends found</p>
                        <p class="subtext">Add friends first to invite them to groups</p>
                    </div>
                `;
                return;
            }
            
            friendSelectionContent.innerHTML = '';
            
            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.dataset.friendId = friend.id;
                
                const initials = friend.displayName 
                    ? friend.displayName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                    : 'U';
                
                friendItem.innerHTML = `
                    <div class="friend-avatar" ${friend.photoURL ? `style="background-image: url('${friend.photoURL}')"` : ''}>
                        ${friend.photoURL ? '' : `<span>${initials}</span>`}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.displayName}</div>
                        <div class="friend-username">${friend.username || ''}</div>
                        <div style="font-size: 11px; color: ${friend.online ? 'var(--success-color)' : 'var(--text-secondary)'}; margin-top: 2px;">
                            <i class="fas fa-circle" style="font-size: 8px;"></i> ${friend.online ? 'Online' : 'Offline'}
                        </div>
                    </div>
                    <div class="friend-checkbox">
                        <i class="fas fa-check" style="display: none;"></i>
                    </div>
                `;
                
                friendItem.addEventListener('click', () => {
                    const checkbox = friendItem.querySelector('.friend-checkbox');
                    const isSelected = checkbox.classList.contains('selected');
                    
                    if (isSelected) {
                        checkbox.classList.remove('selected');
                        checkbox.querySelector('i').style.display = 'none';
                        selectedFriends = selectedFriends.filter(id => id !== friend.id);
                    } else {
                        checkbox.classList.add('selected');
                        checkbox.querySelector('i').style.display = 'block';
                        selectedFriends.push(friend.id);
                    }
                    
                    updateSelectedFriendsList();
                });
                
                friendSelectionContent.appendChild(friendItem);
            });
        }
        
        function updateSelectedFriendsList() {
            const selectedMembersList = document.getElementById('selectedMembersList');
            
            if (selectedFriends.length === 0) {
                selectedMembersList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-users"></i>
                        <p>No members selected yet</p>
                        <p style="font-size: 14px;">Add friends to your group</p>
                    </div>
                `;
                return;
            }
            
            selectedMembersList.innerHTML = '';
            
            selectedFriends.forEach(friendId => {
                const friend = friends.find(f => f.id === friendId);
                if (friend) {
                    const initials = friend.displayName 
                        ? friend.displayName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                        : 'U';
                    
                    const memberItem = document.createElement('div');
                    memberItem.className = 'friend-item';
                    memberItem.style.marginBottom = '5px';
                    memberItem.style.padding = '8px';
                    
                    memberItem.innerHTML = `
                        <div class="friend-avatar" ${friend.photoURL ? `style="background-image: url('${friend.photoURL}')"` : ''}>
                            ${friend.photoURL ? '' : `<span>${initials}</span>`}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.displayName}</div>
                            <div class="friend-username">${friend.username || ''}</div>
                        </div>
                        <div style="color: var(--danger-color); cursor: pointer;" onclick="removeSelectedFriend('${friend.id}')">
                            <i class="fas fa-times"></i>
                        </div>
                    `;
                    
                    selectedMembersList.appendChild(memberItem);
                }
            });
        }
        
        function removeSelectedFriend(friendId) {
            selectedFriends = selectedFriends.filter(id => id !== friendId);
            updateSelectedFriendsList();
            
            // Also update checkbox in friend selection modal
            const friendItem = document.querySelector(`.friend-item[data-friend-id="${friendId}"]`);
            if (friendItem) {
                const checkbox = friendItem.querySelector('.friend-checkbox');
                checkbox.classList.remove('selected');
                checkbox.querySelector('i').style.display = 'none';
            }
        }
        
        // REAL GROUP CREATION FUNCTIONALITY
        async function createGroupOnline(groupData) {
            try {
                // Prepare members list (creator + selected friends)
                const members = [currentUser.uid, ...selectedFriends];
                
                const groupDataToSave = {
                    name: groupData.name,
                    description: groupData.description || '',
                    topic: groupData.topic || '',
                    privacy: groupData.privacy || 'private',
                    theme: groupData.theme || 'blue',
                    welcomeMessage: groupData.welcomeMessage || '',
                    rules: groupData.rules || [],
                    moderationSettings: groupData.moderationSettings || {},
                    joinQuestions: groupData.joinQuestions || [],
                    customReactions: groupData.customReactions || ['üëç', '‚ù§Ô∏è', 'üòÇ'],
                    badges: groupData.badges || ['star', 'fire'],
                    memberIds: members
                };
                
                const response = await api('groups/create', 'POST', groupDataToSave);
                
                if (!response.success) {
                    throw new Error(response.message || 'Failed to create group');
                }
                
                const newGroup = response.data;
                
                // Add to local cache
                groups.push(newGroup);
                myGroups.push(newGroup);
                adminGroups.push(newGroup);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                // Generate invite link
                const inviteLink = `${window.location.origin}/group.html?join=${newGroup.id}`;
                document.getElementById('inviteLinkInput').value = inviteLink;
                document.getElementById('copyInviteLinkBtn').disabled = false;
                document.getElementById('shareInviteLinkBtn').disabled = false;
                
                showNotification('Group created successfully!', 'success');
                
                createGroupModal.classList.remove('active');
                friendSelectionModal.classList.remove('active');
                
                // Reset selected friends
                selectedFriends = [];
                
                // Show group details
                showGroupDetails(newGroup, 'my_group');
                
            } catch (error) {
                console.error('Error creating group:', error);
                showNotification('Failed to create group: ' + error.message, 'error');
            }
        }
        
        // REAL GROUP JOINING FUNCTIONALITY
        async function joinGroupOnline(groupId) {
            try {
                const response = await api(`groups/${groupId}/join`, 'POST');
                
                if (!response.success) {
                    showNotification(response.message || 'Failed to join group', 'error');
                    return;
                }
                
                const updatedGroup = response.data;
                
                // Update local cache
                const existingIndex = groups.findIndex(g => g.id === groupId);
                if (existingIndex !== -1) {
                    groups[existingIndex] = updatedGroup;
                } else {
                    groups.push(updatedGroup);
                }
                
                joinedGroups.push(updatedGroup);
                
                // Remove from invites
                groupInvites = groupInvites.filter(invite => invite.groupId !== groupId);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                showNotification('Successfully joined the group!', 'success');
                
                // Close invite modal if open
                groupInviteModal.classList.remove('active');
                
            } catch (error) {
                console.error('Error joining group:', error);
                showNotification('Failed to join group: ' + error.message, 'error');
            }
        }
        
        // REAL GROUP LEAVING FUNCTIONALITY
        async function leaveGroupOnline(groupId) {
            try {
                const response = await api(`groups/${groupId}/leave`, 'POST');
                
                if (!response.success) {
                    showNotification(response.message || 'Failed to leave group', 'error');
                    return;
                }
                
                // Update local cache
                groups = groups.filter(g => g.id !== groupId);
                joinedGroups = joinedGroups.filter(g => g.id !== groupId);
                adminGroups = adminGroups.filter(g => g.id !== groupId);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                showNotification('Successfully left the group', 'success');
                
                if (groupDetailsPanel.classList.contains('active')) {
                    groupDetailsPanel.classList.remove('active');
                    selectedGroup = null;
                }
                
            } catch (error) {
                console.error('Error leaving group:', error);
                showNotification('Failed to leave group: ' + error.message, 'error');
            }
        }
        
        async function inviteMemberOnline(groupId, userId) {
            try {
                const response = await api(`groups/${groupId}/invite`, 'POST', { userId });
                
                if (!response.success) {
                    showNotification(response.message || 'Failed to send invitation', 'error');
                    return;
                }
                
                showNotification('Invitation sent successfully', 'success');
                
            } catch (error) {
                console.error('Error inviting member:', error);
                showNotification('Failed to send invitation: ' + error.message, 'error');
            }
        }
        
        async function acceptGroupInvite(inviteData) {
            try {
                const inviteId = inviteData.id || inviteData.inviteId;
                const groupId = inviteData.groupId || inviteData.id;
                
                const response = await api(`groups/invites/${inviteId}/accept`, 'POST');
                
                if (!response.success) {
                    showNotification(response.message || 'Failed to accept invitation', 'error');
                    return;
                }
                
                // Join the group
                await joinGroupOnline(groupId);
                
            } catch (error) {
                console.error('Error accepting group invite:', error);
                showNotification('Failed to accept invitation: ' + error.message, 'error');
            }
        }
        
        async function declineGroupInvite(inviteData) {
            try {
                const inviteId = inviteData.id || inviteData.inviteId;
                
                const response = await api(`groups/invites/${inviteId}/decline`, 'POST');
                
                if (!response.success) {
                    showNotification(response.message || 'Failed to decline invitation', 'error');
                    return;
                }
                
                // Update local cache
                groupInvites = groupInvites.filter(invite => invite.id !== inviteId);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                showNotification('Invitation declined', 'success');
                
                groupInviteModal.classList.remove('active');
                
            } catch (error) {
                console.error('Error declining group invite:', error);
                showNotification('Failed to decline invitation: ' + error.message, 'error');
            }
        }
        
        function leaveGroupConfirm(groupData) {
            if (confirm(`Are you sure you want to leave "${groupData.name}"? You will need to be invited again to rejoin.`)) {
                leaveGroupOnline(groupData.id);
            }
        }
        
        function showGroupDetails(groupData, type) {
            selectedGroup = groupData;
            
            document.querySelector('.group-details-title').textContent = 'Group Details';
            
            if (isMobile) {
                // For mobile: hide sidebar and show details panel
                sidebar.style.display = 'none';
                groupDetailsPanel.style.display = 'flex';
                groupDetailsPanel.classList.add('active');
            } else {
                // For desktop: show normally
                groupDetailsPanel.classList.add('active');
            }
            
            loadGroupDetails(groupData, type);
        }
        
        async function loadGroupDetails(groupData, type) {
            const detailsContent = document.getElementById('groupDetailsContent');
            detailsContent.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i><p>Loading group details...</p></div>';
            
            try {
                const theme = groupData.theme || 'blue';
                const themeInfo = groupThemes[theme];
                const groupType = groupData.type || 'private';
                const typeInfo = groupTypes[groupType];
                
                const initials = groupData.name 
                    ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                    : 'G';
                
                // Check user's role in the group
                const userRole = groupData.isCreator ? 'creator' : 
                                groupData.isAdmin ? 'admin' : 'member';
                
                const roleInfo = groupRoles[userRole];
                
                // Create welcome message if available
                const welcomeMessage = groupData.welcomeMessage || `Welcome to ${groupData.name}! We're glad to have you here.`;
                
                // Parse rules if available
                const rules = groupData.rules || [];
                
                // Try to get real member data
                let realMembers = [];
                try {
                    const response = await api(`groups/${groupData.id}/members`, 'GET');
                    if (response.success && response.data) {
                        realMembers = response.data.slice(0, 5); // Get first 5 members for preview
                    }
                } catch (error) {
                    console.log('Error loading members:', error);
                }
                
                detailsContent.innerHTML = `
                    <div class="group-profile-header">
                        <div class="group-profile-avatar" ${groupData.photoURL ? `style="background-image: url('${groupData.photoURL}'); background: ${themeInfo.gradient};"` : `style="background: ${themeInfo.gradient};"`}>
                            ${groupData.photoURL ? '' : `<span style="color: white; font-size: 36px;">${initials}</span>`}
                        </div>
                        <div class="group-profile-name">${groupData.name || 'Unnamed Group'}</div>
                        <div class="group-profile-topic">${groupData.topic || 'No topic set'}</div>
                        <div class="group-profile-type ${groupType}">
                            <i class="${typeInfo.icon}"></i> ${typeInfo.name}
                        </div>
                        <div class="role-badge ${userRole}">
                            <i class="${roleInfo.icon}"></i> ${roleInfo.name}
                        </div>
                    </div>
                    
                    <!-- Welcome Message -->
                    ${welcomeMessage ? `
                    <div class="welcome-message">
                        <div class="welcome-title">
                            <i class="fas fa-door-open"></i> Welcome!
                        </div>
                        <div>${welcomeMessage}</div>
                    </div>
                    ` : ''}
                    
                    <!-- Group Description -->
                    ${groupData.description ? `
                    <div class="group-info-section">
                        <div class="info-section-title">
                            <i class="fas fa-info-circle"></i>
                            <span>About This Group</span>
                        </div>
                        <div style="padding: 10px 0;">${groupData.description}</div>
                    </div>
                    ` : ''}
                    
                    <!-- Rules & Guidelines -->
                    ${rules.length > 0 ? `
                    <div class="rules-section">
                        <div class="rules-title">
                            <i class="fas fa-gavel"></i>
                            <span>Group Rules</span>
                        </div>
                        <ul class="rules-list">
                            ${rules.map(rule => `<li><i class="fas fa-check-circle" style="color: var(--success-color);"></i> ${rule}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <!-- Group Info Section -->
                    <div class="group-info-section">
                        <div class="info-section-title">
                            <i class="fas fa-chart-bar"></i>
                            <span>Group Statistics</span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Members:</span>
                            <span class="info-value">${groupData.memberCount || 0}</span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Created:</span>
                            <span class="info-value">${formatDate(groupData.createdAt || new Date())}</span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Last Activity:</span>
                            <span class="info-value">${formatTimeAgo(groupData.lastActivity || groupData.createdAt || new Date())}</span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Group Theme:</span>
                            <span class="info-value">
                                <div class="theme-badge ${theme}">
                                    <i class="fas fa-palette"></i>
                                    ${themeInfo.name}
                                </div>
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Privacy:</span>
                            <span class="info-value">
                                <div class="type-display ${groupType}">
                                    <i class="${typeInfo.icon}"></i>
                                    ${typeInfo.name}
                                </div>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Member List Preview -->
                    <div class="group-info-section">
                        <div class="info-section-title">
                            <i class="fas fa-users"></i>
                            <span>Members (${Math.min(groupData.memberCount || 0, 5)} shown)</span>
                        </div>
                        <div class="member-list">
                            ${realMembers.length > 0 ? 
                                realMembers.map((member, i) => `
                                    <div class="member-item">
                                        <div class="member-avatar" ${member.photoURL ? `style="background-image: url('${member.photoURL}')"` : 'style="background: var(--secondary-color)"'}>
                                            ${member.photoURL ? '' : `<span style="color: var(--text-primary); font-size: 14px;">${member.displayName ? member.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U'}</span>`}
                                        </div>
                                        <div class="member-info">
                                            <div class="member-name">
                                                <span>${member.displayName || 'Unknown User'}</span>
                                                ${member.uid === currentUser.uid ? `<span class="role-badge ${userRole}"><i class="${roleInfo.icon}"></i> ${roleInfo.name}</span>` : 
                                                 groupData.admins && groupData.admins.includes(member.uid) ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : 
                                                 '<span class="role-badge member"><i class="fas fa-user"></i> Member</span>'}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                ${member.uid === currentUser.uid ? 'You' : (member.online ? 'Online' : 'Offline')}
                                            </div>
                                        </div>
                                    </div>
                                `).join('') :
                                Array.from({length: Math.min(groupData.memberCount || 0, 5)}, (_, i) => `
                                    <div class="member-item">
                                        <div class="member-avatar" style="background: ${i === 0 ? themeInfo.gradient : 'var(--secondary-color)'}">
                                            <span style="color: ${i === 0 ? 'white' : 'var(--text-primary)'}; font-size: 14px;">${i === 0 ? 'Y' : 'M'}</span>
                                        </div>
                                        <div class="member-info">
                                            <div class="member-name">
                                                <span>${i === 0 ? 'You' : 'Member ' + (i+1)}</span>
                                                ${i === 0 ? `<span class="role-badge ${userRole}"><i class="${roleInfo.icon}"></i> ${roleInfo.name}</span>` : 
                                                   i < 3 ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : 
                                                   '<span class="role-badge member"><i class="fas fa-user"></i> Member</span>'}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                ${i === 0 ? 'Online' : (i < 3 ? 'Recently active' : 'Member')}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                        ${groupData.memberCount > 5 ? `
                            <div style="text-align: center; margin-top: 10px;">
                                <button class="action-btn secondary" id="viewAllMembersBtn" style="width: 100%;">
                                    <i class="fas fa-users"></i> View All ${groupData.memberCount} Members
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="action-btn success" id="openGroupChatBtn">
                            <i class="fas fa-comments"></i> Open Chat
                        </button>
                        
                        ${type === 'my_group' || type === 'admin' ? `
                            <button class="action-btn primary" id="manageGroupBtn">
                                <i class="fas fa-cog"></i> Manage
                            </button>
                        ` : ''}
                        
                        ${type === 'joined' ? `
                            <button class="action-btn danger" id="leaveGroupBtn">
                                <i class="fas fa-sign-out-alt"></i> Leave Group
                            </button>
                        ` : ''}
                        
                        <button class="action-btn secondary" id="groupOptionsBtn">
                            <i class="fas fa-ellipsis-h"></i> Options
                        </button>
                    </div>
                `;
                
                // Add event listeners for action buttons
                document.getElementById('openGroupChatBtn').addEventListener('click', () => {
                    openGroupChat(groupData);
                });
                
                if (document.getElementById('manageGroupBtn')) {
                    document.getElementById('manageGroupBtn').addEventListener('click', () => {
                        openAdminManagement(groupData);
                    });
                }
                
                if (document.getElementById('leaveGroupBtn')) {
                    document.getElementById('leaveGroupBtn').addEventListener('click', () => {
                        leaveGroupConfirm(groupData);
                    });
                }
                
                if (document.getElementById('groupOptionsBtn')) {
                    document.getElementById('groupOptionsBtn').addEventListener('click', () => {
                        showGroupOptions(groupData);
                    });
                }
                
                if (document.getElementById('viewAllMembersBtn')) {
                    document.getElementById('viewAllMembersBtn').addEventListener('click', () => {
                        showNotification('Full member list would open here', 'info');
                    });
                }
                
            } catch (error) {
                console.error('Error loading group details:', error);
                detailsContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading group details</p>
                        <p class="subtext">Please try again later</p>
                    </div>
                `;
            }
        }
        
        function showGroupOptions(groupData) {
            const options = [
                { icon: 'fas fa-share-alt', text: 'Share Group', action: () => shareGroup(groupData) },
                { icon: 'fas fa-bell', text: 'Mute Notifications', action: () => muteGroup(groupData) },
                { icon: 'fas fa-star', text: 'Add to Favorites', action: () => favoriteGroup(groupData) },
                { icon: 'fas fa-flag', text: 'Report Group', action: () => reportGroup(groupData) },
                { icon: 'fas fa-ban', text: 'Block Group', action: () => blockGroup(groupData) },
                { icon: 'fas fa-qrcode', text: 'Group QR Code', action: () => showGroupQRCode(groupData) },
                { icon: 'fas fa-link', text: 'Copy Invite Link', action: () => copyInviteLink(groupData) }
            ];
            
            // Add admin options if user is admin
            if (groupData.isAdmin || groupData.isCreator) {
                options.unshift(
                    { icon: 'fas fa-user-plus', text: 'Invite Members', action: () => inviteMembers(groupData) },
                    { icon: 'fas fa-edit', text: 'Edit Group Info', action: () => editGroupInfo(groupData) },
                    { icon: 'fas fa-user-shield', text: 'Manage Roles', action: () => manageRoles(groupData) },
                    { icon: 'fas fa-calendar-plus', text: 'Create Event', action: () => createEvent(groupData) },
                    { icon: 'fas fa-poll', text: 'Create Poll', action: () => createPoll(groupData) }
                );
            }
            
            showOptionsModal('Group Options', options, groupData.name);
        }
        
        function showOptionsModal(title, options, subtitle = '') {
            const modal = document.createElement('div');
            modal.className = 'options-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; align-items: center; justify-content: center;';
            
            modal.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; z-index: 1002; min-width: 300px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                        <div style="font-weight: 600;">${title}</div>
                        ${subtitle ? `<div style="font-size: 14px; color: var(--text-secondary); margin-top: 5px;">${subtitle}</div>` : ''}
                    </div>
                    <div>
                        ${options.map(option => {
                            return `
                                <div style="padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;"
                                     onmouseover="this.style.backgroundColor='var(--secondary-color)'" onmouseout="this.style.backgroundColor='transparent'" onclick="document.querySelector('.options-modal').remove(); ${option.action.toString().replace(/"/g, '&quot;')}();">
                                    <i class="${option.icon}" style="color: var(--primary-color); width: 20px;"></i>
                                    <span>${option.text}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="padding: 15px 20px; text-align: center;">
                        <button onclick="document.querySelector('.options-modal').remove();" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px 16px; border-radius: 8px;">Cancel</button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            document.body.appendChild(modal);
        }
        
        function shareGroup(groupData) {
            const shareUrl = `${window.location.origin}/group.html?id=${groupData.id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: groupData.name,
                    text: `Join ${groupData.name} on Knecta Chat`,
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                showNotification('Group link copied to clipboard', 'success');
            }
        }
        
        function muteGroup(groupData) {
            const mutedGroups = JSON.parse(localStorage.getItem('knecta_muted_groups') || '[]');
            
            if (!mutedGroups.includes(groupData.id)) {
                mutedGroups.push(groupData.id);
                localStorage.setItem('knecta_muted_groups', JSON.stringify(mutedGroups));
                showNotification('Group notifications muted', 'success');
            } else {
                showNotification('Group already muted', 'info');
            }
        }
        
        function favoriteGroup(groupData) {
            const favoriteGroups = JSON.parse(localStorage.getItem('knecta_favorite_groups') || '[]');
            
            if (!favoriteGroups.includes(groupData.id)) {
                favoriteGroups.push(groupData.id);
                localStorage.setItem('knecta_favorite_groups', JSON.stringify(favoriteGroups));
                showNotification('Group added to favorites', 'success');
            } else {
                showNotification('Group already in favorites', 'info');
            }
        }
        
        function reportGroup(groupData) {
            const reason = prompt(`Why are you reporting "${groupData.name}"?\n1. Spam\n2. Harassment\n3. Inappropriate content\n4. Fake group\n5. Other\n\nEnter reason number:`, '1');
            
            if (reason) {
                const reports = JSON.parse(localStorage.getItem('knecta_group_reports') || '[]');
                reports.push({
                    groupId: groupData.id,
                    groupName: groupData.name,
                    reason: reason,
                    timestamp: Date.now()
                });
                localStorage.setItem('knecta_group_reports', JSON.stringify(reports));
                
                showNotification('Group has been reported. Thank you for helping keep our community safe.', 'success');
            }
        }
        
        function blockGroup(groupData) {
            if (confirm(`Are you sure you want to block "${groupData.name}"? You will no longer see this group or receive notifications from it.`)) {
                const blockedGroups = JSON.parse(localStorage.getItem('knecta_blocked_groups') || '[]');
                blockedGroups.push({
                    groupId: groupData.id,
                    groupName: groupData.name,
                    timestamp: Date.now()
                });
                localStorage.setItem('knecta_blocked_groups', JSON.stringify(blockedGroups));
                
                // Remove from local lists
                groups = groups.filter(g => g.id !== groupData.id);
                myGroups = myGroups.filter(g => g.id !== groupData.id);
                joinedGroups = joinedGroups.filter(g => g.id !== groupData.id);
                adminGroups = adminGroups.filter(g => g.id !== groupData.id);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                showNotification('Group blocked successfully', 'success');
                
                if (groupDetailsPanel.classList.contains('active')) {
                    groupDetailsPanel.classList.remove('active');
                    selectedGroup = null;
                }
            }
        }
        
        function showGroupQRCode(groupData) {
            showNotification('Group QR code feature coming soon', 'info');
        }
        
        function copyInviteLink(groupData) {
            const inviteLink = `${window.location.origin}/group.html?join=${groupData.id}`;
            navigator.clipboard.writeText(inviteLink);
            showNotification('Invite link copied to clipboard', 'success');
        }
        
        function inviteMembers(groupData) {
            showFriendSelection();
        }
        
        function editGroupInfo(groupData) {
            showNotification('Group edit panel would open here', 'info');
        }
        
        function manageRoles(groupData) {
            openAdminManagement(groupData);
        }
        
        function createEvent(groupData) {
            showNotification('Event creation panel would open here', 'info');
        }
        
        function createPoll(groupData) {
            showNotification('Poll creation panel would open here', 'info');
        }
        
        function showGroupInviteDetails(inviteData) {
            const groupData = inviteData.groupData || inviteData;
            
            document.getElementById('inviteName').textContent = groupData.name || 'Unnamed Group';
            document.getElementById('inviteTopic').textContent = groupData.topic || 'No topic';
            document.getElementById('inviteMemberCount').innerHTML = `<i class="fas fa-users"></i> ${groupData.memberCount || 0} members`;
            document.getElementById('invitedBy').textContent = inviteData.invitedByName || 'Unknown';
            
            const avatar = document.getElementById('inviteAvatar');
            if (groupData.photoURL) {
                avatar.style.backgroundImage = `url('${groupData.photoURL}')`;
                avatar.innerHTML = '';
            } else {
                const initials = groupData.name 
                    ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                    : 'G';
                avatar.innerHTML = `<span style="color: white; font-size: 24px;">${initials}</span>`;
            }
            
            window.currentInvite = inviteData;
            
            groupInviteModal.classList.add('active');
        }
        
        function matchesFilters(groupData) {
            if (currentTypeFilter !== 'all' && groupData.type !== currentTypeFilter) {
                return false;
            }
            
            if (currentSearchTerm && !matchesSearch(groupData, currentSearchTerm)) {
                return false;
            }
            
            return true;
        }
        
        function matchesSearch(groupData, searchTerm) {
            if (!searchTerm) return true;
            
            const searchIn = [
                groupData.name || '',
                groupData.topic || '',
                groupData.description || ''
            ].join(' ').toLowerCase();
            
            return searchIn.includes(searchTerm.toLowerCase());
        }
        
        function filterGroupsByType(type) {
            currentTypeFilter = type;
            updateCurrentSection();
            
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`.type-filter-btn[data-type="${type}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        function searchGroups(searchTerm) {
            currentSearchTerm = searchTerm.toLowerCase().trim();
            updateCurrentSection();
        }
        
        function saveGroupsToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEYS.GROUPS, JSON.stringify(groups));
                localStorage.setItem(LOCAL_STORAGE_KEYS.MY_GROUPS, JSON.stringify(myGroups));
                localStorage.setItem(LOCAL_STORAGE_KEYS.JOINED_GROUPS, JSON.stringify(joinedGroups));
                localStorage.setItem(LOCAL_STORAGE_KEYS.GROUP_INVITES, JSON.stringify(groupInvites));
                localStorage.setItem(LOCAL_STORAGE_KEYS.ADMIN_GROUPS, JSON.stringify(adminGroups));
                localStorage.setItem(LOCAL_STORAGE_KEYS.PENDING_ACTIONS, JSON.stringify(pendingGroupActions));
                localStorage.setItem(LOCAL_STORAGE_KEYS.LAST_CACHE_TIME, Date.now().toString());
                console.log('Groups saved to local storage');
            } catch (error) {
                console.error('Error saving groups to local storage:', error);
            }
        }
        
        function formatTimeAgo(date) {
            const dateObj = date instanceof Date ? date : new Date(date);
            const now = new Date();
            const diffMs = now - dateObj;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return `${Math.floor(diffDays / 7)}w ago`;
        }
        
        function formatDate(date) {
            const dateObj = date instanceof Date ? date : new Date(date);
            return dateObj.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function showNotification(message, type = 'success') {
            const notificationText = document.getElementById('notificationText');
            if (!notificationText) return;
            
            notificationText.textContent = message;
            
            notification.className = 'notification';
            notification.classList.add(type);
            
            notification.classList.add('active');
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        function processPendingOfflineActions() {
            try {
                // Process any other pending actions
                const pendingActions = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.PENDING_ACTIONS) || '[]');
                if (pendingActions.length > 0) {
                    console.log('Processing pending group actions...');
                }
                
            } catch (error) {
                console.error('Error processing pending offline actions:', error);
            }
        }
        
        function setupEventListeners() {
            // Category tabs
            document.getElementById('allTab').addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                document.querySelectorAll('.groups-section').forEach(section => {
                    section.classList.remove('active');
                });
                allGroupsSection.classList.add('active');
                
                updateCurrentSection();
            });
            
            document.getElementById('myGroupsTab').addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                document.querySelectorAll('.groups-section').forEach(section => {
                    section.classList.remove('active');
                });
                myGroupsSection.classList.add('active');
            });
            
            document.getElementById('joinedTab').addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                document.querySelectorAll('.groups-section').forEach(section => {
                    section.classList.remove('active');
                });
                joinedSection.classList.add('active');
            });
            
            document.getElementById('invitesTab').addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                document.querySelectorAll('.groups-section').forEach(section => {
                    section.classList.remove('active');
                });
                invitesSection.classList.add('active');
            });
            
            document.getElementById('adminTab').addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                document.querySelectorAll('.groups-section').forEach(section => {
                    section.classList.remove('active');
                });
                adminSection.classList.add('active');
            });
            
            // Type filter buttons
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.dataset.type;
                    filterGroupsByType(type);
                });
            });
            
            // Search input
            document.getElementById('groupSearch').addEventListener('input', function() {
                searchGroups(this.value);
            });
            
            // Create group button
            document.getElementById('createGroupBtn').addEventListener('click', () => {
                createGroupModal.classList.add('active');
                document.querySelector('.create-group-tab[data-tab="basic"]').click();
                
                // Reset form
                document.getElementById('groupNameInput').value = '';
                document.getElementById('groupDescriptionInput').value = '';
                document.getElementById('groupTopicInput').value = '';
                document.getElementById('groupTypeSelect').value = 'private';
                document.getElementById('welcomeMessageInput').value = '';
                document.getElementById('groupRulesInput').value = '1. Be respectful to all members\n2. No spam or self-promotion\n3. Keep discussions relevant to the group topic\n4. No hate speech or harassment';
                document.getElementById('approveNewMembers').checked = true;
                document.getElementById('onlyAdminsCanPost').checked = false;
                document.getElementById('allowMediaSharing').checked = true;
                document.getElementById('enableDisappearingMessages').checked = false;
                document.getElementById('joinQuestionsInput').value = '';
                
                // Reset theme selection
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.querySelector('i').style.display = 'none';
                });
                document.querySelector('.theme-option[data-theme="blue"]').querySelector('i').style.display = 'inline';
                
                // Reset reactions
                document.querySelectorAll('.reaction-option').forEach(option => {
                    option.style.borderColor = 'var(--border-color)';
                });
                
                // Reset badges
                document.querySelectorAll('.badge-option').forEach(option => {
                    option.style.borderColor = 'var(--border-color)';
                });
                document.querySelector('.badge-option[data-badge="star"]').style.borderColor = 'var(--primary-color)';
                document.querySelector('.badge-option[data-badge="fire"]').style.borderColor = 'var(--primary-color)';
                
                // Reset selected friends
                selectedFriends = [];
                updateSelectedFriendsList();
            });
            
            // Quick action buttons
            document.getElementById('discoverGroupsBtn').addEventListener('click', () => {
                showNotification('Group discovery feature would open here', 'info');
            });
            
            document.getElementById('groupInvitesBtn').addEventListener('click', () => {
                showMobileSection('invites');
            });
            
            document.getElementById('groupEventsBtn').addEventListener('click', () => {
                showNotification('Group events feature would open here', 'info');
            });
            
            // Create group modal tabs
            document.querySelectorAll('.create-group-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    document.querySelectorAll('.create-group-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.create-group-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabContent = document.getElementById(`${tabName}Tab`);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
            
            // Theme selection
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.dataset.theme;
                    
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        opt.querySelector('i').style.display = 'none';
                    });
                    
                    this.querySelector('i').style.display = 'inline';
                });
            });
            
            // Reaction selection
            document.querySelectorAll('.reaction-option').forEach(option => {
                option.addEventListener('click', function() {
                    const reaction = this.dataset.reaction;
                    
                    if (this.style.borderColor === 'var(--primary-color)') {
                        this.style.borderColor = 'var(--border-color)';
                    } else {
                        this.style.borderColor = 'var(--primary-color)';
                    }
                });
            });
            
            // Badge selection
            document.querySelectorAll('.badge-option').forEach(option => {
                option.addEventListener('click', function() {
                    const badge = this.dataset.badge;
                    
                    if (this.style.borderColor === 'var(--primary-color)') {
                        this.style.borderColor = 'var(--border-color)';
                    } else {
                        this.style.borderColor = 'var(--primary-color)';
                    }
                });
            });
            
            // Add members button
            document.getElementById('addMembersBtn').addEventListener('click', () => {
                showFriendSelection();
            });
            
            // Friend selection modal buttons
            document.getElementById('cancelFriendSelectionBtn').addEventListener('click', () => {
                friendSelectionModal.classList.remove('active');
            });
            
            document.getElementById('confirmFriendSelectionBtn').addEventListener('click', () => {
                friendSelectionModal.classList.remove('active');
                showNotification(`${selectedFriends.length} friends selected`, 'success');
            });
            
            // Create group button in modal
            document.getElementById('createGroupBtnModal').addEventListener('click', async () => {
                const groupName = document.getElementById('groupNameInput').value.trim();
                
                if (!groupName) {
                    showNotification('Please enter a group name', 'error');
                    return;
                }
                
                try {
                    const selectedTheme = document.querySelector('.theme-option i[style*="display: inline"]')?.parentNode?.dataset.theme || 'blue';
                    const selectedReactions = Array.from(document.querySelectorAll('.reaction-option[style*="border-color: var(--primary-color)"]')).map(el => el.dataset.reaction);
                    const selectedBadges = Array.from(document.querySelectorAll('.badge-option[style*="border-color: var(--primary-color)"]')).map(el => el.dataset.badge);
                    
                    const groupData = {
                        name: groupName,
                        description: document.getElementById('groupDescriptionInput').value.trim(),
                        topic: document.getElementById('groupTopicInput').value.trim(),
                        privacy: document.getElementById('groupTypeSelect').value,
                        theme: selectedTheme,
                        welcomeMessage: document.getElementById('welcomeMessageInput').value.trim(),
                        rules: document.getElementById('groupRulesInput').value.trim().split('\n').filter(rule => rule.trim()),
                        moderationSettings: {
                            approveNewMembers: document.getElementById('approveNewMembers').checked,
                            onlyAdminsCanPost: document.getElementById('onlyAdminsCanPost').checked,
                            allowMediaSharing: document.getElementById('allowMediaSharing').checked,
                            disappearingMessages: document.getElementById('enableDisappearingMessages').checked
                        },
                        joinQuestions: document.getElementById('joinQuestionsInput').value.trim().split('\n').filter(q => q.trim()),
                        customReactions: selectedReactions.length > 0 ? selectedReactions : ['üëç', '‚ù§Ô∏è', 'üòÇ'],
                        badges: selectedBadges.length > 0 ? selectedBadges : ['star', 'fire']
                    };
                    
                    await createGroupOnline(groupData);
                    
                } catch (error) {
                    console.error('Error creating group:', error);
                    showNotification('Failed to create group: ' + error.message, 'error');
                }
            });
            
            // Close modals
            document.getElementById('closeCreateGroupModal').addEventListener('click', () => {
                createGroupModal.classList.remove('active');
            });
            
            document.getElementById('cancelCreateGroupBtn').addEventListener('click', () => {
                createGroupModal.classList.remove('active');
            });
            
            // Back button
            document.getElementById('backBtn').addEventListener('click', () => {
                if (isMobile) {
                    // For mobile: show sidebar and hide details panel
                    sidebar.style.display = 'flex';
                    groupDetailsPanel.style.display = 'none';
                }
                groupDetailsPanel.classList.remove('active');
                selectedGroup = null;
            });
            
            // =============================================
            // NEW: CHAT EVENT LISTENERS
            // =============================================
            
            // Close chat button
            closeChatBtn.addEventListener('click', () => {
                if (isMobile) {
                    closeGroupChatMobile();
                } else {
                    hideAllPanels();
                    if (chatUnsubscribe) {
                        chatUnsubscribe();
                        chatUnsubscribe = null;
                    }
                }
            });
            
            // Chat info button
            chatInfoBtn.addEventListener('click', () => {
                if (currentChatGroup) {
                    hideAllPanels();
                    showGroupDetails(currentChatGroup, 'joined');
                }
            });
            
            // Chat call button
            chatCallBtn.addEventListener('click', () => {
                if (currentChatGroup) {
                    startGroupCall();
                }
            });
            
            // Chat input
            chatInput.addEventListener('input', adjustTextareaHeight);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendGroupMessage();
                }
            });
            
            // Chat send button
            chatSendBtn.addEventListener('click', sendGroupMessage);
            
            // =============================================
            // NEW: CALL EVENT LISTENERS
            // =============================================
            
            // End call button
            endCallBtn.addEventListener('click', endGroupCall);
            callLeaveBtn.addEventListener('click', endGroupCall);
            
            // Call control buttons
            callMuteBtn.addEventListener('click', () => {
                if (localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        callMuteBtn.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
                    }
                }
            });
            
            callVideoBtn.addEventListener('click', () => {
                if (localStream) {
                    const videoTrack = localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = !videoTrack.enabled;
                        callVideoBtn.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
                    }
                }
            });
            
            // =============================================
            // NEW: ADMIN MANAGEMENT EVENT LISTENERS
            // =============================================
            
            // Admin management tabs
            document.querySelectorAll('.admin-management-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    document.querySelectorAll('.admin-management-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.admin-management-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    const tabContent = document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
            
            // Close admin management
            document.getElementById('closeAdminManagementBtn').addEventListener('click', () => {
                adminManagementModal.classList.remove('active');
            });
            
            // Save admin settings
            document.getElementById('saveAdminSettingsBtn').addEventListener('click', () => {
                if (selectedGroup) {
                    saveGroupSettings(selectedGroup);
                }
            });
            
            // Group invite modal buttons
            document.getElementById('acceptInviteBtn').addEventListener('click', () => {
                if (window.currentInvite) {
                    acceptGroupInvite(window.currentInvite);
                }
            });
            
            document.getElementById('declineInviteBtn').addEventListener('click', () => {
                if (window.currentInvite) {
                    declineGroupInvite(window.currentInvite);
                }
            });
            
            // Copy invite link button
            document.getElementById('copyInviteLinkBtn').addEventListener('click', () => {
                const link = document.getElementById('inviteLinkInput').value;
                if (link) {
                    navigator.clipboard.writeText(link);
                    showNotification('Invite link copied to clipboard', 'success');
                }
            });
            
            // Share invite link button
            document.getElementById('shareInviteLinkBtn').addEventListener('click', () => {
                const link = document.getElementById('inviteLinkInput').value;
                if (link && navigator.share) {
                    navigator.share({
                        title: 'Join my group on Knecta Chat',
                        text: 'Check out this group I created on Knecta Chat',
                        url: link
                    });
                } else if (link) {
                    navigator.clipboard.writeText(link);
                    showNotification('Invite link copied to clipboard', 'success');
                }
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                checkMobile();
            });
            
            // Before unload
            window.addEventListener('beforeunload', () => {
                saveGroupsToLocalStorage();
                
                // End call if active
                if (callInProgress) {
                    endGroupCall();
                }
                
                // Unsubscribe from chat
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                }
            });
            
            // Initialize offline overlay dismissal
            dismissOfflineBtn.addEventListener('click', () => {
                offlineOverlay.style.display = 'none';
                localStorage.setItem(LOCAL_STORAGE_KEYS.OFFLINE_OVERLAY_DISMISSED, 'true');
            });
        }
        
        console.log('Complete functional groups system initialized successfully with all real features');
    </script>
    <!-- CORRECT - same folder -->
<script src="js/api.js"></script>
<script src="js/settingsManager.js"></script>
<script src="js/app.js"></script>
</body>
</html>