<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="icon" href="../icons/moodchat-192.png">
    <link rel="icon" href="../icons/moodchat-512.png">
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kynecta Groups</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- User Data Scripts -->
    <script src="user-data.js"></script>
    <script src="display-user-selections.js"></script>
    
    <!-- Settings Manager -->
    <script src="settingsManager.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Emoji Picker - FIXED URL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.14.0/dist/style.css">
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.14.0/dist/index.min.js" type="module"></script>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        }
        
        :root {
            --primary-color: #0084ff;
            --kynecta-blue: #4F46E5;
            --kynecta-light-blue: #e0e7ff;
            --kynecta-dark-blue: #3730a3;
            --secondary-color: #f0f2f5;
            --danger-color: #ff3b30;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --bg-color: #ffffff;
            --chat-bg: #f5f7fa;
            --border-color: #e5e7eb;
            --sidebar-width: 400px;
            --header-height: 60px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%234F46E5' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-header {
            padding: 10px 16px;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            background: linear-gradient(135deg, var(--kynecta-blue), var(--kynecta-dark-blue));
            color: white;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: white;
        }
        
        .user-status {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success-color);
            display: inline-block;
        }
        
        .sidebar-actions {
            display: flex;
            gap: 10px;
        }
        
        .sidebar-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 20px;
            transition: background-color 0.2s;
        }
        
        .sidebar-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .search-container {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-box {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 20px 10px 40px;
            border-radius: 20px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 14px;
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .groups-tabs {
            display: flex;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-color);
        }
        
        .group-tab {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .group-tab.active {
            color: var(--kynecta-blue);
            border-bottom-color: var(--kynecta-blue);
        }
        
        .groups-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .group-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .group-item:hover {
            background-color: var(--secondary-color);
        }
        
        .group-item.active {
            background-color: var(--kynecta-light-blue);
            border-left: 4px solid var(--kynecta-blue);
        }
        
        .group-avatar {
            width: 49px;
            height: 49px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 15px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            position: relative;
            flex-shrink: 0;
        }
        
        .group-avatar-multi {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1px;
            background-color: white;
            padding: 1px;
        }
        
        .group-avatar-multi .avatar-piece {
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .group-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            background-color: var(--kynecta-blue);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid var(--bg-color);
        }
        
        .group-info {
            flex: 1;
            min-width: 0;
        }
        
        .group-name-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .group-name {
            font-weight: 600;
            font-size: 17px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .group-time {
            font-size: 12px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .group-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .group-last-message {
            color: var(--text-secondary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .group-unread {
            background-color: var(--kynecta-blue);
            color: white;
            font-size: 12px;
            font-weight: 600;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--chat-bg);
            position: relative;
        }
        
        .group-header {
            background-color: var(--bg-color);
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: var(--header-height);
            background: linear-gradient(135deg, var(--kynecta-blue), var(--kynecta-dark-blue));
            color: white;
        }
        
        .group-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .group-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            position: relative;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .group-header-avatar-multi {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1px;
            background-color: white;
            padding: 1px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .group-header-avatar-multi .avatar-piece {
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: white;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        
        .group-header-details {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .group-header-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }
        
        .group-header-details p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .group-header-actions {
            display: flex;
            gap: 10px;
        }
        
        .header-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 20px;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .header-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Chat Area */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%234F46E5' fill-opacity='0.04' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .message-date {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        
        .date-label {
            background-color: var(--secondary-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            display: inline-block;
        }
        
        .message-wrapper {
            display: flex;
            margin-bottom: 10px;
            padding: 0 20px;
        }
        
        .message-wrapper.sent {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
            position: relative;
        }
        
        .message-bubble.sent {
            background-color: var(--kynecta-light-blue);
            border-top-right-radius: 0;
        }
        
        .message-bubble.received {
            border-top-left-radius: 0;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            color: var(--kynecta-blue);
        }
        
        .message-content {
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .message-content img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 5px;
        }
        
        .message-meta {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
        }
        
        .message-status {
            font-size: 12px;
        }
        
        .message-status.delivered {
            color: var(--text-secondary);
        }
        
        .message-status.read {
            color: var(--kynecta-blue);
        }
        
        .message-reactions {
            display: flex;
            gap: 2px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .reaction {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
        }
        
        .reaction:hover {
            background-color: var(--secondary-color);
        }
        
        .reaction-count {
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        /* Chat Input */
        .chat-input-container {
            padding: 10px 16px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
        }
        
        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-input-actions {
            display: flex;
            gap: 5px;
        }
        
        .chat-action-btn {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 20px;
            transition: background-color 0.2s;
        }
        
        .chat-action-btn:hover {
            background-color: var(--secondary-color);
            color: var(--kynecta-blue);
        }
        
        .chat-input-area {
            flex: 1;
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 5px 15px;
        }
        
        .message-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 10px;
            font-size: 15px;
            background: transparent;
            resize: none;
            max-height: 100px;
            font-family: inherit;
        }
        
        .emoji-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
        }
        
        .send-btn {
            background-color: var(--kynecta-blue);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.2s;
        }
        
        .send-btn:hover {
            background-color: var(--kynecta-dark-blue);
        }
        
        .send-btn:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        /* Group Details Panel */
        .group-details-panel {
            width: 400px;
            background-color: var(--bg-color);
            border-left: 1px solid var(--border-color);
            height: 100%;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            position: absolute;
            right: 0;
            top: 0;
            z-index: 100;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .group-details-panel.active {
            display: flex;
        }
        
        .details-header {
            padding: 20px;
            background-color: var(--kynecta-blue);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--kynecta-blue), var(--kynecta-dark-blue));
        }
        
        .details-header h3 {
            font-size: 18px;
        }
        
        .close-details-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 20px;
            color: white;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .close-details-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .details-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .details-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-icon {
            color: var(--kynecta-blue);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        
        .group-description {
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 14px;
            padding: 10px;
            background-color: var(--secondary-color);
            border-radius: 8px;
        }
        
        .group-description.empty {
            font-style: italic;
            color: #a0a4a8;
        }
        
        .participants-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        
        .participant-item:hover {
            background-color: var(--secondary-color);
        }
        
        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            margin-right: 12px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            position: relative;
            flex-shrink: 0;
        }
        
        .participant-info {
            flex: 1;
            min-width: 0;
        }
        
        .participant-name {
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .participant-status {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .mood-indicator {
            background-color: #e3f2fd;
            color: #1976d2;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .interest-indicator {
            background-color: #f3e5f5;
            color: #7b1fa2;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .admin-badge {
            background-color: var(--kynecta-blue);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-left: 5px;
        }
        
        .participant-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        
        .participant-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .participant-action-btn:hover {
            background-color: var(--secondary-color);
            color: var(--kynecta-blue);
        }
        
        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background-color: var(--secondary-color);
            border-radius: 8px;
        }
        
        .activity-icon {
            width: 30px;
            height: 30px;
            background-color: var(--kynecta-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .activity-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .activity-time {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* Media Grid */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .media-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--secondary-color);
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--kynecta-blue);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-option:last-child {
            border-bottom: none;
        }
        
        .settings-info {
            flex: 1;
        }
        
        .settings-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .settings-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Poll Styling */
        .poll-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            margin: 10px 0;
        }
        
        .poll-question {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .poll-option {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .poll-option:hover {
            background-color: var(--secondary-color);
        }
        
        .poll-bar {
            height: 8px;
            background-color: var(--secondary-color);
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .poll-fill {
            height: 100%;
            background-color: var(--kynecta-blue);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .poll-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* Task Styling */
        .task-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            margin: 10px 0;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-checkbox.completed {
            background-color: var(--kynecta-blue);
            border-color: var(--kynecta-blue);
            color: white;
        }
        
        .task-content {
            flex: 1;
        }
        
        .task-title {
            font-weight: 500;
        }
        
        .task-assignee {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Event Styling */
        .event-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            margin: 10px 0;
        }
        
        .event-date {
            color: var(--kynecta-blue);
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .event-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .event-details {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .event-rsvp {
            display: flex;
            gap: 10px;
        }
        
        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-card {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--kynecta-blue);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--bg-color);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .modal-close:hover {
            background-color: var(--secondary-color);
        }
        
        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--kynecta-blue);
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--kynecta-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--kynecta-dark-blue);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background-color: #e4e6e9;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d70015;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #0da271;
        }
        
        /* Selected Participants */
        .selected-participants {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            min-height: 40px;
        }
        
        .selected-participant-chip {
            display: inline-flex;
            align-items: center;
            background-color: var(--kynecta-blue);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
        }
        
        .remove-chip-btn {
            background: none;
            border: none;
            color: white;
            margin-left: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Search Results */
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            display: none;
        }
        
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: var(--secondary-color);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .spinner {
            border: 3px solid var(--secondary-color);
            border-top: 3px solid var(--kynecta-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .notification.active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.warning {
            background-color: var(--warning-color);
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: var(--warning-color);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }
        
        /* Voice Message */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--secondary-color);
            border-radius: 8px;
            margin-top: 5px;
        }
        
        .play-btn {
            background: none;
            border: none;
            color: var(--kynecta-blue);
            font-size: 20px;
            cursor: pointer;
        }
        
        .voice-waveform {
            flex: 1;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .voice-duration {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Reply Message */
        .reply-container {
            background-color: rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--kynecta-blue);
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        
        .reply-sender {
            font-weight: 600;
            font-size: 12px;
            color: var(--kynecta-blue);
        }
        
        .reply-content {
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Forwarded Message */
        .forwarded-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }
        
        /* Starred Messages */
        .starred-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ffc107;
            font-size: 12px;
        }
        
        /* Reaction Picker */
        .reaction-picker {
            position: absolute;
            bottom: 100%;
            left: 0;
            background-color: white;
            border-radius: 20px;
            padding: 5px;
            display: flex;
            gap: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .reaction-option {
            font-size: 20px;
            cursor: pointer;
            padding: 2px;
            transition: transform 0.2s;
        }
        
        .reaction-option:hover {
            transform: scale(1.2);
        }
        
        /* Mention */
        .mention {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--kynecta-blue);
            padding: 0 4px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* Call Interface */
        .call-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }
        
        .call-interface.active {
            display: flex;
        }
        
        .call-participants {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            padding: 20px;
        }
        
        .call-participant {
            background-color: #2d2d2d;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .call-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .call-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .call-end-btn {
            background-color: #ff3b30;
            color: white;
        }
        
        .call-mute-btn, .call-video-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 350px;
            }
            
            .group-details-panel {
                width: 100%;
                max-width: 350px;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }
            
            .group-details-panel {
                width: 100%;
                max-width: 100%;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
            }
            
            .call-participants {
                grid-template-columns: 1fr;
            }
            
            /* Mobile-specific group chat features */
            .group-header-actions {
                display: flex;
                gap: 5px;
            }
            
            .header-action-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .chat-input-actions {
                display: none; /* Hide on mobile, show in attach menu */
            }
            
            .chat-action-btn {
                width: 35px;
                height: 35px;
            }
            
            .group-details-panel {
                position: fixed;
                width: 100%;
                height: 100%;
                z-index: 1000;
            }
            
            .details-header {
                padding: 15px;
            }
            
            .details-section {
                padding: 15px;
            }
            
            /* Mobile chat bubbles */
            .message-bubble {
                max-width: 85%;
            }
            
            /* Hide group details panel by default on mobile */
            .group-details-panel:not(.active) {
                display: none;
            }
            
            /* Mobile attach menu */
            #attachMenuModal .modal-content {
                max-width: 250px;
            }
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: var(--text-secondary);
        }
        
        .mb-10 {
            margin-bottom: 10px;
        }
        
        .mt-10 {
            margin-top: 10px;
        }
        
        .p-10 {
            padding: 10px;
        }
        
        .w-100 {
            width: 100%;
        }
        
        .cursor-pointer {
            cursor: pointer;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-10 {
            gap: 10px;
        }
        
        .gap-20 {
            gap: 20px;
        }
        
        /* Offline Message Styling */
        .offline-message-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--warning-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            z-index: 1;
        }
        
        .offline-queue-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--warning-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        /* Offline Disabled State */
        .offline-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
        }
        
        .offline-disabled::after {
            content: " (Offline)";
            font-size: 0.8em;
            color: var(--warning-color);
        }
        
        .offline-disabled-btn {
            background-color: var(--text-secondary) !important;
            cursor: not-allowed !important;
        }
        
        .offline-disabled-btn:hover {
            background-color: var(--text-secondary) !important;
        }
        
        /* Mobile Group Features */
        .mobile-group-features {
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-group-features {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 15px;
                background-color: var(--bg-color);
                border-top: 1px solid var(--border-color);
            }
            
            .mobile-feature-btn {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 15px;
                background-color: var(--secondary-color);
                border: none;
                border-radius: 8px;
                font-size: 14px;
                color: var(--text-primary);
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .mobile-feature-btn:hover {
                background-color: #e4e6e9;
            }
            
            .mobile-feature-btn i {
                width: 20px;
                text-align: center;
            }
            
            /* Hide desktop-only features on mobile */
            .desktop-only {
                display: none;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-only {
                display: none;
            }
        }
        
        /* Offline Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: var(--kynecta-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            display: none;
        }
        
        .sync-indicator.active {
            display: flex;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Cached Data Indicator */
        .cached-data-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: var(--warning-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            z-index: 1;
        }
        
        /* New styles for offline-first */
        .cached-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            background-color: var(--warning-color);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            border: 2px solid var(--bg-color);
            z-index: 2;
        }
        
        .sync-indicator-small {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: var(--kynecta-blue);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            border: 2px solid var(--bg-color);
            z-index: 2;
        }
        
        .sync-spinner {
            animation: spin 1s linear infinite;
        }
        
        .groups-list-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-secondary);
        }
        
        .offline-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            display: none;
        }
        
        .offline-overlay.active {
            display: flex;
        }
        
        .refresh-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--kynecta-blue);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .refresh-btn:hover {
            background: var(--kynecta-dark-blue);
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator hidden">
        <i class="fas fa-wifi-slash"></i>
        <span>Offline Mode - Using Cached Data</span>
    </div>
    
    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator">
        <i class="fas fa-sync fa-spin"></i>
        <span>Syncing offline data...</span>
    </div>
    
    <div class="app-container">
        <!-- Sidebar with groups list -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-profile" id="userProfileBtn">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-status">
                            <span class="status-dot"></span>
                            <span id="userMood">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-actions">
                    <button class="sidebar-action-btn" id="statusBtn" title="Status">
                        <i class="fas fa-circle"></i>
                    </button>
                    <button class="sidebar-action-btn" id="newChatBtn" title="New Chat">
                        <i class="fas fa-comment"></i>
                    </button>
                    <button class="sidebar-action-btn" id="newGroupBtn" title="New Group">
                        <i class="fas fa-users"></i>
                    </button>
                    <button class="sidebar-action-btn" id="menuBtn" title="Menu">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchGroupsInput" placeholder="Search groups...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <div class="groups-tabs">
                <div class="group-tab active" data-tab="chats">Groups</div>
                <div class="group-tab" data-tab="activity">Activity</div>
                <div class="group-tab" data-tab="archived">Archived</div>
            </div>
            
            <div class="groups-list" id="groupsList">
                <!-- Loading skeleton will be added here -->
                <div class="offline-overlay" id="groupsOfflineOverlay">
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-wifi-slash" style="font-size: 40px; color: var(--warning-color); margin-bottom: 10px;"></i>
                        <p>Offline - Showing cached groups</p>
                        <button class="refresh-btn" id="refreshGroupsBtn">
                            <i class="fas fa-sync"></i> Retry Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main chat area -->
        <div class="main-content">
            <div class="group-header" id="groupHeader">
                <div class="group-header-info">
                    <div class="group-header-avatar" id="groupHeaderAvatar">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="group-header-details">
                        <h3 id="groupHeaderName">Kynecta Groups</h3>
                        <p id="groupHeaderStatus">Select a group to start chatting</p>
                    </div>
                </div>
                
                <div class="group-header-actions">
                    <button class="header-action-btn" id="searchChatBtn" title="Search in chat">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="header-action-btn" id="groupCallBtn" title="Group Call">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="header-action-btn" id="attachMenuBtn" title="Attach">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="header-action-btn" id="groupInfoBtn" title="Group Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div id="emptyChatState" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); padding: 20px;">
                    <div style="font-size: 80px; color: var(--border-color); margin-bottom: 20px;">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3 style="margin-bottom: 10px; color: var(--text-primary); text-align: center;">Welcome to Kynecta Groups</h3>
                    <p style="text-align: center; max-width: 400px; margin-bottom: 30px; line-height: 1.5;">
                        Create groups with your friends and family. Share messages, photos, videos, and documents. Group chats make it easy to stay connected with everyone at once.
                    </p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-primary" id="createGroupMainBtn">
                            <i class="fas fa-users"></i> Create New Group
                        </button>
                        <button class="btn btn-secondary" id="joinGroupBtn">
                            <i class="fas fa-link"></i> Join Group via Link
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Group Features Panel (Hidden on desktop) -->
            <div class="mobile-group-features mobile-only" id="mobileGroupFeatures" style="display: none;">
                <button class="mobile-feature-btn" id="mobileGroupInfoBtn">
                    <i class="fas fa-info-circle"></i> Group Info
                </button>
                <button class="mobile-feature-btn" id="mobileGroupMediaBtn">
                    <i class="fas fa-images"></i> Media & Files
                </button>
                <button class="mobile-feature-btn" id="mobileGroupParticipantsBtn">
                    <i class="fas fa-users"></i> Participants
                </button>
                <button class="mobile-feature-btn" id="mobileGroupSettingsBtn">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="mobile-feature-btn" id="mobileGroupStarredBtn">
                    <i class="fas fa-star"></i> Starred Messages
                </button>
            </div>
            
            <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                <div class="chat-input-wrapper">
                    <div class="chat-input-actions desktop-only">
                        <button class="chat-action-btn" id="emojiBtn" title="Emoji">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="chat-action-btn" id="attachBtn" title="Attach">
                            <i class="fas fa-paperclip"></i>
                        </button>
                    </div>
                    
                    <div class="chat-input-area">
                        <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                        <button class="emoji-btn mobile-only" id="mobileEmojiBtn">
                            <i class="far fa-smile"></i>
                        </button>
                    </div>
                    
                    <button class="send-btn" id="sendBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Group Details Panel -->
        <div class="group-details-panel" id="groupDetailsPanel">
            <div class="details-header">
                <h3>Group Info</h3>
                <button class="close-details-btn" id="closeDetailsBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="details-section">
                <div class="details-section-title">
                    Description
                    <span class="edit-icon" id="editDescriptionBtn">
                        <i class="fas fa-pencil-alt"></i>
                    </span>
                </div>
                <p class="group-description empty" id="groupDescriptionText">No description</p>
            </div>
            
            <div class="details-section">
                <div class="details-section-title">
                    Participants <span id="participantsCount">(0)</span>
                    <span class="edit-icon" id="addParticipantsBtn">
                        <i class="fas fa-user-plus"></i>
                    </span>
                </div>
                <div class="participants-list" id="participantsList">
                    <!-- Participants loaded here -->
                </div>
            </div>
            
            <div class="details-section">
                <div class="details-section-title">
                    Activity Feed
                </div>
                <div class="activity-feed" id="activityFeed">
                    <!-- Activity items loaded here -->
                </div>
            </div>
            
            <div class="details-section">
                <div class="details-section-title">
                    Media, Links & Docs
                    <span class="edit-icon" id="viewAllMediaBtn">
                        <i class="fas fa-external-link-alt"></i>
                    </span>
                </div>
                <div class="media-grid" id="groupMedia">
                    <div class="media-item" style="background-color: var(--secondary-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="media-item" style="background-color: var(--secondary-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="media-item" style="background-color: var(--secondary-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        <i class="fas fa-file"></i>
                    </div>
                </div>
            </div>
            
            <div class="details-section">
                <div class="details-section-title">Group Settings</div>
                <div class="settings-option">
                    <div class="settings-info">
                        <div class="settings-title">Mute Notifications</div>
                        <div class="settings-desc">You won't get notified for new messages</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="muteNotifications">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-option">
                    <div class="settings-info">
                        <div class="settings-title">Only Admins Can Send Messages</div>
                        <div class="settings-desc">Restrict who can send messages in this group</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="adminOnlyMessages">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-option">
                    <div class="settings-info">
                        <div class="settings-title">Disappearing Messages</div>
                        <div class="settings-desc">Messages disappear after 24 hours</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="disappearingMessages">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-option">
                    <div class="settings-info">
                        <div class="settings-title">Group Invite Link</div>
                        <div class="settings-desc">Share this link to invite people</div>
                    </div>
                    <button class="btn btn-secondary" id="inviteLinkBtn" style="padding: 5px 15px; font-size: 13px;">
                        <i class="fas fa-link"></i> Copy Link
                    </button>
                </div>
            </div>
            
            <div class="details-section">
                <div class="details-section-title">Group Statistics</div>
                <div class="stats-grid" id="groupStats">
                    <!-- Stats loaded here -->
                </div>
            </div>
            
            <div class="details-section">
                <div class="details-section-title">Starred Messages</div>
                <p style="color: var(--text-secondary); font-size: 14px;">View all messages you've starred in this group</p>
                <button class="btn btn-secondary w-100 mt-10" id="starredMessagesBtn">
                    <i class="far fa-star"></i> View Starred Messages
                </button>
            </div>
            
            <div class="details-section">
                <div class="details-section-title">Danger Zone</div>
                <button class="btn btn-secondary w-100 mb-10" id="leaveGroupBtn">
                    <i class="fas fa-sign-out-alt"></i> Leave Group
                </button>
                <button class="btn btn-danger w-100" id="reportGroupBtn">
                    <i class="fas fa-flag"></i> Report Group
                </button>
            </div>
        </div>
    </div>
    
    <!-- Create Group Modal -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Group</h3>
                <button class="modal-close" id="closeCreateGroupModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Group Name</label>
                    <input type="text" class="form-input" id="groupNameInput" placeholder="Group name (max 25 characters)" maxlength="25">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group Description (Optional)</label>
                    <textarea class="form-textarea" id="groupDescriptionInput" placeholder="Add a description for your group" maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Add Participants</label>
                    <div id="selectedParticipants" class="selected-participants"></div>
                    <input type="text" class="form-input" id="searchParticipantsInput" placeholder="Search contacts...">
                    <div id="participantsSearchResults" class="search-results"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group Photo (Optional)</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="group-avatar" id="groupAvatarPreview" style="width: 80px; height: 80px; font-size: 30px;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <button class="btn btn-secondary" id="uploadAvatarBtn">
                                <i class="fas fa-upload"></i> Upload Photo
                            </button>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Recommended: 500x500px</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group Type</label>
                    <select class="form-select" id="groupTypeSelect">
                        <option value="standard">Standard Group</option>
                        <option value="community">Community (With Channels)</option>
                        <option value="event">Event Group</option>
                        <option value="project">Project Group</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateGroup">Cancel</button>
                <button class="btn btn-primary" id="createGroupBtn">Create Group</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Group Modal -->
    <div class="modal" id="editGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Group Info</h3>
                <button class="modal-close" id="closeEditGroupModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Group Name</label>
                    <input type="text" class="form-input" id="editGroupNameInput" placeholder="Group name" maxlength="25">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group Description</label>
                    <textarea class="form-textarea" id="editGroupDescriptionInput" placeholder="Add a description for the group" rows="3" maxlength="500"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group Photo</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="group-avatar" id="editGroupAvatarPreview" style="width: 80px; height: 80px; font-size: 30px;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <button class="btn btn-secondary" id="editUploadAvatarBtn">Change</button>
                            <button class="btn btn-secondary" id="removeAvatarBtn" style="margin-left: 10px;">Remove</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group Theme</label>
                    <div class="theme-selector" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div class="theme-option" data-theme="blue" style="width: 30px; height: 30px; background-color: #4F46E5; border-radius: 6px; cursor: pointer;"></div>
                        <div class="theme-option" data-theme="green" style="width: 30px; height: 30px; background-color: #10b981; border-radius: 6px; cursor: pointer;"></div>
                        <div class="theme-option" data-theme="purple" style="width: 30px; height: 30px; background-color: #8b5cf6; border-radius: 6px; cursor: pointer;"></div>
                        <div class="theme-option" data-theme="red" style="width: 30px; height: 30px; background-color: #ef4444; border-radius: 6px; cursor: pointer;"></div>
                        <div class="theme-option" data-theme="orange" style="width: 30px; height: 30px; background-color: #f59e0b; border-radius: 6px; cursor: pointer;"></div>
                        <div class="theme-option" data-theme="pink" style="width: 30px; height: 30px; background-color: #ec4899; border-radius: 6px; cursor: pointer;"></div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditGroup">Cancel</button>
                <button class="btn btn-primary" id="saveGroupBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Add Participants Modal -->
    <div class="modal" id="addParticipantsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Participants</h3>
                <button class="modal-close" id="closeAddParticipantsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" class="form-input" id="addParticipantsSearchInput" placeholder="Search contacts...">
                    <div id="addParticipantsResults" class="search-results"></div>
                </div>
                
                <div id="selectedNewParticipants" class="selected-participants"></div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddParticipants">Cancel</button>
                <button class="btn btn-primary" id="addParticipantsBtnConfirm">Add Participants</button>
            </div>
        </div>
    </div>
    
    <!-- Create Poll Modal -->
    <div class="modal" id="createPollModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Poll</h3>
                <button class="modal-close" id="closeCreatePollModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Poll Question</label>
                    <input type="text" class="form-input" id="pollQuestionInput" placeholder="What's your question?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Poll Options</label>
                    <div id="pollOptionsContainer">
                        <div class="poll-option-input" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="form-input poll-option-input-field" placeholder="Option 1">
                            <button class="btn btn-secondary remove-option-btn" style="padding: 5px 10px;"></button>
                        </div>
                        <div class="poll-option-input" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="form-input poll-option-input-field" placeholder="Option 2">
                            <button class="btn btn-secondary remove-option-btn" style="padding: 5px 10px;"></button>
                        </div>
                    </div>
                    <button class="btn btn-secondary w-100 mt-10" id="addPollOptionBtn">Add Option</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Poll Settings</label>
                    <div class="settings-option">
                        <div class="settings-info">
                            <div class="settings-title">Multiple Choice</div>
                            <div class="settings-desc">Allow selecting multiple options</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="pollMultipleChoice">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-option">
                        <div class="settings-info">
                            <div class="settings-title">Anonymous Voting</div>
                            <div class="settings-desc">Hide who voted for what</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="pollAnonymous">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreatePoll">Cancel</button>
                <button class="btn btn-primary" id="createPollBtn">Create Poll</button>
            </div>
        </div>
    </div>
    
    <!-- Create Task Modal -->
    <div class="modal" id="createTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Task</h3>
                <button class="modal-close" id="closeCreateTaskModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="taskTitleInput" placeholder="What needs to be done?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Task Description</label>
                    <textarea class="form-textarea" id="taskDescriptionInput" placeholder="Add details about the task"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Assign To</label>
                    <select class="form-select" id="taskAssigneeSelect">
                        <option value="">Unassigned</option>
                        <!-- Participants will be populated here -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="taskDueDateInput">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateTask">Cancel</button>
                <button class="btn btn-primary" id="createTaskBtn">Create Task</button>
            </div>
        </div>
    </div>
    
    <!-- Create Event Modal -->
    <div class="modal" id="createEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Event</h3>
                <button class="modal-close" id="closeCreateEventModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Event Title</label>
                    <input type="text" class="form-input" id="eventTitleInput" placeholder="Event name">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Event Description</label>
                    <textarea class="form-textarea" id="eventDescriptionInput" placeholder="Event details"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date & Time</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" class="form-input" id="eventDateInput">
                        <input type="time" class="form-input" id="eventTimeInput">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="eventLocationInput" placeholder="Virtual or physical location">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateEvent">Cancel</button>
                <button class="btn btn-primary" id="createEventBtn">Create Event</button>
            </div>
        </div>
    </div>
    
    <!-- Invite Link Modal -->
    <div class="modal" id="inviteLinkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Group Invite Link</h3>
                <button class="modal-close" id="closeInviteLinkModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Share this link to invite people to your group:</label>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="text" class="form-input" id="inviteLinkInput" readonly style="flex: 1;">
                        <button class="btn btn-primary" id="copyInviteLinkBtn">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Reset Link</label>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">Generate a new invite link. The old link will stop working.</p>
                    <button class="btn btn-secondary" id="resetInviteLinkBtn">
                        <i class="fas fa-redo"></i> Reset Link
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">QR Code</label>
                    <div style="text-align: center; padding: 20px; background-color: var(--secondary-color); border-radius: 8px;">
                        <div id="qrCodeContainer" style="width: 150px; height: 150px; background-color: white; margin: 0 auto; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                            <i class="fas fa-qrcode" style="font-size: 80px; color: var(--text-secondary);"></i>
                        </div>
                        <p style="margin-top: 15px; color: var(--text-secondary); font-size: 14px;">Scan QR code to join group</p>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeInviteModalBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Attach Menu Modal -->
    <div class="modal" id="attachMenuModal">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-secondary" id="attachDocumentBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-file"></i> Document
                    </button>
                    <button class="btn btn-secondary" id="attachCameraBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-camera"></i> Camera
                    </button>
                    <button class="btn btn-secondary" id="attachGalleryBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-images"></i> Gallery
                    </button>
                    <button class="btn btn-secondary" id="attachAudioBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-microphone"></i> Audio
                    </button>
                    <button class="btn btn-secondary" id="attachLocationBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-map-marker-alt"></i> Location
                    </button>
                    <button class="btn btn-secondary" id="attachContactBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-user"></i> Contact
                    </button>
                    <button class="btn btn-secondary" id="createPollBtn" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-chart-bar"></i> Create Poll
                    </button>
                    <button class="btn btn-secondary" id="createTaskBtnMain" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-tasks"></i> Create Task
                    </button>
                    <button class="btn btn-secondary" id="createEventBtnMain" style="justify-content: flex-start; text-align: left;">
                        <i class="fas fa-calendar"></i> Create Event
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reaction Picker -->
    <div id="reactionPicker" class="reaction-picker hidden">
        <div class="reaction-option" data-reaction=""></div>
        <div class="reaction-option" data-reaction=""></div>
        <div class="reaction-option" data-reaction=""></div>
        <div class="reaction-option" data-reaction=""></div>
        <div class="reaction-option" data-reaction=""></div>
        <div class="reaction-option" data-reaction=""></div>
    </div>
    
    <!-- Call Interface -->
    <div class="call-interface" id="callInterface">
        <div class="call-participants" id="callParticipants">
            <!-- Participants video streams will be added here -->
        </div>
        <div class="call-controls">
            <button class="call-btn call-mute-btn" id="callMuteBtn">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-btn call-video-btn" id="callVideoBtn">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-btn call-end-btn" id="callEndBtn">
                <i class="fas fa-phone"></i>
            </button>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Success!</span>
    </div>
    
    <!-- Emoji Picker Container -->
    <div id="emojiPickerContainer" style="display: none; position: absolute; bottom: 80px; right: 20px; z-index: 1000;"></div>
    
    <!-- Mobile Media Gallery Modal -->
    <div class="modal" id="mobileMediaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Group Media</h3>
                <button class="modal-close" id="closeMobileMediaModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="mobileMediaContent">
                <!-- Media content loaded here -->
            </div>
        </div>
    </div>
    
    <script>
// Enhanced Firebase Configuration with offline-first support
const firebaseConfig = {
    apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
    authDomain: "uniconnect-ee95c.firebaseapp.com",
    projectId: "uniconnect-ee95c",
    storageBucket: "uniconnect-ee95c.firebasestorage.app",
    messagingSenderId: "1003264444309",
    appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();

// Enable offline persistence for Firestore with enhanced settings
db.enablePersistence({
    synchronizeTabs: true
})
.catch((err) => {
    console.warn('Firebase offline persistence error:', err.code);
    // Fallback to localStorage caching
});

// Global Variables
let currentUser = null;
let currentGroup = null;
let userData = null;
let groups = [];
let friends = [];
let selectedParticipants = new Set();
let selectedParticipantsData = new Map();
let groupMessages = new Map();
let groupSettings = new Map();
let userMood = '';
let userInterests = [];
let emojiPicker = null;
let realTimeListeners = [];
let activeTab = 'chats';
let currentCall = null;
let localStream = null;
let peerConnections = new Map();

// Offline-first support variables
let isOnline = navigator.onLine;
let offlineMessagesQueue = [];
let offlineActivitiesQueue = [];
let pendingSyncOperations = [];
let syncInProgress = false;
let isMobile = window.innerWidth <= 768;
let groupsCacheLoaded = false;
let serverConnectionAttempted = false;
let serverConnectionRetryCount = 0;
const MAX_RETRIES = 3;

// Cache keys
const CACHE_KEYS = {
    GROUPS: 'kynecta_groups_v2',
    GROUP_MESSAGES: 'kynecta_group_messages_v2',
    USER_DATA: 'kynecta_user_v2',
    FRIENDS: 'kynecta_friends_v2',
    PARTICIPANTS: 'kynecta_participants_v2',
    ACTIVITIES: 'kynecta_activities_v2',
    STATS: 'kynecta_stats_v2',
    TIMESTAMP: 'kynecta_cache_timestamp'
};

// DOM Elements
const groupsList = document.getElementById('groupsList');
const groupsSpinner = document.getElementById('groupsSpinner');
const emptyGroupsState = document.getElementById('emptyGroupsState');
const userAvatar = document.getElementById('userAvatar');
const userName = document.getElementById('userName');
const userMoodEl = document.getElementById('userMood');
const groupHeader = document.getElementById('groupHeader');
const groupHeaderAvatar = document.getElementById('groupHeaderAvatar');
const groupHeaderName = document.getElementById('groupHeaderName');
const groupHeaderStatus = document.getElementById('groupHeaderStatus');
const chatContainer = document.getElementById('chatContainer');
const chatInputContainer = document.getElementById('chatInputContainer');
const emptyChatState = document.getElementById('emptyChatState');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const groupDetailsPanel = document.getElementById('groupDetailsPanel');
const participantsList = document.getElementById('participantsList');
const participantsCount = document.getElementById('participantsCount');
const groupDescriptionText = document.getElementById('groupDescriptionText');
const notification = document.getElementById('notification');
const notificationText = document.getElementById('notificationText');
const activityFeed = document.getElementById('activityFeed');
const groupStats = document.getElementById('groupStats');
const offlineIndicator = document.getElementById('offlineIndicator');
const syncIndicator = document.getElementById('syncIndicator');
const mobileGroupFeatures = document.getElementById('mobileGroupFeatures');
const mobileMediaModal = document.getElementById('mobileMediaModal');
const mobileMediaContent = document.getElementById('mobileMediaContent');
const groupsOfflineOverlay = document.getElementById('groupsOfflineOverlay');
const refreshGroupsBtn = document.getElementById('refreshGroupsBtn');

// Settings Manager
let settingsManager = null;

// Initialize App with offline-first approach
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    console.log('Initializing app with offline-first approach...');
    
    // Set up online/offline detection
    setupOnlineStatusDetection();
    
    // Initialize settings manager
    settingsManager = new SettingsManager();
    settingsManager.initialize();
    
    // Show loading skeleton immediately
    renderGroupsLoadingSkeleton();
    
    // Check authentication
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            console.log('User authenticated:', user.uid);
            
            // PHASE 1: INSTANT LOAD FROM CACHE
            await loadCachedUserData();
            await loadCachedGroups();
            
            // Update UI immediately with cached data
            updateUserUIFromCache();
            if (groups.length > 0) {
                renderGroupsList();
                showNotification('Loaded from cache', 'success');
            }
            
            // Mark cache as loaded
            groupsCacheLoaded = true;
            
            // Setup event listeners (non-blocking)
            setTimeout(() => setupEventListeners(), 100);
            
            // PHASE 2: BACKGROUND SERVER SYNC (non-blocking)
            setTimeout(async () => {
                await backgroundSyncWithServer();
            }, 500);
            
        } else {
            console.log('No user authenticated, redirecting to index.html');
            window.location.href = 'index.html';
        }
    });
}

// ============================================
// OFFLINE-FIRST CACHING SYSTEM
// ============================================

async function loadCachedUserData() {
    try {
        // Load user data from localStorage
        const cachedUserData = localStorage.getItem(CACHE_KEYS.USER_DATA);
        if (cachedUserData) {
            userData = JSON.parse(cachedUserData);
            console.log(' Loaded user data from cache');
        }
        
        // Load cached friends
        const cachedFriends = localStorage.getItem(CACHE_KEYS.FRIENDS);
        if (cachedFriends) {
            friends = JSON.parse(cachedFriends);
            console.log(` Loaded ${friends.length} friends from cache`);
        }
        
    } catch (error) {
        console.error('Error loading cached user data:', error);
    }
}

async function loadCachedGroups() {
    try {
        const cachedGroups = localStorage.getItem(CACHE_KEYS.GROUPS);
        if (cachedGroups) {
            groups = JSON.parse(cachedGroups);
            console.log(` Instantly loaded ${groups.length} cached groups`);
            
            // Add cache timestamps
            const cacheTimestamp = localStorage.getItem(CACHE_KEYS.TIMESTAMP);
            if (cacheTimestamp) {
                const age = Date.now() - parseInt(cacheTimestamp);
                const hoursOld = Math.floor(age / (1000 * 60 * 60));
                if (hoursOld > 24) {
                    console.log(`Cache is ${hoursOld} hours old`);
                }
            }
            
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error loading cached groups:', error);
        return false;
    }
}

function saveGroupsToCache(groupsData) {
    try {
        localStorage.setItem(CACHE_KEYS.GROUPS, JSON.stringify(groupsData));
        localStorage.setItem(CACHE_KEYS.TIMESTAMP, Date.now().toString());
        console.log(' Saved groups to cache');
    } catch (error) {
        console.error('Error saving groups to cache:', error);
    }
}

async function saveGroupMessagesToCache(groupId, messages) {
    try {
        localStorage.setItem(`${CACHE_KEYS.GROUP_MESSAGES}_${groupId}`, JSON.stringify(messages));
    } catch (error) {
        console.error('Error saving group messages to cache:', error);
    }
}

async function loadCachedGroupMessages(groupId) {
    try {
        const cachedMessages = localStorage.getItem(`${CACHE_KEYS.GROUP_MESSAGES}_${groupId}`);
        if (cachedMessages) {
            return JSON.parse(cachedMessages);
        }
    } catch (error) {
        console.error('Error loading cached group messages:', error);
    }
    return null;
}

// ============================================
// BACKGROUND SERVER SYNC
// ============================================

async function backgroundSyncWithServer() {
    // Don't sync if already in progress or not online
    if (syncInProgress || !isOnline) {
        if (!isOnline) {
            showOfflineOverlay();
        }
        return;
    }
    
    syncInProgress = true;
    serverConnectionAttempted = true;
    
    try {
        console.log(' Starting background server sync...');
        
        // Show small sync indicator
        showSyncIndicator();
        
        // Load fresh data from server with timeout
        await Promise.race([
            loadFreshGroupsFromServer(),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Server timeout')), 10000))
        ]);
        
        // Update UI with fresh data
        renderGroupsList();
        
        // Hide offline overlay if it was showing
        hideOfflineOverlay();
        
        console.log(' Background sync completed');
        showNotification('Groups updated', 'success');
        
    } catch (error) {
        console.warn('Server sync failed:', error.message);
        
        // Increment retry count
        serverConnectionRetryCount++;
        
        if (serverConnectionRetryCount < MAX_RETRIES) {
            // Retry after delay
            console.log(`Retrying sync in 3 seconds... (${serverConnectionRetryCount}/${MAX_RETRIES})`);
            setTimeout(() => {
                syncInProgress = false;
                backgroundSyncWithServer();
            }, 3000);
        } else {
            // Max retries reached, show offline mode
            console.log('Max retries reached, staying in offline mode');
            showOfflineOverlay();
        }
    } finally {
        syncInProgress = false;
        hideSyncIndicator();
    }
}

async function loadFreshGroupsFromServer() {
    if (!currentUser) return;
    
    try {
        console.log('Fetching fresh groups from server...');
        
        const groupsSnapshot = await db.collection('groups')
            .where('participants', 'array-contains', currentUser.uid)
            .orderBy('updatedAt', 'desc')
            .get();
        
        if (groupsSnapshot.empty) {
            console.log('No groups found on server');
            groups = [];
            saveGroupsToCache([]);
            return;
        }
        
        const freshGroups = [];
        
        // Process each group (in parallel for speed)
        const groupPromises = groupsSnapshot.docs.map(async (doc) => {
            const group = { id: doc.id, ...doc.data() };
            
            // Calculate unread count
            const lastRead = group.lastRead?.[currentUser.uid] || new Date(0);
            const messagesSnapshot = await db.collection('groups')
                .doc(group.id)
                .collection('messages')
                .where('timestamp', '>', lastRead)
                .where('senderId', '!=', currentUser.uid)
                .get();
            
            group.unreadCount = messagesSnapshot.size;
            
            // Get last message
            const lastMessageSnapshot = await db.collection('groups')
                .doc(group.id)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(1)
                .get();
            
            if (!lastMessageSnapshot.empty) {
                const lastMessage = lastMessageSnapshot.docs[0].data();
                group.lastMessage = formatLastMessage(lastMessage);
                group.lastMessageTime = formatTime(lastMessage.timestamp?.toDate() || new Date());
                group.lastMessageSender = lastMessage.senderName || 'Unknown';
            } else {
                group.lastMessage = 'No messages yet';
                group.lastMessageTime = '';
                group.lastMessageSender = '';
            }
            
            // Mark as fresh from server
            group._fresh = true;
            group._cached = false;
            
            freshGroups.push(group);
            
            // Cache messages for this group in background
            cacheGroupMessagesInBackground(group.id);
        });
        
        await Promise.all(groupPromises);
        
        // Update groups array
        groups = freshGroups;
        
        // Save to cache
        saveGroupsToCache(groups);
        
        // Reset retry count on success
        serverConnectionRetryCount = 0;
        
        console.log(` Loaded ${freshGroups.length} fresh groups from server`);
        
    } catch (error) {
        console.error('Error loading fresh groups:', error);
        throw error;
    }
}

async function cacheGroupMessagesInBackground(groupId) {
    // Run in background without blocking
    setTimeout(async () => {
        try {
            const messagesSnapshot = await db.collection('groups')
                .doc(groupId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(50)
                .get();
            
            const messages = messagesSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            await saveGroupMessagesToCache(groupId, messages);
            console.log(` Cached ${messages.length} messages for group ${groupId}`);
        } catch (error) {
            console.error('Background message caching failed:', error);
        }
    }, 1000);
}

// ============================================
// UI UPDATES FOR OFFLINE-FIRST
// ============================================

function renderGroupsLoadingSkeleton() {
    groupsList.innerHTML = '';
    
    // Add 3 skeleton items
    for (let i = 0; i < 3; i++) {
        const skeletonItem = document.createElement('div');
        skeletonItem.className = 'group-item';
        skeletonItem.innerHTML = `
            <div class="group-avatar" style="background-color: var(--secondary-color);"></div>
            <div class="group-info" style="flex: 1;">
                <div class="group-name-row">
                    <div class="group-name" style="background-color: var(--secondary-color); width: 70%; height: 16px; border-radius: 4px;"></div>
                    <div class="group-time" style="background-color: var(--secondary-color); width: 40px; height: 12px; border-radius: 4px;"></div>
                </div>
                <div class="group-preview">
                    <div class="group-last-message" style="background-color: var(--secondary-color); width: 90%; height: 14px; border-radius: 4px;"></div>
                </div>
            </div>
        `;
        groupsList.appendChild(skeletonItem);
    }
}

function renderGroupsList() {
    groupsList.innerHTML = '';
    
    if (groups.length === 0) {
        // Check if we have cache but no groups
        const cachedGroups = localStorage.getItem(CACHE_KEYS.GROUPS);
        if (!cachedGroups || JSON.parse(cachedGroups).length === 0) {
            emptyGroupsState.classList.remove('hidden');
        } else {
            // Show cached empty state
            emptyGroupsState.classList.remove('hidden');
        }
        return;
    }
    
    emptyGroupsState.classList.add('hidden');
    
    let filteredGroups = groups;
    
    // Filter based on active tab
    if (activeTab === 'archived') {
        filteredGroups = groups.filter(group => group.isArchived);
    } else if (activeTab === 'activity') {
        filteredGroups = groups.sort((a, b) => (b.recentActivity || 0) - (a.recentActivity || 0));
    }
    
    filteredGroups.forEach(group => {
        const groupItem = document.createElement('div');
        groupItem.className = 'group-item';
        if (currentGroup && currentGroup.id === group.id) {
            groupItem.classList.add('active');
        }
        groupItem.dataset.groupId = group.id;
        
        // Create group avatar with theme
        let avatarHTML = '';
        if (group.photoURL) {
            avatarHTML = `<div class="group-avatar" style="background-image: url('${group.photoURL}')"></div>`;
        } else {
            // Create multi-avatar for group
            const participantAvatars = group.participants?.slice(0, 4) || [];
            if (participantAvatars.length > 1) {
                avatarHTML = '<div class="group-avatar group-avatar-multi">';
                participantAvatars.forEach(() => {
                    avatarHTML += '<div class="avatar-piece"></div>';
                });
                avatarHTML += '</div>';
            } else {
                const initials = group.name.split(' ').map(w => w[0]).join('').toUpperCase().substring(0, 2);
                avatarHTML = `<div class="group-avatar"><span>${initials}</span></div>`;
            }
        }
        
        // Add badge for activity
        let badgeHTML = '';
        if (group.recentActivity > 10 && activeTab === 'activity') {
            badgeHTML = `<div class="group-badge"></div>`;
        } else if (group.type === 'community') {
            badgeHTML = `<div class="group-badge"></div>`;
        } else if (group.type === 'event') {
            badgeHTML = `<div class="group-badge"></div>`;
        }
        
        // Add cached badge if not fresh from server
        if (group._cached !== false) {
            badgeHTML += `<div class="cached-badge" title="Loaded from cache"><i class="fas fa-database"></i></div>`;
        }
        
        // Add sync indicator if syncing
        if (syncInProgress && !group._fresh) {
            badgeHTML += `<div class="sync-indicator-small"><i class="fas fa-sync sync-spinner"></i></div>`;
        }
        
        // Add offline indicator if group has pending messages
        const pendingMessages = offlineMessagesQueue.filter(msg => msg.groupId === group.id);
        if (pendingMessages.length > 0) {
            badgeHTML += `<div class="offline-queue-badge">${pendingMessages.length}</div>`;
        }
        
        let lastMessagePreview = group.lastMessage;
        if (group.lastMessageSender && group.lastMessage !== 'No messages yet') {
            lastMessagePreview = `${group.lastMessageSender}: ${group.lastMessage}`;
        }
        
        groupItem.innerHTML = `
            ${avatarHTML}
            ${badgeHTML}
            <div class="group-info">
                <div class="group-name-row">
                    <div class="group-name">${group.name}</div>
                    <div class="group-time">${group.lastMessageTime}</div>
                </div>
                <div class="group-preview">
                    <div class="group-last-message">${lastMessagePreview}</div>
                    ${group.unreadCount > 0 ? `<div class="group-unread">${group.unreadCount}</div>` : ''}
                </div>
            </div>
        `;
        
        groupItem.addEventListener('click', () => selectGroup(group));
        groupsList.appendChild(groupItem);
    });
}

function showSyncIndicator() {
    // Add sync indicator to the groups list header
    const groupsHeader = document.querySelector('.groups-tabs');
    if (groupsHeader && !document.getElementById('syncHeaderIndicator')) {
        const syncIndicator = document.createElement('div');
        syncIndicator.id = 'syncHeaderIndicator';
        syncIndicator.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: var(--kynecta-blue);
            display: flex;
            align-items: center;
            gap: 5px;
        `;
        syncIndicator.innerHTML = `<i class="fas fa-sync fa-spin"></i> Syncing...`;
        groupsHeader.style.position = 'relative';
        groupsHeader.appendChild(syncIndicator);
    }
}

function hideSyncIndicator() {
    const syncIndicator = document.getElementById('syncHeaderIndicator');
    if (syncIndicator) {
        syncIndicator.remove();
    }
}

function showOfflineOverlay() {
    if (groupsCacheLoaded && !isOnline) {
        groupsOfflineOverlay.classList.add('active');
    }
}

function hideOfflineOverlay() {
    groupsOfflineOverlay.classList.remove('active');
}

// ============================================
// ORIGINAL FUNCTIONS WITH OFFLINE-FIRST ENHANCEMENTS
// ============================================

function setupOnlineStatusDetection() {
    // Update online status initially
    updateOnlineStatus();
    
    // Listen for online/offline events
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Listen for window resize to detect mobile/desktop
    window.addEventListener('resize', () => {
        isMobile = window.innerWidth <= 768;
        updateUIForMobile();
    });
}

function updateOnlineStatus() {
    const wasOnline = isOnline;
    isOnline = navigator.onLine;
    
    if (isOnline && !wasOnline) {
        // Just came online
        offlineIndicator.classList.add('hidden');
        showNotification('Back online. Syncing data...', 'success');
        
        // Enable group creation buttons
        updateCreateGroupButtons();
        
        // Trigger sync when back online
        setTimeout(() => {
            if (currentUser) {
                backgroundSyncWithServer();
            }
        }, 1000);
        
        // Hide offline overlay
        hideOfflineOverlay();
        
    } else if (!isOnline && wasOnline) {
        // Just went offline
        offlineIndicator.classList.remove('hidden');
        showNotification('You are offline. Using cached data.', 'warning');
        
        // Disable group creation buttons
        updateCreateGroupButtons();
        
        // Show offline overlay
        if (groupsCacheLoaded) {
            showOfflineOverlay();
        }
    }
    
    // Update UI elements based on online status
    updateUIForOnlineStatus();
}

function updateCreateGroupButtons() {
    const groupButtons = [
        'newGroupBtn', 
        'createFirstGroupBtn', 
        'createGroupMainBtn',
        'createGroupBtn'
    ];
    
    groupButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            if (!isOnline) {
                btn.disabled = true;
                btn.classList.add('offline-disabled-btn');
                if (btnId === 'createGroupBtn') {
                    btn.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                    btn.title = 'Group creation requires internet connection';
                }
            } else {
                btn.disabled = false;
                btn.classList.remove('offline-disabled-btn');
                if (btnId === 'createGroupBtn') {
                    btn.innerHTML = 'Create Group';
                    btn.title = '';
                }
            }
        }
    });
}

function updateUIForOnlineStatus() {
    updateCreateGroupButtons();
    
    // Update other UI elements that require online status
    const onlineDependentElements = [
        'groupCallBtn',
        'joinGroupBtn',
        'inviteLinkBtn'
    ];
    
    onlineDependentElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            if (!isOnline) {
                element.disabled = true;
                element.classList.add('offline-disabled-btn');
            } else {
                element.disabled = false;
                element.classList.remove('offline-disabled-btn');
            }
        }
    });
}

function updateUIForMobile() {
    if (isMobile) {
        // Show mobile features panel when a group is selected
        if (currentGroup) {
            mobileGroupFeatures.style.display = 'flex';
        }
    } else {
        // Hide mobile features panel on desktop
        mobileGroupFeatures.style.display = 'none';
    }
}

function updateUserUIFromCache() {
    if (!userData) return;
    
    userName.textContent = userData.displayName || userData.email.split('@')[0];
    userMood = userData.mood || 'Feeling good';
    userInterests = userData.interests || [];
    updateUserStatusDisplay();
    
    if (userData.photoURL) {
        userAvatar.style.backgroundImage = `url('${userData.photoURL}')`;
        userAvatar.innerHTML = '';
    }
}

function updateUserStatusDisplay() {
    // Apply settings for mood visibility
    const settings = settingsManager.getAllSettings();
    let statusText = userMood;
    
    if (settings.moodVisibility === 'friends' || settings.moodVisibility === 'public') {
        if (userInterests && userInterests.length > 0) {
            statusText += `  Interested in: ${userInterests.join(', ')}`;
        }
    }
    
    userMoodEl.textContent = statusText;
    
    // Also update in database for other users to see
    if (userData && isOnline) {
        db.collection('users').doc(currentUser.uid).update({
            status: statusText,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            isOnline: true
        }).catch(console.error);
    }
}

async function loadFriends() {
    try {
        // Try to load friends from cache first
        const cachedFriends = localStorage.getItem(CACHE_KEYS.FRIENDS);
        if (cachedFriends) {
            friends = JSON.parse(cachedFriends);
            console.log(`Loaded ${friends.length} friends from cache`);
        }
        
        // Only load from server if online
        if (isOnline) {
            const friendsRef = db.collection('users').doc(currentUser.uid).collection('friends');
            const friendsSnapshot = await friendsRef.get();
            
            friends = [];
            
            for (const doc of friendsSnapshot.docs) {
                const friendData = doc.data();
                
                // Get friend's user data with mood and interests
                const userDoc = await db.collection('users').doc(friendData.userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const friend = {
                        id: friendData.userId,
                        name: userData.displayName || userData.email.split('@')[0],
                        email: userData.email,
                        photoURL: userData.photoURL || '',
                        mood: userData.mood || '',
                        interests: userData.interests || [],
                        isOnline: userData.isOnline || false,
                        lastSeen: userData.lastSeen
                    };
                    friends.push(friend);
                }
            }
            
            console.log(`Loaded ${friends.length} friends from server`);
            
            // Cache friends list
            localStorage.setItem(CACHE_KEYS.FRIENDS, JSON.stringify(friends));
        }
        
    } catch (error) {
        console.error('Error loading friends:', error);
    }
}

async function selectGroup(group) {
    try {
        currentGroup = group;
        
        // Update UI
        document.querySelectorAll('.group-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.groupId === group.id) {
                item.classList.add('active');
            }
        });
        
        // Update header
        groupHeaderName.textContent = group.name;
        const participantsCount = group.participants?.length || 0;
        groupHeaderStatus.textContent = `${participantsCount} members`;
        
        // Update avatar
        updateGroupHeaderAvatar(group);
        
        // Show chat interface
        emptyChatState.style.display = 'none';
        chatInputContainer.style.display = 'block';
        
        // Show mobile features panel on mobile
        if (isMobile) {
            mobileGroupFeatures.style.display = 'flex';
        }
        
        // Load messages with offline-first approach
        await loadGroupMessages(group.id);
        
        // Load activity feed with offline-first
        await loadActivityFeed(group.id);
        
        // Load statistics with offline-first
        await loadGroupStatistics(group.id);
        
        // Mark as read (only when online)
        if (isOnline) {
            await markGroupAsRead(group.id);
        }
        
        // Update group details panel if open
        if (groupDetailsPanel.classList.contains('active')) {
            updateGroupDetails();
        }
        
        // Setup real-time listener for this group (only when online)
        if (isOnline) {
            setupGroupMessageListener(group.id);
        }
        
    } catch (error) {
        console.error('Error selecting group:', error);
        showNotification('Error loading group', 'error');
    }
}

async function loadGroupMessages(groupId) {
    try {
        chatContainer.innerHTML = '<div class="spinner"></div>';
        
        // Try to load messages from cache first (offline-first)
        const cachedMessages = await loadCachedGroupMessages(groupId);
        if (cachedMessages) {
            renderMessages(cachedMessages);
            console.log(`Loaded ${cachedMessages.length} cached messages for group ${groupId}`);
            
            // If offline, don't try to fetch from server
            if (!isOnline) {
                // Show offline indicator in chat
                const offlineMessage = document.createElement('div');
                offlineMessage.className = 'message-date';
                offlineMessage.innerHTML = `
                    <div class="date-label" style="background-color: var(--warning-color); color: white;">
                        <i class="fas fa-wifi-slash"></i> Offline - Showing cached messages
                    </div>
                `;
                chatContainer.insertBefore(offlineMessage, chatContainer.firstChild);
                return;
            }
        }
        
        // Only load from server if online
        if (isOnline) {
            const messagesSnapshot = await db.collection('groups')
                .doc(groupId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(100)
                .get();
            
            if (messagesSnapshot.empty) {
                chatContainer.innerHTML = `
                    <div class="message-date">
                        <div class="date-label">Today</div>
                    </div>
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }
            
            const messages = messagesSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            renderMessages(messages);
            
            // Cache messages for offline access
            await saveGroupMessagesToCache(groupId, messages);
        }
        
    } catch (error) {
        console.error('Error loading messages:', error);
        
        // Fallback to cached messages
        const cachedMessages = await loadCachedGroupMessages(groupId);
        if (cachedMessages) {
            renderMessages(cachedMessages);
            
            // Show offline indicator
            const offlineMessage = document.createElement('div');
            offlineMessage.className = 'message-date';
            offlineMessage.innerHTML = `
                <div class="date-label" style="background-color: var(--warning-color); color: white;">
                    <i class="fas fa-wifi-slash"></i> Offline - Showing cached messages
                </div>
            `;
            chatContainer.insertBefore(offlineMessage, chatContainer.firstChild);
            
            showNotification('Showing cached messages (offline mode)', 'warning');
        } else {
            chatContainer.innerHTML = `
                <div class="message-date">
                    <div class="date-label">Today</div>
                </div>
                <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                    <p>Unable to load messages. Please check your connection.</p>
                </div>
            `;
        }
    }
}

function formatLastMessage(message) {
    if (!message) return '';
    
    if (message.type === 'text') {
        return message.content.length > 40 ? message.content.substring(0, 40) + '...' : message.content;
    } else if (message.type === 'image') {
        return ' Photo';
    } else if (message.type === 'video') {
        return ' Video';
    } else if (message.type === 'audio') {
        return ' Audio';
    } else if (message.type === 'document') {
        return ' Document';
    } else if (message.type === 'location') {
        return ' Location';
    } else if (message.type === 'poll') {
        return ' Poll';
    } else if (message.type === 'task') {
        return ' Task';
    } else if (message.type === 'event') {
        return ' Event';
    } else if (message.type === 'system') {
        return message.content;
    }
    
    return 'Media';
}

function formatTime(date) {
    if (!date) return '';
    
    if (typeof date === 'string') {
        date = new Date(date);
    }
    
    return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
    });
}

function showNotification(message, type = 'success') {
    notificationText.textContent = message;
    notification.className = 'notification';
    notification.classList.add(type);
    notification.classList.add('active');
    
    setTimeout(() => {
        notification.classList.remove('active');
    }, 3000);
}

// ============================================
// SETUP EVENT LISTENERS
// ============================================

function setupEventListeners() {
    // Tab switching
    document.querySelectorAll('.group-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.group-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            activeTab = tab.dataset.tab;
            renderGroupsList();
        });
    });
    
    // Refresh groups button
    refreshGroupsBtn.addEventListener('click', () => {
        hideOfflineOverlay();
        backgroundSyncWithServer();
    });
    
    // New group buttons
    document.getElementById('newGroupBtn').addEventListener('click', showCreateGroupModal);
    document.getElementById('createFirstGroupBtn').addEventListener('click', showCreateGroupModal);
    document.getElementById('createGroupMainBtn').addEventListener('click', showCreateGroupModal);
    
    // Create group modal
    document.getElementById('closeCreateGroupModal').addEventListener('click', hideCreateGroupModal);
    document.getElementById('cancelCreateGroup').addEventListener('click', hideCreateGroupModal);
    document.getElementById('createGroupBtn').addEventListener('click', handleCreateGroup);
    
    // Update create group button based on online status
    updateCreateGroupButtons();
    
    // Group info
    document.getElementById('groupInfoBtn').addEventListener('click', () => {
        if (!currentGroup) {
            showNotification('Select a group first', 'warning');
            return;
        }
        groupDetailsPanel.classList.add('active');
        updateGroupDetails();
    });
    
    document.getElementById('closeDetailsBtn').addEventListener('click', () => {
        groupDetailsPanel.classList.remove('active');
    });
    
    // Message input
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        sendBtn.disabled = this.value.trim() === '';
    });
    
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) {
                sendMessage();
            }
        }
    });
    
    sendBtn.addEventListener('click', sendMessage);
    
    // Search groups
    document.getElementById('searchGroupsInput').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        document.querySelectorAll('.group-item').forEach(item => {
            const groupName = item.querySelector('.group-name').textContent.toLowerCase();
            item.style.display = groupName.includes(searchTerm) ? 'flex' : 'none';
        });
    });
    
    // All other event listeners from original code...
    // [Include all other event listener setups from the original code]
    
    // For brevity, including key ones:
    document.getElementById('leaveGroupBtn').addEventListener('click', handleLeaveGroup);
    document.getElementById('reportGroupBtn').addEventListener('click', handleReportGroup);
    document.getElementById('inviteLinkBtn').addEventListener('click', showInviteLinkModal);
    document.getElementById('attachMenuBtn').addEventListener('click', showAttachMenu);
    document.getElementById('attachBtn').addEventListener('click', showAttachMenu);
    
    // Initialize mobile UI
    updateUIForMobile();
}

// ============================================
// ORIGINAL FUNCTIONS (simplified for brevity)
// ============================================

async function sendMessage() {
    const content = messageInput.value.trim();
    if (!content || !currentGroup) return;
    
    try {
        const message = {
            senderId: currentUser.uid,
            senderName: userData.displayName || currentUser.email.split('@')[0],
            content: content,
            type: 'text',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            readBy: [],
            reactions: {},
            _offline: !isOnline,
            _pending: !isOnline
        };
        
        if (isOnline) {
            await db.collection('groups')
                .doc(currentGroup.id)
                .collection('messages')
                .add(message);
            
            await db.collection('groups')
                .doc(currentGroup.id)
                .update({
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: content.substring(0, 100)
                });
            
            showNotification('Message sent', 'success');
        } else {
            // Queue message for offline sync
            const messageId = `offline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            message.id = messageId;
            message.timestamp = new Date();
            
            offlineMessagesQueue.push({
                groupId: currentGroup.id,
                message: message,
                type: 'message'
            });
            
            // Update UI immediately
            const cachedMessages = JSON.parse(localStorage.getItem(`${CACHE_KEYS.GROUP_MESSAGES}_${currentGroup.id}`) || '[]');
            cachedMessages.push(message);
            localStorage.setItem(`${CACHE_KEYS.GROUP_MESSAGES}_${currentGroup.id}`, JSON.stringify(cachedMessages));
            
            showNotification('Message saved offline. Will send when online.', 'warning');
            
            // Update groups list UI
            updateGroupInList(currentGroup.id);
        }
        
        messageInput.value = '';
        sendBtn.disabled = true;
        messageInput.style.height = 'auto';
        
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Error sending message', 'error');
    }
}

function updateGroupInList(groupId) {
    const groupItem = document.querySelector(`.group-item[data-group-id="${groupId}"]`);
    if (groupItem) {
        const pendingMessages = offlineMessagesQueue.filter(msg => msg.groupId === groupId);
        if (pendingMessages.length > 0) {
            let badge = groupItem.querySelector('.offline-queue-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'offline-queue-badge';
                groupItem.querySelector('.group-avatar').appendChild(badge);
            }
            badge.textContent = pendingMessages.length;
        }
    }
}

async function markGroupAsRead(groupId) {
    if (!isOnline) return;
    
    try {
        await db.collection('groups')
            .doc(groupId)
            .update({
                [`lastRead.${currentUser.uid}`]: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        const groupIndex = groups.findIndex(g => g.id === groupId);
        if (groupIndex !== -1) {
            groups[groupIndex].unreadCount = 0;
            renderGroupsList();
        }
        
    } catch (error) {
        console.error('Error marking as read:', error);
    }
}

async function createGroup(groupData) {
    if (!isOnline) {
        showNotification('Cannot create groups while offline. Please connect to the internet.', 'error');
        return;
    }
    
    try {
        const groupId = db.collection('groups').doc().id;
        
        const group = {
            id: groupId,
            name: groupData.name,
            description: groupData.description || '',
            photoURL: groupData.photoURL || '',
            participants: [currentUser.uid, ...Array.from(selectedParticipants)],
            admins: [currentUser.uid],
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser.uid,
            lastMessage: '',
            settings: {
                adminOnly: false,
                disappearingMessages: false,
                inviteCode: generateInviteCode(),
                theme: groupData.theme || 'blue'
            },
            type: groupData.type || 'standard',
            lastRead: {
                [currentUser.uid]: firebase.firestore.FieldValue.serverTimestamp()
            }
        };
        
        await db.collection('groups').doc(groupId).set(group);
        
        const systemMessage = {
            senderId: 'system',
            senderName: 'System',
            content: `${userData.displayName || currentUser.email.split('@')[0]} created group "${groupData.name}"`,
            type: 'system',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('groups')
            .doc(groupId)
            .collection('messages')
            .add(systemMessage);
        
        selectedParticipants.clear();
        selectedParticipantsData.clear();
        
        // Add to local cache immediately
        groups.unshift(group);
        saveGroupsToCache(groups);
        renderGroupsList();
        
        const newGroup = groups.find(g => g.id === groupId);
        if (newGroup) await selectGroup(newGroup);
        
        showNotification('Group created successfully!', 'success');
        
    } catch (error) {
        console.error('Error creating group:', error);
        showNotification('Error creating group', 'error');
    }
}

function generateInviteCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

function showCreateGroupModal() {
    if (!isOnline) {
        showNotification('Group creation requires internet connection. Please go online to create a new group.', 'error');
        return;
    }
    
    document.getElementById('createGroupModal').classList.add('active');
    document.getElementById('groupNameInput').focus();
}

function hideCreateGroupModal() {
    document.getElementById('createGroupModal').classList.remove('active');
    document.getElementById('groupNameInput').value = '';
    document.getElementById('groupDescriptionInput').value = '';
    document.getElementById('searchParticipantsInput').value = '';
    document.getElementById('participantsSearchResults').style.display = 'none';
    document.getElementById('selectedParticipants').innerHTML = '';
    selectedParticipants.clear();
    selectedParticipantsData.clear();
}

async function handleCreateGroup() {
    if (!isOnline) {
        showNotification('Cannot create groups while offline. Please connect to the internet.', 'error');
        hideCreateGroupModal();
        return;
    }
    
    const groupName = document.getElementById('groupNameInput').value.trim();
    const groupDescription = document.getElementById('groupDescriptionInput').value.trim();
    const groupType = document.getElementById('groupTypeSelect').value;
    
    if (!groupName) {
        showNotification('Please enter a group name', 'error');
        return;
    }
    
    if (selectedParticipants.size === 0) {
        showNotification('Please add at least one participant', 'error');
        return;
    }
    
    const groupData = {
        name: groupName,
        description: groupDescription,
        photoURL: document.getElementById('groupAvatarPreview').style.backgroundImage.slice(5, -2) || '',
        type: groupType
    };
    
    await createGroup(groupData);
    hideCreateGroupModal();
}

function updateGroupHeaderAvatar(group) {
    if (group.photoURL) {
        groupHeaderAvatar.style.backgroundImage = `url('${group.photoURL}')`;
        groupHeaderAvatar.innerHTML = '';
        groupHeaderAvatar.className = 'group-header-avatar';
    } else {
        const participantAvatars = group.participants?.slice(0, 4) || [];
        if (participantAvatars.length > 1) {
            groupHeaderAvatar.className = 'group-header-avatar-multi';
            groupHeaderAvatar.innerHTML = '';
            participantAvatars.forEach(() => {
                const piece = document.createElement('div');
                piece.className = 'avatar-piece';
                groupHeaderAvatar.appendChild(piece);
            });
            groupHeaderAvatar.style.backgroundImage = '';
        } else {
            groupHeaderAvatar.className = 'group-header-avatar';
            const initials = group.name.split(' ').map(w => w[0]).join('').toUpperCase().substring(0, 2);
            groupHeaderAvatar.style.backgroundImage = '';
            groupHeaderAvatar.innerHTML = `<span>${initials}</span>`;
        }
    }
}

// ============================================
// MESSAGE RENDERING FUNCTIONS
// ============================================

function renderMessages(messages) {
    let messagesHTML = '';
    let currentDate = '';
    
    messages.forEach(message => {
        const messageDate = message.timestamp?.toDate ? message.timestamp.toDate() : 
                          (message.timestamp ? new Date(message.timestamp) : new Date());
        const dateStr = messageDate.toDateString();
        
        if (dateStr !== currentDate) {
            currentDate = dateStr;
            messagesHTML += `
                <div class="message-date">
                    <div class="date-label">${formatDate(messageDate)}</div>
                </div>
            `;
        }
        
        const isSent = message.senderId === currentUser.uid;
        const senderName = message.senderName || 'Unknown';
        const timeStr = formatTime(messageDate);
        
        let messageContent = '';
        
        switch (message.type) {
            case 'text':
                messageContent = `
                    <div class="message-content">${formatMessageContent(message.content)}</div>
                `;
                break;
                
            case 'image':
                messageContent = `
                    <div class="media-message">
                        <img src="${message.content}" alt="Image" style="max-width: 100%; border-radius: 8px; cursor: pointer;" onclick="viewImage('${message.content}')">
                        <div class="media-info" style="margin-top: 5px; color: var(--text-secondary); font-size: 12px;"> Photo</div>
                    </div>
                `;
                break;
                
            default:
                messageContent = `
                    <div class="message-content">${escapeHtml(message.content)}</div>
                `;
        }
        
        // Add offline indicator if message is from offline queue
        const offlineIndicatorHTML = message._offline ? 
            '<div class="offline-message-indicator"><i class="fas fa-clock"></i> Offline</div>' : '';
        
        messagesHTML += `
            <div class="message-wrapper ${isSent ? 'sent' : 'received'}" data-message-id="${message.id}">
                <div class="message-bubble ${isSent ? 'sent' : 'received'}" style="position: relative;">
                    ${offlineIndicatorHTML}
                    ${!isSent && message.type !== 'system' ? `<div class="message-sender">${senderName}</div>` : ''}
                    ${messageContent}
                    <div class="message-meta">
                        <div class="message-time">${timeStr}</div>
                        ${isSent && message.type !== 'system' ? `
                            <div class="message-status ${message.readBy && message.readBy.length > 0 ? 'read' : 'delivered'}">
                                <i class="fas fa-check${message.readBy && message.readBy.length > 0 ? '-double' : ''}"></i>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    chatContainer.innerHTML = messagesHTML;
    scrollToBottom();
}

function formatDate(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) return 'Today';
    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
    
    return date.toLocaleDateString('en-US', { 
        weekday: 'long',
        month: 'short', 
        day: 'numeric' 
    });
}

function formatMessageContent(text) {
    text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--kynecta-blue);">$1</a>');
    text = text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
    text = text.replace(/\n/g, '<br>');
    return escapeHtml(text);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ============================================
// OTHER ORIGINAL FUNCTIONS (simplified)
// ============================================

async function handleLeaveGroup() {
    if (!currentGroup) return;
    
    if (!isOnline) {
        showNotification('Leaving groups requires internet connection', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to leave this group?')) return;
    
    try {
        const newParticipants = currentGroup.participants.filter(id => id !== currentUser.uid);
        const newAdmins = (currentGroup.admins || []).filter(id => id !== currentUser.uid);
        
        await db.collection('groups')
            .doc(currentGroup.id)
            .update({
                participants: newParticipants,
                admins: newAdmins
            });
        
        currentGroup = null;
        
        groupHeaderName.textContent = 'Kynecta Groups';
        groupHeaderStatus.textContent = 'Select a group to start chatting';
        groupHeaderAvatar.innerHTML = '<i class="fas fa-users"></i>';
        groupHeaderAvatar.style.backgroundImage = '';
        groupHeaderAvatar.className = 'group-header-avatar';
        emptyChatState.style.display = 'flex';
        chatInputContainer.style.display = 'none';
        groupDetailsPanel.classList.remove('active');
        
        mobileGroupFeatures.style.display = 'none';
        
        await backgroundSyncWithServer();
        
        showNotification('You left the group', 'success');
        
    } catch (error) {
        console.error('Error leaving group:', error);
        showNotification('Error leaving group', 'error');
    }
}

async function handleReportGroup() {
    if (!currentGroup) return;
    
    if (!isOnline) {
        showNotification('Reporting groups requires internet connection', 'error');
        return;
    }
    
    if (confirm('Report this group to administrators?')) {
        try {
            await db.collection('reports').add({
                groupId: currentGroup.id,
                groupName: currentGroup.name,
                reporterId: currentUser.uid,
                reporterEmail: currentUser.email,
                reason: 'User reported',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending'
            });
            
            showNotification('Group reported', 'success');
            
        } catch (error) {
            console.error('Error reporting group:', error);
            showNotification('Error reporting group', 'error');
        }
    }
}

function showInviteLinkModal() {
    if (!currentGroup) return;
    
    const inviteCode = currentGroup.settings?.inviteCode || generateInviteCode();
    const inviteLink = `${window.location.origin}/join/${inviteCode}`;
    document.getElementById('inviteLinkInput').value = inviteLink;
    
    document.getElementById('inviteLinkModal').classList.add('active');
}

function showAttachMenu() {
    document.getElementById('attachMenuModal').classList.add('active');
}

// ============================================
// ACTIVITY FEED AND STATISTICS (offline-first)
// ============================================

async function loadActivityFeed(groupId) {
    try {
        // Try to load from cache first
        const cachedActivities = localStorage.getItem(`${CACHE_KEYS.ACTIVITIES}_${groupId}`);
        if (cachedActivities) {
            const activities = JSON.parse(cachedActivities);
            renderActivityFeed(activities);
        }
        
        // Only load from server if online
        if (isOnline) {
            const activitiesSnapshot = await db.collection('groups')
                .doc(groupId)
                .collection('activities')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get();
            
            if (!activitiesSnapshot.empty) {
                const activities = activitiesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                renderActivityFeed(activities);
                
                // Cache activities
                localStorage.setItem(`${CACHE_KEYS.ACTIVITIES}_${groupId}`, JSON.stringify(activities));
            }
        }
        
    } catch (error) {
        console.error('Error loading activity feed:', error);
    }
}

function renderActivityFeed(activities) {
    activityFeed.innerHTML = '';
    
    if (!activities || activities.length === 0) {
        activityFeed.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No recent activity</p>';
        return;
    }
    
    activities.forEach(activity => {
        const activityDate = activity.timestamp?.toDate() || new Date(activity.timestamp) || new Date();
        
        let icon = 'fas fa-comment';
        if (activity.type === 'member_added') icon = 'fas fa-user-plus';
        else if (activity.type === 'poll_created') icon = 'fas fa-chart-bar';
        else if (activity.type === 'task_created') icon = 'fas fa-tasks';
        else if (activity.type === 'event_created') icon = 'fas fa-calendar';
        else if (activity.type === 'message') icon = 'fas fa-comment';
        
        const activityItem = document.createElement('div');
        activityItem.className = 'activity-item';
        activityItem.innerHTML = `
            <div class="activity-icon">
                <i class="${icon}"></i>
            </div>
            <div class="activity-content">
                <div class="activity-title">${activity.content}</div>
                <div class="activity-time">${formatTime(activityDate)}</div>
            </div>
        `;
        
        activityFeed.appendChild(activityItem);
    });
}

async function loadGroupStatistics(groupId) {
    try {
        // Try to load from cache first
        const cachedStats = localStorage.getItem(`${CACHE_KEYS.STATS}_${groupId}`);
        if (cachedStats) {
            const stats = JSON.parse(cachedStats);
            renderGroupStatistics(stats);
        }
        
        // Only load from server if online
        if (isOnline) {
            const messagesSnapshot = await db.collection('groups')
                .doc(groupId)
                .collection('messages')
                .get();
            
            const messageCount = messagesSnapshot.size;
            
            const groupDoc = await db.collection('groups').doc(groupId).get();
            const groupData = groupDoc.data();
            const participantCount = groupData.participants?.length || 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayMessagesSnapshot = await db.collection('groups')
                .doc(groupId)
                .collection('messages')
                .where('timestamp', '>', today)
                .get();
            
            const todayMessageCount = todayMessagesSnapshot.size;
            
            const mediaMessagesSnapshot = await db.collection('groups')
                .doc(groupId)
                .collection('messages')
                .where('type', 'in', ['image', 'video', 'audio', 'document'])
                .get();
            
            const mediaCount = mediaMessagesSnapshot.size;
            
            const stats = {
                messageCount,
                participantCount,
                todayMessageCount,
                mediaCount
            };
            
            renderGroupStatistics(stats);
            
            // Cache statistics
            localStorage.setItem(`${CACHE_KEYS.STATS}_${groupId}`, JSON.stringify(stats));
        }
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

function renderGroupStatistics(stats) {
    groupStats.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${stats.messageCount || 0}</div>
            <div class="stat-label">Total Messages</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${stats.participantCount || 0}</div>
            <div class="stat-label">Members</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${stats.todayMessageCount || 0}</div>
            <div class="stat-label">Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${stats.mediaCount || 0}</div>
            <div class="stat-label">Media Files</div>
        </div>
    `;
}

function updateGroupDetails() {
    if (!currentGroup) return;
    
    if (currentGroup.description) {
        groupDescriptionText.textContent = currentGroup.description;
        groupDescriptionText.classList.remove('empty');
    } else {
        groupDescriptionText.textContent = 'No description';
        groupDescriptionText.classList.add('empty');
    }
    
    const count = currentGroup.participants?.length || 0;
    participantsCount.textContent = `(${count})`;
    
    loadParticipantsList();
    loadActivityFeed(currentGroup.id);
    loadGroupStatistics(currentGroup.id);
    
    const settings = groupSettings.get(currentGroup.id) || {};
    document.getElementById('muteNotifications').checked = settings.muted || false;
    document.getElementById('adminOnlyMessages').checked = currentGroup.settings?.adminOnly || false;
    document.getElementById('disappearingMessages').checked = currentGroup.settings?.disappearingMessages || false;
}

async function loadParticipantsList() {
    if (!currentGroup || !currentGroup.participants) return;
    
    participantsList.innerHTML = '';
    
    // Try to load from cache first
    const cachedParticipants = localStorage.getItem(`${CACHE_KEYS.PARTICIPANTS}_${currentGroup.id}`);
    if (cachedParticipants) {
        const participants = JSON.parse(cachedParticipants);
        renderParticipantsList(participants);
    }
    
    // Only load from server if online
    if (isOnline) {
        const participantsData = [];
        
        for (const participantId of currentGroup.participants) {
            try {
                const userDoc = await db.collection('users').doc(participantId).get();
                if (userDoc.exists) {
                    const participantData = userDoc.data();
                    const isAdmin = currentGroup.admins?.includes(participantId) || false;
                    const isCurrentUser = participantId === currentUser.uid;
                    
                    participantsData.push({
                        id: participantId,
                        ...participantData,
                        isAdmin,
                        isCurrentUser
                    });
                }
            } catch (error) {
                console.error('Error loading participant:', error);
            }
        }
        
        renderParticipantsList(participantsData);
        
        // Cache participants
        localStorage.setItem(`${CACHE_KEYS.PARTICIPANTS}_${currentGroup.id}`, JSON.stringify(participantsData));
    }
}

function renderParticipantsList(participantsData) {
    participantsList.innerHTML = '';
    
    participantsData.forEach(participantData => {
        const initials = (participantData.displayName || participantData.email.split('@')[0])
            .split(' ').map(w => w[0]).join('').toUpperCase().substring(0, 2);
        
        const participantItem = document.createElement('div');
        participantItem.className = 'participant-item';
        
        let statusIndicators = '';
        const settings = settingsManager.getAllSettings();
        
        if (participantData.mood && (settings.moodVisibility === 'friends' || settings.moodVisibility === 'public')) {
            statusIndicators += `<span class="mood-indicator">${participantData.mood}</span> `;
        }
        
        if (participantData.interests && participantData.interests.length > 0) {
            statusIndicators += `<span class="interest-indicator">${participantData.interests[0]}</span>`;
        }
        
        participantItem.innerHTML = `
            <div class="participant-avatar" ${participantData.photoURL ? `style="background-image: url('${participantData.photoURL}')"` : ''}>
                ${participantData.photoURL ? '' : `<span>${initials}</span>`}
                ${participantData.isOnline ? '<div class="online-indicator"></div>' : ''}
            </div>
            <div class="participant-info">
                <div class="participant-name">
                    ${participantData.displayName || participantData.email.split('@')[0]}
                    ${participantData.isCurrentUser ? ' (You)' : ''}
                    ${participantData.isAdmin ? '<span class="admin-badge">Admin</span>' : ''}
                </div>
                <div class="participant-status">
                    ${participantData.email}
                    ${statusIndicators}
                </div>
            </div>
            ${!participantData.isCurrentUser && currentGroup.admins?.includes(currentUser.uid) ? `
            <div class="participant-actions">
                <button class="participant-action-btn" data-action="admin" data-user-id="${participantData.id}" title="${participantData.isAdmin ? 'Remove admin' : 'Make admin'}">
                    <i class="fas ${participantData.isAdmin ? 'fa-user-minus' : 'fa-user-plus'}"></i>
                </button>
                <button class="participant-action-btn" data-action="remove" data-user-id="${participantData.id}" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            ` : ''}
        `;
        
        participantsList.appendChild(participantItem);
    });
}

// ============================================
// SETUP GROUP MESSAGE LISTENER
// ============================================

function setupGroupMessageListener(groupId) {
    // Clean up previous listeners
    realTimeListeners.forEach(unsubscribe => unsubscribe());
    realTimeListeners = [];
    
    // Listen for new messages (only when online)
    if (!isOnline) return;
    
    const unsubscribe = db.collection('groups')
        .doc(groupId)
        .collection('messages')
        .orderBy('timestamp', 'desc')
        .limit(1)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    if (currentGroup && currentGroup.id === groupId) {
                        loadGroupMessages(groupId);
                    }
                    backgroundSyncWithServer();
                }
            });
        });
    
    realTimeListeners.push(unsubscribe);
}

// ============================================
// GLOBAL WINDOW FUNCTIONS
// ============================================

window.viewImage = function(url) {
    window.open(url, '_blank');
};

window.playAudio = function(url) {
    const audio = new Audio(url);
    audio.play();
};

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// Initial call to setup event listeners
setTimeout(() => {
    if (currentUser) {
        setupEventListeners();
    }
}, 1000);

    </script>
</body>
</html>