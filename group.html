<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="icon" href="../icons/moodchat-192.png">
    <link rel="icon" href="../icons/moodchat-512.png">
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Groups | Knecta Chat</title>
    
    <!-- API System - LOADED FIRST -->
    <script src="./js/api.js"></script>
    <script src="./js/settingsManager.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Link CSS -->
    <link rel="stylesheet" href="group.css">

    <style>
        /* Group Purpose Styles */
        .group-purpose-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 5px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .group-mood-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 5px;
        }
        
        .posting-rules-banner {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .group-pulse {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 5px;
        }
        
        .pulse-active {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }
        
        .pulse-quiet {
            background: rgba(158, 158, 158, 0.1);
            color: #9e9e9e;
        }
        
        .participation-mode {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f5f5f5;
            color: #666;
        }
        
        .mode-read-only {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .mode-react-only {
            background: #e8f5e9;
            color: #4caf50;
        }
        
        .mode-anonymous {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .topic-label {
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            margin-bottom: 3px;
            display: inline-block;
        }
        
        .topic-announcement {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .topic-question {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .topic-discussion {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        /* Group Pulse Animation */
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .group-pulse.pulse-active {
            animation: pulse 2s infinite;
        }
        
        /* Energy Suggestion */
        .energy-suggestion {
            padding: 10px;
            border-radius: 8px;
            background: #fff3e0;
            color: #f57c00;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Admin Transparency Log */
        .admin-transparency-log {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 12px;
        }
        
        .transparency-log-item {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .transparency-log-item:last-child {
            border-bottom: none;
        }
        
        /* Event Countdown */
        .event-countdown {
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            text-align: center;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 100%;
            }
            
            .group-details-panel,
            .group-chat-panel,
            .group-call-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 100;
                background: white;
            }
            
            .mobile-back-btn {
                background: none;
                border: none;
                color: var(--text-primary);
                cursor: pointer;
                font-size: 18px;
                margin-right: 10px;
            }
        }
        
        /* Loading Animation for Instant Load */
        .instant-load .group-item {
            animation: fadeInUp 0.3s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .group-item:nth-child(1) { animation-delay: 0.05s; }
        .group-item:nth-child(2) { animation-delay: 0.1s; }
        .group-item:nth-child(3) { animation-delay: 0.15s; }
        .group-item:nth-child(4) { animation-delay: 0.2s; }
        .group-item:nth-child(5) { animation-delay: 0.25s; }
        .group-item:nth-child(6) { animation-delay: 0.3s; }
        .group-item:nth-child(7) { animation-delay: 0.35s; }
        .group-item:nth-child(8) { animation-delay: 0.4s; }
        .group-item:nth-child(9) { animation-delay: 0.45s; }
        .group-item:nth-child(10) { animation-delay: 0.5s; }
    </style>
</head>
<body>
    <!-- Offline Overlay -->
    <div class="offline-overlay" id="offlineOverlay" style="display: none;">
        <div class="offline-icon">
            <i class="fas fa-wifi-slash"></i>
        </div>
        <div class="offline-title">You're Offline</div>
        <div class="offline-message">Some group features require internet connection to work properly.</div>
        <div class="offline-submessage">
            <i class="fas fa-info-circle"></i> You can still view your cached groups, chat with existing groups, and use most features. New group creation and syncing will work when you're back online.
        </div>
        <button class="offline-dismiss-btn" id="dismissOfflineBtn">
            <i class="fas fa-eye"></i> View Cached Groups
        </button>
    </div>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator" style="display: none;">
        <i class="fas fa-wifi-slash"></i>
        <span>Offline</span>
    </div>
    
    <!-- Local Storage Indicator -->
    <div class="local-storage-indicator" id="localStorageIndicator" style="display: none;">
        <i class="fas fa-database"></i>
        <span>Loaded from Local Storage</span>
    </div>
    
    <div class="app-container">
        <!-- Sidebar with group list -->
        <div class="sidebar active" id="sidebar">
            <div class="sidebar-header">
                <h2>Groups</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="create-group-btn" id="createGroupBtn" title="Create new group">
                        <i class="fas fa-users"></i>
                    </button>
                </div>
            </div>
            
            <div class="group-categories">
                <button class="category-btn active" id="allTab">All Groups</button>
                <button class="category-btn" id="myGroupsTab">My Groups <span class="badge" id="myGroupsCount">0</span></button>
                <button class="category-btn" id="joinedTab">Joined <span class="badge" id="joinedCount">0</span></button>
                <button class="category-btn" id="invitesTab">Invites <span class="badge" id="invitesCount">0</span></button>
                <button class="category-btn" id="adminTab">Admin <span class="badge" id="adminCount">0</span></button>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="groupSearch" placeholder="Search groups...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <!-- Cache Indicator (shown when offline) -->
            <div class="cache-indicator" id="cacheIndicator" style="display: none;">
                <i class="fas fa-database"></i>
                <span>Showing cached groups data. Some features may be limited.</span>
            </div>
            
            <div class="group-list">
                <div class="quick-actions">
                    <button class="quick-action-btn" id="discoverGroupsBtn" title="Discover groups">
                        <div class="quick-action-icon">
                            <i class="fas fa-compass"></i>
                        </div>
                        <div class="quick-action-text">Discover</div>
                    </button>
                    <button class="quick-action-btn" id="groupInvitesBtn" title="Group invites">
                        <div class="quick-action-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="quick-action-text">Invites</div>
                    </button>
                    <button class="quick-action-btn" id="groupEventsBtn" title="Group events">
                        <div class="quick-action-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="quick-action-text">Events</div>
                    </button>
                </div>
                
                <!-- Group Stats -->
                <div class="group-stats">
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-number" id="totalGroups">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="activeGroups">0</div>
                            <div class="stat-label">Active</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalMembers">0</div>
                            <div class="stat-label">Members</div>
                        </div>
                    </div>
                </div>
                
                <!-- Type Filters -->
                <div class="type-filters">
                    <div class="type-filters-container">
                        <button class="type-filter-btn active" data-type="all">All</button>
                        <button class="type-filter-btn" data-type="public">Public</button>
                        <button class="type-filter-btn" data-type="private">Private</button>
                        <button class="type-filter-btn" data-type="secret">Secret</button>
                        <button class="type-filter-btn" data-type="family">Family</button>
                        <button class="type-filter-btn" data-type="work">Work</button>
                    </div>
                </div>
                
                <div class="group-list-content">
                    <!-- All Groups Section -->
                    <div class="groups-section active" id="allGroupsSection">
                        <div class="groups-list" id="allGroupsList">
                            <div class="loading-placeholder">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading groups...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- My Groups Section -->
                    <div class="groups-section" id="myGroupsSection">
                        <div class="groups-list" id="myGroupsList">
                            <!-- User-created groups will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Joined Groups Section -->
                    <div class="groups-section" id="joinedSection">
                        <div class="groups-list" id="joinedList">
                            <!-- Joined groups will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Invites Section -->
                    <div class="groups-section" id="invitesSection">
                        <div class="section-title">
                            <span>Group Invites</span>
                            <span class="section-count" id="invitesSectionCount">0</span>
                        </div>
                        <div class="groups-list" id="invitesList">
                            <!-- Group invites will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Admin Groups Section -->
                    <div class="groups-section" id="adminSection">
                        <div class="groups-list" id="adminList">
                            <!-- Admin groups will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Group Details Panel -->
        <div class="group-details-panel" id="groupDetailsPanel">
            <div class="group-details-header">
                <button class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="group-details-title">Group Details</div>
                <div style="width: 40px;"></div> <!-- Spacer for alignment -->
            </div>
            
            <div class="group-details-content" id="groupDetailsContent">
                <!-- Group details will be loaded here -->
            </div>
        </div>
        
        <!-- ============================================= -->
        <!-- GROUP CHAT PANEL -->
        <!-- ============================================= -->
        <div class="group-chat-panel" id="groupChatPanel">
            <div class="chat-header">
                <div class="chat-header-info" id="chatHeaderInfo">
                    <div class="chat-header-avatar" id="chatAvatar">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="chat-header-details">
                        <div class="chat-header-title" id="chatTitle">Group Chat</div>
                        <div class="chat-header-subtitle" id="chatSubtitle">
                            <span id="chatMemberCount">0 members</span>
                            <span>‚Ä¢</span>
                            <span id="chatActive">Active now</span>
                            <!-- ADDED: Group Purpose & Pulse -->
                            <span id="chatPurposeTag" class="group-purpose-tag" style="display: none;"></span>
                            <span id="chatPulse" class="group-pulse" style="display: none;"></span>
                        </div>
                        <!-- ADDED: Group Mood & Posting Rules -->
                        <div id="chatMoodRules" style="display: none; margin-top: 4px;">
                            <span id="chatMood" class="group-mood-indicator"></span>
                            <span id="chatPostingRules" class="posting-rules-banner"></span>
                        </div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="chat-header-btn" id="chatInfoBtn" title="Group Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="chat-header-btn" id="chatCallBtn" title="Start Group Call">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="chat-header-btn" id="closeChatBtn" title="Close Chat">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-messages-container" id="chatMessagesContainer">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be loaded here -->
                </div>
            </div>
            
            <div class="chat-input-container">
                <!-- ADDED: Topic Selection & Silent Mode -->
                <div id="topicSelection" style="display: none; padding: 5px 10px; background: var(--secondary-color); border-bottom: 1px solid var(--border-color);">
                    <select id="messageTopic" style="width: 100%; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 12px;">
                        <option value="">Select topic (optional)</option>
                        <option value="announcement">üì¢ Announcement</option>
                        <option value="question">‚ùì Question</option>
                        <option value="discussion">üí¨ Discussion</option>
                    </select>
                </div>
                <div class="chat-input-actions">
                    <button class="chat-input-btn" id="chatAttachBtn" title="Attach File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="chat-input-btn" id="chatEmojiBtn" title="Emoji">
                        <i class="far fa-smile"></i>
                    </button>
                    <!-- ADDED: Silent Participation Mode Toggle -->
                    <button class="chat-input-btn" id="silentModeBtn" title="Toggle Silent Mode" style="display: none;">
                        <i class="fas fa-eye"></i>
                    </button>
                    <!-- ADDED: Anonymous Posting Toggle -->
                    <button class="chat-input-btn" id="anonymousModeBtn" title="Toggle Anonymous Posting" style="display: none;">
                        <i class="fas fa-user-secret"></i>
                    </button>
                </div>
                <textarea class="chat-input" id="chatInput" placeholder="Type a message..." rows="1"></textarea>
                <button class="chat-input-btn send" id="chatSendBtn" title="Send Message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <!-- ADDED: Group Notes Panel -->
            <div id="groupNotesPanel" style="display: none; border-top: 1px solid var(--border-color); padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;"><i class="fas fa-sticky-note"></i> Group Notes</h4>
                    <button id="editNotesBtn" class="action-btn secondary" style="font-size: 12px; padding: 4px 8px;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                <div id="groupNotesContent" style="min-height: 100px; max-height: 200px; overflow-y: auto; padding: 10px; background: var(--secondary-color); border-radius: 6px;">
                    <p style="margin: 0; color: var(--text-secondary);">No notes yet. Add important information here.</p>
                </div>
                <textarea id="groupNotesEditor" style="display: none; width: 100%; min-height: 100px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: vertical;"></textarea>
                <div id="notesEditorActions" style="display: none; margin-top: 10px; text-align: right;">
                    <button id="saveNotesBtn" class="action-btn success" style="font-size: 12px; padding: 4px 12px;">Save</button>
                    <button id="cancelNotesEditBtn" class="action-btn secondary" style="font-size: 12px; padding: 4px 12px; margin-left: 5px;">Cancel</button>
                </div>
            </div>
            
            <!-- ADDED: Event Countdown Panel -->
            <div id="eventCountdownPanel" style="display: none; border-top: 1px solid var(--border-color); padding: 15px;">
                <h4 style="margin: 0 0 10px 0;"><i class="fas fa-calendar-alt"></i> Event Countdown</h4>
                <div id="eventCountdownDisplay" class="event-countdown">
                    No upcoming events
                </div>
                <button id="addEventBtn" class="action-btn secondary" style="width: 100%; margin-top: 10px; font-size: 12px; padding: 6px;">
                    <i class="fas fa-plus"></i> Add Event
                </button>
            </div>
            
            <!-- ADDED: Energy Suggestion Panel -->
            <div id="energySuggestionPanel" style="display: none; border-top: 1px solid var(--border-color); padding: 15px;">
                <div class="energy-suggestion" id="energySuggestionContent">
                    <i class="fas fa-lightbulb"></i> Group is active. All good!
                </div>
            </div>
            
            <!-- ADDED: Admin Transparency Log -->
            <div id="adminTransparencyPanel" style="display: none; border-top: 1px solid var(--border-color); padding: 15px;">
                <h4 style="margin: 0 0 10px 0;"><i class="fas fa-history"></i> Recent Changes</h4>
                <div id="adminTransparencyLog" class="admin-transparency-log">
                    No recent changes
                </div>
            </div>
        </div>
        
        <!-- ============================================= -->
        <!-- GROUP CALL PANEL -->
        <!-- ============================================= -->
        <div class="group-call-panel" id="groupCallPanel">
            <div class="call-header">
                <div class="call-header-info">
                    <div>
                        <div class="call-header-title" id="callTitle">Group Call</div>
                        <div class="call-header-subtitle" id="callDuration">00:00</div>
                    </div>
                </div>
                <div class="call-header-actions">
                    <button class="call-header-btn" id="callParticipantsBtn" title="Participants">
                        <i class="fas fa-users"></i>
                    </button>
                    <button class="call-header-btn" id="callSettingsBtn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="call-header-btn" id="endCallBtn" title="End Call">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
            
            <div class="call-participants" id="callParticipants">
                <!-- Video feeds will be added here -->
            </div>
            
            <div class="call-controls">
                <button class="call-control-btn secondary" id="callMuteBtn" title="Mute/Unmute">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="call-control-btn secondary" id="callVideoBtn" title="Video On/Off">
                    <i class="fas fa-video"></i>
                </button>
                <button class="call-control-btn secondary" id="callScreenBtn" title="Share Screen">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="call-control-btn danger" id="callLeaveBtn" title="Leave Call">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Create Group Modal (UPDATED with new features) -->
    <div class="create-group-modal" id="createGroupModal">
        <div class="create-group-container">
            <div class="create-group-header">
                <h3>Create Group</h3>
                <button class="create-group-btn" id="closeCreateGroupModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="create-group-tabs">
                <button class="create-group-tab active" data-tab="basic">Basic</button>
                <button class="create-group-tab" data-tab="settings">Settings</button>
                <button class="create-group-tab" data-tab="purpose">Purpose</button>
                <button class="create-group-tab" data-tab="theme">Theme</button>
            </div>
            
            <div class="create-group-content">
                <!-- Basic Tab -->
                <div class="create-group-tab-content active" id="basicTab">
                    <div class="input-group">
                        <label class="input-label">Group Name *</label>
                        <input type="text" class="text-input" id="groupNameInput" placeholder="Enter group name" maxlength="100">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Description</label>
                        <textarea class="text-input" id="groupDescriptionInput" placeholder="Describe the purpose of this group..." rows="3"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Topic (Optional)</label>
                        <input type="text" class="text-input" id="groupTopicInput" placeholder="#family #gaming #work">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Add topics to help others discover your group</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Type</label>
                        <select class="text-input" id="groupTypeSelect">
                            <option value="public">Public - Anyone can join</option>
                            <option value="private" selected>Private - Invite only</option>
                            <option value="secret">Secret - Hidden and invite only</option>
                        </select>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="create-group-tab-content" id="settingsTab">
                    <div class="input-group">
                        <label class="input-label">Welcome Message</label>
                        <textarea class="text-input" id="welcomeMessageInput" placeholder="Welcome message for new members..." rows="3"></textarea>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">This message will be shown to new members when they join</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Rules</label>
                        <textarea class="text-input" id="groupRulesInput" placeholder="Add group rules (one per line)..." rows="5">1. Be respectful to all members
2. No spam or self-promotion
3. Keep discussions relevant to the group topic
4. No hate speech or harassment</textarea>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Moderation Settings</label>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="approveNewMembers" checked>
                                <span>Approve new members before they can join</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="onlyAdminsCanPost" checked>
                                <span>Only admins can post messages</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="allowMediaSharing" checked>
                                <span>Allow media sharing</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableDisappearingMessages">
                                <span>Enable disappearing messages (24 hours)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- ADDED: Purpose Tab with New Features -->
                <div class="create-group-tab-content" id="purposeTab">
                    <div class="input-group">
                        <label class="input-label">Group Purpose *</label>
                        <select class="text-input" id="groupPurposeSelect">
                            <option value="">Select a purpose</option>
                            <option value="study">üìö Study / Learning</option>
                            <option value="prayer">üôè Prayer / Spiritual</option>
                            <option value="work">üíº Work / Professional</option>
                            <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</option>
                            <option value="event">üéâ Event / Celebration</option>
                            <option value="project">üìã Project Collaboration</option>
                            <option value="support">ü§ù Support Group</option>
                            <option value="hobby">üé® Hobby / Interest</option>
                            <option value="fitness">üí™ Fitness / Health</option>
                            <option value="other">üîÆ Other</option>
                        </select>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">This helps members understand the group's focus</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Default Group Mood</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <div class="mood-option" data-mood="calm" style="flex: 1; min-width: 100px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: #e3f2fd; color: #1976d2;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>üòå Calm</div>
                            </div>
                            <div class="mood-option" data-mood="busy" style="flex: 1; min-width: 100px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: #fff3e0; color: #f57c00;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>üèÉ Busy</div>
                            </div>
                            <div class="mood-option" data-mood="celebratory" style="flex: 1; min-width: 100px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: #fce4ec; color: #c2185b;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>üéâ Celebratory</div>
                            </div>
                            <div class="mood-option" data-mood="silent" style="flex: 1; min-width: 100px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: #f5f5f5; color: #616161;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>üîá Silent</div>
                            </div>
                            <div class="mood-option" data-mood="urgent" style="flex: 1; min-width: 100px; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: #ffebee; color: #d32f2f;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>üö® Urgent</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Posting Rules Mode</label>
                        <select class="text-input" id="postingRulesSelect">
                            <option value="everyone">Everyone can post</option>
                            <option value="admin_only">Admin-only posting</option>
                            <option value="scheduled">Scheduled posting times</option>
                            <option value="quiet_hours">Quiet hours enabled</option>
                        </select>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Controls who can post and when</div>
                    </div>
                    
                    <div class="input-group" id="quietHoursSection" style="display: none;">
                        <label class="input-label">Quiet Hours</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="time" class="text-input" id="quietStartTime" value="22:00">
                            <span>to</span>
                            <input type="time" class="text-input" id="quietEndTime" value="08:00">
                        </div>
                    </div>
                    
                    <div class="input-group" id="scheduledPostingSection" style="display: none;">
                        <label class="input-label">Allowed Posting Times</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="time" class="text-input" id="postingStartTime" value="09:00">
                            <span>to</span>
                            <input type="time" class="text-input" id="postingEndTime" value="18:00">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Enable Silent Participation</label>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="enableReadOnlyMode">
                                <span>Allow read-only mode for members</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" id="enableReactOnlyMode">
                                <span>Allow react-only participation</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="enableAnonymousMode">
                                <span>Allow anonymous posting (optional)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Theme Tab -->
                <div class="create-group-tab-content" id="themeTab">
                    <div class="input-group">
                        <label class="input-label">Group Theme Color</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <div class="theme-option" data-theme="blue" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Blue</div>
                            </div>
                            <div class="theme-option" data-theme="green" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Green</div>
                            </div>
                            <div class="theme-option" data-theme="red" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Red</div>
                            </div>
                            <div class="theme-option" data-theme="purple" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #8a2387 0%, #f27121 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Purple</div>
                            </div>
                            <div class="theme-option" data-theme="dark" style="flex: 1; min-width: 100px; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); color: white;">
                                <i class="fas fa-check" style="display: none;"></i>
                                <div>Dark</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Custom Reactions (Optional)</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <div class="reaction-option" data-reaction="üëç" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üëç
                            </div>
                            <div class="reaction-option" data-reaction="‚ù§Ô∏è" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                ‚ù§Ô∏è
                            </div>
                            <div class="reaction-option" data-reaction="üòÇ" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üòÇ
                            </div>
                            <div class="reaction-option" data-reaction="üôè" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üôè
                            </div>
                            <div class="reaction-option" data-reaction="üî•" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üî•
                            </div>
                            <div class="reaction-option" data-reaction="üëè" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center; font-size: 20px;">
                                üëè
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Select custom reactions for your group</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Group Badges</label>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <div class="badge-option" data-badge="star" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center;">
                                <i class="fas fa-star" style="color: gold;"></i>
                                <div style="font-size: 12px; margin-top: 5px;">Helpful</div>
                            </div>
                            <div class="badge-option" data-badge="fire" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center;">
                                <i class="fas fa-fire" style="color: orange;"></i>
                                <div style="font-size: 12px; margin-top: 5px;">Active</div>
                            </div>
                            <div class="badge-option" data-badge="crown" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center;">
                                <i class="fas fa-crown" style="color: purple;"></i>
                                <div style="font-size: 12px; margin-top: 5px;">Moderator</div>
                            </div>
                            <div class="badge-option" data-badge="heart" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; text-align: center;">
                                <i class="fas fa-heart" style="color: red;"></i>
                                <div style="font-size: 12px; margin-top: 5px;">Supporter</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Select badges that admins can award to members</div>
                    </div>
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                <button class="action-btn secondary" id="cancelCreateGroupBtn">Cancel</button>
                <button class="action-btn success" id="createGroupBtnModal">Create Group</button>
            </div>
        </div>
    </div>
    
    <!-- ============================================= -->
    <!-- ADMIN MANAGEMENT MODAL (UPDATED with transparency features) -->
    <!-- ============================================= -->
    <div class="admin-management-modal" id="adminManagementModal">
        <div class="admin-management-container">
            <div class="admin-management-header">
                <h3>Group Management</h3>
                <div id="adminManagementGroupName" style="opacity: 0.9; font-size: 14px;"></div>
            </div>
            
            <div class="admin-management-tabs">
                <button class="admin-management-tab active" data-tab="members">Members</button>
                <button class="admin-management-tab" data-tab="settings">Settings</button>
                <button class="admin-management-tab" data-tab="purpose">Purpose</button>
                <button class="admin-management-tab" data-tab="analytics">Analytics</button>
                <button class="admin-management-tab" data-tab="transparency">Transparency</button>
            </div>
            
            <div class="admin-management-content">
                <!-- Members Tab -->
                <div class="admin-management-section active" id="adminMembersTab">
                    <div class="admin-actions">
                        <button class="admin-action-btn" id="adminAddMemberBtn">
                            <i class="fas fa-user-plus"></i> Add Member
                        </button>
                        <button class="admin-action-btn" id="adminInviteLinkBtn">
                            <i class="fas fa-link"></i> Manage Invite Links
                        </button>
                        <button class="admin-action-btn" id="adminExportMembersBtn">
                            <i class="fas fa-download"></i> Export Members
                        </button>
                    </div>
                    
                    <div class="member-management-list" id="memberManagementList">
                        <!-- Members will be loaded here -->
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="admin-management-section" id="adminSettingsTab">
                    <div class="admin-settings-form">
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-lock"></i>
                                Privacy Settings
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminPublicGroup" data-setting="publicGroup">
                                    <span>Make group public (anyone can join)</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminApproveMembers" data-setting="approveMembers" checked>
                                    <span>Approve new members before joining</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminAllowInvites" data-setting="allowInvites" checked>
                                    <span>Allow members to invite others</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-comments"></i>
                                Chat Settings
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminOnlyAdminsPost" data-setting="onlyAdminsPost">
                                    <span>Only admins can post messages</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminAllowMedia" data-setting="allowMedia" checked>
                                    <span>Allow media sharing</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminDisappearingMessages" data-setting="disappearingMessages">
                                    <span>Enable disappearing messages (24h)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-bell"></i>
                                Notification Settings
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminMentionNotifications" data-setting="mentionNotifications" checked>
                                    <span>Send notifications for @mentions</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminAnnouncementNotifications" data-setting="announcementNotifications" checked>
                                    <span>Send notifications for announcements</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ADDED: Purpose Management Tab -->
                <div class="admin-management-section" id="adminPurposeTab">
                    <div class="admin-settings-form">
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-bullseye"></i>
                                Group Purpose & Mood
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">Update Group Purpose:</label>
                                <select class="text-input" id="adminGroupPurpose" style="margin-top: 8px; width: 100%;">
                                    <option value="">Select purpose</option>
                                    <option value="study">üìö Study / Learning</option>
                                    <option value="prayer">üôè Prayer / Spiritual</option>
                                    <option value="work">üíº Work / Professional</option>
                                    <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</option>
                                    <option value="event">üéâ Event / Celebration</option>
                                    <option value="project">üìã Project Collaboration</option>
                                    <option value="support">ü§ù Support Group</option>
                                    <option value="hobby">üé® Hobby / Interest</option>
                                    <option value="fitness">üí™ Fitness / Health</option>
                                    <option value="other">üîÆ Other</option>
                                </select>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">Current Group Mood:</label>
                                <div style="display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                                    <button class="mood-select-btn" data-mood="calm" style="padding: 8px 12px; border: 1px solid #1976d2; border-radius: 6px; background: #e3f2fd; color: #1976d2; cursor: pointer;">üòå Calm</button>
                                    <button class="mood-select-btn" data-mood="busy" style="padding: 8px 12px; border: 1px solid #f57c00; border-radius: 6px; background: #fff3e0; color: #f57c00; cursor: pointer;">üèÉ Busy</button>
                                    <button class="mood-select-btn" data-mood="celebratory" style="padding: 8px 12px; border: 1px solid #c2185b; border-radius: 6px; background: #fce4ec; color: #c2185b; cursor: pointer;">üéâ Celebratory</button>
                                    <button class="mood-select-btn" data-mood="silent" style="padding: 8px 12px; border: 1px solid #616161; border-radius: 6px; background: #f5f5f5; color: #616161; cursor: pointer;">üîá Silent</button>
                                    <button class="mood-select-btn" data-mood="urgent" style="padding: 8px 12px; border: 1px solid #d32f2f; border-radius: 6px; background: #ffebee; color: #d32f2f; cursor: pointer;">üö® Urgent</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-comment-slash"></i>
                                Posting Rules
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">Posting Mode:</label>
                                <select class="text-input" id="adminPostingMode" style="margin-top: 8px; width: 100%;">
                                    <option value="everyone">Everyone can post</option>
                                    <option value="admin_only">Admin-only posting</option>
                                    <option value="scheduled">Scheduled posting times</option>
                                    <option value="quiet_hours">Quiet hours enabled</option>
                                </select>
                            </div>
                            <div class="admin-settings-option" id="adminQuietHoursSection" style="display: none;">
                                <label class="admin-settings-label">Quiet Hours:</label>
                                <div style="display: flex; gap: 10px; margin-top: 8px; align-items: center;">
                                    <input type="time" class="text-input" id="adminQuietStart" style="flex: 1;" value="22:00">
                                    <span>to</span>
                                    <input type="time" class="text-input" id="adminQuietEnd" style="flex: 1;" value="08:00">
                                </div>
                            </div>
                            <div class="admin-settings-option" id="adminScheduledPostingSection" style="display: none;">
                                <label class="admin-settings-label">Allowed Posting Times:</label>
                                <div style="display: flex; gap: 10px; margin-top: 8px; align-items: center;">
                                    <input type="time" class="text-input" id="adminPostingStart" style="flex: 1;" value="09:00">
                                    <span>to</span>
                                    <input type="time" class="text-input" id="adminPostingEnd" style="flex: 1;" value="18:00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-user-secret"></i>
                                Participation Modes
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminEnableReadOnly">
                                    <span>Allow read-only mode for members</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminEnableReactOnly">
                                    <span>Allow react-only participation</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminEnableAnonymous">
                                    <span>Allow anonymous posting</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Tab -->
                <div class="admin-management-section" id="adminAnalyticsTab">
                    <div class="admin-analytics-content">
                        <div class="admin-analytics-stats">
                            <div class="analytics-stat">
                                <div class="analytics-stat-number" id="analyticsDailyMessages">0</div>
                                <div class="analytics-stat-label">Messages Today</div>
                            </div>
                            <div class="analytics-stat">
                                <div class="analytics-stat-number" id="analyticsActiveMembers">0</div>
                                <div class="analytics-stat-label">Active Members</div>
                            </div>
                            <div class="analytics-stat">
                                <div class="analytics-stat-number" id="analyticsEngagementRate">0%</div>
                                <div class="analytics-stat-label">Engagement Rate</div>
                            </div>
                        </div>
                        <div class="admin-analytics-chart">
                            <canvas id="analyticsChart" width="400" height="200" style="max-width: 100%;"></canvas>
                        </div>
                        <div class="admin-analytics-insights">
                            <h4>Group Pulse Insights</h4>
                            <div id="groupPulseInsight" style="padding: 10px; background: var(--secondary-color); border-radius: 8px; margin-top: 10px;">
                                <p style="margin: 0;">Loading group pulse analysis...</p>
                            </div>
                            <button id="refreshAnalyticsBtn" class="action-btn secondary" style="margin-top: 15px; width: 100%;">
                                <i class="fas fa-sync-alt"></i> Refresh Analytics
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ADDED: Transparency Tab -->
                <div class="admin-management-section" id="adminTransparencyTab">
                    <div class="admin-transparency-content">
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-history"></i>
                                Change History
                            </div>
                            <div id="transparencyLog" style="max-height: 300px; overflow-y: auto; padding: 10px; background: var(--secondary-color); border-radius: 8px;">
                                <div class="transparency-log-item">
                                    <div><strong>Group created</strong></div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">By you ‚Ä¢ Just now</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-eye"></i>
                                Visibility Settings
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminShowChangeHistory" checked>
                                    <span>Show change history to members</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminShowAdminActions" checked>
                                    <span>Show admin actions to members</span>
                                </label>
                            </div>
                            <div class="admin-settings-option">
                                <label class="admin-settings-label">
                                    <input type="checkbox" id="adminShowModerationLog">
                                    <span>Show moderation actions (mutes, bans)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="admin-settings-group">
                            <div class="admin-settings-title">
                                <i class="fas fa-download"></i>
                                Export Data
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="admin-action-btn" id="exportTransparencyLog">
                                    <i class="fas fa-file-export"></i> Export Change History
                                </button>
                                <button class="admin-action-btn" id="exportSettingsHistory">
                                    <i class="fas fa-cog"></i> Export Settings History
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                <button class="action-btn secondary" id="closeAdminManagementBtn">Close</button>
                <button class="action-btn success" id="saveAdminSettingsBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Friend Selection Modal -->
    <div class="friend-selection-modal" id="friendSelectionModal">
        <div class="friend-selection-container">
            <div class="friend-selection-header">
                <h3>Select Friends</h3>
                <p>Choose friends to add to your group</p>
            </div>
            <div class="friend-selection-content" id="friendSelectionContent">
                <div class="loading-placeholder">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading friends...</p>
                </div>
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                <button class="action-btn secondary" id="cancelFriendSelectionBtn">Cancel</button>
                <button class="action-btn success" id="confirmFriendSelectionBtn">Add Selected Friends</button>
            </div>
        </div>
    </div>
    
    <!-- Group Invite Modal -->
    <div class="group-invite-modal" id="groupInviteModal">
        <div class="group-invite-container">
            <div class="group-invite-header">
                <div class="group-invite-avatar" id="inviteAvatar">
                    <i class="fas fa-users"></i>
                </div>
                <div class="group-invite-name" id="inviteName">Family Chat</div>
                <!-- ADDED: Purpose and Mood in Invite -->
                <div class="group-purpose-tag" id="invitePurpose" style="margin: 5px 0;"></div>
                <div class="group-mood-indicator" id="inviteMood" style="margin: 5px 0;"></div>
                <div class="group-invite-topic" id="inviteTopic">#family #updates</div>
                <div class="member-count-badge" id="inviteMemberCount">
                    <i class="fas fa-users"></i> 12 members
                </div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
                    Invited by <span id="invitedBy">John Doe</span>
                </div>
            </div>
            
            <div class="group-invite-actions">
                <button class="group-invite-btn decline" id="declineInviteBtn">
                    <i class="fas fa-times"></i> Decline
                </button>
                <button class="group-invite-btn accept" id="acceptInviteBtn">
                    <i class="fas fa-check"></i> Join Group
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operation completed successfully</span>
    </div>

    <script>
        // =============================================
        // COMPLETE FUNCTIONAL GROUPS SYSTEM WITH UNIQUE FEATURES
        // INTEGRATED WITH EXISTING API SYSTEM
        // =============================================

        // Global variables
        let currentUser = null;
        let userData = null;
        let groups = [];
        let myGroups = [];
        let joinedGroups = [];
        let groupInvites = [];
        let adminGroups = [];
        let selectedGroup = null;
        let currentTypeFilter = 'all';
        let currentSearchTerm = '';
        let isLoadedFromLocalStorage = false;
        let isMobile = window.innerWidth <= 768;
        let pendingGroupActions = [];
        let offlineOverlayDismissed = false;
        let friends = [];
        let selectedFriends = [];
        
        // Unique features variables
        let groupPurposes = {
            'study': { name: 'Study', icon: 'üìö', color: '#4CAF50' },
            'prayer': { name: 'Prayer', icon: 'üôè', color: '#9C27B0' },
            'work': { name: 'Work', icon: 'üíº', color: '#2196F3' },
            'family': { name: 'Family', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', color: '#FF9800' },
            'event': { name: 'Event', icon: 'üéâ', color: '#E91E63' },
            'project': { name: 'Project', icon: 'üìã', color: '#009688' },
            'support': { name: 'Support', icon: 'ü§ù', color: '#3F51B5' },
            'hobby': { name: 'Hobby', icon: 'üé®', color: '#FF5722' },
            'fitness': { name: 'Fitness', icon: 'üí™', color: '#00BCD4' },
            'other': { name: 'Other', icon: 'üîÆ', color: '#607D8B' }
        };
        
        let groupMoods = {
            'calm': { name: 'Calm', icon: 'üòå', color: '#1976d2', bgColor: '#e3f2fd' },
            'busy': { name: 'Busy', icon: 'üèÉ', color: '#f57c00', bgColor: '#fff3e0' },
            'celebratory': { name: 'Celebratory', icon: 'üéâ', color: '#c2185b', bgColor: '#fce4ec' },
            'silent': { name: 'Silent', icon: 'üîá', color: '#616161', bgColor: '#f5f5f5' },
            'urgent': { name: 'Urgent', icon: 'üö®', color: '#d32f2f', bgColor: '#ffebee' }
        };
        
        let postingRules = {
            'everyone': { name: 'Everyone can post', color: '#4CAF50', bgColor: '#E8F5E9' },
            'admin_only': { name: 'Admin-only posting', color: '#FF9800', bgColor: '#FFF3E0' },
            'scheduled': { name: 'Scheduled posting times', color: '#2196F3', bgColor: '#E3F2FD' },
            'quiet_hours': { name: 'Quiet hours enabled', color: '#9C27B0', bgColor: '#F3E5F5' }
        };
        
        let participationModes = {
            'read_only': { name: 'Read Only', icon: 'üëÅÔ∏è', color: '#666', bgColor: '#F5F5F5' },
            'react_only': { name: 'React Only', icon: 'üëç', color: '#1976D2', bgColor: '#E3F2FD' },
            'anonymous': { name: 'Anonymous', icon: 'üïµÔ∏è', color: '#7B1FA2', bgColor: '#F3E5F5' }
        };
        
        let groupTopics = {
            'announcement': { name: 'Announcement', icon: 'üì¢', color: '#1976d2', bgColor: '#e3f2fd' },
            'question': { name: 'Question', icon: '‚ùì', color: '#7b1fa2', bgColor: '#f3e5f5' },
            'discussion': { name: 'Discussion', icon: 'üí¨', color: '#2e7d32', bgColor: '#e8f5e9' }
        };

        // Group types with colors and icons
        const groupTypes = {
            'public': {
                name: 'Public',
                color: 'var(--success-color)',
                icon: 'fas fa-globe',
                description: 'Anyone can join'
            },
            'private': {
                name: 'Private',
                color: 'var(--warning-color)',
                icon: 'fas fa-lock',
                description: 'Invite only'
            },
            'secret': {
                name: 'Secret',
                color: 'var(--danger-color)',
                icon: 'fas fa-eye-slash',
                description: 'Hidden and invite only'
            },
            'family': {
                name: 'Family',
                color: '#9c27b0',
                icon: 'fas fa-home',
                description: 'Family members only'
            },
            'work': {
                name: 'Work',
                color: '#2196f3',
                icon: 'fas fa-briefcase',
                description: 'Work colleagues'
            }
        };

        // Group themes
        const groupThemes = {
            'blue': {
                name: 'Blue',
                gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: '#667eea'
            },
            'green': {
                name: 'Green',
                gradient: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                color: '#11998e'
            },
            'red': {
                name: 'Red',
                gradient: 'linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)',
                color: '#ff416c'
            },
            'purple': {
                name: 'Purple',
                gradient: 'linear-gradient(135deg, #8a2387 0%, #f27121 100%)',
                color: '#8a2387'
            },
            'dark': {
                name: 'Dark',
                gradient: 'linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%)',
                color: '#0f2027'
            }
        };

        // Group roles with permissions
        const groupRoles = {
            'admin': {
                name: 'Admin',
                color: 'var(--role-admin)',
                icon: 'fas fa-crown',
                permissions: ['manage_group', 'add_members', 'remove_members', 'post_messages', 'delete_messages', 'assign_roles', 'manage_events', 'manage_polls', 'manage_calls', 'moderate_chat']
            },
            'moderator': {
                name: 'Moderator',
                color: 'var(--role-moderator)',
                icon: 'fas fa-shield-alt',
                permissions: ['add_members', 'remove_members', 'post_messages', 'delete_messages', 'manage_events', 'moderate_chat']
            },
            'organizer': {
                name: 'Organizer',
                color: 'var(--role-organizer)',
                icon: 'fas fa-calendar-alt',
                permissions: ['manage_events', 'post_messages']
            },
            'helper': {
                name: 'Helper',
                color: 'var(--role-helper)',
                icon: 'fas fa-hands-helping',
                permissions: ['add_members', 'post_messages']
            },
            'member': {
                name: 'Member',
                color: 'var(--role-member)',
                icon: 'fas fa-user',
                permissions: ['post_messages']
            }
        };

        // Chat & Call variables
        let currentChatGroup = null;
        let chatMessagesList = [];
        let isTyping = false;
        let callInProgress = false;
        let callStartTime = null;
        let callTimer = null;
        let localStream = null;
        let peerConnections = {};
        
        // Unique features state variables
        let currentParticipationMode = 'normal';
        let isSilentMode = false;
        let isAnonymousMode = false;
        let groupNotes = {};
        let groupEvents = {};
        let transparencyLog = [];
        let energySuggestions = [];

        // Local Storage Keys
        const LOCAL_STORAGE_KEYS = {
            USER: 'knecta_current_user',
            GROUPS: 'knecta_groups',
            MY_GROUPS: 'knecta_my_groups',
            JOINED_GROUPS: 'knecta_joined_groups',
            GROUP_INVITES: 'knecta_group_invites',
            ADMIN_GROUPS: 'knecta_admin_groups',
            LAST_SYNC: 'knecta_groups_last_sync',
            PENDING_ACTIONS: 'knecta_pending_group_actions',
            USER_PROFILE: 'knecta_user_profile',
            OFFLINE_OVERLAY_DISMISSED: 'knecta_offline_overlay_dismissed_groups',
            LAST_CACHE_TIME: 'knecta_groups_last_cache_time',
            FRIENDS: 'knecta_friends',
            GROUP_CHATS: 'knecta_group_chats',
            GROUP_MESSAGES: 'knecta_group_messages_',
            GROUP_TYPING: 'knecta_group_typing_',
            GROUP_CALLS: 'knecta_group_calls',
            GROUP_PURPOSES: 'knecta_group_purposes',
            GROUP_MOODS: 'knecta_group_moods',
            GROUP_POSTING_RULES: 'knecta_group_posting_rules',
            GROUP_NOTES: 'knecta_group_notes_',
            GROUP_EVENTS: 'knecta_group_events_',
            GROUP_TRANSPARENCY: 'knecta_group_transparency_',
            USER_PARTICIPATION_MODES: 'knecta_user_participation_modes'
        };
        
        // Flag to track if page is already initialized
        let isPageInitialized = false;
        let apiReady = false;
        
        // API access helper - FIXED: Validate method existence before calling
        function getApi() {
            if (window.parent && window.parent.api) {
                return window.parent.api;
            } else if (window.api) {
                return window.api;
            } else {
                return null;
            }
        }
        
        // Safe API call - FIXED: Validate method exists before calling
        async function safeApiCall(method, endpoint, data = null) {
            try {
                const api = getApi();
                if (!api) {
                    console.log(`API not available for ${method} ${endpoint}`);
                    return { success: false, error: 'API not available' };
                }
                
                // Check if method exists on api object
                if (typeof api[method] !== 'function') {
                    console.warn(`API method ${method} not available`);
                    return { success: false, error: `API method ${method} not available` };
                }
                
                // Check if we're trying to call a method that requires authentication but we don't have a user
                if (!currentUser && endpoint.includes('auth/me')) {
                    console.log('No current user for auth check');
                    return { success: false, error: 'No authenticated user' };
                }
                
                if (!apiReady) {
                    console.log(`API not ready yet for ${method} ${endpoint}`);
                    return { success: false, error: 'API not ready yet' };
                }
                
                console.log(`API call: ${method} ${endpoint}`);
                const result = await api[method](endpoint, data);
                return result || { success: false, error: 'No response from API' };
                
            } catch (error) {
                console.error(`API ${method} error:`, error);
                return { success: false, error: error.message || 'Unknown error' };
            }
        }
        
        // Background sync safe call - FIXED: Won't crash if API methods don't exist
        async function backgroundApiCall(method, endpoint, data = null) {
            try {
                const api = getApi();
                if (!api) {
                    return null;
                }
                
                // Skip background sync if API method doesn't exist
                if (typeof api[method] !== 'function') {
                    return null;
                }
                
                return await safeApiCall(method, endpoint, data);
            } catch (error) {
                // Silent fail for background sync
                return null;
            }
        }
        
        // Main initialization function
        function initGroupPage() {
            if (isPageInitialized) {
                console.log('Group page already initialized');
                return;
            }
            
            isPageInitialized = true;
            console.log('=== PASSIVE IFRAME GROUP PAGE INITIALIZATION START ===');
            
            // Load cached data instantly
            loadCachedDataInstantly();
            
            // Set up API ready listener
            setupApiReadyListener();
            
            // Start API readiness check
            checkApiReady();
        }
        
        // Set up API ready listener
        function setupApiReadyListener() {
            window.addEventListener('message', function(event) {
                if (event.data === 'API_READY' || event.data.type === 'API_READY') {
                    apiReady = true;
                    console.log('API Ready received via message');
                    initializeApp();
                }
            });
        }
        
        // Check if API is ready
        function checkApiReady() {
            const api = getApi();
            if (api && typeof api.get === 'function') {
                apiReady = true;
                console.log('API detected as ready');
                initializeApp();
            } else {
                // Try again after a delay
                setTimeout(checkApiReady, 500);
            }
        }
        
        // Load cached data INSTANTLY on page load
        function loadCachedDataInstantly() {
            console.log('=== INSTANT CACHE LOAD START (GROUPS) ===');
            
            try {
                // Load user from cache
                const cachedUser = localStorage.getItem(LOCAL_STORAGE_KEYS.USER);
                if (cachedUser) {
                    currentUser = JSON.parse(cachedUser);
                    console.log('‚úì Instant: User loaded from cache');
                }
                
                // Load user profile
                const cachedProfile = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_PROFILE);
                if (cachedProfile) {
                    userData = JSON.parse(cachedProfile);
                }
                
                // Load friends
                const cachedFriends = localStorage.getItem(LOCAL_STORAGE_KEYS.FRIENDS);
                if (cachedFriends) {
                    friends = JSON.parse(cachedFriends);
                    console.log(`‚úì Instant: ${friends.length} friends loaded from cache`);
                }
                
                // Load groups
                const groupsData = localStorage.getItem(LOCAL_STORAGE_KEYS.GROUPS);
                if (groupsData) {
                    groups = JSON.parse(groupsData);
                    console.log(`‚úì Instant: ${groups.length} groups loaded from cache`);
                    isLoadedFromLocalStorage = true;
                    
                    updateGroupCounts();
                    renderGroupsListInstantly();
                }
                
                // Load other group data
                const myGroupsData = localStorage.getItem(LOCAL_STORAGE_KEYS.MY_GROUPS);
                if (myGroupsData) myGroups = JSON.parse(myGroupsData);
                
                const joinedData = localStorage.getItem(LOCAL_STORAGE_KEYS.JOINED_GROUPS);
                if (joinedData) joinedGroups = JSON.parse(joinedData);
                
                const invitesData = localStorage.getItem(LOCAL_STORAGE_KEYS.GROUP_INVITES);
                if (invitesData) groupInvites = JSON.parse(invitesData);
                
                const adminData = localStorage.getItem(LOCAL_STORAGE_KEYS.ADMIN_GROUPS);
                if (adminData) adminGroups = JSON.parse(adminData);
                
                // Load unique features data
                loadUniqueFeaturesData();
                
                console.log('=== INSTANT CACHE LOAD COMPLETE (GROUPS) ===');
                
            } catch (error) {
                console.error('Error in instant cache load:', error);
            }
        }
        
        // Load unique features data from cache
        function loadUniqueFeaturesData() {
            try {
                const cachedPurposes = localStorage.getItem(LOCAL_STORAGE_KEYS.GROUP_PURPOSES);
                if (cachedPurposes) {
                    const purposes = JSON.parse(cachedPurposes);
                    groups.forEach(group => {
                        if (purposes[group.id]) {
                            group.purpose = purposes[group.id];
                        }
                    });
                }
                
                const cachedMoods = localStorage.getItem(LOCAL_STORAGE_KEYS.GROUP_MOODS);
                if (cachedMoods) {
                    const moods = JSON.parse(cachedMoods);
                    groups.forEach(group => {
                        if (moods[group.id]) {
                            group.mood = moods[group.id];
                        }
                    });
                }
                
                const cachedRules = localStorage.getItem(LOCAL_STORAGE_KEYS.GROUP_POSTING_RULES);
                if (cachedRules) {
                    const rules = JSON.parse(cachedRules);
                    groups.forEach(group => {
                        if (rules[group.id]) {
                            group.postingRule = rules[group.id];
                        }
                    });
                }
                
                const cachedModes = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_PARTICIPATION_MODES);
                if (cachedModes) {
                    currentParticipationMode = JSON.parse(cachedModes);
                }
                
                console.log('‚úì Instant: Unique features data loaded from cache');
                
            } catch (error) {
                console.error('Error loading unique features data:', error);
            }
        }
        
        // Render groups list instantly from cache
        function renderGroupsListInstantly() {
            const allGroupsList = document.getElementById('allGroupsList');
            if (!allGroupsList) return;
            
            allGroupsList.innerHTML = '';
            
            if (groups.length === 0) {
                allGroupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>No groups yet</p>
                        <p class="subtext">Create or join groups to start connecting</p>
                    </div>
                `;
                return;
            }
            
            const fragment = document.createDocumentFragment();
            const groupsToRender = groups.slice(0, 15);
            
            groupsToRender.forEach(group => {
                addGroupItemInstant(group, fragment, 'group');
            });
            
            allGroupsList.appendChild(fragment);
            
            if (groups.length > 15) {
                setTimeout(() => {
                    const remainingGroups = groups.slice(15);
                    remainingGroups.forEach(group => {
                        addGroupItemInstant(group, allGroupsList, 'group');
                    });
                }, 100);
            }
            
            allGroupsList.classList.add('instant-load');
        }
        
        // Add group item instantly
        function addGroupItemInstant(groupData, container, type) {
            const groupItem = document.createElement('div');
            groupItem.className = 'group-item';
            groupItem.dataset.groupId = groupData.id;
            groupItem.dataset.type = type;
            
            const initials = groupData.name 
                ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                : 'G';
            
            const groupType = groupData.type || 'private';
            const typeInfo = groupTypes[groupType];
            const theme = groupData.theme || 'blue';
            const themeInfo = groupThemes[theme];
            
            const purpose = groupData.purpose || '';
            const mood = groupData.mood || '';
            const postingRule = groupData.postingRule || 'everyone';
            const purposeInfo = purpose ? groupPurposes[purpose] : null;
            const moodInfo = mood ? groupMoods[mood] : null;
            const ruleInfo = postingRules[postingRule];
            
            const pulse = calculateGroupPulse(groupData);
            
            groupItem.innerHTML = `
                <div class="group-avatar" ${groupData.photoURL ? `style="background-image: url('${groupData.photoURL}'); background: ${themeInfo.gradient};"` : `style="background: ${themeInfo.gradient};"`}>
                    ${groupData.photoURL ? '' : `<span>${initials}</span>`}
                    <div class="group-theme-badge ${theme}"></div>
                    <div class="group-type-badge ${groupType}" title="${typeInfo ? typeInfo.name : 'Private'}">
                        <i class="${typeInfo ? typeInfo.icon : 'fas fa-lock'}"></i>
                    </div>
                    ${purposeInfo ? `<div class="group-purpose-badge" style="position: absolute; bottom: -5px; right: -5px; background: ${purposeInfo.color}; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px;">${purposeInfo.icon}</div>` : ''}
                </div>
                <div class="group-info">
                    <div class="group-name">
                        <span class="group-name-text">${groupData.name || 'Unnamed Group'}</span>
                        ${pulse ? `<span class="group-pulse ${pulse.class}"><i class="fas fa-heartbeat"></i> ${pulse.text}</span>` : ''}
                        <span class="group-details">
                            ${groupData.isAdmin ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : ''}
                        </span>
                    </div>
                    <div class="group-details">
                        ${purposeInfo ? `<span class="group-purpose-tag">${purposeInfo.icon} ${purposeInfo.name}</span>` : ''}
                        ${moodInfo ? `<span class="group-mood-indicator mood-${mood}" style="background: ${moodInfo.bgColor}; color: ${moodInfo.color}; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${moodInfo.icon} ${moodInfo.name}</span>` : ''}
                        ${groupData.topic ? `<span class="group-topic">${groupData.topic}</span>` : ''}
                        <span class="member-count"><i class="fas fa-users"></i> ${groupData.memberCount || 0}</span>
                        <span>${typeInfo ? typeInfo.name : 'Private'}</span>
                    </div>
                    ${ruleInfo ? `<div style="font-size: 11px; color: ${ruleInfo.color}; margin-top: 3px;"><i class="fas fa-comment"></i> ${ruleInfo.name}</div>` : ''}
                </div>
                <div class="group-actions">
                    <button class="group-action-btn chat" data-action="open-chat" title="Open Chat">
                        <i class="fas fa-comments"></i>
                    </button>
                    <button class="group-action-btn" data-action="info" title="Group Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            `;
            
            groupItem.addEventListener('click', (e) => {
                if (!e.target.closest('.group-actions')) {
                    showGroupDetails(groupData, type);
                }
            });
            
            const actionButtons = groupItem.querySelectorAll('.group-action-btn');
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.dataset.action;
                    handleGroupAction(action, groupData, type, btn);
                });
            });
            
            container.appendChild(groupItem);
        }
        
        // Calculate group pulse
        function calculateGroupPulse(groupData) {
            if (!groupData.lastActivity) return null;
            
            const lastActivity = new Date(groupData.lastActivity).getTime();
            const now = Date.now();
            const hoursSinceActivity = (now - lastActivity) / (1000 * 60 * 60);
            
            if (hoursSinceActivity < 1) {
                return { text: 'Very Active', class: 'pulse-active' };
            } else if (hoursSinceActivity < 6) {
                return { text: 'Active', class: 'pulse-active' };
            } else if (hoursSinceActivity < 24) {
                return { text: 'Quiet', class: 'pulse-quiet' };
            } else if (hoursSinceActivity < 72) {
                return { text: 'Inactive', class: 'pulse-quiet' };
            } else {
                return { text: 'Dormant', class: 'pulse-quiet' };
            }
        }
        
        async function initializeApp() {
            console.log('=== FULL GROUP APP INITIALIZATION START ===');
            
            if (!apiReady) {
                console.log('Waiting for API to be ready...');
                setTimeout(initializeApp, 1000);
                return;
            }
            
            checkMobile();
            window.addEventListener('resize', checkMobile);
            
            await loadUserFromCache();
            await tryLoadUserFromAPI();
            
            setupEventListeners();
            setupGroupInvitesListener();
            
            showNotification('Groups system ready with unique features', 'success');
            
            // Start background sync after a delay
            setTimeout(() => {
                backgroundSyncWithServer();
            }, 1000);
            
            // Set up periodic sync
            setInterval(() => {
                backgroundSyncWithServer();
            }, 30000); // Sync every 30 seconds
            
            processPendingOfflineActions();
            
            console.log('=== FULL GROUP APP INITIALIZATION COMPLETE ===');
        }
        
        // Load user from cache
        async function loadUserFromCache() {
            try {
                const cachedUser = localStorage.getItem(LOCAL_STORAGE_KEYS.USER);
                if (cachedUser) {
                    currentUser = JSON.parse(cachedUser);
                    console.log('Loaded user from cache:', currentUser?.uid);
                }
                
                const cachedProfile = localStorage.getItem(LOCAL_STORAGE_KEYS.USER_PROFILE);
                if (cachedProfile) {
                    userData = JSON.parse(cachedProfile);
                }
                
                if (!currentUser) {
                    currentUser = {
                        uid: 'local_user_' + Date.now(),
                        displayName: 'Local User',
                        email: '',
                        photoURL: ''
                    };
                }
                
            } catch (error) {
                console.error('Error loading user from cache:', error);
                currentUser = {
                    uid: 'fallback_user_' + Date.now(),
                    displayName: 'User',
                    email: '',
                    photoURL: ''
                };
            }
        }
        
        // Try to load user from API
        async function tryLoadUserFromAPI() {
            try {
                const response = await safeApiCall('get', 'auth/me');
                if (response && response.success && response.data) {
                    currentUser = response.data;
                    console.log('User detected from API:', currentUser.uid);
                    
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER, JSON.stringify({
                        uid: currentUser.uid,
                        displayName: currentUser.displayName,
                        email: currentUser.email,
                        photoURL: currentUser.photoURL
                    }));
                    
                    userData = {
                        displayName: currentUser.displayName || 'User',
                        username: currentUser.username || null
                    };
                    
                    localStorage.setItem(LOCAL_STORAGE_KEYS.USER_PROFILE, JSON.stringify(userData));
                }
            } catch (error) {
                console.log('Could not load user from API:', error.message);
            }
        }
        
        // Load friends from API
        async function loadFriends() {
            if (!currentUser) return;
            
            try {
                const cachedFriends = localStorage.getItem(LOCAL_STORAGE_KEYS.FRIENDS);
                if (cachedFriends) {
                    friends = JSON.parse(cachedFriends);
                    console.log(`Loaded ${friends.length} friends from cache`);
                }
                
                const response = await safeApiCall('get', 'friends/list');
                if (response && response.success && response.data) {
                    friends = response.data;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.FRIENDS, JSON.stringify(friends));
                    console.log(`Loaded ${friends.length} friends from API`);
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }
        
        // Background sync with server - FIXED: Won't crash on missing API methods
        async function backgroundSyncWithServer() {
            if (!currentUser) {
                console.log('Background sync: Skipping - no user');
                return;
            }
            
            if (!apiReady) {
                console.log('Background sync: Skipping - API not ready');
                return;
            }
            
            console.log('Background sync: Starting server fetch...');
            
            try {
                const syncPromises = [
                    syncGroupsFromServer(),
                    syncGroupInvitesFromServer(),
                    loadFriends(),
                    syncUniqueFeaturesData()
                ];
                
                await Promise.allSettled(syncPromises);
                localStorage.setItem(LOCAL_STORAGE_KEYS.LAST_SYNC, Date.now().toString());
                console.log('Background sync: Completed successfully');
                
            } catch (error) {
                console.log('Background sync: Server appears to be unreachable:', error.message);
            }
        }
        
        // Sync unique features data
        async function syncUniqueFeaturesData() {
            if (!currentUser) return;
            
            try {
                const purposesResponse = await backgroundApiCall('get', 'groups/purposes');
                if (purposesResponse && purposesResponse.success && purposesResponse.data) {
                    localStorage.setItem(LOCAL_STORAGE_KEYS.GROUP_PURPOSES, JSON.stringify(purposesResponse.data));
                    
                    purposesResponse.data.forEach(purpose => {
                        const group = groups.find(g => g.id === purpose.groupId);
                        if (group) {
                            group.purpose = purpose.purpose;
                        }
                    });
                }
                
                const moodsResponse = await backgroundApiCall('get', 'groups/moods');
                if (moodsResponse && moodsResponse.success && moodsResponse.data) {
                    localStorage.setItem(LOCAL_STORAGE_KEYS.GROUP_MOODS, JSON.stringify(moodsResponse.data));
                    
                    moodsResponse.data.forEach(mood => {
                        const group = groups.find(g => g.id === mood.groupId);
                        if (group) {
                            group.mood = mood.mood;
                        }
                    });
                }
                
                const notesResponse = await backgroundApiCall('get', 'groups/notes');
                if (notesResponse && notesResponse.success && notesResponse.data) {
                    notesResponse.data.forEach(note => {
                        const key = LOCAL_STORAGE_KEYS.GROUP_NOTES + note.groupId;
                        localStorage.setItem(key, JSON.stringify(note.notes));
                    });
                }
                
            } catch (error) {
                console.log('Unique features sync error:', error.message);
            }
        }
        
        // Sync groups from server - FIXED: Won't crash on missing API methods
        async function syncGroupsFromServer() {
            if (!currentUser) return;
            
            try {
                const response = await backgroundApiCall('get', 'groups/user');
                
                if (!response || !response.success || !response.data) {
                    console.log('No groups found on server or API not available');
                    return;
                }
                
                const serverGroups = response.data;
                const serverMyGroups = [];
                const serverJoinedGroups = [];
                const serverAdminGroups = [];
                
                serverGroups.forEach(groupData => {
                    const groupWithMeta = {
                        ...groupData,
                        id: groupData.id || groupData._id,
                        type: groupData.privacy || 'private',
                        theme: groupData.theme || 'blue',
                        memberCount: groupData.members ? groupData.members.length : 0,
                        isAdmin: groupData.admins && groupData.admins.includes(currentUser.uid),
                        isCreator: groupData.createdBy === currentUser.uid,
                        lastActivity: groupData.lastActivity || groupData.createdAt,
                        purpose: groupData.purpose || '',
                        mood: groupData.mood || '',
                        postingRule: groupData.postingRule || 'everyone',
                        quietHours: groupData.quietHours || {},
                        scheduledPosting: groupData.scheduledPosting || {},
                        participationModes: groupData.participationModes || {}
                    };
                    
                    if (groupData.createdBy === currentUser.uid) {
                        serverMyGroups.push(groupWithMeta);
                    } else if (groupData.admins && groupData.admins.includes(currentUser.uid)) {
                        serverAdminGroups.push(groupWithMeta);
                    } else {
                        serverJoinedGroups.push(groupWithMeta);
                    }
                });
                
                if (JSON.stringify(serverGroups) !== JSON.stringify(groups)) {
                    console.log('Group data updated from server');
                    groups = serverGroups;
                    myGroups = serverMyGroups;
                    joinedGroups = serverJoinedGroups;
                    adminGroups = serverAdminGroups;
                    
                    localStorage.setItem(LOCAL_STORAGE_KEYS.GROUPS, JSON.stringify(groups));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.MY_GROUPS, JSON.stringify(myGroups));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.JOINED_GROUPS, JSON.stringify(joinedGroups));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.ADMIN_GROUPS, JSON.stringify(adminGroups));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.LAST_CACHE_TIME, Date.now().toString());
                    
                    const allGroupsSection = document.getElementById('allGroupsSection');
                    if (allGroupsSection && allGroupsSection.classList.contains('active')) {
                        updateCurrentSection();
                        updateGroupCounts();
                    }
                    
                    showNotification('Groups list updated', 'success');
                }
                
            } catch (error) {
                console.log('Group sync error:', error.message);
            }
        }
        
        // Sync group invites - FIXED: Won't crash on missing API methods
        async function syncGroupInvitesFromServer() {
            if (!currentUser) return;
            
            try {
                const response = await backgroundApiCall('get', 'groups/invites');
                
                const serverInvites = [];
                
                if (response && response.success && response.data) {
                    serverInvites.push(...response.data.map(invite => ({
                        ...invite,
                        id: invite.id || invite._id,
                        type: 'group_invite',
                        purpose: invite.purpose || '',
                        mood: invite.mood || '',
                        postingRule: invite.postingRule || 'everyone'
                    })));
                }
                
                if (JSON.stringify(serverInvites) !== JSON.stringify(groupInvites)) {
                    console.log('Group invites updated from server');
                    groupInvites = serverInvites;
                    localStorage.setItem(LOCAL_STORAGE_KEYS.GROUP_INVITES, JSON.stringify(groupInvites));
                    
                    const invitesCountEl = document.getElementById('invitesCount');
                    const invitesSectionCountEl = document.getElementById('invitesSectionCount');
                    if (invitesCountEl) invitesCountEl.textContent = groupInvites.length;
                    if (invitesSectionCountEl) invitesSectionCountEl.textContent = groupInvites.length;
                }
                
            } catch (error) {
                console.log('Group invites sync error:', error.message);
            }
        }
        
        // Update group counts
        function updateGroupCounts() {
            const totalGroupsEl = document.getElementById('totalGroups');
            const activeGroupsEl = document.getElementById('activeGroups');
            const totalMembersEl = document.getElementById('totalMembers');
            const myGroupsCountEl = document.getElementById('myGroupsCount');
            const joinedCountEl = document.getElementById('joinedCount');
            const invitesCountEl = document.getElementById('invitesCount');
            const adminCountEl = document.getElementById('adminCount');
            
            if (totalGroupsEl) totalGroupsEl.textContent = groups.length;
            
            const activeGroups = groups.filter(g => g.lastActivity && (Date.now() - new Date(g.lastActivity).getTime()) < 86400000).length;
            if (activeGroupsEl) activeGroupsEl.textContent = activeGroups;
            
            const totalMembers = groups.reduce((sum, group) => sum + (group.memberCount || 0), 0);
            if (totalMembersEl) totalMembersEl.textContent = totalMembers;
            
            if (myGroupsCountEl) myGroupsCountEl.textContent = myGroups.length;
            if (joinedCountEl) joinedCountEl.textContent = joinedGroups.length;
            if (invitesCountEl) invitesCountEl.textContent = groupInvites.length;
            if (adminCountEl) adminCountEl.textContent = adminGroups.length;
        }
        
        // Update current section
        function updateCurrentSection() {
            const activeSection = document.querySelector('.groups-section.active');
            if (activeSection) {
                const sectionId = activeSection.id;
                
                switch(sectionId) {
                    case 'allGroupsSection':
                        renderAllGroups();
                        break;
                    case 'myGroupsSection':
                        renderMyGroups();
                        break;
                    case 'joinedSection':
                        renderJoinedGroups();
                        break;
                    case 'invitesSection':
                        renderGroupInvites();
                        break;
                    case 'adminSection':
                        renderAdminGroups();
                        break;
                }
            }
        }
        
        // Render all groups
        function renderAllGroups() {
            const allGroupsList = document.getElementById('allGroupsList');
            if (!allGroupsList) return;
            
            allGroupsList.innerHTML = '';
            
            if (groups.length === 0) {
                allGroupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>No groups yet</p>
                        <p class="subtext">Create or join groups to start connecting</p>
                    </div>
                `;
                return;
            }
            
            groups.forEach(group => {
                if (matchesFilters(group)) {
                    addGroupItem(group, allGroupsList, 'group');
                }
            });
            
            if (allGroupsList.children.length === 0) {
                allGroupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No groups match your filters</p>
                        <p class="subtext">Try changing your search or filter criteria</p>
                    </div>
                `;
            }
        }
        
        // Add group item
        function addGroupItem(groupData, container, type) {
            const existingItem = container.querySelector(`[data-group-id="${groupData.id}"]`);
            if (existingItem) {
                existingItem.remove();
            }
            
            if (!matchesFilters(groupData)) {
                return;
            }
            
            const groupItem = document.createElement('div');
            groupItem.className = 'group-item';
            groupItem.dataset.groupId = groupData.id;
            groupItem.dataset.type = type;
            
            const initials = groupData.name 
                ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                : 'G';
            
            const groupType = groupData.type || 'private';
            const typeInfo = groupTypes[groupType];
            const theme = groupData.theme || 'blue';
            const themeInfo = groupThemes[theme];
            
            const purpose = groupData.purpose || '';
            const mood = groupData.mood || '';
            const postingRule = groupData.postingRule || 'everyone';
            const purposeInfo = purpose ? groupPurposes[purpose] : null;
            const moodInfo = mood ? groupMoods[mood] : null;
            const ruleInfo = postingRules[postingRule];
            const pulse = calculateGroupPulse(groupData);
            
            groupItem.innerHTML = `
                <div class="group-avatar" ${groupData.photoURL ? `style="background-image: url('${groupData.photoURL}'); background: ${themeInfo.gradient};"` : `style="background: ${themeInfo.gradient};"`}>
                    ${groupData.photoURL ? '' : `<span>${initials}</span>`}
                    <div class="group-theme-badge ${theme}"></div>
                    <div class="group-type-badge ${groupType}" title="${typeInfo ? typeInfo.name : 'Private'}">
                        <i class="${typeInfo ? typeInfo.icon : 'fas fa-lock'}"></i>
                    </div>
                    ${purposeInfo ? `<div class="group-purpose-badge" style="position: absolute; bottom: -5px; right: -5px; background: ${purposeInfo.color}; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px;">${purposeInfo.icon}</div>` : ''}
                </div>
                <div class="group-info">
                    <div class="group-name">
                        <span class="group-name-text">${groupData.name || 'Unnamed Group'}</span>
                        ${pulse ? `<span class="group-pulse ${pulse.class}"><i class="fas fa-heartbeat"></i> ${pulse.text}</span>` : ''}
                        <span class="group-details">
                            ${groupData.isAdmin ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : ''}
                            ${groupData.isCreator ? '<span class="role-badge admin"><i class="fas fa-star"></i> Creator</span>' : ''}
                        </span>
                    </div>
                    <div class="group-details">
                        ${purposeInfo ? `<span class="group-purpose-tag">${purposeInfo.icon} ${purposeInfo.name}</span>` : ''}
                        ${moodInfo ? `<span class="group-mood-indicator mood-${mood}" style="background: ${moodInfo.bgColor}; color: ${moodInfo.color}; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${moodInfo.icon} ${moodInfo.name}</span>` : ''}
                        ${groupData.topic ? `<span class="group-topic">${groupData.topic}</span>` : ''}
                        <span class="member-count"><i class="fas fa-users"></i> ${groupData.memberCount || 0}</span>
                        <span>${typeInfo ? typeInfo.name : 'Private'}</span>
                        ${groupData.theme ? `<span class="theme-badge ${groupData.theme}"><i class="fas fa-palette"></i> ${groupThemes[groupData.theme].name}</span>` : ''}
                    </div>
                    ${ruleInfo ? `<div style="font-size: 11px; color: ${ruleInfo.color}; margin-top: 3px;"><i class="fas fa-comment"></i> ${ruleInfo.name}</div>` : ''}
                    ${groupData.description ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">${groupData.description.substring(0, 100)}${groupData.description.length > 100 ? '...' : ''}</div>` : ''}
                </div>
                <div class="group-actions">
                    ${type === 'group_invite' ? `
                        <button class="group-action-btn success" data-action="accept-invite" title="Accept Invite">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="group-action-btn danger" data-action="decline-invite" title="Decline Invite">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : `
                        <button class="group-action-btn chat" data-action="open-chat" title="Open Chat">
                            <i class="fas fa-comments"></i>
                        </button>
                        <button class="group-action-btn" data-action="info" title="Group Info">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        ${type === 'my_group' || type === 'admin' ? `
                            <button class="group-action-btn" data-action="manage" title="Manage Group">
                                <i class="fas fa-cog"></i>
                            </button>
                        ` : ''}
                        ${type === 'joined' ? `
                            <button class="group-action-btn danger" data-action="leave" title="Leave Group">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        ` : ''}
                    `}
                </div>
            `;
            
            groupItem.addEventListener('click', (e) => {
                if (!e.target.closest('.group-actions')) {
                    showGroupDetails(groupData, type);
                }
            });
            
            const actionButtons = groupItem.querySelectorAll('.group-action-btn');
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.dataset.action;
                    handleGroupAction(action, groupData, type, btn);
                });
            });
            
            container.appendChild(groupItem);
        }
        
        // Handle group actions
        function handleGroupAction(action, groupData, type, button) {
            switch(action) {
                case 'open-chat':
                    openGroupChat(groupData);
                    break;
                case 'info':
                    showGroupDetails(groupData, type);
                    break;
                case 'manage':
                    openAdminManagement(groupData);
                    break;
                case 'leave':
                    leaveGroupConfirm(groupData);
                    break;
                case 'accept-invite':
                    acceptGroupInvite(groupData);
                    break;
                case 'decline-invite':
                    declineGroupInvite(groupData);
                    break;
                default:
                    console.log('Unknown group action:', action);
            }
        }
        
        // Open group chat
        function openGroupChat(groupData) {
            console.log('Opening inline group chat for:', groupData.name);
            
            currentChatGroup = groupData;
            
            const chatTitle = document.getElementById('chatTitle');
            const chatMemberCount = document.getElementById('chatMemberCount');
            const chatActive = document.getElementById('chatActive');
            const chatAvatar = document.getElementById('chatAvatar');
            
            if (chatTitle) chatTitle.textContent = groupData.name || 'Group Chat';
            if (chatMemberCount) chatMemberCount.textContent = `${groupData.memberCount || 0} members`;
            if (chatActive) chatActive.textContent = 'Active now';
            
            const theme = groupData.theme || 'blue';
            const themeInfo = groupThemes[theme];
            const initials = groupData.name 
                ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                : 'G';
            
            if (chatAvatar) {
                if (groupData.photoURL) {
                    chatAvatar.style.backgroundImage = `url('${groupData.photoURL}')`;
                    chatAvatar.innerHTML = '';
                } else {
                    chatAvatar.style.background = themeInfo.gradient;
                    chatAvatar.innerHTML = `<span style="color: white; font-size: 16px;">${initials}</span>`;
                }
            }
            
            updateChatHeaderUniqueFeatures(groupData);
            
            const sidebar = document.getElementById('sidebar');
            const groupChatPanel = document.getElementById('groupChatPanel');
            
            if (isMobile) {
                if (sidebar) sidebar.style.display = 'none';
                if (groupChatPanel) {
                    groupChatPanel.style.display = 'flex';
                    groupChatPanel.classList.add('active');
                }
                
                const chatHeaderInfo = document.getElementById('chatHeaderInfo');
                if (chatHeaderInfo && !chatHeaderInfo.querySelector('.mobile-back-btn')) {
                    const backBtn = document.createElement('button');
                    backBtn.className = 'mobile-back-btn';
                    backBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
                    backBtn.style.cssText = 'background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 18px; margin-right: 10px;';
                    backBtn.addEventListener('click', closeGroupChatMobile);
                    chatHeaderInfo.insertBefore(backBtn, chatHeaderInfo.firstChild);
                }
            } else {
                hideAllPanels();
                if (groupChatPanel) groupChatPanel.classList.add('active');
            }
            
            const chatMessages = document.getElementById('chatMessages');
            const chatMessagesContainer = document.getElementById('chatMessagesContainer');
            
            if (chatMessages) chatMessages.innerHTML = '';
            if (chatMessagesContainer) chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            
            loadGroupChatMessages(groupData.id);
            setupTypingListener(groupData.id);
            
            loadUniqueFeaturesPanels(groupData.id);
            checkPostingRules(groupData);
            
            showNotification(`Opened chat: ${groupData.name}`, 'success');
        }
        
        // Update chat header with unique features
        function updateChatHeaderUniqueFeatures(groupData) {
            const purpose = groupData.purpose || '';
            const chatPurposeTag = document.getElementById('chatPurposeTag');
            if (purpose && groupPurposes[purpose] && chatPurposeTag) {
                const purposeInfo = groupPurposes[purpose];
                chatPurposeTag.textContent = `${purposeInfo.icon} ${purposeInfo.name}`;
                chatPurposeTag.style.backgroundColor = purposeInfo.color + '20';
                chatPurposeTag.style.color = purposeInfo.color;
                chatPurposeTag.style.display = 'inline-block';
            } else if (chatPurposeTag) {
                chatPurposeTag.style.display = 'none';
            }
            
            const pulse = calculateGroupPulse(groupData);
            const chatPulse = document.getElementById('chatPulse');
            if (pulse && chatPulse) {
                chatPulse.textContent = pulse.text;
                chatPulse.className = `group-pulse ${pulse.class}`;
                chatPulse.style.display = 'inline-block';
            } else if (chatPulse) {
                chatPulse.style.display = 'none';
            }
            
            const mood = groupData.mood || '';
            const postingRule = groupData.postingRule || 'everyone';
            const chatMood = document.getElementById('chatMood');
            const chatPostingRules = document.getElementById('chatPostingRules');
            const chatMoodRules = document.getElementById('chatMoodRules');
            
            if (mood && groupMoods[mood] && chatMood) {
                const moodInfo = groupMoods[mood];
                chatMood.innerHTML = `${moodInfo.icon} ${moodInfo.name}`;
                chatMood.className = `group-mood-indicator mood-${mood}`;
                chatMood.style.backgroundColor = moodInfo.bgColor;
                chatMood.style.color = moodInfo.color;
                chatMood.style.display = 'flex';
            } else if (chatMood) {
                chatMood.style.display = 'none';
            }
            
            if (postingRule && postingRules[postingRule] && chatPostingRules) {
                const ruleInfo = postingRules[postingRule];
                chatPostingRules.innerHTML = `<i class="fas fa-comment"></i> ${ruleInfo.name}`;
                chatPostingRules.className = `posting-rules-banner rule-${postingRule.replace('_', '-')}`;
                chatPostingRules.style.backgroundColor = ruleInfo.bgColor;
                chatPostingRules.style.color = ruleInfo.color;
                chatPostingRules.style.display = 'inline-flex';
            } else if (chatPostingRules) {
                chatPostingRules.style.display = 'none';
            }
            
            if (chatMoodRules) {
                if ((chatMood && chatMood.style.display !== 'none') || (chatPostingRules && chatPostingRules.style.display !== 'none')) {
                    chatMoodRules.style.display = 'block';
                } else {
                    chatMoodRules.style.display = 'none';
                }
            }
        }
        
        // Check posting rules
        function checkPostingRules(groupData) {
            const postingRule = groupData.postingRule || 'everyone';
            const quietHours = groupData.quietHours || {};
            const scheduledPosting = groupData.scheduledPosting || {};
            
            let canPost = true;
            let reason = '';
            
            if (postingRule === 'admin_only' && !groupData.isAdmin && !groupData.isCreator) {
                canPost = false;
                reason = 'Only admins can post in this group';
            }
            
            if (postingRule === 'quiet_hours' && quietHours.start && quietHours.end) {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTime = currentHour * 60 + currentMinute;
                
                const [startHour, startMinute] = quietHours.start.split(':').map(Number);
                const [endHour, endMinute] = quietHours.end.split(':').map(Number);
                const startTime = startHour * 60 + startMinute;
                const endTime = endHour * 60 + endMinute;
                
                if (currentTime >= startTime && currentTime <= endTime) {
                    canPost = false;
                    reason = `Quiet hours: ${quietHours.start} - ${quietHours.end}`;
                }
            }
            
            if (postingRule === 'scheduled' && scheduledPosting.start && scheduledPosting.end) {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTime = currentHour * 60 + currentMinute;
                
                const [startHour, startMinute] = scheduledPosting.start.split(':').map(Number);
                const [endHour, endMinute] = scheduledPosting.end.split(':').map(Number);
                const startTime = startHour * 60 + startMinute;
                const endTime = endHour * 60 + endMinute;
                
                if (currentTime < startTime || currentTime > endTime) {
                    canPost = false;
                    reason = `Posting allowed: ${scheduledPosting.start} - ${scheduledPosting.end}`;
                }
            }
            
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const topicSelection = document.getElementById('topicSelection');
            const silentModeBtn = document.getElementById('silentModeBtn');
            const anonymousModeBtn = document.getElementById('anonymousModeBtn');
            
            if (chatInput && chatSendBtn) {
                if (!canPost) {
                    chatInput.placeholder = reason;
                    chatInput.disabled = true;
                    chatSendBtn.disabled = true;
                    showNotification(reason, 'info');
                } else {
                    chatInput.placeholder = 'Type a message...';
                    chatInput.disabled = false;
                    chatSendBtn.disabled = false;
                }
            }
            
            const showTopics = groupData.features && groupData.features.topics === true;
            if (topicSelection) {
                topicSelection.style.display = showTopics ? 'block' : 'none';
            }
            
            const participationModes = groupData.participationModes || {};
            if (silentModeBtn) {
                silentModeBtn.style.display = participationModes.readOnly ? 'block' : 'none';
            }
            if (anonymousModeBtn) {
                anonymousModeBtn.style.display = participationModes.anonymous ? 'block' : 'none';
            }
            
            updateParticipationModeButtons();
        }
        
        // Update participation mode buttons
        function updateParticipationModeButtons() {
            const silentModeBtn = document.getElementById('silentModeBtn');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const anonymousModeBtn = document.getElementById('anonymousModeBtn');
            
            if (silentModeBtn) {
                if (currentParticipationMode === 'read_only') {
                    silentModeBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    silentModeBtn.title = 'Exit Silent Mode';
                    if (chatInput) chatInput.placeholder = 'Silent mode: Read only';
                    if (chatInput) chatInput.disabled = true;
                    if (chatSendBtn) chatSendBtn.disabled = true;
                } else {
                    silentModeBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    silentModeBtn.title = 'Enter Silent Mode';
                }
            }
            
            if (anonymousModeBtn) {
                if (isAnonymousMode) {
                    anonymousModeBtn.innerHTML = '<i class="fas fa-user-secret"></i>';
                    anonymousModeBtn.title = 'Exit Anonymous Mode';
                    if (chatInput) chatInput.placeholder = 'Anonymous mode enabled';
                } else {
                    anonymousModeBtn.innerHTML = '<i class="fas fa-user"></i>';
                    anonymousModeBtn.title = 'Enter Anonymous Mode';
                }
            }
        }
        
        // Load unique features panels
        function loadUniqueFeaturesPanels(groupId) {
            loadGroupNotes(groupId);
            loadGroupEvents(groupId);
            loadTransparencyLog(groupId);
            analyzeGroupEnergy(groupId);
        }
        
        // Load group notes
        async function loadGroupNotes(groupId) {
            try {
                const cacheKey = LOCAL_STORAGE_KEYS.GROUP_NOTES + groupId;
                const cachedNotes = localStorage.getItem(cacheKey);
                
                const groupNotesContent = document.getElementById('groupNotesContent');
                if (groupNotesContent) {
                    if (cachedNotes) {
                        groupNotesContent.innerHTML = cachedNotes;
                    } else {
                        groupNotesContent.innerHTML = '<p style="margin: 0; color: var(--text-secondary);">No notes yet. Add important information here.</p>';
                    }
                }
                
                const response = await backgroundApiCall('get', `groups/${groupId}/notes`);
                if (response && response.success && response.data && groupNotesContent) {
                    const notes = response.data.notes || '';
                    groupNotesContent.innerHTML = notes || '<p style="margin: 0; color: var(--text-secondary);">No notes yet. Add important information here.</p>';
                    localStorage.setItem(cacheKey, notes);
                }
                
                const groupNotesPanel = document.getElementById('groupNotesPanel');
                if (groupNotesPanel && currentChatGroup && (currentChatGroup.isAdmin || currentChatGroup.isCreator || cachedNotes)) {
                    groupNotesPanel.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading group notes:', error);
                const groupNotesPanel = document.getElementById('groupNotesPanel');
                if (groupNotesPanel) groupNotesPanel.style.display = 'none';
            }
        }
        
        // Load group events
        async function loadGroupEvents(groupId) {
            try {
                const cacheKey = LOCAL_STORAGE_KEYS.GROUP_EVENTS + groupId;
                const cachedEvents = localStorage.getItem(cacheKey);
                
                let events = [];
                if (cachedEvents) {
                    events = JSON.parse(cachedEvents);
                }
                
                const response = await backgroundApiCall('get', `groups/${groupId}/events`);
                if (response && response.success && response.data) {
                    events = response.data;
                    localStorage.setItem(cacheKey, JSON.stringify(events));
                }
                
                const now = new Date();
                const upcomingEvents = events
                    .filter(event => new Date(event.date) > now)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const eventCountdownDisplay = document.getElementById('eventCountdownDisplay');
                const eventCountdownPanel = document.getElementById('eventCountdownPanel');
                
                if (eventCountdownDisplay && eventCountdownPanel) {
                    if (upcomingEvents.length > 0) {
                        const nextEvent = upcomingEvents[0];
                        const eventDate = new Date(nextEvent.date);
                        const timeDiff = eventDate.getTime() - now.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        
                        if (daysDiff <= 7) {
                            eventCountdownDisplay.innerHTML = `
                                <div style="font-size: 14px; font-weight: 600;">${nextEvent.title}</div>
                                <div style="font-size: 12px; opacity: 0.9;">${formatDate(eventDate)} ‚Ä¢ ${daysDiff} day${daysDiff !== 1 ? 's' : ''} to go</div>
                            `;
                            eventCountdownPanel.style.display = 'block';
                        } else {
                            eventCountdownPanel.style.display = 'none';
                        }
                    } else {
                        eventCountdownDisplay.innerHTML = 'No upcoming events';
                        eventCountdownPanel.style.display = currentChatGroup && (currentChatGroup.isAdmin || currentChatGroup.isCreator) ? 'block' : 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error loading group events:', error);
                const eventCountdownPanel = document.getElementById('eventCountdownPanel');
                if (eventCountdownPanel) eventCountdownPanel.style.display = 'none';
            }
        }
        
        // Load transparency log
        async function loadTransparencyLog(groupId) {
            try {
                const cacheKey = LOCAL_STORAGE_KEYS.GROUP_TRANSPARENCY + groupId;
                const cachedLog = localStorage.getItem(cacheKey);
                
                let log = [];
                if (cachedLog) {
                    log = JSON.parse(cachedLog);
                }
                
                const response = await backgroundApiCall('get', `groups/${groupId}/transparency`);
                if (response && response.success && response.data) {
                    log = response.data;
                    localStorage.setItem(cacheKey, JSON.stringify(log));
                }
                
                const adminTransparencyLog = document.getElementById('adminTransparencyLog');
                const adminTransparencyPanel = document.getElementById('adminTransparencyPanel');
                
                if (adminTransparencyLog && adminTransparencyPanel) {
                    if (log.length > 0 && currentChatGroup && currentChatGroup.isAdmin) {
                        let logHTML = '';
                        log.slice(0, 5).forEach(item => {
                            logHTML += `
                                <div class="transparency-log-item" style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                                    <div><strong>${item.action}</strong></div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        By ${item.by || 'Unknown'} ‚Ä¢ ${formatTimeAgo(item.timestamp)}
                                    </div>
                                </div>
                            `;
                        });
                        
                        adminTransparencyLog.innerHTML = logHTML || 'No recent changes';
                        adminTransparencyPanel.style.display = 'block';
                    } else {
                        adminTransparencyPanel.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error loading transparency log:', error);
                const adminTransparencyPanel = document.getElementById('adminTransparencyPanel');
                if (adminTransparencyPanel) adminTransparencyPanel.style.display = 'none';
            }
        }
        
        // Analyze group energy
        async function analyzeGroupEnergy(groupId) {
            try {
                const response = await backgroundApiCall('get', `groups/${groupId}/messages?limit=50`);
                if (!response || !response.success || !response.data) return;
                
                const messages = response.data;
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                
                const recentMessages = messages.filter(m => new Date(m.timestamp) > oneHourAgo);
                const dailyMessages = messages.filter(m => new Date(m.timestamp) > oneDayAgo);
                
                const messagesPerHour = recentMessages.length;
                const messagesPerDay = dailyMessages.length;
                
                let suggestion = '';
                
                if (messagesPerHour > 50) {
                    suggestion = 'Group is very active! Consider switching to silent mode to reduce notifications.';
                } else if (messagesPerHour > 20) {
                    suggestion = 'Group is active. All good!';
                } else if (messagesPerHour > 5) {
                    suggestion = 'Group is moderately active.';
                } else if (messagesPerDay < 5) {
                    suggestion = 'Group is quiet. Consider sending a check-in message.';
                } else {
                    suggestion = 'Group activity is normal.';
                }
                
                const energySuggestionContent = document.getElementById('energySuggestionContent');
                const energySuggestionPanel = document.getElementById('energySuggestionPanel');
                
                if (energySuggestionContent && energySuggestionPanel) {
                    energySuggestionContent.innerHTML = `<i class="fas fa-lightbulb"></i> ${suggestion}`;
                    energySuggestionPanel.style.display = 'block';
                }
                
                energySuggestions.push({
                    groupId,
                    timestamp: now,
                    messagesPerHour,
                    messagesPerDay,
                    suggestion
                });
                
            } catch (error) {
                console.error('Error analyzing group energy:', error);
                const energySuggestionPanel = document.getElementById('energySuggestionPanel');
                if (energySuggestionPanel) energySuggestionPanel.style.display = 'none';
            }
        }
        
        // Close group chat mobile
        function closeGroupChatMobile() {
            const sidebar = document.getElementById('sidebar');
            const groupChatPanel = document.getElementById('groupChatPanel');
            
            if (isMobile) {
                if (sidebar) sidebar.style.display = 'flex';
                if (groupChatPanel) {
                    groupChatPanel.style.display = 'none';
                    groupChatPanel.classList.remove('active');
                }
                
                const mobileBackBtn = document.querySelector('.mobile-back-btn');
                if (mobileBackBtn) {
                    mobileBackBtn.remove();
                }
            }
        }
        
        // Hide all panels
        function hideAllPanels() {
            const groupDetailsPanel = document.getElementById('groupDetailsPanel');
            const groupChatPanel = document.getElementById('groupChatPanel');
            const groupCallPanel = document.getElementById('groupCallPanel');
            const sidebar = document.getElementById('sidebar');
            
            if (groupDetailsPanel) groupDetailsPanel.classList.remove('active');
            if (groupChatPanel) groupChatPanel.classList.remove('active');
            if (groupCallPanel) groupCallPanel.classList.remove('active');
            
            if (isMobile) {
                if (sidebar) sidebar.style.display = 'flex';
                if (groupChatPanel) groupChatPanel.style.display = 'none';
                if (groupCallPanel) groupCallPanel.style.display = 'none';
            }
        }
        
        // Load group chat messages
        async function loadGroupChatMessages(groupId) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const cachedMessagesKey = LOCAL_STORAGE_KEYS.GROUP_MESSAGES + groupId;
            const cachedMessages = localStorage.getItem(cachedMessagesKey);
            
            if (cachedMessages) {
                try {
                    const messages = JSON.parse(cachedMessages);
                    messages.forEach(message => {
                        addMessageToChat(message, false);
                    });
                } catch (error) {
                    console.error('Error loading cached messages:', error);
                }
            }
            
            if (chatMessages.children.length === 0) {
                addSystemMessage(`Welcome to the group chat! Start the conversation.`);
            }
            
            const chatMessagesContainer = document.getElementById('chatMessagesContainer');
            setTimeout(() => {
                if (chatMessagesContainer) {
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
            }, 100);
            
            try {
                const response = await backgroundApiCall('get', `groups/${groupId}/messages`);
                if (response && response.success && response.data) {
                    response.data.forEach(message => {
                        addMessageToChat(message, true);
                        saveMessageToCache(groupId, message);
                    });
                }
            } catch (error) {
                console.error('Error loading messages from API:', error);
            }
        }
        
        // Add message to chat
        function addMessageToChat(messageData, isNew = true) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            const isSystem = messageData.type === 'system';
            const isSent = messageData.senderId === currentUser.uid;
            const isAnonymous = messageData.anonymous === true;
            const topic = messageData.topic || '';
            const topicInfo = topic ? groupTopics[topic] : null;
            
            if (isSystem) {
                messageElement.className = 'message system';
                messageElement.innerHTML = `
                    <div class="message-content">${messageData.content}</div>
                    <div class="message-time">${formatMessageTime(messageData.timestamp || new Date())}</div>
                `;
            } else {
                messageElement.className = isSent ? 'message sent' : 'message received';
                const senderName = isAnonymous ? 'Anonymous' : (isSent ? 'You' : (messageData.senderName || 'Unknown'));
                
                messageElement.innerHTML = `
                    ${!isSent ? `<div class="message-sender">${senderName} ${isAnonymous ? '<i class="fas fa-user-secret" style="margin-left: 5px; color: var(--text-secondary); font-size: 10px;"></i>' : ''}</div>` : ''}
                    ${topicInfo ? `<div class="topic-label topic-${topic}" style="margin-bottom: 3px;">${topicInfo.icon} ${topicInfo.name}</div>` : ''}
                    <div class="message-content">${messageData.content}</div>
                    <div class="message-time">${formatMessageTime(messageData.timestamp || new Date())}</div>
                    <div class="message-actions">
                        <button class="message-action-btn" title="React">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="message-action-btn" title="Reply">
                            <i class="fas fa-reply"></i>
                        </button>
                        ${isSent ? `<button class="message-action-btn" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageElement);
            
            const chatMessagesContainer = document.getElementById('chatMessagesContainer');
            if (isNew && chatMessagesContainer) {
                setTimeout(() => {
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }, 100);
            }
        }
        
        // Add system message
        function addSystemMessage(content) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${formatMessageTime(new Date())}</div>
            `;
            chatMessages.appendChild(messageElement);
        }
        
        // Save message to cache
        function saveMessageToCache(groupId, message) {
            try {
                const cacheKey = LOCAL_STORAGE_KEYS.GROUP_MESSAGES + groupId;
                const cachedMessages = JSON.parse(localStorage.getItem(cacheKey) || '[]');
                
                if (!cachedMessages.some(m => m.id === message.id)) {
                    cachedMessages.push(message);
                    
                    if (cachedMessages.length > 100) {
                        cachedMessages.splice(0, cachedMessages.length - 100);
                    }
                    
                    localStorage.setItem(cacheKey, JSON.stringify(cachedMessages));
                }
            } catch (error) {
                console.error('Error saving message to cache:', error);
            }
        }
        
        // Send group message
        async function sendGroupMessage() {
            const chatInput = document.getElementById('chatInput');
            const messageTopic = document.getElementById('messageTopic');
            
            if (!currentChatGroup || !chatInput || !chatInput.value.trim()) return;
            
            const messageContent = chatInput.value.trim();
            const selectedTopic = messageTopic ? messageTopic.value : '';
            
            chatInput.value = '';
            adjustTextareaHeight();
            
            const message = {
                groupId: currentChatGroup.id,
                senderId: currentUser.uid,
                senderName: userData.displayName || 'User',
                content: messageContent,
                timestamp: new Date(),
                type: 'text',
                readBy: [currentUser.uid],
                topic: selectedTopic || undefined,
                anonymous: isAnonymousMode
            };
            
            const tempMessage = {
                ...message,
                id: 'temp_' + Date.now()
            };
            
            addMessageToChat(tempMessage, true);
            
            try {
                const response = await safeApiCall('post', `groups/${currentChatGroup.id}/messages`, {
                    content: messageContent,
                    topic: selectedTopic || undefined,
                    anonymous: isAnonymousMode
                });
                
                if (response && response.success) {
                    saveMessageToCache(currentChatGroup.id, {
                        ...tempMessage,
                        id: response.data?.id || tempMessage.id
                    });
                    
                    if (isAnonymousMode) {
                        toggleAnonymousMode();
                    }
                } else {
                    showNotification('Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
            
            stopTypingIndicator();
        }
        
        // Toggle silent mode
        function toggleSilentMode() {
            if (currentParticipationMode === 'read_only') {
                currentParticipationMode = 'normal';
                const chatInput = document.getElementById('chatInput');
                const chatSendBtn = document.getElementById('chatSendBtn');
                if (chatInput) chatInput.disabled = false;
                if (chatSendBtn) chatSendBtn.disabled = false;
                if (chatInput) chatInput.placeholder = 'Type a message...';
                showNotification('Exited silent mode', 'success');
            } else {
                currentParticipationMode = 'read_only';
                const chatInput = document.getElementById('chatInput');
                const chatSendBtn = document.getElementById('chatSendBtn');
                if (chatInput) chatInput.disabled = true;
                if (chatSendBtn) chatSendBtn.disabled = true;
                if (chatInput) chatInput.placeholder = 'Silent mode: Read only';
                showNotification('Entered silent mode (read only)', 'info');
            }
            
            localStorage.setItem(LOCAL_STORAGE_KEYS.USER_PARTICIPATION_MODES, JSON.stringify(currentParticipationMode));
            updateParticipationModeButtons();
        }
        
        // Toggle anonymous mode
        function toggleAnonymousMode() {
            isAnonymousMode = !isAnonymousMode;
            
            if (isAnonymousMode) {
                showNotification('Anonymous mode enabled', 'info');
            } else {
                showNotification('Anonymous mode disabled', 'success');
            }
            
            updateParticipationModeButtons();
        }
        
        // Setup typing listener
        let typingTimeout;
        function setupTypingListener(groupId) {
            const chatInput = document.getElementById('chatInput');
            if (!chatInput) return;
            
            chatInput.addEventListener('input', () => {
                if (!isTyping) {
                    isTyping = true;
                    backgroundApiCall('post', `groups/${groupId}/typing`, { typing: true })
                        .catch(() => {});
                }
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    isTyping = false;
                    backgroundApiCall('post', `groups/${groupId}/typing`, { typing: false })
                        .catch(() => {});
                }, 1000);
            });
        }
        
        // Stop typing indicator
        function stopTypingIndicator() {
            isTyping = false;
            if (typingTimeout) clearTimeout(typingTimeout);
        }
        
        // Adjust textarea height
        function adjustTextareaHeight() {
            const chatInput = document.getElementById('chatInput');
            if (!chatInput) return;
            
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + 'px';
        }
        
        // Format message time
        function formatMessageTime(date) {
            const dateObj = date instanceof Date ? date : new Date(date);
            return dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Open admin management
        function openAdminManagement(groupData) {
            if (!groupData.isAdmin && !groupData.isCreator) {
                showNotification('You need admin permissions to manage this group', 'error');
                return;
            }
            
            const adminManagementGroupName = document.getElementById('adminManagementGroupName');
            if (adminManagementGroupName) {
                adminManagementGroupName.textContent = groupData.name;
            }
            
            const adminManagementModal = document.getElementById('adminManagementModal');
            if (adminManagementModal) {
                adminManagementModal.classList.add('active');
            }
            
            loadGroupMembersForManagement(groupData);
            loadGroupSettingsForManagement(groupData);
            loadUniqueFeaturesForManagement(groupData);
        }
        
        // Load group members for management
        async function loadGroupMembersForManagement(groupData) {
            const memberList = document.getElementById('memberManagementList');
            if (!memberList) return;
            
            memberList.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i><p>Loading members...</p></div>';
            
            try {
                const response = await backgroundApiCall('get', `groups/${groupData.id}/members`);
                
                if (!response || !response.success || !response.data) {
                    memberList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No members in this group</p>
                        </div>
                    `;
                    return;
                }
                
                const memberDetails = response.data;
                memberList.innerHTML = '';
                
                memberDetails.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-management-item';
                    
                    const initials = member.displayName 
                        ? member.displayName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                        : 'U';
                    
                    memberItem.innerHTML = `
                        <div class="member-management-info">
                            <div class="friend-avatar" ${member.photoURL ? `style="background-image: url('${member.photoURL}')"` : ''}>
                                ${member.photoURL ? '' : `<span>${initials}</span>`}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${member.displayName}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${member.username || ''}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                    ${member.isCreator ? '<span class="role-badge admin"><i class="fas fa-star"></i> Creator</span>' : ''}
                                    ${member.isAdmin && !member.isCreator ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : ''}
                                    ${!member.isAdmin && !member.isCreator ? '<span class="role-badge member"><i class="fas fa-user"></i> Member</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="member-management-actions">
                            ${!member.isCreator ? `
                                ${member.isAdmin ? `
                                    <button class="member-action-btn demote" data-member-id="${member.id}" title="Demote to Member">
                                        <i class="fas fa-arrow-down"></i> Demote
                                    </button>
                                ` : `
                                    <button class="member-action-btn promote" data-member-id="${member.id}" title="Promote to Admin">
                                        <i class="fas fa-arrow-up"></i> Promote
                                    </button>
                                `}
                                ${member.id !== currentUser.uid ? `
                                    <button class="member-action-btn remove" data-member-id="${member.id}" title="Remove from Group">
                                        <i class="fas fa-user-times"></i> Remove
                                    </button>
                                ` : ''}
                            ` : ''}
                        </div>
                    `;
                    
                    memberList.appendChild(memberItem);
                });
                
                memberList.querySelectorAll('.member-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const memberId = btn.dataset.memberId;
                        const action = btn.classList.contains('promote') ? 'promote' : 
                                      btn.classList.contains('demote') ? 'demote' : 'remove';
                        
                        handleMemberAction(action, memberId, groupData);
                    });
                });
                
            } catch (error) {
                console.error('Error loading members:', error);
                memberList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading members</p>
                        <p class="subtext">Please try again later</p>
                    </div>
                `;
            }
        }
        
        // Handle member action
        async function handleMemberAction(action, memberId, groupData) {
            try {
                switch(action) {
                    case 'promote':
                        await safeApiCall('post', `groups/${groupData.id}/members/${memberId}/promote`);
                        showNotification('Member promoted to admin', 'success');
                        logTransparencyAction(groupData.id, 'Promoted member to admin', memberId);
                        break;
                    case 'demote':
                        await safeApiCall('post', `groups/${groupData.id}/members/${memberId}/demote`);
                        showNotification('Admin demoted to member', 'success');
                        logTransparencyAction(groupData.id, 'Demoted admin to member', memberId);
                        break;
                    case 'remove':
                        if (confirm('Are you sure you want to remove this member from the group?')) {
                            await safeApiCall('delete', `groups/${groupData.id}/members/${memberId}`);
                            showNotification('Member removed from group', 'success');
                            logTransparencyAction(groupData.id, 'Removed member from group', memberId);
                        }
                        break;
                }
                
                loadGroupMembersForManagement(groupData);
                
            } catch (error) {
                console.error('Error performing member action:', error);
                showNotification('Failed to perform action', 'error');
            }
        }
        
        // Log transparency action
        async function logTransparencyAction(groupId, action, targetId = null) {
            try {
                const logEntry = {
                    groupId,
                    action,
                    targetId,
                    by: currentUser.uid,
                    byName: userData.displayName || 'Unknown',
                    timestamp: new Date()
                };
                
                const cacheKey = LOCAL_STORAGE_KEYS.GROUP_TRANSPARENCY + groupId;
                const cachedLog = JSON.parse(localStorage.getItem(cacheKey) || '[]');
                cachedLog.unshift(logEntry);
                if (cachedLog.length > 50) cachedLog.pop();
                localStorage.setItem(cacheKey, JSON.stringify(cachedLog));
                
                await backgroundApiCall('post', `groups/${groupId}/transparency`, logEntry);
                
            } catch (error) {
                console.error('Error logging transparency action:', error);
            }
        }
        
        // Load group settings for management
        function loadGroupSettingsForManagement(groupData) {
            const adminPublicGroup = document.getElementById('adminPublicGroup');
            const adminApproveMembers = document.getElementById('adminApproveMembers');
            const adminAllowInvites = document.getElementById('adminAllowInvites');
            const adminOnlyAdminsPost = document.getElementById('adminOnlyAdminsPost');
            const adminAllowMedia = document.getElementById('adminAllowMedia');
            const adminDisappearingMessages = document.getElementById('adminDisappearingMessages');
            const adminMentionNotifications = document.getElementById('adminMentionNotifications');
            const adminAnnouncementNotifications = document.getElementById('adminAnnouncementNotifications');
            
            if (adminPublicGroup) adminPublicGroup.checked = groupData.type === 'public';
            if (adminApproveMembers) adminApproveMembers.checked = groupData.moderationSettings?.approveNewMembers || false;
            if (adminAllowInvites) adminAllowInvites.checked = groupData.moderationSettings?.allowInvites || true;
            if (adminOnlyAdminsPost) adminOnlyAdminsPost.checked = groupData.moderationSettings?.onlyAdminsCanPost || false;
            if (adminAllowMedia) adminAllowMedia.checked = groupData.moderationSettings?.allowMediaSharing || true;
            if (adminDisappearingMessages) adminDisappearingMessages.checked = groupData.moderationSettings?.disappearingMessages || false;
            if (adminMentionNotifications) adminMentionNotifications.checked = groupData.notificationSettings?.mentionNotifications || true;
            if (adminAnnouncementNotifications) adminAnnouncementNotifications.checked = groupData.notificationSettings?.announcementNotifications || true;
        }
        
        // Load unique features for management
        function loadUniqueFeaturesForManagement(groupData) {
            const adminGroupPurpose = document.getElementById('adminGroupPurpose');
            if (adminGroupPurpose) adminGroupPurpose.value = groupData.purpose || '';
            
            document.querySelectorAll('.mood-select-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mood === groupData.mood) {
                    btn.classList.add('active');
                    btn.style.borderWidth = '2px';
                }
            });
            
            const adminPostingMode = document.getElementById('adminPostingMode');
            if (adminPostingMode) adminPostingMode.value = groupData.postingRule || 'everyone';
            updatePostingRulesUI();
            
            if (groupData.quietHours) {
                const adminQuietStart = document.getElementById('adminQuietStart');
                const adminQuietEnd = document.getElementById('adminQuietEnd');
                if (adminQuietStart) adminQuietStart.value = groupData.quietHours.start || '22:00';
                if (adminQuietEnd) adminQuietEnd.value = groupData.quietHours.end || '08:00';
            }
            
            if (groupData.scheduledPosting) {
                const adminPostingStart = document.getElementById('adminPostingStart');
                const adminPostingEnd = document.getElementById('adminPostingEnd');
                if (adminPostingStart) adminPostingStart.value = groupData.scheduledPosting.start || '09:00';
                if (adminPostingEnd) adminPostingEnd.value = groupData.scheduledPosting.end || '18:00';
            }
            
            const participationModes = groupData.participationModes || {};
            const adminEnableReadOnly = document.getElementById('adminEnableReadOnly');
            const adminEnableReactOnly = document.getElementById('adminEnableReactOnly');
            const adminEnableAnonymous = document.getElementById('adminEnableAnonymous');
            
            if (adminEnableReadOnly) adminEnableReadOnly.checked = participationModes.readOnly || false;
            if (adminEnableReactOnly) adminEnableReactOnly.checked = participationModes.reactOnly || false;
            if (adminEnableAnonymous) adminEnableAnonymous.checked = participationModes.anonymous || false;
        }
        
        // Update posting rules UI
        function updatePostingRulesUI() {
            const adminPostingMode = document.getElementById('adminPostingMode');
            const adminQuietHoursSection = document.getElementById('adminQuietHoursSection');
            const adminScheduledPostingSection = document.getElementById('adminScheduledPostingSection');
            
            if (!adminPostingMode) return;
            
            const mode = adminPostingMode.value;
            if (adminQuietHoursSection) {
                adminQuietHoursSection.style.display = mode === 'quiet_hours' ? 'block' : 'none';
            }
            if (adminScheduledPostingSection) {
                adminScheduledPostingSection.style.display = mode === 'scheduled' ? 'block' : 'none';
            }
        }
        
        // Save group settings
        async function saveGroupSettings(groupData) {
            try {
                const adminPublicGroup = document.getElementById('adminPublicGroup');
                const adminApproveMembers = document.getElementById('adminApproveMembers');
                const adminAllowInvites = document.getElementById('adminAllowInvites');
                const adminOnlyAdminsPost = document.getElementById('adminOnlyAdminsPost');
                const adminAllowMedia = document.getElementById('adminAllowMedia');
                const adminDisappearingMessages = document.getElementById('adminDisappearingMessages');
                const adminMentionNotifications = document.getElementById('adminMentionNotifications');
                const adminAnnouncementNotifications = document.getElementById('adminAnnouncementNotifications');
                const adminGroupPurpose = document.getElementById('adminGroupPurpose');
                const adminPostingMode = document.getElementById('adminPostingMode');
                const adminQuietStart = document.getElementById('adminQuietStart');
                const adminQuietEnd = document.getElementById('adminQuietEnd');
                const adminPostingStart = document.getElementById('adminPostingStart');
                const adminPostingEnd = document.getElementById('adminPostingEnd');
                const adminEnableReadOnly = document.getElementById('adminEnableReadOnly');
                const adminEnableReactOnly = document.getElementById('adminEnableReactOnly');
                const adminEnableAnonymous = document.getElementById('adminEnableAnonymous');
                
                const settings = {
                    privacy: adminPublicGroup && adminPublicGroup.checked ? 'public' : 'private',
                    moderationSettings: {
                        approveNewMembers: adminApproveMembers ? adminApproveMembers.checked : false,
                        allowInvites: adminAllowInvites ? adminAllowInvites.checked : true,
                        onlyAdminsCanPost: adminOnlyAdminsPost ? adminOnlyAdminsPost.checked : false,
                        allowMediaSharing: adminAllowMedia ? adminAllowMedia.checked : true,
                        disappearingMessages: adminDisappearingMessages ? adminDisappearingMessages.checked : false
                    },
                    notificationSettings: {
                        mentionNotifications: adminMentionNotifications ? adminMentionNotifications.checked : true,
                        announcementNotifications: adminAnnouncementNotifications ? adminAnnouncementNotifications.checked : true
                    },
                    purpose: adminGroupPurpose ? adminGroupPurpose.value : '',
                    mood: document.querySelector('.mood-select-btn.active')?.dataset.mood || '',
                    postingRule: adminPostingMode ? adminPostingMode.value : 'everyone',
                    quietHours: adminPostingMode && adminPostingMode.value === 'quiet_hours' ? {
                        start: adminQuietStart ? adminQuietStart.value : '22:00',
                        end: adminQuietEnd ? adminQuietEnd.value : '08:00'
                    } : {},
                    scheduledPosting: adminPostingMode && adminPostingMode.value === 'scheduled' ? {
                        start: adminPostingStart ? adminPostingStart.value : '09:00',
                        end: adminPostingEnd ? adminPostingEnd.value : '18:00'
                    } : {},
                    participationModes: {
                        readOnly: adminEnableReadOnly ? adminEnableReadOnly.checked : false,
                        reactOnly: adminEnableReactOnly ? adminEnableReactOnly.checked : false,
                        anonymous: adminEnableAnonymous ? adminEnableAnonymous.checked : false
                    }
                };
                
                const response = await safeApiCall('put', `groups/${groupData.id}/settings`, settings);
                
                if (response && response.success) {
                    Object.assign(groupData, settings);
                    
                    logTransparencyAction(groupData.id, 'Updated group settings');
                    
                    if (currentChatGroup && currentChatGroup.id === groupData.id) {
                        updateChatHeaderUniqueFeatures(groupData);
                        checkPostingRules(groupData);
                    }
                    
                    showNotification('Group settings saved successfully', 'success');
                    
                    const adminManagementModal = document.getElementById('adminManagementModal');
                    if (adminManagementModal) adminManagementModal.classList.remove('active');
                } else {
                    throw new Error(response?.error || 'Failed to save settings');
                }
                
            } catch (error) {
                console.error('Error saving group settings:', error);
                showNotification('Failed to save settings: ' + error.message, 'error');
            }
        }
        
        // Show friend selection
        function showFriendSelection() {
            const friendSelectionModal = document.getElementById('friendSelectionModal');
            if (friendSelectionModal) {
                friendSelectionModal.classList.add('active');
            }
            selectedFriends = [];
            
            const friendSelectionContent = document.getElementById('friendSelectionContent');
            if (friendSelectionContent) {
                friendSelectionContent.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i><p>Loading friends...</p></div>';
            }
            
            setTimeout(() => {
                renderFriendSelection();
            }, 100);
        }
        
        // Render friend selection
        function renderFriendSelection() {
            const friendSelectionContent = document.getElementById('friendSelectionContent');
            if (!friendSelectionContent) return;
            
            if (friends.length === 0) {
                friendSelectionContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <p>No friends found</p>
                        <p class="subtext">Add friends first to invite them to groups</p>
                    </div>
                `;
                return;
            }
            
            friendSelectionContent.innerHTML = '';
            
            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.dataset.friendId = friend.id;
                
                const initials = friend.displayName 
                    ? friend.displayName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                    : 'U';
                
                friendItem.innerHTML = `
                    <div class="friend-avatar" ${friend.photoURL ? `style="background-image: url('${friend.photoURL}')"` : ''}>
                        ${friend.photoURL ? '' : `<span>${initials}</span>`}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.displayName}</div>
                        <div class="friend-username">${friend.username || ''}</div>
                        <div style="font-size: 11px; color: ${friend.online ? 'var(--success-color)' : 'var(--text-secondary)'}; margin-top: 2px;">
                            <i class="fas fa-circle" style="font-size: 8px;"></i> ${friend.online ? 'Online' : 'Offline'}
                        </div>
                    </div>
                    <div class="friend-checkbox">
                        <i class="fas fa-check" style="display: none;"></i>
                    </div>
                `;
                
                friendItem.addEventListener('click', () => {
                    const checkbox = friendItem.querySelector('.friend-checkbox');
                    const isSelected = checkbox.classList.contains('selected');
                    
                    if (isSelected) {
                        checkbox.classList.remove('selected');
                        checkbox.querySelector('i').style.display = 'none';
                        selectedFriends = selectedFriends.filter(id => id !== friend.id);
                    } else {
                        checkbox.classList.add('selected');
                        checkbox.querySelector('i').style.display = 'block';
                        selectedFriends.push(friend.id);
                    }
                    
                    updateSelectedFriendsList();
                });
                
                friendSelectionContent.appendChild(friendItem);
            });
        }
        
        // Update selected friends list
        function updateSelectedFriendsList() {
            const selectedMembersList = document.getElementById('selectedMembersList');
            if (!selectedMembersList) return;
            
            if (selectedFriends.length === 0) {
                selectedMembersList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-users"></i>
                        <p>No members selected yet</p>
                        <p style="font-size: 14px;">Add friends to your group</p>
                    </div>
                `;
                return;
            }
            
            selectedMembersList.innerHTML = '';
            
            selectedFriends.forEach(friendId => {
                const friend = friends.find(f => f.id === friendId);
                if (friend) {
                    const initials = friend.displayName 
                        ? friend.displayName.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                        : 'U';
                    
                    const memberItem = document.createElement('div');
                    memberItem.className = 'friend-item';
                    memberItem.style.marginBottom = '5px';
                    memberItem.style.padding = '8px';
                    
                    memberItem.innerHTML = `
                        <div class="friend-avatar" ${friend.photoURL ? `style="background-image: url('${friend.photoURL}')"` : ''}>
                            ${friend.photoURL ? '' : `<span>${initials}</span>`}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.displayName}</div>
                            <div class="friend-username">${friend.username || ''}</div>
                        </div>
                        <div style="color: var(--danger-color); cursor: pointer;" onclick="removeSelectedFriend('${friend.id}')">
                            <i class="fas fa-times"></i>
                        </div>
                    `;
                    
                    selectedMembersList.appendChild(memberItem);
                }
            });
        }
        
        // Remove selected friend
        window.removeSelectedFriend = function(friendId) {
            selectedFriends = selectedFriends.filter(id => id !== friendId);
            updateSelectedFriendsList();
            
            const friendItem = document.querySelector(`.friend-item[data-friend-id="${friendId}"]`);
            if (friendItem) {
                const checkbox = friendItem.querySelector('.friend-checkbox');
                checkbox.classList.remove('selected');
                checkbox.querySelector('i').style.display = 'none';
            }
        };
        
        // Create group online
        async function createGroupOnline(groupData) {
            try {
                const members = [currentUser.uid, ...selectedFriends];
                
                const groupDataToSave = {
                    name: groupData.name,
                    description: groupData.description || '',
                    topic: groupData.topic || '',
                    privacy: groupData.privacy || 'private',
                    theme: groupData.theme || 'blue',
                    welcomeMessage: groupData.welcomeMessage || '',
                    rules: groupData.rules || [],
                    moderationSettings: groupData.moderationSettings || {},
                    joinQuestions: groupData.joinQuestions || [],
                    customReactions: groupData.customReactions || ['üëç', '‚ù§Ô∏è', 'üòÇ'],
                    badges: groupData.badges || ['star', 'fire'],
                    memberIds: members,
                    purpose: groupData.purpose || '',
                    mood: groupData.mood || '',
                    postingRule: groupData.postingRule || 'everyone',
                    quietHours: groupData.quietHours || {},
                    scheduledPosting: groupData.scheduledPosting || {},
                    participationModes: groupData.participationModes || {}
                };
                
                const response = await safeApiCall('post', 'groups/create', groupDataToSave);
                
                if (!response || !response.success) {
                    throw new Error(response?.error || 'Failed to create group');
                }
                
                const newGroup = response.data;
                
                groups.push(newGroup);
                myGroups.push(newGroup);
                adminGroups.push(newGroup);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                const inviteLinkInput = document.getElementById('inviteLinkInput');
                const copyInviteLinkBtn = document.getElementById('copyInviteLinkBtn');
                const shareInviteLinkBtn = document.getElementById('shareInviteLinkBtn');
                
                if (inviteLinkInput) inviteLinkInput.value = `${window.location.origin}/group.html?join=${newGroup.id}`;
                if (copyInviteLinkBtn) copyInviteLinkBtn.disabled = false;
                if (shareInviteLinkBtn) shareInviteLinkBtn.disabled = false;
                
                showNotification('Group created successfully!', 'success');
                
                const createGroupModal = document.getElementById('createGroupModal');
                const friendSelectionModal = document.getElementById('friendSelectionModal');
                
                if (createGroupModal) createGroupModal.classList.remove('active');
                if (friendSelectionModal) friendSelectionModal.classList.remove('active');
                
                selectedFriends = [];
                showGroupDetails(newGroup, 'my_group');
                
            } catch (error) {
                console.error('Error creating group:', error);
                showNotification('Failed to create group: ' + error.message, 'error');
            }
        }
        
        // Join group online
        async function joinGroupOnline(groupId) {
            try {
                const response = await safeApiCall('post', `groups/${groupId}/join`);
                
                if (!response || !response.success) {
                    showNotification(response?.error || 'Failed to join group', 'error');
                    return;
                }
                
                const updatedGroup = response.data;
                
                const existingIndex = groups.findIndex(g => g.id === groupId);
                if (existingIndex !== -1) {
                    groups[existingIndex] = updatedGroup;
                } else {
                    groups.push(updatedGroup);
                }
                
                joinedGroups.push(updatedGroup);
                groupInvites = groupInvites.filter(invite => invite.groupId !== groupId);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                showNotification('Successfully joined the group!', 'success');
                
                const groupInviteModal = document.getElementById('groupInviteModal');
                if (groupInviteModal) groupInviteModal.classList.remove('active');
                
            } catch (error) {
                console.error('Error joining group:', error);
                showNotification('Failed to join group: ' + error.message, 'error');
            }
        }
        
        // Leave group online
        async function leaveGroupOnline(groupId) {
            try {
                const response = await safeApiCall('post', `groups/${groupId}/leave`);
                
                if (!response || !response.success) {
                    showNotification(response?.error || 'Failed to leave group', 'error');
                    return;
                }
                
                groups = groups.filter(g => g.id !== groupId);
                joinedGroups = joinedGroups.filter(g => g.id !== groupId);
                adminGroups = adminGroups.filter(g => g.id !== groupId);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                showNotification('Successfully left the group', 'success');
                
                const groupDetailsPanel = document.getElementById('groupDetailsPanel');
                if (groupDetailsPanel && groupDetailsPanel.classList.contains('active')) {
                    groupDetailsPanel.classList.remove('active');
                    selectedGroup = null;
                }
                
            } catch (error) {
                console.error('Error leaving group:', error);
                showNotification('Failed to leave group: ' + error.message, 'error');
            }
        }
        
        // Accept group invite
        async function acceptGroupInvite(inviteData) {
            try {
                const inviteId = inviteData.id || inviteData.inviteId;
                const groupId = inviteData.groupId || inviteData.id;
                
                const response = await safeApiCall('post', `groups/invites/${inviteId}/accept`);
                
                if (!response || !response.success) {
                    showNotification(response?.error || 'Failed to accept invitation', 'error');
                    return;
                }
                
                await joinGroupOnline(groupId);
                
            } catch (error) {
                console.error('Error accepting group invite:', error);
                showNotification('Failed to accept invitation: ' + error.message, 'error');
            }
        }
        
        // Decline group invite
        async function declineGroupInvite(inviteData) {
            try {
                const inviteId = inviteData.id || inviteData.inviteId;
                
                const response = await safeApiCall('post', `groups/invites/${inviteId}/decline`);
                
                if (!response || !response.success) {
                    showNotification(response?.error || 'Failed to decline invitation', 'error');
                    return;
                }
                
                groupInvites = groupInvites.filter(invite => invite.id !== inviteId);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                showNotification('Invitation declined', 'success');
                
                const groupInviteModal = document.getElementById('groupInviteModal');
                if (groupInviteModal) groupInviteModal.classList.remove('active');
                
            } catch (error) {
                console.error('Error declining group invite:', error);
                showNotification('Failed to decline invitation: ' + error.message, 'error');
            }
        }
        
        // Leave group confirmation
        function leaveGroupConfirm(groupData) {
            if (confirm(`Are you sure you want to leave "${groupData.name}"? You will need to be invited again to rejoin.`)) {
                leaveGroupOnline(groupData.id);
            }
        }
        
        // Show group details
        function showGroupDetails(groupData, type) {
            selectedGroup = groupData;
            
            const groupDetailsTitle = document.querySelector('.group-details-title');
            if (groupDetailsTitle) groupDetailsTitle.textContent = 'Group Details';
            
            const sidebar = document.getElementById('sidebar');
            const groupDetailsPanel = document.getElementById('groupDetailsPanel');
            
            if (isMobile) {
                if (sidebar) sidebar.style.display = 'none';
                if (groupDetailsPanel) {
                    groupDetailsPanel.style.display = 'flex';
                    groupDetailsPanel.classList.add('active');
                }
            } else {
                if (groupDetailsPanel) groupDetailsPanel.classList.add('active');
            }
            
            loadGroupDetails(groupData, type);
        }
        
        // Load group details
        async function loadGroupDetails(groupData, type) {
            const detailsContent = document.getElementById('groupDetailsContent');
            if (!detailsContent) return;
            
            detailsContent.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i><p>Loading group details...</p></div>';
            
            try {
                const theme = groupData.theme || 'blue';
                const themeInfo = groupThemes[theme];
                const groupType = groupData.type || 'private';
                const typeInfo = groupTypes[groupType];
                
                const initials = groupData.name 
                    ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                    : 'G';
                
                const userRole = groupData.isCreator ? 'creator' : 
                                groupData.isAdmin ? 'admin' : 'member';
                const roleInfo = groupRoles[userRole];
                
                const welcomeMessage = groupData.welcomeMessage || `Welcome to ${groupData.name}! We're glad to have you here.`;
                const rules = groupData.rules || [];
                
                const purpose = groupData.purpose || '';
                const mood = groupData.mood || '';
                const postingRule = groupData.postingRule || 'everyone';
                const purposeInfo = purpose ? groupPurposes[purpose] : null;
                const moodInfo = mood ? groupMoods[mood] : null;
                const ruleInfo = postingRules[postingRule];
                
                let realMembers = [];
                try {
                    const response = await backgroundApiCall('get', `groups/${groupData.id}/members`);
                    if (response && response.success && response.data) {
                        realMembers = response.data.slice(0, 5);
                    }
                } catch (error) {
                    console.log('Error loading members:', error);
                }
                
                detailsContent.innerHTML = `
                    <div class="group-profile-header">
                        <div class="group-profile-avatar" ${groupData.photoURL ? `style="background-image: url('${groupData.photoURL}'); background: ${themeInfo.gradient};"` : `style="background: ${themeInfo.gradient};"`}>
                            ${groupData.photoURL ? '' : `<span style="color: white; font-size: 36px;">${initials}</span>`}
                            ${purposeInfo ? `<div class="group-purpose-badge-large" style="position: absolute; bottom: -10px; right: -10px; background: ${purposeInfo.color}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;">${purposeInfo.icon}</div>` : ''}
                        </div>
                        <div class="group-profile-name">${groupData.name || 'Unnamed Group'}</div>
                        ${purposeInfo ? `<div class="group-purpose-tag-large" style="margin: 5px 0; font-size: 14px; padding: 6px 12px; background: ${purposeInfo.color}20; color: ${purposeInfo.color}; border-radius: 20px;">${purposeInfo.icon} ${purposeInfo.name}</div>` : ''}
                        <div class="group-profile-topic">${groupData.topic || 'No topic set'}</div>
                        <div class="group-profile-type ${groupType}">
                            <i class="${typeInfo.icon}"></i> ${typeInfo.name}
                        </div>
                        <div class="role-badge ${userRole}">
                            <i class="${roleInfo.icon}"></i> ${roleInfo.name}
                        </div>
                        ${moodInfo ? `<div class="group-mood-indicator mood-${mood}" style="margin: 10px auto; background: ${moodInfo.bgColor}; color: ${moodInfo.color}; padding: 8px 16px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px;">${moodInfo.icon} ${moodInfo.name}</span>` : ''}
                        ${ruleInfo ? `<div class="posting-rules-banner rule-${postingRule.replace('_', '-')}" style="margin: 10px auto; background: ${ruleInfo.bgColor}; color: ${ruleInfo.color}; padding: 8px 16px; border-radius: 8px; display: inline-flex; align-items: center; gap: 8px;"><i class="fas fa-comment"></i> ${ruleInfo.name}</div>` : ''}
                    </div>
                    
                    ${welcomeMessage ? `
                    <div class="welcome-message">
                        <div class="welcome-title">
                            <i class="fas fa-door-open"></i> Welcome!
                        </div>
                        <div>${welcomeMessage}</div>
                    </div>
                    ` : ''}
                    
                    ${groupData.description ? `
                    <div class="group-info-section">
                        <div class="info-section-title">
                            <i class="fas fa-info-circle"></i>
                            <span>About This Group</span>
                        </div>
                        <div style="padding: 10px 0;">${groupData.description}</div>
                    </div>
                    ` : ''}
                    
                    ${rules.length > 0 ? `
                    <div class="rules-section">
                        <div class="rules-title">
                            <i class="fas fa-gavel"></i>
                            <span>Group Rules</span>
                        </div>
                        <ul class="rules-list">
                            ${rules.map(rule => `<li><i class="fas fa-check-circle" style="color: var(--success-color);"></i> ${rule}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <div class="group-info-section">
                        <div class="info-section-title">
                            <i class="fas fa-chart-bar"></i>
                            <span>Group Statistics</span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Members:</span>
                            <span class="info-value">${groupData.memberCount || 0}</span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Created:</span>
                            <span class="info-value">${formatDate(groupData.createdAt || new Date())}</span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Last Activity:</span>
                            <span class="info-value">${formatTimeAgo(groupData.lastActivity || groupData.createdAt || new Date())}</span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Group Theme:</span>
                            <span class="info-value">
                                <div class="theme-badge ${theme}">
                                    <i class="fas fa-palette"></i>
                                    ${themeInfo.name}
                                </div>
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Privacy:</span>
                            <span class="info-value">
                                <div class="type-display ${groupType}">
                                    <i class="${typeInfo.icon}"></i>
                                    ${typeInfo.name}
                                </div>
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">Activity Pulse:</span>
                            <span class="info-value">
                                ${(() => {
                                    const pulse = calculateGroupPulse(groupData);
                                    return pulse ? `<div class="group-pulse ${pulse.class}"><i class="fas fa-heartbeat"></i> ${pulse.text}</div>` : '<span>Unknown</span>';
                                })()}
                            </span>
                        </div>
                    </div>
                    
                    <div class="group-info-section">
                        <div class="info-section-title">
                            <i class="fas fa-users"></i>
                            <span>Members (${Math.min(groupData.memberCount || 0, 5)} shown)</span>
                        </div>
                        <div class="member-list">
                            ${realMembers.length > 0 ? 
                                realMembers.map((member, i) => `
                                    <div class="member-item">
                                        <div class="member-avatar" ${member.photoURL ? `style="background-image: url('${member.photoURL}')"` : 'style="background: var(--secondary-color)"'}>
                                            ${member.photoURL ? '' : `<span style="color: var(--text-primary); font-size: 14px;">${member.displayName ? member.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U'}</span>`}
                                        </div>
                                        <div class="member-info">
                                            <div class="member-name">
                                                <span>${member.displayName || 'Unknown User'}</span>
                                                ${member.uid === currentUser.uid ? `<span class="role-badge ${userRole}"><i class="${roleInfo.icon}"></i> ${roleInfo.name}</span>` : 
                                                 groupData.admins && groupData.admins.includes(member.uid) ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : 
                                                 '<span class="role-badge member"><i class="fas fa-user"></i> Member</span>'}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                ${member.uid === currentUser.uid ? 'You' : (member.online ? 'Online' : 'Offline')}
                                            </div>
                                        </div>
                                    </div>
                                `).join('') :
                                Array.from({length: Math.min(groupData.memberCount || 0, 5)}, (_, i) => `
                                    <div class="member-item">
                                        <div class="member-avatar" style="background: ${i === 0 ? themeInfo.gradient : 'var(--secondary-color)'}">
                                            <span style="color: ${i === 0 ? 'white' : 'var(--text-primary)'}; font-size: 14px;">${i === 0 ? 'Y' : 'M'}</span>
                                        </div>
                                        <div class="member-info">
                                            <div class="member-name">
                                                <span>${i === 0 ? 'You' : 'Member ' + (i+1)}</span>
                                                ${i === 0 ? `<span class="role-badge ${userRole}"><i class="${roleInfo.icon}"></i> ${roleInfo.name}</span>` : 
                                                   i < 3 ? '<span class="role-badge admin"><i class="fas fa-crown"></i> Admin</span>' : 
                                                   '<span class="role-badge member"><i class="fas fa-user"></i> Member</span>'}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                ${i === 0 ? 'Online' : (i < 3 ? 'Recently active' : 'Member')}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                        ${groupData.memberCount > 5 ? `
                            <div style="text-align: center; margin-top: 10px;">
                                <button class="action-btn secondary" id="viewAllMembersBtn" style="width: 100%;">
                                    <i class="fas fa-users"></i> View All ${groupData.memberCount} Members
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${groupData.participationModes ? `
                    <div class="group-info-section">
                        <div class="info-section-title">
                            <i class="fas fa-user-secret"></i>
                            <span>Participation Modes</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                            ${groupData.participationModes.readOnly ? `
                                <div class="participation-mode mode-read-only">
                                    <i class="fas fa-eye"></i> Read Only
                                </div>
                            ` : ''}
                            ${groupData.participationModes.reactOnly ? `
                                <div class="participation-mode mode-react-only">
                                    <i class="fas fa-thumbs-up"></i> React Only
                                </div>
                            ` : ''}
                            ${groupData.participationModes.anonymous ? `
                                <div class="participation-mode mode-anonymous">
                                    <i class="fas fa-user-secret"></i> Anonymous
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="action-buttons">
                        <button class="action-btn success" id="openGroupChatBtn">
                            <i class="fas fa-comments"></i> Open Chat
                        </button>
                        
                        ${type === 'my_group' || type === 'admin' ? `
                            <button class="action-btn primary" id="manageGroupBtn">
                                <i class="fas fa-cog"></i> Manage
                            </button>
                        ` : ''}
                        
                        ${type === 'joined' ? `
                            <button class="action-btn danger" id="leaveGroupBtn">
                                <i class="fas fa-sign-out-alt"></i> Leave Group
                            </button>
                        ` : ''}
                        
                        <button class="action-btn secondary" id="groupOptionsBtn">
                            <i class="fas fa-ellipsis-h"></i> Options
                        </button>
                    </div>
                `;
                
                const openGroupChatBtn = document.getElementById('openGroupChatBtn');
                const manageGroupBtn = document.getElementById('manageGroupBtn');
                const leaveGroupBtn = document.getElementById('leaveGroupBtn');
                const groupOptionsBtn = document.getElementById('groupOptionsBtn');
                const viewAllMembersBtn = document.getElementById('viewAllMembersBtn');
                
                if (openGroupChatBtn) {
                    openGroupChatBtn.addEventListener('click', () => {
                        openGroupChat(groupData);
                    });
                }
                
                if (manageGroupBtn) {
                    manageGroupBtn.addEventListener('click', () => {
                        openAdminManagement(groupData);
                    });
                }
                
                if (leaveGroupBtn) {
                    leaveGroupBtn.addEventListener('click', () => {
                        leaveGroupConfirm(groupData);
                    });
                }
                
                if (groupOptionsBtn) {
                    groupOptionsBtn.addEventListener('click', () => {
                        showGroupOptions(groupData);
                    });
                }
                
                if (viewAllMembersBtn) {
                    viewAllMembersBtn.addEventListener('click', () => {
                        showNotification('Full member list would open here', 'info');
                    });
                }
                
            } catch (error) {
                console.error('Error loading group details:', error);
                detailsContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading group details</p>
                        <p class="subtext">Please try again later</p>
                    </div>
                `;
            }
        }
        
        // Show group options
        function showGroupOptions(groupData) {
            const options = [
                { icon: 'fas fa-share-alt', text: 'Share Group', action: () => shareGroup(groupData) },
                { icon: 'fas fa-bell', text: 'Mute Notifications', action: () => muteGroup(groupData) },
                { icon: 'fas fa-star', text: 'Add to Favorites', action: () => favoriteGroup(groupData) },
                { icon: 'fas fa-flag', text: 'Report Group', action: () => reportGroup(groupData) },
                { icon: 'fas fa-ban', text: 'Block Group', action: () => blockGroup(groupData) },
                { icon: 'fas fa-qrcode', text: 'Group QR Code', action: () => showGroupQRCode(groupData) },
                { icon: 'fas fa-link', text: 'Copy Invite Link', action: () => copyInviteLink(groupData) },
                { icon: 'fas fa-sticky-note', text: 'View Group Notes', action: () => viewGroupNotes(groupData) },
                { icon: 'fas fa-calendar-alt', text: 'View Events', action: () => viewGroupEvents(groupData) },
                { icon: 'fas fa-chart-line', text: 'View Analytics', action: () => viewGroupAnalytics(groupData) }
            ];
            
            if (groupData.isAdmin || groupData.isCreator) {
                options.unshift(
                    { icon: 'fas fa-user-plus', text: 'Invite Members', action: () => inviteMembers(groupData) },
                    { icon: 'fas fa-edit', text: 'Edit Group Info', action: () => editGroupInfo(groupData) },
                    { icon: 'fas fa-user-shield', text: 'Manage Roles', action: () => manageRoles(groupData) },
                    { icon: 'fas fa-calendar-plus', text: 'Create Event', action: () => createEvent(groupData) },
                    { icon: 'fas fa-poll', text: 'Create Poll', action: () => createPoll(groupData) },
                    { icon: 'fas fa-bullseye', text: 'Change Purpose/Mood', action: () => changePurposeMood(groupData) },
                    { icon: 'fas fa-comment-slash', text: 'Update Posting Rules', action: () => updatePostingRules(groupData) },
                    { icon: 'fas fa-history', text: 'View Change History', action: () => viewChangeHistory(groupData) }
                );
            }
            
            showOptionsModal('Group Options', options, groupData.name);
        }
        
        // View group notes
        function viewGroupNotes(groupData) {
            const groupNotesPanel = document.getElementById('groupNotesPanel');
            if (currentChatGroup && currentChatGroup.id === groupData.id) {
                if (groupNotesPanel) {
                    groupNotesPanel.style.display = groupNotesPanel.style.display === 'none' ? 'block' : 'none';
                }
            } else {
                openGroupChat(groupData);
                setTimeout(() => {
                    if (groupNotesPanel) groupNotesPanel.style.display = 'block';
                }, 100);
            }
        }
        
        // View group events
        function viewGroupEvents(groupData) {
            const eventCountdownPanel = document.getElementById('eventCountdownPanel');
            if (currentChatGroup && currentChatGroup.id === groupData.id) {
                if (eventCountdownPanel) {
                    eventCountdownPanel.style.display = eventCountdownPanel.style.display === 'none' ? 'block' : 'none';
                }
            } else {
                openGroupChat(groupData);
                setTimeout(() => {
                    if (eventCountdownPanel) eventCountdownPanel.style.display = 'block';
                }, 100);
            }
        }
        
        // View group analytics
        function viewGroupAnalytics(groupData) {
            showNotification('Group analytics feature coming soon', 'info');
        }
        
        // Change purpose/mood
        function changePurposeMood(groupData) {
            openAdminManagement(groupData);
            const purposeTab = document.querySelector('.admin-management-tab[data-tab="purpose"]');
            if (purposeTab) {
                purposeTab.click();
            }
        }
        
        // Update posting rules
        function updatePostingRules(groupData) {
            openAdminManagement(groupData);
            const purposeTab = document.querySelector('.admin-management-tab[data-tab="purpose"]');
            if (purposeTab) {
                purposeTab.click();
            }
        }
        
        // View change history
        function viewChangeHistory(groupData) {
            openAdminManagement(groupData);
            const transparencyTab = document.querySelector('.admin-management-tab[data-tab="transparency"]');
            if (transparencyTab) {
                transparencyTab.click();
            }
        }
        
        // Show options modal
        function showOptionsModal(title, options, subtitle = '') {
            const modal = document.createElement('div');
            modal.className = 'options-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; align-items: center; justify-content: center;';
            
            modal.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; z-index: 1002; min-width: 300px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                        <div style="font-weight: 600;">${title}</div>
                        ${subtitle ? `<div style="font-size: 14px; color: var(--text-secondary); margin-top: 5px;">${subtitle}</div>` : ''}
                    </div>
                    <div>
                        ${options.map(option => {
                            return `
                                <div style="padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;"
                                     onmouseover="this.style.backgroundColor='var(--secondary-color)'" onmouseout="this.style.backgroundColor='transparent'" onclick="document.querySelector('.options-modal').remove(); ${option.action.toString().replace(/"/g, '&quot;')}();">
                                    <i class="${option.icon}" style="color: var(--primary-color); width: 20px;"></i>
                                    <span>${option.text}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="padding: 15px 20px; text-align: center;">
                        <button onclick="document.querySelector('.options-modal').remove();" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px 16px; border-radius: 8px;">Cancel</button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            document.body.appendChild(modal);
        }
        
        // Share group
        function shareGroup(groupData) {
            const shareUrl = `${window.location.origin}/group.html?id=${groupData.id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: groupData.name,
                    text: `Join ${groupData.name} on Knecta Chat`,
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                showNotification('Group link copied to clipboard', 'success');
            }
        }
        
        // Mute group
        function muteGroup(groupData) {
            const mutedGroups = JSON.parse(localStorage.getItem('knecta_muted_groups') || '[]');
            
            if (!mutedGroups.includes(groupData.id)) {
                mutedGroups.push(groupData.id);
                localStorage.setItem('knecta_muted_groups', JSON.stringify(mutedGroups));
                showNotification('Group notifications muted', 'success');
            } else {
                showNotification('Group already muted', 'info');
            }
        }
        
        // Favorite group
        function favoriteGroup(groupData) {
            const favoriteGroups = JSON.parse(localStorage.getItem('knecta_favorite_groups') || '[]');
            
            if (!favoriteGroups.includes(groupData.id)) {
                favoriteGroups.push(groupData.id);
                localStorage.setItem('knecta_favorite_groups', JSON.stringify(favoriteGroups));
                showNotification('Group added to favorites', 'success');
            } else {
                showNotification('Group already in favorites', 'info');
            }
        }
        
        // Report group
        function reportGroup(groupData) {
            const reason = prompt(`Why are you reporting "${groupData.name}"?\n1. Spam\n2. Harassment\n3. Inappropriate content\n4. Fake group\n5. Other\n\nEnter reason number:`, '1');
            
            if (reason) {
                const reports = JSON.parse(localStorage.getItem('knecta_group_reports') || '[]');
                reports.push({
                    groupId: groupData.id,
                    groupName: groupData.name,
                    reason: reason,
                    timestamp: Date.now()
                });
                localStorage.setItem('knecta_group_reports', JSON.stringify(reports));
                showNotification('Group has been reported. Thank you for helping keep our community safe.', 'success');
            }
        }
        
        // Block group
        function blockGroup(groupData) {
            if (confirm(`Are you sure you want to block "${groupData.name}"? You will no longer see this group or receive notifications from it.`)) {
                const blockedGroups = JSON.parse(localStorage.getItem('knecta_blocked_groups') || '[]');
                blockedGroups.push({
                    groupId: groupData.id,
                    groupName: groupData.name,
                    timestamp: Date.now()
                });
                localStorage.setItem('knecta_blocked_groups', JSON.stringify(blockedGroups));
                
                groups = groups.filter(g => g.id !== groupData.id);
                myGroups = myGroups.filter(g => g.id !== groupData.id);
                joinedGroups = joinedGroups.filter(g => g.id !== groupData.id);
                adminGroups = adminGroups.filter(g => g.id !== groupData.id);
                
                saveGroupsToLocalStorage();
                updateGroupCounts();
                updateCurrentSection();
                
                showNotification('Group blocked successfully', 'success');
                
                const groupDetailsPanel = document.getElementById('groupDetailsPanel');
                if (groupDetailsPanel && groupDetailsPanel.classList.contains('active')) {
                    groupDetailsPanel.classList.remove('active');
                    selectedGroup = null;
                }
            }
        }
        
        // Show group QR code
        function showGroupQRCode(groupData) {
            showNotification('Group QR code feature coming soon', 'info');
        }
        
        // Copy invite link
        function copyInviteLink(groupData) {
            const inviteLink = `${window.location.origin}/group.html?join=${groupData.id}`;
            navigator.clipboard.writeText(inviteLink);
            showNotification('Invite link copied to clipboard', 'success');
        }
        
        // Invite members
        function inviteMembers(groupData) {
            showFriendSelection();
        }
        
        // Edit group info
        function editGroupInfo(groupData) {
            showNotification('Group edit panel would open here', 'info');
        }
        
        // Manage roles
        function manageRoles(groupData) {
            openAdminManagement(groupData);
        }
        
        // Create event
        function createEvent(groupData) {
            showNotification('Event creation panel would open here', 'info');
        }
        
        // Create poll
        function createPoll(groupData) {
            showNotification('Poll creation panel would open here', 'info');
        }
        
        // Show group invite details
        function showGroupInviteDetails(inviteData) {
            const groupData = inviteData.groupData || inviteData;
            
            const inviteName = document.getElementById('inviteName');
            const inviteTopic = document.getElementById('inviteTopic');
            const inviteMemberCount = document.getElementById('inviteMemberCount');
            const invitedBy = document.getElementById('invitedBy');
            const invitePurpose = document.getElementById('invitePurpose');
            const inviteMood = document.getElementById('inviteMood');
            const avatar = document.getElementById('inviteAvatar');
            
            if (inviteName) inviteName.textContent = groupData.name || 'Unnamed Group';
            if (inviteTopic) inviteTopic.textContent = groupData.topic || 'No topic';
            if (inviteMemberCount) inviteMemberCount.innerHTML = `<i class="fas fa-users"></i> ${groupData.memberCount || 0} members`;
            if (invitedBy) invitedBy.textContent = inviteData.invitedByName || 'Unknown';
            
            const purpose = groupData.purpose || '';
            const mood = groupData.mood || '';
            const purposeInfo = purpose ? groupPurposes[purpose] : null;
            const moodInfo = mood ? groupMoods[mood] : null;
            
            if (purposeInfo && invitePurpose) {
                invitePurpose.textContent = `${purposeInfo.icon} ${purposeInfo.name}`;
                invitePurpose.style.backgroundColor = purposeInfo.color + '20';
                invitePurpose.style.color = purposeInfo.color;
                invitePurpose.style.display = 'inline-block';
            } else if (invitePurpose) {
                invitePurpose.style.display = 'none';
            }
            
            if (moodInfo && inviteMood) {
                inviteMood.innerHTML = `${moodInfo.icon} ${moodInfo.name}`;
                inviteMood.className = `group-mood-indicator mood-${mood}`;
                inviteMood.style.backgroundColor = moodInfo.bgColor;
                inviteMood.style.color = moodInfo.color;
                inviteMood.style.display = 'flex';
            } else if (inviteMood) {
                inviteMood.style.display = 'none';
            }
            
            if (avatar) {
                if (groupData.photoURL) {
                    avatar.style.backgroundImage = `url('${groupData.photoURL}')`;
                    avatar.innerHTML = '';
                } else {
                    const initials = groupData.name 
                        ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                        : 'G';
                    avatar.innerHTML = `<span style="color: white; font-size: 24px;">${initials}</span>`;
                }
            }
            
            window.currentInvite = inviteData;
            
            const groupInviteModal = document.getElementById('groupInviteModal');
            if (groupInviteModal) {
                groupInviteModal.classList.add('active');
            }
        }
        
        // Check filters
        function matchesFilters(groupData) {
            if (currentTypeFilter !== 'all' && groupData.type !== currentTypeFilter) {
                return false;
            }
            
            if (currentSearchTerm && !matchesSearch(groupData, currentSearchTerm)) {
                return false;
            }
            
            return true;
        }
        
        // Check search
        function matchesSearch(groupData, searchTerm) {
            if (!searchTerm) return true;
            
            const searchIn = [
                groupData.name || '',
                groupData.topic || '',
                groupData.description || '',
                groupData.purpose ? groupPurposes[groupData.purpose]?.name || '' : ''
            ].join(' ').toLowerCase();
            
            return searchIn.includes(searchTerm.toLowerCase());
        }
        
        // Filter groups by type
        function filterGroupsByType(type) {
            currentTypeFilter = type;
            updateCurrentSection();
            
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`.type-filter-btn[data-type="${type}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        // Search groups
        function searchGroups(searchTerm) {
            currentSearchTerm = searchTerm.toLowerCase().trim();
            updateCurrentSection();
        }
        
        // Save groups to local storage
        function saveGroupsToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEYS.GROUPS, JSON.stringify(groups));
                localStorage.setItem(LOCAL_STORAGE_KEYS.MY_GROUPS, JSON.stringify(myGroups));
                localStorage.setItem(LOCAL_STORAGE_KEYS.JOINED_GROUPS, JSON.stringify(joinedGroups));
                localStorage.setItem(LOCAL_STORAGE_KEYS.GROUP_INVITES, JSON.stringify(groupInvites));
                localStorage.setItem(LOCAL_STORAGE_KEYS.ADMIN_GROUPS, JSON.stringify(adminGroups));
                localStorage.setItem(LOCAL_STORAGE_KEYS.PENDING_ACTIONS, JSON.stringify(pendingGroupActions));
                localStorage.setItem(LOCAL_STORAGE_KEYS.LAST_CACHE_TIME, Date.now().toString());
                console.log('Groups saved to local storage');
            } catch (error) {
                console.error('Error saving groups to local storage:', error);
            }
        }
        
        // Format time ago
        function formatTimeAgo(date) {
            const dateObj = date instanceof Date ? date : new Date(date);
            const now = new Date();
            const diffMs = now - dateObj;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return `${Math.floor(diffDays / 7)}w ago`;
        }
        
        // Format date
        function formatDate(date) {
            const dateObj = date instanceof Date ? date : new Date(date);
            return dateObj.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notificationText = document.getElementById('notificationText');
            const notification = document.getElementById('notification');
            
            if (!notificationText || !notification) return;
            
            notificationText.textContent = message;
            
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('active');
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        // Process pending offline actions
        function processPendingOfflineActions() {
            try {
                const pendingActions = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.PENDING_ACTIONS) || '[]');
                if (pendingActions.length > 0) {
                    console.log('Processing pending group actions...');
                }
            } catch (error) {
                console.error('Error processing pending offline actions:', error);
            }
        }
        
        // Update create group posting rules UI
        function updateCreateGroupPostingRulesUI() {
            const postingRulesSelect = document.getElementById('postingRulesSelect');
            const quietHoursSection = document.getElementById('quietHoursSection');
            const scheduledPostingSection = document.getElementById('scheduledPostingSection');
            
            if (!postingRulesSelect) return;
            
            const mode = postingRulesSelect.value;
            if (quietHoursSection) {
                quietHoursSection.style.display = mode === 'quiet_hours' ? 'block' : 'none';
            }
            if (scheduledPostingSection) {
                scheduledPostingSection.style.display = mode === 'scheduled' ? 'block' : 'none';
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Category tabs
            const allTab = document.getElementById('allTab');
            const myGroupsTab = document.getElementById('myGroupsTab');
            const joinedTab = document.getElementById('joinedTab');
            const invitesTab = document.getElementById('invitesTab');
            const adminTab = document.getElementById('adminTab');
            
            const allGroupsSection = document.getElementById('allGroupsSection');
            const myGroupsSection = document.getElementById('myGroupsSection');
            const joinedSection = document.getElementById('joinedSection');
            const invitesSection = document.getElementById('invitesSection');
            const adminSection = document.getElementById('adminSection');
            
            if (allTab) {
                allTab.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.groups-section').forEach(section => section.classList.remove('active'));
                    if (allGroupsSection) allGroupsSection.classList.add('active');
                    updateCurrentSection();
                });
            }
            
            if (myGroupsTab) {
                myGroupsTab.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.groups-section').forEach(section => section.classList.remove('active'));
                    if (myGroupsSection) myGroupsSection.classList.add('active');
                    updateCurrentSection();
                });
            }
            
            if (joinedTab) {
                joinedTab.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.groups-section').forEach(section => section.classList.remove('active'));
                    if (joinedSection) joinedSection.classList.add('active');
                    updateCurrentSection();
                });
            }
            
            if (invitesTab) {
                invitesTab.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.groups-section').forEach(section => section.classList.remove('active'));
                    if (invitesSection) invitesSection.classList.add('active');
                    updateCurrentSection();
                });
            }
            
            if (adminTab) {
                adminTab.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.groups-section').forEach(section => section.classList.remove('active'));
                    if (adminSection) adminSection.classList.add('active');
                    updateCurrentSection();
                });
            }
            
            // Type filter buttons
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.dataset.type;
                    filterGroupsByType(type);
                });
            });
            
            // Search input
            const groupSearch = document.getElementById('groupSearch');
            if (groupSearch) {
                groupSearch.addEventListener('input', function() {
                    searchGroups(this.value);
                });
            }
            
            // Create group button
            const createGroupBtn = document.getElementById('createGroupBtn');
            const createGroupModal = document.getElementById('createGroupModal');
            
            if (createGroupBtn) {
                createGroupBtn.addEventListener('click', () => {
                    if (createGroupModal) {
                        createGroupModal.classList.add('active');
                        const basicTab = document.querySelector('.create-group-tab[data-tab="basic"]');
                        if (basicTab) basicTab.click();
                        
                        // Reset form
                        const groupNameInput = document.getElementById('groupNameInput');
                        const groupDescriptionInput = document.getElementById('groupDescriptionInput');
                        const groupTopicInput = document.getElementById('groupTopicInput');
                        const groupTypeSelect = document.getElementById('groupTypeSelect');
                        const welcomeMessageInput = document.getElementById('welcomeMessageInput');
                        const groupRulesInput = document.getElementById('groupRulesInput');
                        const approveNewMembers = document.getElementById('approveNewMembers');
                        const onlyAdminsCanPost = document.getElementById('onlyAdminsCanPost');
                        const allowMediaSharing = document.getElementById('allowMediaSharing');
                        const enableDisappearingMessages = document.getElementById('enableDisappearingMessages');
                        const groupPurposeSelect = document.getElementById('groupPurposeSelect');
                        const postingRulesSelect = document.getElementById('postingRulesSelect');
                        const enableReadOnlyMode = document.getElementById('enableReadOnlyMode');
                        const enableReactOnlyMode = document.getElementById('enableReactOnlyMode');
                        const enableAnonymousMode = document.getElementById('enableAnonymousMode');
                        
                        if (groupNameInput) groupNameInput.value = '';
                        if (groupDescriptionInput) groupDescriptionInput.value = '';
                        if (groupTopicInput) groupTopicInput.value = '';
                        if (groupTypeSelect) groupTypeSelect.value = 'private';
                        if (welcomeMessageInput) welcomeMessageInput.value = '';
                        if (groupRulesInput) groupRulesInput.value = '1. Be respectful to all members\n2. No spam or self-promotion\n3. Keep discussions relevant to the group topic\n4. No hate speech or harassment';
                        if (approveNewMembers) approveNewMembers.checked = true;
                        if (onlyAdminsCanPost) onlyAdminsCanPost.checked = false;
                        if (allowMediaSharing) allowMediaSharing.checked = true;
                        if (enableDisappearingMessages) enableDisappearingMessages.checked = false;
                        if (groupPurposeSelect) groupPurposeSelect.value = '';
                        if (postingRulesSelect) postingRulesSelect.value = 'everyone';
                        if (enableReadOnlyMode) enableReadOnlyMode.checked = false;
                        if (enableReactOnlyMode) enableReactOnlyMode.checked = false;
                        if (enableAnonymousMode) enableAnonymousMode.checked = false;
                        
                        // Reset theme selection
                        document.querySelectorAll('.theme-option').forEach(option => {
                            const icon = option.querySelector('i');
                            if (icon) icon.style.display = 'none';
                        });
                        const blueThemeOption = document.querySelector('.theme-option[data-theme="blue"]');
                        if (blueThemeOption) {
                            const icon = blueThemeOption.querySelector('i');
                            if (icon) icon.style.display = 'inline';
                        }
                        
                        // Reset mood selection
                        document.querySelectorAll('.mood-option').forEach(option => {
                            const icon = option.querySelector('i');
                            if (icon) icon.style.display = 'none';
                        });
                        const calmMoodOption = document.querySelector('.mood-option[data-mood="calm"]');
                        if (calmMoodOption) {
                            const icon = calmMoodOption.querySelector('i');
                            if (icon) icon.style.display = 'inline';
                        }
                        
                        // Reset reactions
                        document.querySelectorAll('.reaction-option').forEach(option => {
                            option.style.borderColor = 'var(--border-color)';
                        });
                        
                        // Reset badges
                        document.querySelectorAll('.badge-option').forEach(option => {
                            option.style.borderColor = 'var(--border-color)';
                        });
                        const starBadge = document.querySelector('.badge-option[data-badge="star"]');
                        if (starBadge) starBadge.style.borderColor = 'var(--primary-color)';
                        const fireBadge = document.querySelector('.badge-option[data-badge="fire"]');
                        if (fireBadge) fireBadge.style.borderColor = 'var(--primary-color)';
                        
                        selectedFriends = [];
                        updateSelectedFriendsList();
                    }
                });
            }
            
            // Quick action buttons
            const discoverGroupsBtn = document.getElementById('discoverGroupsBtn');
            if (discoverGroupsBtn) {
                discoverGroupsBtn.addEventListener('click', () => {
                    showNotification('Group discovery feature would open here', 'info');
                });
            }
            
            const groupInvitesBtn = document.getElementById('groupInvitesBtn');
            if (groupInvitesBtn) {
                groupInvitesBtn.addEventListener('click', () => {
                    showMobileSection('invites');
                });
            }
            
            const groupEventsBtn = document.getElementById('groupEventsBtn');
            if (groupEventsBtn) {
                groupEventsBtn.addEventListener('click', () => {
                    showNotification('Group events feature would open here', 'info');
                });
            }
            
            // Create group modal tabs
            document.querySelectorAll('.create-group-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    document.querySelectorAll('.create-group-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.create-group-tab-content').forEach(content => content.classList.remove('active'));
                    
                    const tabContent = document.getElementById(`${tabName}Tab`);
                    if (tabContent) tabContent.classList.add('active');
                    
                    if (tabName === 'purpose') {
                        updateCreateGroupPostingRulesUI();
                    }
                });
            });
            
            // Posting rules change listener
            const postingRulesSelect = document.getElementById('postingRulesSelect');
            if (postingRulesSelect) {
                postingRulesSelect.addEventListener('change', updateCreateGroupPostingRulesUI);
            }
            
            // Theme selection
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.dataset.theme;
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        const icon = opt.querySelector('i');
                        if (icon) icon.style.display = 'none';
                    });
                    
                    const icon = this.querySelector('i');
                    if (icon) icon.style.display = 'inline';
                });
            });
            
            // Mood selection
            document.querySelectorAll('.mood-option').forEach(option => {
                option.addEventListener('click', function() {
                    const mood = this.dataset.mood;
                    document.querySelectorAll('.mood-option').forEach(opt => {
                        const icon = opt.querySelector('i');
                        if (icon) icon.style.display = 'none';
                    });
                    
                    const icon = this.querySelector('i');
                    if (icon) icon.style.display = 'inline';
                });
            });
            
            // Reaction selection
            document.querySelectorAll('.reaction-option').forEach(option => {
                option.addEventListener('click', function() {
                    const reaction = this.dataset.reaction;
                    if (this.style.borderColor === 'var(--primary-color)') {
                        this.style.borderColor = 'var(--border-color)';
                    } else {
                        this.style.borderColor = 'var(--primary-color)';
                    }
                });
            });
            
            // Badge selection
            document.querySelectorAll('.badge-option').forEach(option => {
                option.addEventListener('click', function() {
                    const badge = this.dataset.badge;
                    if (this.style.borderColor === 'var(--primary-color)') {
                        this.style.borderColor = 'var(--border-color)';
                    } else {
                        this.style.borderColor = 'var(--primary-color)';
                    }
                });
            });
            
            // Create group button in modal
            const createGroupBtnModal = document.getElementById('createGroupBtnModal');
            if (createGroupBtnModal) {
                createGroupBtnModal.addEventListener('click', async () => {
                    const groupNameInput = document.getElementById('groupNameInput');
                    const groupPurposeSelect = document.getElementById('groupPurposeSelect');
                    
                    if (!groupNameInput || !groupNameInput.value.trim()) {
                        showNotification('Please enter a group name', 'error');
                        return;
                    }
                    
                    if (groupPurposeSelect && !groupPurposeSelect.value) {
                        showNotification('Please select a group purpose', 'error');
                        return;
                    }
                    
                    const selectedTheme = document.querySelector('.theme-option i[style*="display: inline"]')?.parentNode?.dataset.theme || 'blue';
                    const selectedMood = document.querySelector('.mood-option i[style*="display: inline"]')?.parentNode?.dataset.mood || 'calm';
                    const selectedReactions = Array.from(document.querySelectorAll('.reaction-option[style*="border-color: var(--primary-color)"]')).map(el => el.dataset.reaction);
                    const selectedBadges = Array.from(document.querySelectorAll('.badge-option[style*="border-color: var(--primary-color)"]')).map(el => el.dataset.badge);
                    
                    const postingRule = document.getElementById('postingRulesSelect')?.value || 'everyone';
                    let quietHours = {};
                    let scheduledPosting = {};
                    
                    if (postingRule === 'quiet_hours') {
                        const quietStartTime = document.getElementById('quietStartTime');
                        const quietEndTime = document.getElementById('quietEndTime');
                        if (quietStartTime && quietEndTime) {
                            quietHours = {
                                start: quietStartTime.value,
                                end: quietEndTime.value
                            };
                        }
                    } else if (postingRule === 'scheduled') {
                        const postingStartTime = document.getElementById('postingStartTime');
                        const postingEndTime = document.getElementById('postingEndTime');
                        if (postingStartTime && postingEndTime) {
                            scheduledPosting = {
                                start: postingStartTime.value,
                                end: postingEndTime.value
                            };
                        }
                    }
                    
                    const groupData = {
                        name: groupNameInput.value.trim(),
                        description: document.getElementById('groupDescriptionInput')?.value.trim() || '',
                        topic: document.getElementById('groupTopicInput')?.value.trim() || '',
                        privacy: document.getElementById('groupTypeSelect')?.value || 'private',
                        theme: selectedTheme,
                        mood: selectedMood,
                        postingRule: postingRule,
                        quietHours: quietHours,
                        scheduledPosting: scheduledPosting
                    };
                    
                    await createGroupOnline(groupData);
                });
            }
            
            // Chat functionality
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatInput = document.getElementById('chatInput');
            const chatCallBtn = document.getElementById('chatCallBtn');
            const closeChatBtn = document.getElementById('closeChatBtn');
            
            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', sendGroupMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendGroupMessage();
                    }
                });
                
                chatInput.addEventListener('input', adjustTextareaHeight);
            }
            
            if (chatCallBtn) {
                chatCallBtn.addEventListener('click', startGroupCall);
            }
            
            if (closeChatBtn) {
                closeChatBtn.addEventListener('click', closeGroupChatMobile);
            }
            
            // Silent mode button
            const silentModeBtn = document.getElementById('silentModeBtn');
            if (silentModeBtn) {
                silentModeBtn.addEventListener('click', toggleSilentMode);
            }
            
            // Anonymous mode button
            const anonymousModeBtn = document.getElementById('anonymousModeBtn');
            if (anonymousModeBtn) {
                anonymousModeBtn.addEventListener('click', toggleAnonymousMode);
            }
            
            // Edit notes button
            const editNotesBtn = document.getElementById('editNotesBtn');
            const groupNotesContent = document.getElementById('groupNotesContent');
            const groupNotesEditor = document.getElementById('groupNotesEditor');
            const notesEditorActions = document.getElementById('notesEditorActions');
            const saveNotesBtn = document.getElementById('saveNotesBtn');
            const cancelNotesEditBtn = document.getElementById('cancelNotesEditBtn');
            
            if (editNotesBtn) {
                editNotesBtn.addEventListener('click', () => {
                    groupNotesEditor.value = groupNotesContent.textContent;
                    groupNotesContent.style.display = 'none';
                    groupNotesEditor.style.display = 'block';
                    notesEditorActions.style.display = 'block';
                });
            }
            
            if (saveNotesBtn) {
                saveNotesBtn.addEventListener('click', async () => {
                    const notes = groupNotesEditor.value;
                    groupNotesContent.innerHTML = notes;
                    groupNotesEditor.style.display = 'none';
                    groupNotesContent.style.display = 'block';
                    notesEditorActions.style.display = 'none';
                    
                    if (currentChatGroup) {
                        const response = await backgroundApiCall('post', `groups/${currentChatGroup.id}/notes`, { notes });
                        if (response && response.success) {
                            showNotification('Notes saved successfully', 'success');
                        }
                    }
                });
            }
            
            if (cancelNotesEditBtn) {
                cancelNotesEditBtn.addEventListener('click', () => {
                    groupNotesEditor.style.display = 'none';
                    groupNotesContent.style.display = 'block';
                    notesEditorActions.style.display = 'none';
                });
            }
            
            // Add event button
            const addEventBtn = document.getElementById('addEventBtn');
            if (addEventBtn) {
                addEventBtn.addEventListener('click', () => {
                    showNotification('Event creation panel would open here', 'info');
                });
            }
            
            // Back button
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    const groupDetailsPanel = document.getElementById('groupDetailsPanel');
                    
                    if (isMobile) {
                        if (sidebar) sidebar.style.display = 'flex';
                        if (groupDetailsPanel) {
                            groupDetailsPanel.style.display = 'none';
                            groupDetailsPanel.classList.remove('active');
                        }
                    } else {
                        if (groupDetailsPanel) groupDetailsPanel.classList.remove('active');
                    }
                    selectedGroup = null;
                });
            }
            
            // Close create group modal
            const closeCreateGroupModal = document.getElementById('closeCreateGroupModal');
            if (closeCreateGroupModal) {
                closeCreateGroupModal.addEventListener('click', () => {
                    if (createGroupModal) createGroupModal.classList.remove('active');
                });
            }
            
            // Cancel create group button
            const cancelCreateGroupBtn = document.getElementById('cancelCreateGroupBtn');
            if (cancelCreateGroupBtn) {
                cancelCreateGroupBtn.addEventListener('click', () => {
                    if (createGroupModal) createGroupModal.classList.remove('active');
                });
            }
            
            // Close admin management
            const closeAdminManagementBtn = document.getElementById('closeAdminManagementBtn');
            if (closeAdminManagementBtn) {
                closeAdminManagementBtn.addEventListener('click', () => {
                    const adminManagementModal = document.getElementById('adminManagementModal');
                    if (adminManagementModal) adminManagementModal.classList.remove('active');
                });
            }
            
            // Save admin settings
            const saveAdminSettingsBtn = document.getElementById('saveAdminSettingsBtn');
            if (saveAdminSettingsBtn) {
                saveAdminSettingsBtn.addEventListener('click', () => {
                    if (selectedGroup) {
                        saveGroupSettings(selectedGroup);
                    }
                });
            }
            
            // Admin posting mode change
            const adminPostingMode = document.getElementById('adminPostingMode');
            if (adminPostingMode) {
                adminPostingMode.addEventListener('change', updatePostingRulesUI);
            }
            
            // Admin mood selection
            document.querySelectorAll('.mood-select-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mood-select-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.borderWidth = '1px';
                    });
                    this.classList.add('active');
                    this.style.borderWidth = '2px';
                });
            });
            
            // Cancel friend selection
            const cancelFriendSelectionBtn = document.getElementById('cancelFriendSelectionBtn');
            if (cancelFriendSelectionBtn) {
                cancelFriendSelectionBtn.addEventListener('click', () => {
                    const friendSelectionModal = document.getElementById('friendSelectionModal');
                    if (friendSelectionModal) friendSelectionModal.classList.remove('active');
                });
            }
            
            // Confirm friend selection
            const confirmFriendSelectionBtn = document.getElementById('confirmFriendSelectionBtn');
            if (confirmFriendSelectionBtn) {
                confirmFriendSelectionBtn.addEventListener('click', () => {
                    showNotification(`Selected ${selectedFriends.length} friends`, 'success');
                    const friendSelectionModal = document.getElementById('friendSelectionModal');
                    if (friendSelectionModal) friendSelectionModal.classList.remove('active');
                });
            }
            
            // Accept invite button
            const acceptInviteBtn = document.getElementById('acceptInviteBtn');
            if (acceptInviteBtn) {
                acceptInviteBtn.addEventListener('click', () => {
                    if (window.currentInvite) {
                        acceptGroupInvite(window.currentInvite);
                    }
                });
            }
            
            // Decline invite button
            const declineInviteBtn = document.getElementById('declineInviteBtn');
            if (declineInviteBtn) {
                declineInviteBtn.addEventListener('click', () => {
                    if (window.currentInvite) {
                        declineGroupInvite(window.currentInvite);
                    }
                });
            }
        }
        
        // Setup group invites listener
        function setupGroupInvitesListener() {
            if (!currentUser) return;
            
            // Already handled by background sync interval
        }
        
        // Check mobile
        function checkMobile() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                document.body.classList.add('mobile');
                const sidebar = document.getElementById('sidebar');
                const groupChatPanel = document.getElementById('groupChatPanel');
                
                if (groupChatPanel && groupChatPanel.classList.contains('active')) {
                    if (sidebar) sidebar.style.display = 'none';
                    if (groupChatPanel) groupChatPanel.style.display = 'flex';
                } else {
                    if (sidebar) sidebar.style.display = 'flex';
                    if (groupChatPanel) groupChatPanel.style.display = 'none';
                }
            } else {
                document.body.classList.remove('mobile');
                const sidebar = document.getElementById('sidebar');
                const groupChatPanel = document.getElementById('groupChatPanel');
                
                if (sidebar) sidebar.style.display = 'flex';
                if (groupChatPanel) groupChatPanel.style.display = 'flex';
                
                const mobileBackBtn = document.querySelector('.mobile-back-btn');
                if (mobileBackBtn) {
                    mobileBackBtn.remove();
                }
            }
        }
        
        // Show mobile section
        function showMobileSection(section) {
            document.querySelectorAll('.groups-section').forEach(s => {
                s.classList.remove('active');
            });
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            switch(section) {
                case 'all':
                    const allGroupsSection = document.getElementById('allGroupsSection');
                    const allTab = document.getElementById('allTab');
                    if (allGroupsSection) allGroupsSection.classList.add('active');
                    if (allTab) allTab.classList.add('active');
                    break;
                case 'my':
                    const myGroupsSection = document.getElementById('myGroupsSection');
                    const myGroupsTab = document.getElementById('myGroupsTab');
                    if (myGroupsSection) myGroupsSection.classList.add('active');
                    if (myGroupsTab) myGroupsTab.classList.add('active');
                    break;
                case 'joined':
                    const joinedSection = document.getElementById('joinedSection');
                    const joinedTab = document.getElementById('joinedTab');
                    if (joinedSection) joinedSection.classList.add('active');
                    if (joinedTab) joinedTab.classList.add('active');
                    break;
                case 'invites':
                    const invitesSection = document.getElementById('invitesSection');
                    const invitesTab = document.getElementById('invitesTab');
                    if (invitesSection) invitesSection.classList.add('active');
                    if (invitesTab) invitesTab.classList.add('active');
                    break;
                case 'admin':
                    const adminSection = document.getElementById('adminSection');
                    const adminTab = document.getElementById('adminTab');
                    if (adminSection) adminSection.classList.add('active');
                    if (adminTab) adminTab.classList.add('active');
                    break;
            }
            
            updateCurrentSection();
        }
        
        // Render my groups
        function renderMyGroups() {
            const myGroupsList = document.getElementById('myGroupsList');
            if (!myGroupsList) return;
            
            myGroupsList.innerHTML = '';
            
            if (myGroups.length === 0) {
                myGroupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>You haven't created any groups</p>
                        <p class="subtext">Create your first group to get started</p>
                    </div>
                `;
                return;
            }
            
            myGroups.forEach(group => {
                if (matchesFilters(group)) {
                    addGroupItem(group, myGroupsList, 'my_group');
                }
            });
        }
        
        // Render joined groups
        function renderJoinedGroups() {
            const joinedList = document.getElementById('joinedList');
            if (!joinedList) return;
            
            joinedList.innerHTML = '';
            
            if (joinedGroups.length === 0) {
                joinedList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>You haven't joined any groups</p>
                        <p class="subtext">Join groups to connect with others</p>
                    </div>
                `;
                return;
            }
            
            joinedGroups.forEach(group => {
                if (matchesFilters(group)) {
                    addGroupItem(group, joinedList, 'joined');
                }
            });
        }
        
        // Render group invites
        function renderGroupInvites() {
            const invitesList = document.getElementById('invitesList');
            if (!invitesList) return;
            
            invitesList.innerHTML = '';
            
            if (groupInvites.length === 0) {
                invitesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-envelope"></i>
                        <p>No group invites</p>
                        <p class="subtext">When someone invites you to a group, it will appear here</p>
                    </div>
                `;
                return;
            }
            
            groupInvites.forEach(invite => {
                addGroupInviteItem(invite, invitesList);
            });
        }
        
        // Add group invite item
        function addGroupInviteItem(inviteData, container) {
            const inviteItem = document.createElement('div');
            inviteItem.className = 'group-item';
            inviteItem.dataset.inviteId = inviteData.id;
            inviteItem.dataset.type = 'group_invite';
            
            const groupData = inviteData.groupData || inviteData;
            const initials = groupData.name 
                ? groupData.name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2)
                : 'G';
            
            const groupType = groupData.type || 'private';
            const typeInfo = groupTypes[groupType];
            
            const purpose = groupData.purpose || '';
            const mood = groupData.mood || '';
            const purposeInfo = purpose ? groupPurposes[purpose] : null;
            const moodInfo = mood ? groupMoods[mood] : null;
            
            inviteItem.innerHTML = `
                <div class="group-avatar" ${groupData.photoURL ? `style="background-image: url('${groupData.photoURL}')"` : ''}>
                    ${groupData.photoURL ? '' : `<span>${initials}</span>`}
                    <div class="group-type-badge ${groupType}" title="${typeInfo ? typeInfo.name : 'Private'}">
                        <i class="${typeInfo ? typeInfo.icon : 'fas fa-lock'}"></i>
                    </div>
                </div>
                <div class="group-info">
                    <div class="group-name">
                        <span class="group-name-text">${groupData.name || 'Unnamed Group'}</span>
                        ${purposeInfo ? `<span class="group-purpose-tag" style="font-size: 11px;">${purposeInfo.icon} ${purposeInfo.name}</span>` : ''}
                    </div>
                    <div class="group-details">
                        ${moodInfo ? `<span class="group-mood-indicator mood-${mood}" style="background: ${moodInfo.bgColor}; color: ${moodInfo.color}; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${moodInfo.icon} ${moodInfo.name}</span>` : ''}
                        ${groupData.topic ? `<span class="group-topic">${groupData.topic}</span>` : ''}
                        <span class="member-count"><i class="fas fa-users"></i> ${groupData.memberCount || 0}</span>
                        <span>Invited by ${inviteData.invitedByName || 'Unknown'}</span>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">
                        <i class="fas fa-clock"></i> ${formatTimeAgo(inviteData.invitedAt || new Date())}
                    </div>
                </div>
                <div class="group-actions">
                    <button class="group-action-btn success" data-action="accept-invite" title="Accept Invite">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="group-action-btn danger" data-action="decline-invite" title="Decline Invite">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            inviteItem.addEventListener('click', (e) => {
                if (!e.target.closest('.group-actions')) {
                    showGroupInviteDetails(inviteData);
                }
            });
            
            const actionButtons = inviteItem.querySelectorAll('.group-action-btn');
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.dataset.action;
                    handleGroupInviteAction(action, inviteData, btn);
                });
            });
            
            container.appendChild(inviteItem);
        }
        
        // Handle group invite action
        function handleGroupInviteAction(action, inviteData, button) {
            switch(action) {
                case 'accept-invite':
                    acceptGroupInvite(inviteData);
                    break;
                case 'decline-invite':
                    declineGroupInvite(inviteData);
                    break;
                default:
                    console.log('Unknown invite action:', action);
            }
        }
        
        // Render admin groups
        function renderAdminGroups() {
            const adminList = document.getElementById('adminList');
            if (!adminList) return;
            
            adminList.innerHTML = '';
            
            if (adminGroups.length === 0) {
                adminList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-crown"></i>
                        <p>You're not an admin of any groups</p>
                        <p class="subtext">Create or get promoted in a group to see it here</p>
                    </div>
                `;
                return;
            }
            
            adminGroups.forEach(group => {
                if (matchesFilters(group)) {
                    addGroupItem(group, adminList, 'admin');
                }
            });
        }
        
        // Start group call
        function startGroupCall() {
            if (!currentChatGroup) return;
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                })
                .then(stream => {
                    localStream = stream;
                    
                    hideAllPanels();
                    const groupCallPanel = document.getElementById('groupCallPanel');
                    if (groupCallPanel) {
                        groupCallPanel.classList.add('active');
                    }
                    callInProgress = true;
                    callStartTime = Date.now();
                    
                    const callTitle = document.getElementById('callTitle');
                    const callDuration = document.getElementById('callDuration');
                    const callParticipants = document.getElementById('callParticipants');
                    
                    if (callTitle) callTitle.textContent = `Call: ${currentChatGroup.name}`;
                    startCallTimer();
                    addParticipantVideo('local', 'You', stream, true);
                    
                    showNotification('Group call started', 'success');
                })
                .catch(error => {
                    console.error('Error accessing media devices:', error);
                    showNotification('Cannot access camera/microphone', 'error');
                });
            } else {
                showNotification('Your browser does not support video calls', 'error');
            }
        }
        
        // Add participant video
        function addParticipantVideo(participantId, name, stream, isSelf = false) {
            const callParticipants = document.getElementById('callParticipants');
            if (!callParticipants) return;
            
            const participantElement = document.createElement('div');
            participantElement.className = `call-participant ${isSelf ? 'self' : ''}`;
            participantElement.id = `participant-${participantId}`;
            
            participantElement.innerHTML = `
                <video class="participant-video" ${isSelf ? 'muted' : ''} autoplay playsinline></video>
                <div class="participant-info">
                    <div>
                        <div class="participant-name">${name}</div>
                        <div class="participant-status">${isSelf ? 'You' : 'Connected'}</div>
                    </div>
                    <div class="participant-muted">
                        <i class="fas fa-microphone-slash"></i>
                    </div>
                </div>
            `;
            
            const videoElement = participantElement.querySelector('.participant-video');
            if (videoElement) {
                videoElement.srcObject = stream;
            }
            
            callParticipants.appendChild(participantElement);
            
            if (!isSelf) {
                peerConnections[participantId] = null;
            }
        }
        
        // Start call timer
        function startCallTimer() {
            const callDuration = document.getElementById('callDuration');
            callTimer = setInterval(() => {
                if (callStartTime && callDuration) {
                    const elapsed = Date.now() - callStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    callDuration.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        // End group call
        function endGroupCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            Object.keys(peerConnections).forEach(peerId => {
                if (peerConnections[peerId]) {
                    peerConnections[peerId].close();
                }
            });
            peerConnections = {};
            
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            callInProgress = false;
            callStartTime = null;
            
            const callParticipants = document.getElementById('callParticipants');
            const groupCallPanel = document.getElementById('groupCallPanel');
            
            if (callParticipants) callParticipants.innerHTML = '';
            
            if (groupCallPanel) groupCallPanel.classList.remove('active');
            
            if (currentChatGroup) {
                openGroupChat(currentChatGroup);
            } else {
                hideAllPanels();
            }
            
            showNotification('Call ended', 'success');
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', initGroupPage);
        
        // Expose necessary functions to window
        window.showMobileSection = showMobileSection;
        window.removeSelectedFriend = removeSelectedFriend;
    </script>
</body>
</html>